<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>外包历史报价查询</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Inter', system-ui, sans-serif; background-color: #f1f5f9; }
        
        /* 标签样式定义 */
        .badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; border: 1px solid; white-space: nowrap; }
        .badge-internal { background-color: #eff6ff; color: #3b82f6; border-color: #bfdbfe; } /* 内包 */
        .badge-external { background-color: #fff7ed; color: #f97316; border-color: #fed7aa; } /* 外包 */

        /* 动画 */
        .modal-enter { animation: modalIn 0.2s ease-out; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        
        /* 滚动条 */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f8fafc; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen bg-black/40 backdrop-blur-sm" x-data="globalHistoryQuoteModal()">

    <div class="bg-white rounded-xl shadow-2xl w-[1100px] h-[750px] flex flex-col modal-enter overflow-hidden relative" @click.outside="close()">
        
        <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-white shrink-0">
            <div>
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <i class="fa-solid fa-globe text-blue-600"></i>
                    外包历史报价查询
                </h3>
                <p class="text-xs text-slate-500 mt-1">
                    查询历史外包记录，辅助成本定价
                </p>
            </div>
            <button @click="close()" class="w-8 h-8 rounded-full hover:bg-slate-100 text-slate-400 hover:text-red-500 transition flex items-center justify-center">
                <i class="fa-solid fa-times text-lg"></i>
            </button>
        </div>

        <div class="px-6 py-4 bg-slate-50 border-b border-slate-200 flex flex-wrap gap-4 items-center shrink-0">
            
            <div class="relative w-72">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                <input type="text" x-model="filters.keyword" class="w-full pl-9 pr-3 py-2 border border-slate-300 rounded text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition bg-white" placeholder="搜器具 / 供应商 / 报价单号...">
            </div>

            <div class="relative w-48">
                <i class="fa-regular fa-building absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                <input type="text" x-model="filters.customer" class="w-full pl-9 pr-3 py-2 border border-slate-300 rounded text-sm focus:border-blue-500 outline-none transition bg-white" placeholder="筛选客户名称...">
            </div>
            


            <div class="flex-1 text-right">
                <div class="inline-flex items-center gap-2 text-sm text-slate-600 bg-white border border-slate-300 rounded px-3 py-2">
                    <span class="text-xs text-slate-400">排序</span>
                    <select x-model="filters.sort" class="border-none bg-transparent font-bold text-slate-700 outline-none cursor-pointer hover:text-blue-600 text-sm">
                        <option value="date_desc">时间倒序 (最新)</option>
                        <option value="price_asc">报价从低到高</option>
                        <option value="price_desc">报价从高到低</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-auto custom-scroll bg-white">
            <table class="w-full text-left text-sm border-collapse">
                <thead class="bg-slate-50 sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="px-4 py-3 border-b border-slate-200 text-slate-500 font-medium w-40">报价单号</th>
                        <th class="px-4 py-3 border-b border-slate-200 text-slate-500 font-medium min-w-[150px]">器具名称</th>
                        <th class="px-4 py-3 border-b border-slate-200 text-slate-500 font-medium w-28">外包类型</th>
                        <th class="px-4 py-3 border-b border-slate-200 text-slate-500 font-medium min-w-[200px]">供应商</th>
                        <th class="px-4 py-3 border-b border-slate-200 text-slate-500 font-medium min-w-[150px]">关联客户</th>
                        <th class="px-4 py-3 border-b border-slate-200 text-slate-500 font-medium w-32">成交时间</th>
                        <th class="px-4 py-3 border-b border-slate-200 text-slate-500 font-medium text-right w-28">报价</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    <template x-for="record in filteredRecords" :key="record.id">
                        <tr class="hover:bg-blue-50/50 transition-colors group">
                            <td class="px-4 py-3">
                                <div class="font-mono text-xs text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded w-fit" x-text="record.quoteNo"></div>
                            </td>

                            <td class="px-4 py-3">
                                <div class="font-bold text-slate-700" x-text="record.instrumentName"></div>
                                <div class="text-xs text-slate-400" x-text="record.model || '-'"></div>
                            </td>
                            
                            <td class="px-4 py-3">
                                <span class="badge" 
                                      :class="{
                                          'badge-internal': record.type === 'internal',
                                          'badge-external': record.type === 'external'
                                      }"
                                      x-text="getTypeLabel(record.type)">
                                </span>
                            </td>
                            
                            <td class="px-4 py-3">
                                <div class="text-slate-700 text-sm truncate max-w-[200px]" :title="record.vendor" x-text="record.vendor"></div>
                            </td>

                            <td class="px-4 py-3">
                                <div class="text-slate-500 text-xs truncate max-w-[150px]" :title="record.customer" x-text="record.customer"></div>
                            </td>

                            <td class="px-4 py-3 text-slate-500 text-xs font-mono" x-text="record.date"></td>
                            
                            <td class="px-4 py-3 text-right">
                                <div class="font-bold text-red-600 font-mono" x-text="'¥' + record.price"></div>
                            </td>
                            
                            <td class="px-4 py-3 text-center sticky right-0 bg-white group-hover:bg-blue-50/50 shadow-[-4px_0_8px_-4px_rgba(0,0,0,0.05)]">
                                <button @click="selectPrice(record)" class="text-blue-600 hover:text-blue-800 hover:bg-blue-100 p-1.5 rounded transition" title="引用此价格">

                                </button>
                            </td>
                        </tr>
                    </template>

                    <tr x-show="filteredRecords.length === 0">
                        <td colspan="8" class="py-16 text-center text-slate-400">
                            <div class="flex flex-col items-center">
                                <i class="fa-solid fa-inbox text-4xl mb-3 opacity-20"></i>
                                <p class="text-sm">未找到符合条件的外包报价记录</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="px-6 py-3 border-t border-slate-200 bg-slate-50 text-xs text-slate-500 flex justify-between items-center shrink-0">
            <div class="flex gap-4">
                <span><i class="fa-solid fa-circle-info mr-1 text-blue-400"></i> 数据范围：已剔除自主检测记录，仅展示历史外包数据。</span>
            </div>
            <span>共找到 <span class="font-bold text-slate-700" x-text="filteredRecords.length"></span> 条记录</span>
        </div>
    </div>

    <script>
        function globalHistoryQuoteModal() {
            return {
                // 模拟数据源 (仅保留外包类型：internal/external)
                records: [
                    { id: 1, quoteNo: 'QT2025110501', instrumentName: '激光测径仪', model: 'LMD-300', type: 'external', vendor: '大连锅炉压力容器检验研究院', price: 1200, customer: '英特尔半导体', date: '2025-11-05' },
                    { id: 2, quoteNo: 'QT2025102003', instrumentName: '特种气体检测仪', model: 'GasPro', type: 'external', vendor: '大连锅炉压力容器检验研究院', price: 500, customer: '恒力石化', date: '2025-10-20' },
                    { id: 3, quoteNo: 'QT2025091508', instrumentName: '高压核相仪', model: 'TAG-8000', type: 'external', vendor: '辽宁省计量科学研究院', price: 450, customer: '沈阳鼓风机', date: '2025-09-15' },
                    { id: 4, quoteNo: 'QT2025080112', instrumentName: '全站仪', model: 'TS-06', type: 'external', vendor: '大连锅炉压力容器检验研究院', price: 1800, customer: '中铁九局', date: '2025-08-01' },
                    { id: 5, quoteNo: 'QT2025072205', instrumentName: '绝缘电阻测试仪', model: 'Megger', type: 'external', vendor: '大连市计量检验检测研究院', price: 200, customer: '大连船舶重工', date: '2025-07-22' },
                    { id: 6, quoteNo: 'QT2025061009', instrumentName: '激光测径仪', model: 'LMD-200', type: 'external', vendor: '大连锅炉压力容器检验研究院', price: 1150, customer: '一汽大众', date: '2025-06-10' },
                    { id: 7, quoteNo: 'QT2025050502', instrumentName: '气相色谱仪', model: 'GC-2010', type: 'external', vendor: '辽宁省计量科学研究院', price: 1500, customer: '辉瑞制药', date: '2025-05-05' },
                ],
                
                filters: {
                    keyword: '',
                    customer: '',
                    type: 'all',
                    sort: 'date_desc'
                },

                // 核心过滤与排序逻辑
                get filteredRecords() {
                    let result = this.records;

                    // 1. 综合关键词筛选 (器具 / 供应商 / 报价单号)
                    if (this.filters.keyword) {
                        const kw = this.filters.keyword.toLowerCase();
                        result = result.filter(r => 
                            r.instrumentName.toLowerCase().includes(kw) || 
                            r.vendor.toLowerCase().includes(kw) ||
                            r.quoteNo.toLowerCase().includes(kw)
                        );
                    }

                    // 2. 客户筛选
                    if (this.filters.customer) {
                        const custKw = this.filters.customer.toLowerCase();
                        result = result.filter(r => r.customer.toLowerCase().includes(custKw));
                    }

                    // 3. 类型筛选 (内包/外包)
                    if (this.filters.type !== 'all') {
                        result = result.filter(r => r.type === this.filters.type);
                    }

                    // 4. 排序
                    result = result.sort((a, b) => {
                        if (this.filters.sort === 'date_desc') {
                            return new Date(b.date) - new Date(a.date);
                        } else if (this.filters.sort === 'price_asc') {
                            return a.price - b.price;
                        } else if (this.filters.sort === 'price_desc') {
                            return b.price - a.price;
                        }
                        return 0;
                    });

                    return result;
                },

                // 辅助函数：类型转中文
                getTypeLabel(type) {
                    const map = { 'internal': '集团内包', 'external': '外部分包' };
                    return map[type] || type;
                },

                // 动作：引用价格
                selectPrice(record) {
                    // 模拟回调逻辑
                    const msg = `已引用以下数据：\n\n器具：${record.instrumentName}\n供应商：${record.vendor}\n报价：¥${record.price}`;
                    alert(msg);
                    
                    // 实际场景：window.parent.callback(record);
                    this.close();
                },

                // 动作：关闭
                close() {
                    document.body.innerHTML = '<div class="flex h-screen items-center justify-center text-slate-500 bg-slate-50">弹窗已关闭</div>';
                }
            }
        }
    </script>
</body>
</html>
