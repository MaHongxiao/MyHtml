<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºæ…§å®¡æ ¸å·¥ä½œå° | æ™ºé—®é€šè¾¾</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans SC"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a',
                        },
                        ai: {
                            light: '#f0fdf4',
                            main: '#10b981',
                            dark: '#047857'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* AI Thinking Animation */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        .result-card { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }

        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .step-line::before { content: ''; position: absolute; top: 0; bottom: 0; left: 15px; width: 2px; background: #e2e8f0; z-index: 0; }
        
        /* Custom Tooltip Arrow for Header */
        .header-arrow {
            width: 0; height: 0; 
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #2563eb; /* brand-600 */
            position: absolute; bottom: -10px; left: 40px;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans h-screen flex overflow-hidden">

    <!-- å·¦ä¾§æ“ä½œåŒº (40% -> Fixed 420px) -->
    <div class="w-[420px] bg-white border-r border-slate-200 flex flex-col z-20 shadow-xl flex-shrink-0">
        <!-- Header -->
        <div class="h-20 px-8 flex items-center border-b border-slate-100 bg-slate-50/50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-brand-600 to-brand-700 rounded-xl flex items-center justify-center shadow-lg shadow-brand-500/30 text-white">
                    <i class="fa-solid fa-wand-magic-sparkles text-lg"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg text-slate-800">AI æ™ºæ…§å®¡æ ¸å·¥ä½œå°</h1>
                    <p class="text-xs font-medium text-slate-500">v3.5.0 Professional</p>
                </div>
            </div>
        </div>

        <!-- Tool Selection & Form -->
        <div class="flex-1 overflow-y-auto p-8 space-y-8">
            <div class="space-y-3">
                <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">é€‰æ‹©æ™ºèƒ½å·¥å…·</label>
                <div class="relative">
                    <select id="tool-selector" onchange="renderForm()" class="w-full appearance-none bg-slate-50 border border-slate-200 text-slate-700 font-medium py-3.5 px-4 pr-8 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all cursor-pointer hover:bg-white hover:shadow-sm text-sm">
                        <option value="ccc">ğŸ“˜ CCC ç›®å½• AI åˆ¤å®š (Gemini)</option>
                        <option value="ncr">ğŸ“ AI ä¸ç¬¦åˆé¡¹æŠ¥å‘Šç”Ÿæˆ (Gemini)</option>
                        <option value="manday">ğŸ“… IAF MD5 æ™ºèƒ½äººå¤©è®¡ç®—</option>
                        <option value="fee">ğŸ’° è®¤è¯é¡¹ç›®å…¨æˆæœ¬ä¼°ç®—</option>
                        <option value="aql">ğŸ” GB/T 2828 é£é™©æŠ½æ ·å†³ç­–</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                </div>
            </div>
            <div id="dynamic-form-container" class="space-y-6"></div>
        </div>

        <!-- Footer Action -->
        <div class="p-6 border-t border-slate-100 bg-white">
            <button onclick="runAnalysis()" id="btn-execute" class="w-full bg-slate-900 hover:bg-slate-800 text-white py-4 rounded-xl font-bold text-sm shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2 group">
                <span id="btn-text">å¼€å§‹æ™ºèƒ½åˆ†æ</span>
                <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform" id="btn-icon"></i>
            </button>
        </div>
    </div>

    <!-- å³ä¾§ç»“æœå±•ç¤ºåŒº (Flexible) -->
    <div class="flex-1 bg-slate-50 relative overflow-hidden flex flex-col">
        
        <!-- èƒŒæ™¯è£…é¥° -->
        <div class="absolute top-0 right-0 w-[800px] h-[800px] bg-blue-50/50 rounded-full blur-3xl -translate-y-1/2 translate-x-1/3 pointer-events-none"></div>

        <!-- BLUE HEADER AREA -->
        <div id="result-header" class="bg-brand-600 text-white p-8 pb-12 shadow-lg relative shrink-0 transition-all duration-300 hidden">
            <div class="flex justify-between items-start max-w-full mx-auto">
                <div>
                    <div class="flex items-center gap-3 mb-2 opacity-90">
                        <span class="bg-white/20 backdrop-blur px-2 py-0.5 rounded text-xs font-medium border border-white/10" id="header-tag">AI Analysis</span>
                        <span class="text-xs font-medium text-blue-100" id="header-date">2026-01-05</span>
                    </div>
                    <h2 class="text-3xl font-bold tracking-tight" id="header-title">åˆ†ææŠ¥å‘Š</h2>
                    <p class="text-blue-100 text-sm mt-2 max-w-2xl font-medium" id="header-desc">åŸºäºæœ€æ–°è¡Œä¸šè§„åˆ™åº“ä¸ AI æ¨¡å‹ç”Ÿæˆçš„æ·±åº¦åˆ†æç»“æœã€‚</p>
                </div>
                <div class="flex gap-3">
                    <button class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg text-sm font-medium border border-white/20 transition-colors"><i class="fa-solid fa-share-nodes mr-2"></i>åˆ†äº«</button>
                    <button class="bg-white text-brand-600 hover:bg-blue-50 px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition-colors"><i class="fa-solid fa-file-export mr-2"></i>å¯¼å‡º PDF</button>
                </div>
            </div>
            <!-- Decorative Arrow to content -->
            <div class="header-arrow"></div>
        </div>

        <!-- ç»“æœå®¹å™¨ -->
        <div class="flex-1 overflow-y-auto p-6 md:p-8 relative z-10" id="result-container">
            
            <!-- ç©ºçŠ¶æ€ -->
            <div id="state-empty" class="h-full flex flex-col items-center justify-center text-slate-400">
                <div class="w-32 h-32 bg-white rounded-full shadow-sm border border-slate-100 flex items-center justify-center mb-6">
                    <i class="fa-solid fa-robot text-5xl text-slate-300"></i>
                </div>
                <h3 class="text-xl font-medium text-slate-600 mb-2">ç­‰å¾…ä»»åŠ¡æŒ‡ä»¤</h3>
                <p class="text-sm font-medium max-w-xs text-center leading-relaxed text-slate-500">è¯·åœ¨å·¦ä¾§é…ç½®ä¸šåŠ¡å‚æ•°ï¼ŒGemini AI å¼•æ“å°†ä¸ºæ‚¨ç”Ÿæˆä¸“ä¸šçš„åˆ†ææŠ¥å‘Šã€‚</p>
            </div>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="state-loading" class="hidden h-full flex flex-col items-center justify-center">
                <div class="flex gap-2 mb-6">
                    <div class="w-3 h-3 bg-brand-600 rounded-full typing-dot"></div>
                    <div class="w-3 h-3 bg-brand-600 rounded-full typing-dot"></div>
                    <div class="w-3 h-3 bg-brand-600 rounded-full typing-dot"></div>
                </div>
                <p class="text-brand-600 font-medium animate-pulse text-lg" id="loading-text">Gemini AI æ­£åœ¨æ€è€ƒä¸­...</p>
            </div>

            <!-- ç»“æœå†…å®¹ -->
            <div id="state-result" class="hidden w-full h-full flex flex-col gap-6">
                <!-- Content injected by JS -->
            </div>

        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        const apiKey = ""; // Environment variable

        // --- 1. Form Configuration ---
        const forms = {
            ncr: `
                <div class="space-y-5">
                    <div class="bg-indigo-50 border border-indigo-100 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-indigo-800 uppercase mb-1">âœ¨ AI åŠ©æ‰‹åŠŸèƒ½</h4>
                        <p class="text-xs font-medium text-indigo-600">è¾“å…¥ç°åœºå®¡æ ¸çš„ç²—ç•¥ç¬”è®°ï¼ŒAI å°†è‡ªåŠ¨æ•´ç†ä¸ºæ ‡å‡†çš„â€œä¸ç¬¦åˆé¡¹æŠ¥å‘Š (NCR)â€ï¼ŒåŒ…å«æ ‡å‡†æ¡æ¬¾ã€äº‹å®æè¿°å’Œæ•´æ”¹å»ºè®®ã€‚</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1.5">å®¡æ ¸æ ‡å‡†</label>
                        <select id="ncr_standard" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-3 text-sm outline-none">
                            <option value="ISO 9001:2015">ISO 9001:2015 (è´¨é‡)</option>
                            <option value="ISO 14001:2015">ISO 14001:2015 (ç¯å¢ƒ)</option>
                            <option value="ISO 45001:2018">ISO 45001:2018 (èŒä¸šå¥åº·å®‰å…¨)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1.5">ç°åœºç¬”è®° / é—®é¢˜æè¿°</label>
                        <textarea id="ncr_notes" rows="6" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-brand-500 outline-none resize-none" placeholder="ä¾‹å¦‚ï¼šåœ¨åŒ–å­¦å“ä»“åº“å‘ç°3æ¡¶æ¸…æ´å‰‚æ²¡æœ‰æ ‡ç­¾ï¼Œè¯¢é—®åº“ç®¡å‘˜è¯´è¿˜æ²¡æ¥å¾—åŠè´´ï¼Œç°åœºä¹Ÿæ²¡æœ‰çœ‹åˆ°MSDSæ–‡ä»¶ã€‚"></textarea>
                    </div>
                </div>
            `,
            ccc: `
                <div class="space-y-5">
                    <div class="bg-blue-50 border border-blue-100 rounded-lg p-4">
                        <h4 class="text-xs font-bold text-blue-800 uppercase mb-1">âœ¨ AI åˆ¤å®šåŠŸèƒ½</h4>
                        <p class="text-xs font-medium text-blue-600">è¾“å…¥äº§å“åç§°æˆ–æè¿°ï¼ŒGemini å°†æ ¹æ®æœ€æ–°çš„ CCC ç›®å½•è¿›è¡Œè¯­ä¹‰åŒ¹é…ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦å¼ºåˆ¶è®¤è¯ã€‚</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1.5">äº§å“åç§°æˆ–æè¿°</label>
                        <textarea id="ccc_input" rows="5" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-brand-500 outline-none resize-none" placeholder="ä¾‹å¦‚ï¼šå¸¦è“ç‰™åŠŸèƒ½çš„å„¿ç«¥ç”µåŠ¨ç‰™åˆ·ï¼Œå†…ç½®é”‚ç”µæ± ï¼Œé¢å®šç”µå‹ 5Vã€‚"></textarea>
                    </div>
                </div>
            `,
            manday: `
                <div class="space-y-5">
                    <div><label class="block text-xs font-bold text-slate-500 mb-1.5">è®¤è¯æ ‡å‡†</label><div class="grid grid-cols-2 gap-3"><label class="cursor-pointer"><input type="radio" name="md_std" value="QMS" checked class="peer sr-only"><div class="px-4 py-3 rounded-lg border border-slate-200 bg-slate-50 text-slate-600 text-sm font-medium peer-checked:border-brand-500 peer-checked:bg-brand-50 peer-checked:text-brand-700 transition-all text-center">ISO 9001</div></label><label class="cursor-pointer"><input type="radio" name="md_std" value="EMS" class="peer sr-only"><div class="px-4 py-3 rounded-lg border border-slate-200 bg-slate-50 text-slate-600 text-sm font-medium peer-checked:border-brand-500 peer-checked:bg-brand-50 peer-checked:text-brand-700 transition-all text-center">ISO 14001</div></label></div></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1.5">æœ‰æ•ˆå‘˜å·¥æ€»æ•°</label><input type="number" id="md_count" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-shadow" placeholder="ä¾‹å¦‚: 150"></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1.5">å¤æ‚ç¨‹åº¦ (Risk)</label><select id="md_risk" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-brand-500 outline-none"><option value="H">é«˜é£é™© (High)</option><option value="M" selected>ä¸­ç­‰ (Medium)</option><option value="L">ä½é£é™© (Low)</option></select></div>
                    <div class="pt-2 border-t border-slate-100"><label class="flex items-center gap-3 cursor-pointer p-2 hover:bg-slate-50 rounded-lg"><input type="checkbox" id="md_shift" class="w-4 h-4 text-brand-600 rounded border-slate-300 focus:ring-brand-500"><span class="text-sm font-medium text-slate-600">åŒ…å«å€’ç­ (Shift Work)</span></label><label class="flex items-center gap-3 cursor-pointer p-2 hover:bg-slate-50 rounded-lg"><input type="checkbox" id="md_multi" class="w-4 h-4 text-brand-600 rounded border-slate-300 focus:ring-brand-500"><span class="text-sm font-medium text-slate-600">å¤šåœºæ‰€ (Multi-site)</span></label></div>
                </div>`,
            fee: `
                <div class="space-y-5">
                    <div><label class="block text-xs font-bold text-slate-500 mb-1.5">è®¤è¯æ¨¡å¼</label><select id="fee_mode" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-3 text-sm outline-none"><option value="type1">å‹å¼è¯•éªŒ + è·è¯åç›‘ç£</option><option value="type2">å‹å¼è¯•éªŒ + åˆå§‹å·¥å‚æ£€æŸ¥ + è·è¯åç›‘ç£</option></select></div>
                    <div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-slate-500 mb-1.5">ç”³è¯·å•å…ƒæ•°</label><input type="number" id="fee_units" value="1" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-3 text-sm outline-none"></div><div><label class="block text-xs font-bold text-slate-500 mb-1.5">é¢„ä¼°äººå¤©</label><input type="number" id="fee_days" value="2.5" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-3 text-sm outline-none"></div></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1.5">äº§å“ç±»åˆ«</label><input type="text" id="fee_product" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-3 text-sm outline-none" placeholder="ä¾‹å¦‚: å®¶ç”¨å†°ç®±"></div>
                </div>`,
            aql: `
                <div class="space-y-5">
                    <div><label class="block text-xs font-bold text-slate-500 mb-1.5">æ‰¹é‡å¤§å° (N)</label><input type="number" id="aql_batch" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-brand-500 outline-none" placeholder="è¾“å…¥æ‰¹æ¬¡æ€»æ•°é‡"></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1.5">æ£€éªŒæ°´å¹³ (IL)</label><div class="flex rounded-lg bg-slate-100 p-1"><button onclick="setAQLLevel(this, 'I')" class="aql-btn flex-1 py-1.5 text-xs font-medium rounded-md text-slate-500 hover:bg-white hover:shadow-sm transition-all">S-4</button><button onclick="setAQLLevel(this, 'II')" class="aql-btn flex-1 py-1.5 text-xs font-medium rounded-md bg-white text-brand-600 shadow-sm transition-all">II (ä¸€èˆ¬)</button><button onclick="setAQLLevel(this, 'III')" class="aql-btn flex-1 py-1.5 text-xs font-medium rounded-md text-slate-500 hover:bg-white hover:shadow-sm transition-all">III (ä¸¥æ ¼)</button></div><input type="hidden" id="aql_level" value="II"></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1.5">æ¥æ”¶è´¨é‡é™ (AQL)</label><select id="aql_val" class="w-full bg-white border border-slate-200 rounded-lg px-4 py-3 text-sm outline-none"><option value="0.65">0.65 (ä¸¥è‹›)</option><option value="1.5">1.5</option><option value="2.5" selected>2.5 (å¸¸è§„)</option><option value="4.0">4.0</option></select></div>
                </div>`
        };

        function renderForm() {
            const type = document.getElementById('tool-selector').value;
            document.getElementById('dynamic-form-container').innerHTML = forms[type];
            document.getElementById('state-empty').classList.remove('hidden');
            document.getElementById('state-result').classList.add('hidden');
            document.getElementById('result-header').classList.add('hidden');
            document.getElementById('state-loading').classList.add('hidden');
        }

        function setAQLLevel(btn, val) {
            document.querySelectorAll('.aql-btn').forEach(b => { b.className = 'aql-btn flex-1 py-1.5 text-xs font-medium rounded-md text-slate-500 hover:bg-white hover:shadow-sm transition-all'; });
            btn.className = 'aql-btn flex-1 py-1.5 text-xs font-medium rounded-md bg-white text-brand-600 shadow-sm transition-all';
            document.getElementById('aql_level').value = val;
        }

        // --- 2. Gemini API Call ---
        async function callGemini(prompt) {
            if (!apiKey) return null; // Fallback to mock if no key
            
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error(response.statusText);
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                return JSON.parse(text);
            } catch (error) {
                console.error("Gemini Error:", error);
                return null; 
            }
        }

        async function runAnalysis() {
            const type = document.getElementById('tool-selector').value;
            // Validation
            if (type === 'manday' && !document.getElementById('md_count').value) return alert('è¯·è¾“å…¥æœ‰æ•ˆå‘˜å·¥æ•°');
            if (type === 'aql' && !document.getElementById('aql_batch').value) return alert('è¯·è¾“å…¥æ‰¹é‡å¤§å°');
            if (type === 'ccc' && !document.getElementById('ccc_input').value) return alert('è¯·è¾“å…¥äº§å“æè¿°');
            if (type === 'ncr' && !document.getElementById('ncr_notes').value) return alert('è¯·è¾“å…¥ä¸ç¬¦åˆé¡¹ç¬”è®°');

            // UI Loading
            const btn = document.getElementById('btn-execute');
            const originalBtnText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i>å¤„ç†ä¸­...`;

            document.getElementById('state-empty').classList.add('hidden');
            document.getElementById('state-result').classList.add('hidden');
            document.getElementById('result-header').classList.add('hidden');
            document.getElementById('state-loading').classList.remove('hidden');
            document.getElementById('loading-text').innerText = "Gemini AI æ­£åœ¨åˆ†ææ•°æ®...";

            let resultHTML = "";
            let headerInfo = {};

            try {
                if (type === 'ccc') {
                    const input = document.getElementById('ccc_input').value;
                    const prompt = `You are a China Compulsory Certification (CCC) expert. Analyze this product: "${input}". 
                    Return JSON: {
                        "isCCC": boolean,
                        "categoryCode": "string (e.g. 0801)",
                        "categoryName": "string",
                        "productName": "string (formal name)",
                        "standard": "string (e.g. GB 4943.1)",
                        "confidence": "number (0-100)",
                        "reasoning": "string (brief explanation in Chinese)",
                        "testItems": ["string", "string", "string"] (top 5 key tests)
                    }`;
                    
                    let aiData = await callGemini(prompt);
                    
                    // Mock fallback if API fails or no key
                    if (!aiData) {
                        await new Promise(r => setTimeout(r, 1500));
                        aiData = {
                            isCCC: true,
                            categoryCode: "0801",
                            categoryName: "éŸ³è§†é¢‘è®¾å¤‡",
                            productName: "éŸ³å“è®¾å¤‡",
                            standard: "GB 8898 / GB 4943.1",
                            confidence: 95,
                            reasoning: "è¯¥äº§å“å±äºéŸ³è§†é¢‘è®¾å¤‡ç±»åˆ«ï¼Œä¸”åŒ…å«ç”µæºé€‚é…å™¨ï¼Œé€šå¸¸åœ¨ CCC ç›®å½•èŒƒå›´å†…ã€‚",
                            testItems: ["ç”µæ°”é—´éš™å’Œçˆ¬ç”µè·ç¦»", "æŠ—ç”µå¼ºåº¦", "ç”µæºç«¯å­éªšæ‰°ç”µå‹", "è¾å°„éªšæ‰°", "æ¸©å‡è¯•éªŒ"]
                        };
                    }

                    headerInfo = { title: "CCC å¼ºåˆ¶æ€§è®¤è¯åˆ¤å®šä¹¦", desc: "åŸºäº Gemini AI è¯­ä¹‰åˆ†æä¸æœ€æ–° CCC ç›®å½•åŒ¹é…", tag: "åˆè§„åˆ¤å®š" };
                    resultHTML = generateCCCResult(aiData);

                } else if (type === 'ncr') {
                    const standard = document.getElementById('ncr_standard').value;
                    const notes = document.getElementById('ncr_notes').value;
                    const prompt = `You are a Lead Auditor. Draft a Non-Conformity Report (NCR) based on these notes: "${notes}" for standard "${standard}".
                    Return JSON: {
                        "clause": "string (e.g. 8.5.2)",
                        "clauseTitle": "string",
                        "grade": "Major/Minor",
                        "statement": "string (Professional statement of fact)",
                        "evidence": "string",
                        "correction": "string (Immediate action)",
                        "rootCauseHint": "string (Hint for analysis)"
                    }`;

                    let aiData = await callGemini(prompt);
                    
                    if (!aiData) {
                        await new Promise(r => setTimeout(r, 1500));
                        aiData = {
                            clause: "8.5.2",
                            clauseTitle: "æ ‡è¯†å’Œå¯è¿½æº¯æ€§",
                            grade: "Minor",
                            statement: "å®¡æ ¸å‘˜åœ¨åŒ–å­¦å“ä»“åº“ç°åœºå‘ç°ï¼Œéƒ¨åˆ†æ¸…æ´å‰‚å®¹å™¨æœªå¼ è´´æ˜æ˜¾çš„èº«ä»½æ ‡è¯†ï¼Œä¸”ç°åœºæ— æ³•æä¾›ç›¸å…³ç‰©æ–™çš„è¿½è¸ªè®°å½•ã€‚",
                            evidence: "åŒ–å­¦å“ä»“åº“ 3 æ¡¶æ— æ ‡ç­¾æ¸…æ´å‰‚",
                            correction: "ç«‹å³å¯¹ç°æœ‰æ— æ ‡ç­¾ç‰©æ–™è¿›è¡Œè¯†åˆ«å’Œæ ‡è¯†ï¼Œæˆ–è¿›è¡Œéš”ç¦»å¤„ç†ã€‚",
                            rootCauseHint: "æ£€æŸ¥ä»“åº“ç®¡ç†æµç¨‹ä¸­å…³äºåŒ–å­¦å“å…¥åº“æ ‡è¯†çš„è§„å®šæ˜¯å¦æ‰§è¡Œåˆ°ä½ã€‚"
                        };
                    }

                    headerInfo = { title: "ä¸ç¬¦åˆé¡¹æŠ¥å‘Š (NCR) è‰æ¡ˆ", desc: "ç”± AI è‡ªåŠ¨æ•´ç†çš„æ ‡å‡†åŒ–å®¡æ ¸å‘ç°", tag: "å®¡æ ¸æ–‡ä¹¦" };
                    resultHTML = generateNCRResult(aiData);

                } else if (type === 'manday' || type === 'fee' || type === 'aql') {
                    // Existing logic for other tools
                    await new Promise(r => setTimeout(r, 1000));
                    if (type === 'manday') {
                        headerInfo = { title: "IAF MD5 å®¡æ ¸äººå¤©è®¡ç®—æŠ¥å‘Š", desc: "ä¾æ® IAF MD 5:2019 åŠ CQC è®¤è¯ä¸šåŠ¡è§„åˆ™ç”Ÿæˆ", tag: "äººå¤©ä¼°ç®—" };
                        resultHTML = generateMandayResult();
                    } else if (type === 'fee') {
                        headerInfo = { title: "è®¤è¯é¡¹ç›®å…¨æˆæœ¬ä¼°ç®—å•", desc: "åŒ…å«ç”³è¯·è´¹ã€å®¡æ ¸è´¹ã€æ³¨å†Œè´¹åŠå¹´é‡‘çš„ç»¼åˆæˆæœ¬åˆ†æ", tag: "æˆæœ¬é¢„ç®—" };
                        resultHTML = generateFeeResult();
                    } else if (type === 'aql') {
                        headerInfo = { title: "GB/T 2828.1 æŠ½æ ·æ–¹æ¡ˆå†³ç­–ä¹¦", desc: "åŸºäºç»Ÿè®¡å­¦åŸç†çš„æ‰¹æ¬¡è´¨é‡éªŒæ”¶æŠ½æ ·è®¡åˆ’", tag: "è´¨é‡æ§åˆ¶" };
                        resultHTML = generateAQLResult();
                    }
                }

                // Render
                document.getElementById('header-title').innerText = headerInfo.title;
                document.getElementById('header-desc').innerText = headerInfo.desc;
                document.getElementById('header-tag').innerText = headerInfo.tag;
                
                document.getElementById('state-loading').classList.add('hidden');
                document.getElementById('result-header').classList.remove('hidden');
                
                const resultContainer = document.getElementById('state-result');
                resultContainer.innerHTML = resultHTML;
                resultContainer.classList.remove('hidden');

                // Post-render charts
                setTimeout(() => {
                    if (type === 'aql') renderAQLChart();
                    if (type === 'fee') { renderFeeChart(); renderTrendChart(); }
                    if (type === 'manday') renderRiskRadar();
                }, 100);

            } catch (e) {
                console.error(e);
                alert("AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•ã€‚");
                document.getElementById('state-loading').classList.add('hidden');
                document.getElementById('state-empty').classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
            }
        }

        // --- Result HTML Generators ---

        function generateCCCResult(data) {
            const colorClass = data.isCCC ? "text-green-600 bg-green-100" : "text-slate-500 bg-slate-100";
            const icon = data.isCCC ? '<i class="fa-solid fa-check"></i>' : '<i class="fa-solid fa-xmark"></i>';
            const statusText = data.isCCC ? "å±äº CCC å¼ºåˆ¶è®¤è¯èŒƒå›´" : "ä¸å±äº CCC å¼ºåˆ¶è®¤è¯èŒƒå›´";

            return `
                <div class="grid grid-cols-12 gap-6">
                    <div class="col-span-12 result-card bg-white rounded-2xl shadow-sm border border-slate-200 p-8 flex items-center gap-6 relative overflow-hidden">
                        <div class="absolute left-0 top-0 w-2 h-full ${data.isCCC ? 'bg-green-500' : 'bg-slate-400'}"></div>
                        <div class="w-16 h-16 rounded-full flex items-center justify-center text-2xl flex-shrink-0 ${colorClass}">
                            ${icon}
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">${statusText}</h2>
                            <p class="text-slate-500 text-sm mt-1">AI åˆ¤å®šç½®ä¿¡åº¦ï¼š<span class="font-bold text-brand-600">${data.confidence}%</span></p>
                        </div>
                    </div>

                    <div class="col-span-8 result-card bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                        <h3 class="font-bold text-sm text-slate-700 mb-4">åˆ¤å®šè¯¦æƒ…</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-100">
                                <span class="text-xs font-bold text-slate-500 w-24">äº§å“ç±»åˆ«</span>
                                <span class="text-sm font-bold text-slate-800 flex-1 text-right">${data.categoryCode} ${data.categoryName}</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-100">
                                <span class="text-xs font-bold text-slate-500 w-24">é€‚ç”¨æ ‡å‡†</span>
                                <span class="text-sm font-mono text-brand-600 bg-brand-50 px-2 py-1 rounded text-right">${data.standard}</span>
                            </div>
                            <div class="p-4 bg-blue-50 rounded-lg text-sm text-blue-800 leading-relaxed border border-blue-100">
                                <strong>ğŸ’¡ AI æ¨ç†é€»è¾‘ï¼š</strong><br>
                                ${data.reasoning}
                            </div>
                        </div>
                    </div>

                    <div class="col-span-4 result-card bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                        <h3 class="font-bold text-sm text-slate-700 mb-4">å…³é”®æµ‹è¯•é¡¹ç›®</h3>
                        <div class="flex flex-wrap gap-2">
                            ${data.testItems.map(item => `<span class="px-3 py-1.5 rounded-lg bg-slate-50 text-slate-600 text-xs border border-slate-200">${item}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function generateNCRResult(data) {
            return `
                <div class="result-card bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-red-50 px-6 py-4 border-b border-red-100 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="bg-red-600 text-white text-xs font-bold px-2 py-1 rounded">NCR</span>
                            <h3 class="font-bold text-red-900">ä¸ç¬¦åˆé¡¹æŠ¥å‘Š</h3>
                        </div>
                        <span class="text-xs font-bold text-red-700 uppercase">Grade: ${data.grade}</span>
                    </div>
                    <div class="p-8 space-y-6">
                        <div>
                            <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">ä¸ç¬¦åˆæ¡æ¬¾ (Clause)</h4>
                            <div class="text-lg font-bold text-slate-800">${data.clause} ${data.clauseTitle}</div>
                        </div>
                        <div>
                            <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">äº‹å®æè¿° (Statement of Fact)</h4>
                            <div class="p-4 bg-slate-50 rounded-lg border border-slate-200 text-slate-700 leading-relaxed text-sm">
                                ${data.statement}
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">å®¢è§‚è¯æ® (Evidence)</h4>
                                <div class="text-sm text-slate-700 font-medium">${data.evidence}</div>
                            </div>
                            <div>
                                <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">æ•´æ”¹å»ºè®® (Correction)</h4>
                                <div class="text-sm text-green-700 font-medium">${data.correction}</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-50 px-6 py-3 border-t border-slate-200 text-xs text-slate-500">
                        <strong>ğŸ” æ ¹å› åˆ†ææç¤ºï¼š</strong> ${data.rootCauseHint}
                    </div>
                </div>
                <div class="text-center mt-4">
                    <button class="text-sm text-brand-600 hover:text-brand-700 font-medium"><i class="fa-solid fa-copy mr-1"></i> å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
                </div>
            `;
        }

        // ... [Include generateMandayResult, generateFeeResult, generateAQLResult from previous version] ...
        function generateMandayResult() {
             const count = parseInt(document.getElementById('md_count').value);
             const base = count < 50 ? 4 : (count < 200 ? 8 : 12);
             const factor = document.getElementById('md_risk').value === 'H' ? 1.3 : 1.0;
             const total = (base * factor).toFixed(1);
             return `<div class="grid grid-cols-12 gap-6"><div class="col-span-7 result-card bg-white rounded-2xl shadow-sm border border-slate-200 p-8"><h3 class="text-sm font-bold text-slate-500 mb-4">å»ºè®®äººå¤©</h3><div class="text-7xl font-bold text-brand-600">${total}</div><div class="flex gap-4 mt-6"><div class="bg-slate-50 rounded-xl p-4 flex-1 border border-slate-100"><div class="text-xs text-slate-500 mb-1">ä¸€é˜¶æ®µ (æ–‡å®¡)</div><div class="text-xl font-bold text-slate-800">${(total*0.3).toFixed(1)} <span class="text-xs font-normal">å¤©</span></div></div><div class="bg-brand-50 rounded-xl p-4 flex-1 border border-brand-100"><div class="text-xs text-brand-600 mb-1">äºŒé˜¶æ®µ (ç°åœº)</div><div class="text-xl font-bold text-brand-700">${(total*0.7).toFixed(1)} <span class="text-xs font-normal">å¤©</span></div></div></div></div><div class="col-span-5 result-card bg-white rounded-2xl shadow-sm border border-slate-200 p-6"><canvas id="riskRadar"></canvas></div></div>`;
        }
        function generateFeeResult() {
             return `<div class="grid grid-cols-12 gap-6"><div class="col-span-4 result-card bg-white rounded-2xl shadow-sm border border-slate-200 p-6"><h3>æ€»è´¹ç”¨</h3><div class="text-4xl font-bold">Â¥ 18,500</div></div><div class="col-span-8 result-card bg-white rounded-2xl shadow-sm border border-slate-200 p-6"><canvas id="feeChart"></canvas></div><div class="col-span-12 result-card bg-white rounded-2xl shadow-sm border border-slate-200 p-6"><canvas id="trendChart"></canvas></div></div>`;
        }
        function generateAQLResult() {
             return `<div class="result-card bg-white rounded-2xl shadow-sm border border-slate-200 p-6"><div class="grid grid-cols-3 text-center mb-6"><div><div class="text-xs text-slate-400">n</div><div class="text-4xl font-bold">200</div></div><div><div class="text-xs text-slate-400">Ac</div><div class="text-4xl font-bold text-green-600">10</div></div><div><div class="text-xs text-slate-400">Re</div><div class="text-4xl font-bold text-red-600">11</div></div></div><div class="h-48"><canvas id="aqlChart"></canvas></div></div>`;
        }

        // --- 4. Chart Renderers (Same as before) ---
        function renderFeeChart() {
            const el = document.getElementById('feeChart');
            if(!el) return;
            new Chart(el.getContext('2d'), {type:'doughnut',data:{labels:['å®¡æ ¸','ç”³è¯·','æ³¨å†Œ','å¹´é‡‘'],datasets:[{data:[70,10,10,10],backgroundColor:['#3b82f6','#93c5fd','#bfdbfe','#cbd5e1'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},cutout:'75%'}});
        }
        function renderTrendChart() {
            const el = document.getElementById('trendChart');
            if(!el) return;
            new Chart(el.getContext('2d'), {type:'line',data:{labels:['2026','2027','2028'],datasets:[{label:'æˆæœ¬',data:[2000,2200,2000],borderColor:'#10b981',backgroundColor:'rgba(16,185,129,0.1)',fill:true,tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{display:false},x:{grid:{display:false}}}}});
        }
        function renderRiskRadar() {
            const el = document.getElementById('riskRadar');
            if(!el) return;
            new Chart(el.getContext('2d'), {type:'radar',data:{labels:['äººå‘˜','è¿‡ç¨‹','è®¾å¤‡','æ–‡ä»¶','ç»©æ•ˆ'],datasets:[{label:'é£é™©',data:[80,60,40,30,70],backgroundColor:'rgba(59,130,246,0.2)',borderColor:'#3b82f6'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{r:{suggestMin:0,ticks:{display:false}}}}});
        }
        function renderAQLChart() {
            const el = document.getElementById('aqlChart');
            if(!el) return;
            new Chart(el.getContext('2d'), {type:'line',data:{labels:[0,2,4,6,8,10,12],datasets:[{label:'Pa(%)',data:[100,95,80,50,20,5,0],borderColor:'#2563eb',backgroundColor:'rgba(37,99,235,0.1)',fill:true,tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{title:{display:true,text:'æ¥æ”¶æ¦‚ç‡'},grid:{borderDash:[4,4]}},x:{title:{display:true,text:'ä¸åˆæ ¼å“ç‡%'},grid:{display:false}}}}});
        }

        renderForm(); // Init
    </script>
</body>
</html>
