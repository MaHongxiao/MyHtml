<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>区域目标分配 - 华东分公司 (含历史数据)</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Inter', "PingFang SC", system-ui, sans-serif; background-color: #f2f3f5; font-size: 14px; color: #1d1d1f; }
        
        /* 组件样式 */
        .t-card { background: #fff; border-radius: 3px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e7e7e7; }
        
        .t-input {
            width: 100%; border: 1px solid #dcdcdc; border-radius: 3px; padding: 6px 12px;
            font-size: 14px; transition: all 0.2s; outline: none; background-color: #fff; height: 32px;
        }
        .t-input:hover:not(:disabled) { border-color: #0052D9; }
        .t-input:focus:not(:disabled) { border-color: #0052D9; box-shadow: 0 0 0 2px rgba(0, 82, 217, 0.1); }
        .t-input:disabled { background-color: #f7f7f7; color: #999; cursor: not-allowed; border-color: #e0e0e0; }

        .t-btn { display: inline-flex; align-items: center; justify-content: center; padding: 0 20px; border-radius: 3px; cursor: pointer; transition: all 0.2s; font-size: 14px; height: 36px; font-weight: 500; }
        .t-btn-primary { background: #0052D9; color: #fff; border: 1px solid #0052D9; }
        .t-btn-primary:hover { background: #003CAB; border-color: #003CAB; }
        .t-btn-default { background: #fff; border: 1px solid #dcdcdc; color: #333; }
        .t-btn-default:hover { border-color: #0052D9; color: #0052D9; }
        .t-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #e7e7e7; border-color: #e7e7e7; color: #999; }

        /* 表格样式 */
        .plan-table th { background-color: #f3f5f8; font-weight: 600; color: #444; padding: 10px 12px; border-bottom: 1px solid #e7e7e7; text-align: left; white-space: nowrap; }
        .plan-table td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
        .plan-table tr:hover { background-color: #f8faff; }
        
        /* 开关样式 */
        .toggle-checkbox:checked { right: 0; border-color: #0052D9; }
        .toggle-checkbox:checked + .toggle-label { background-color: #0052D9; }
        
        /* 底部栏强化样式 */
        .footer-highlight { background: #fff; border-top: 1px solid #e7e7e7; box-shadow: 0 -8px 30px rgba(0,0,0,0.08); }
        .progress-track { background: #f0f0f0; border-radius: 4px; height: 12px; overflow: hidden; }
        .progress-bar { height: 100%; transition: width 0.3s ease; border-radius: 4px; }
    </style>
</head>

<body class="pb-32" x-data="distributeApp()">

    <header class="bg-white border-b border-gray-200 px-6 py-4 sticky top-0 z-30 shadow-sm flex justify-between items-center">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-indigo-600 text-white rounded flex items-center justify-center font-bold text-lg">
                <i class="fa-solid fa-sitemap"></i>
            </div>
            <div>
                <div class="flex items-center gap-2">
                    <h1 class="text-lg font-bold text-gray-900">2025年度目标分配任务</h1>
                    <span class="bg-blue-50 text-blue-700 border border-blue-200 text-xs px-2 py-0.5 rounded">进行中</span>
                </div>
                <div class="text-xs text-gray-500 mt-0.5 flex gap-3">
                    <span><i class="fa-regular fa-building mr-1"></i>当前单位：<strong>华东区域分公司</strong></span>
                    <span class="text-gray-300">|</span>
                    <span><i class="fa-regular fa-clock mr-1"></i>截止日期：2024-12-31</span>
                </div>
            </div>
        </div>
        <button class="text-gray-500 hover:text-gray-800 text-sm" @click="confirmCancel()">
            <i class="fa-solid fa-xmark mr-1"></i>关闭
        </button>
    </header>

    <main class="max-w-[1400px] mx-auto p-6 space-y-6">

        <div class="t-card p-6 relative overflow-hidden">
            <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-3">
                <h3 class="text-sm font-bold text-gray-800 border-l-4 border-blue-600 pl-3">本单位年度挑战目标设定</h3>
                <div class="text-xs text-gray-500 bg-yellow-50 text-yellow-700 px-3 py-1 rounded border border-yellow-100">
                    <i class="fa-solid fa-circle-exclamation mr-1"></i>
                    上级考核红线：内部挑战目标不得低于下达基准值
                </div>
            </div>

            <div class="mb-6 bg-indigo-50 border border-indigo-100 rounded-lg p-4 grid grid-cols-4 gap-6">
                <div class="border-r border-indigo-100 flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-sm"><i class="fa-solid fa-history"></i></div>
                    <div>
                        <div class="text-xs text-indigo-400">2024年总目标 (万元)</div>
                        <div class="text-lg font-bold text-indigo-900 font-mono" x-text="formatMoney(totalLastTarget)"></div>
                    </div>
                </div>
                <div class="border-r border-indigo-100 flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-sm"><i class="fa-solid fa-check"></i></div>
                    <div>
                        <div class="text-xs text-indigo-400">2024年实际完成 (万元)</div>
                        <div class="text-lg font-bold text-indigo-900 font-mono" x-text="formatMoney(totalLastActual)"></div>
                    </div>
                </div>
                <div class="border-r border-indigo-100 flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-sm"><i class="fa-solid fa-chart-line"></i></div>
                    <div>
                        <div class="text-xs text-indigo-400">2024年达成率</div>
                        <div class="text-lg font-bold font-mono" :class="totalLastActual >= totalLastTarget ? 'text-green-600' : 'text-orange-500'" x-text="((totalLastActual / totalLastTarget)*100).toFixed(1) + '%'"></div>
                    </div>
                </div>
                <div class="flex items-center justify-end pr-2 text-xs text-indigo-400">
                    * 数据来源：系统自动汇总下级机构2024年报表
                </div>
            </div>

            <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                <div class="flex items-start gap-6">
                    
                    <div class="flex-1 opacity-90">
                        <div class="text-xs text-gray-500 mb-2 font-bold">2025年总部下达基准值 (不可变)</div>
                        <div class="relative">
                            <input type="text" :value="formatMoney(baseTarget)" disabled 
                                   class="t-input text-2xl font-bold text-gray-500 bg-gray-200 cursor-not-allowed pl-8 h-14 border-gray-300">
                            <i class="fa-solid fa-lock absolute left-3 top-5 text-gray-400"></i>
                            <span class="absolute right-4 top-5 text-xs text-gray-500 font-bold">万元</span>
                        </div>
                    </div>

                    <div class="pt-10 text-gray-400"><i class="fa-solid fa-plus"></i></div>

                    <div class="flex-1">
                        <div class="text-xs text-blue-600 mb-2 font-bold flex justify-between">
                            <span>自我加压上浮比例</span>
                            <span class="text-[10px] text-gray-400 font-normal">调整此处可改变挑战目标</span>
                        </div>
                        <div class="relative group">
                            <input type="number" x-model.number="floatRatio" @input="calcTargetByRatio()" step="0.5"
                                   class="t-input text-2xl font-bold text-blue-600 border-blue-200 focus:border-blue-600 h-14 pr-10 transition">
                            <span class="absolute right-4 top-5 text-sm text-blue-400 font-bold">%</span>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button @click="quickSetRate(0)" class="text-[10px] bg-white border px-2 py-0.5 rounded hover:border-blue-500 text-gray-600">保底(0%)</button>
                            <button @click="quickSetRate(10)" class="text-[10px] bg-white border px-2 py-0.5 rounded hover:border-blue-500 text-gray-600">挑战(10%)</button>
                            <button @click="quickSetRate(20)" class="text-[10px] bg-white border px-2 py-0.5 rounded hover:border-blue-500 text-gray-600">冲刺(20%)</button>
                        </div>
                    </div>

                    <div class="pt-10 text-gray-400"><i class="fa-solid fa-equals"></i></div>

                    <div class="flex-1">
                        <div class="flex justify-between mb-2">
                            <div class="text-xs font-bold" :class="isValidTarget ? 'text-gray-800' : 'text-red-600'">内部挑战目标值</div>
                            <div class="text-[10px] text-red-500 bg-red-50 px-2 rounded font-bold" x-show="!isValidTarget">
                                <i class="fa-solid fa-ban mr-1"></i>低于基准值
                            </div>
                        </div>
                        <div class="relative">
                            <span class="absolute left-4 top-5 text-gray-400 text-base">¥</span>
                            <input type="number" x-model.number="actualTarget" @input="calcRateByTarget()"
                                   class="t-input text-4xl font-bold pl-8 h-14"
                                   :class="isValidTarget ? 'text-indigo-700 border-indigo-200 focus:border-indigo-600' : 'text-red-600 border-red-300 bg-red-50 focus:border-red-500'">
                            <span class="absolute right-4 top-5 text-sm text-gray-400 font-bold">万元</span>
                        </div>
                        <div class="mt-2 text-xs text-gray-500 flex justify-end gap-3" x-show="isValidTarget">
                            <span>同比去年：<span :class="actualTarget >= totalLastActual ? 'text-green-600' : 'text-red-500'" class="font-bold" x-text="((actualTarget - totalLastActual)/totalLastActual * 100).toFixed(1) + '%'"></span></span>
                            <span class="text-gray-300">|</span>
                            <span>较基准增加：<span class="font-bold text-blue-600" x-text="formatMoney(actualTarget - baseTarget)"></span> 万</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="t-card p-0 flex flex-col min-h-[500px]">
            
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                <div class="flex items-center gap-4">
                    <h3 class="text-sm font-bold text-gray-800 border-l-4 border-blue-600 pl-3">下属分支机构分解</h3>
                    
                    <div class="flex items-center gap-2 ml-4 border-l border-gray-300 pl-4">
                        <span class="text-xs text-gray-600">显示去年完成情况</span>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="history-toggle" x-model="showHistory" 
                                   class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 top-0 left-0"/>
                            <label for="history-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer transition-colors duration-300"></label>
                        </div>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button class="t-btn t-btn-default text-xs h-8" @click="distribute('avg')">
                        <i class="fa-solid fa-scale-balanced mr-1.5 text-gray-400"></i>平均分配
                    </button>
                    <button class="t-btn t-btn-default text-xs h-8" @click="distribute('ref')">
                        <i class="fa-solid fa-chart-pie mr-1.5 text-gray-400"></i>按去年权重分配
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-auto">
                <table class="w-full plan-table text-sm">
                    <thead>
                        <tr>
                            <th class="w-16 text-center">序号</th>
                            <th class="w-48">下级分支机构</th>
                            
                            <template x-if="showHistory">
                                <th class="w-32 text-right text-gray-500 font-normal bg-indigo-50/30">去年目标 (万)</th>
                            </template>
                            <template x-if="showHistory">
                                <th class="w-32 text-right text-gray-500 font-normal bg-indigo-50/30">去年完成 (万)</th>
                            </template>
                            <template x-if="showHistory">
                                <th class="w-24 text-right text-gray-500 font-normal bg-indigo-50/30">达成率</th>
                            </template>

                            <th class="w-48 text-right bg-blue-50 text-blue-700">分配目标 (万元)</th>
                            <th class="w-24 text-right">同比增长</th>
                            <th class="w-24 text-right">目标占比</th>
                            <th>备注</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700">
                        <template x-for="(comp, index) in companies" :key="comp.id">
                            <tr>
                                <td class="text-center text-gray-400" x-text="index + 1"></td>
                                <td class="font-bold text-gray-800" x-text="comp.name"></td>
                                
                                <template x-if="showHistory">
                                    <td class="text-right font-mono text-gray-400 text-xs bg-indigo-50/10" x-text="formatMoney(comp.lastYearTarget)"></td>
                                </template>
                                <template x-if="showHistory">
                                    <td class="text-right font-mono text-gray-600 text-xs bg-indigo-50/10" x-text="formatMoney(comp.lastYearActual)"></td>
                                </template>
                                <template x-if="showHistory">
                                    <td class="text-right font-mono text-xs bg-indigo-50/10" :class="comp.lastYearActual >= comp.lastYearTarget ? 'text-green-600' : 'text-orange-500'" x-text="((comp.lastYearActual/comp.lastYearTarget)*100).toFixed(0) + '%'"></td>
                                </template>

                                <td class="text-right p-0 relative border-l border-blue-100">
                                    <input type="number" x-model.number="comp.target" 
                                           class="w-full h-full text-right outline-none bg-transparent px-4 py-3 font-bold font-mono focus:bg-white focus:shadow-inner text-blue-700 hover:bg-blue-50/30 transition" 
                                           placeholder="0">
                                </td>
                                
                                <td class="text-right">
                                    <span class="text-xs px-1.5 rounded" 
                                          :class="getGrowthRate(comp) >= 0 ? 'text-green-600 bg-green-50' : 'text-red-500 bg-red-50'"
                                          x-text="getGrowthRate(comp) > 0 ? '+' + getGrowthRate(comp) + '%' : getGrowthRate(comp) + '%'">
                                    </span>
                                </td>
                                <td class="text-right text-xs text-gray-500" x-text="getShare(comp) + '%'"></td>
                                <td>
                                    <input type="text" x-model="comp.remark" class="w-full text-xs border-b border-transparent focus:border-gray-300 outline-none bg-transparent" placeholder="选填...">
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <div class="fixed bottom-0 left-0 right-0 footer-highlight z-40 h-20 flex items-center justify-center">
        <div class="max-w-[1400px] w-full px-6 flex justify-between items-center">
            
            <div class="flex items-center gap-8 flex-1 mr-12">
                <div class="flex-1 max-w-lg">
                    <div class="flex justify-between items-end mb-2">
                        <div class="text-sm font-medium text-gray-600">
                            已分配: <span class="font-bold text-gray-900 font-mono text-lg" x-text="formatMoney(allocatedTotal)"></span>
                        </div>
                        <div class="text-sm font-bold flex items-center gap-2" :class="balanceStatus.color">
                            <i class="fa-solid text-lg" :class="balanceStatus.icon"></i>
                            <span x-text="balanceStatus.text"></span>
                        </div>
                    </div>
                    <div class="progress-track w-full">
                        <div class="progress-bar" 
                             :class="balanceStatus.barColor"
                             :style="`width: ${Math.min((allocatedTotal / (actualTarget || 1)) * 100, 100)}%`"></div>
                    </div>
                </div>

                <div class="h-10 border-l border-gray-300 pl-6 flex flex-col justify-center min-w-[120px]">
                    <div x-show="diffAmount > 0" class="text-blue-600 text-xs">还需分配</div>
                    <div x-show="diffAmount < 0" class="text-red-500 text-xs">超出目标</div>
                    <div x-show="diffAmount !== 0" class="font-bold font-mono text-xl" 
                         :class="diffAmount > 0 ? 'text-blue-700' : 'text-red-600'"
                         x-text="formatMoney(Math.abs(diffAmount))">
                    </div>
                    <div x-show="diffAmount === 0" class="text-green-600 font-bold text-lg">完美匹配</div>
                </div>
            </div>

            <div class="flex items-center gap-6">
                <div class="text-right">
                    <div class="text-[10px] text-gray-400 font-sans uppercase tracking-wider">Internal Target</div>
                    <div class="text-2xl font-bold font-mono" :class="isValidTarget ? 'text-indigo-700' : 'text-red-500 line-through decoration-2'" x-text="formatMoney(actualTarget)"></div>
                </div>

                <div class="flex gap-3 pl-6 border-l border-gray-200">
                    <button class="t-btn t-btn-default w-32 h-10 text-base" @click="saveDraft()">保存草稿</button>
                    <button class="t-btn t-btn-primary w-32 h-10 text-base shadow-lg shadow-blue-200/50" 
                            @click="submitPlan()" 
                            :disabled="!isValid" 
                            :class="{'opacity-50 cursor-not-allowed': !isValid}">
                        <i class="fa-regular fa-paper-plane mr-2"></i> 提交
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function distributeApp() {
            return {
                // 目标设定逻辑
                baseTarget: 1000,   // 上级下达 (固定 1000万)
                floatRatio: 10.0,   // 默认上浮 10%
                actualTarget: 1100, // 初始目标 1100万
                
                showHistory: false,

                // 模拟华东区域下级分支机构数据 (2024年实际)
                // 补充了 lastYearTarget 字段以便计算总目标
                companies: [
                    { id: 1, name: '上海分公司', lastYearTarget: 330, lastYearActual: 350, target: 0, remark: '' },
                    { id: 2, name: '杭州分公司', lastYearTarget: 200, lastYearActual: 220, target: 0, remark: '' },
                    { id: 3, name: '南京分公司', lastYearTarget: 180, lastYearActual: 180, target: 0, remark: '' },
                    { id: 4, name: '苏州办事处', lastYearTarget: 140, lastYearActual: 150, target: 0, remark: '' },
                    { id: 5, name: '宁波办事处', lastYearTarget: 70, lastYearActual: 80, target: 0, remark: '' },
                    { id: 6, name: '无锡办事处', lastYearTarget: 60, lastYearActual: 50, target: 0, remark: '' },
                ],

                // 去年总实际 (自动汇总)
                get totalLastActual() {
                    return this.companies.reduce((sum, c) => sum + c.lastYearActual, 0);
                },
                
                // 去年总目标 (自动汇总)
                get totalLastTarget() {
                    return this.companies.reduce((sum, c) => sum + c.lastYearTarget, 0);
                },

                init() {
                    this.calcTargetByRatio();
                    this.distribute('ref'); // 默认按去年权重分配
                },

                // 校验：挑战目标是否 >= 基准值
                get isValidTarget() {
                    return this.actualTarget >= this.baseTarget;
                },

                // 快捷设置比例
                quickSetRate(rate) {
                    this.floatRatio = rate;
                    this.calcTargetByRatio();
                },

                // 逻辑 1: 比例 -> 目标
                calcTargetByRatio() {
                    const raw = this.baseTarget * (1 + Number(this.floatRatio) / 100);
                    this.actualTarget = Math.ceil(raw);
                },

                // 逻辑 2: 目标 -> 比例
                calcRateByTarget() {
                    if (this.actualTarget < 0) this.actualTarget = 0;
                    if (this.baseTarget === 0) return;
                    
                    const rawRatio = ((this.actualTarget - this.baseTarget) / this.baseTarget) * 100;
                    this.floatRatio = rawRatio.toFixed(1);
                },

                // 统计已分配
                get allocatedTotal() {
                    return this.companies.reduce((sum, c) => sum + (Number(c.target) || 0), 0);
                },

                get diffAmount() {
                    return this.actualTarget - this.allocatedTotal;
                },

                get balanceStatus() {
                    const diff = this.diffAmount;
                    if (diff === 0) return { text: '分配平衡', color: 'text-green-600', icon: 'fa-circle-check', barColor: 'bg-green-500' };
                    if (diff > 0) return { text: '仍需分配', color: 'text-blue-600', icon: 'fa-circle-half-stroke', barColor: 'bg-blue-600' };
                    return { text: '分配超额', color: 'text-red-500', icon: 'fa-circle-xmark', barColor: 'bg-red-500' };
                },

                // 整体校验：目标合法 且 分配平衡
                get isValid() {
                    return this.isValidTarget && this.diffAmount === 0;
                },

                distribute(mode) {
                    // 即使目标不合法(低于基准)，如果用户强制想看分配效果也可以，但提交会卡住
                    // 这里为了体验，若目标无效，暂不自动分配或重置
                    if (this.actualTarget <= 0) return; 

                    const total = this.actualTarget;
                    const count = this.companies.length;
                    let runningSum = 0;

                    if (mode === 'avg') {
                        const avg = Math.floor(total / count);
                        this.companies.forEach((c, i) => {
                            c.target = (i === count - 1) ? (total - runningSum) : avg;
                            runningSum += c.target;
                        });
                    } else if (mode === 'ref') {
                        const totalRef = this.totalLastActual;
                        if (totalRef === 0) return; 

                        this.companies.forEach((c, i) => {
                            if (i === count - 1) {
                                c.target = total - runningSum;
                            } else {
                                const ratio = c.lastYearActual / totalRef;
                                c.target = Math.floor(total * ratio);
                                runningSum += c.target;
                            }
                        });
                    }
                },

                getGrowthRate(comp) {
                    if (!comp.lastYearActual) return 100;
                    return Math.round(((comp.target - comp.lastYearActual) / comp.lastYearActual) * 100);
                },

                getShare(comp) {
                    if (this.actualTarget === 0) return 0;
                    return ((comp.target / this.actualTarget) * 100).toFixed(1);
                },

                formatMoney(num) {
                    return Number(num).toLocaleString('en-US');
                },

                saveDraft() {
                    alert('草稿已保存！');
                },

                confirmCancel() {
                    if(confirm('确定要退出吗？未保存的内容将丢失。')) {
                        history.back();
                    }
                },

                submitPlan() {
                    if (!this.isValid) return;
                    alert(`提交成功！\n华东区域挑战目标：${this.actualTarget}万元\n已全部分解至下级单位。`);
                }
            }
        }
    </script>
</body>
</html>
