<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>初始营销计划制定 (增强版)</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Inter', "PingFang SC", system-ui, sans-serif; background-color: #f2f3f5; font-size: 14px; color: #1d1d1f; }
        
        /* TDesign 风格组件 */
        .t-card { background: #fff; border-radius: 3px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e7e7e7; }
        
        .t-input {
            width: 100%; border: 1px solid #dcdcdc; border-radius: 3px; padding: 6px 12px;
            font-size: 14px; transition: all 0.2s; outline: none; background-color: #fff; height: 32px;
        }
        .t-input:hover:not(:disabled) { border-color: #0052D9; }
        .t-input:focus:not(:disabled) { border-color: #0052D9; box-shadow: 0 0 0 2px rgba(0, 82, 217, 0.1); }
        .t-input:disabled { background-color: #f7f7f7; color: #999; cursor: not-allowed; }

        .t-btn { display: inline-flex; align-items: center; justify-content: center; padding: 0 20px; border-radius: 3px; cursor: pointer; transition: all 0.2s; font-size: 14px; height: 36px; font-weight: 500; }
        .t-btn-primary { background: #0052D9; color: #fff; border: 1px solid #0052D9; }
        .t-btn-primary:hover { background: #003CAB; border-color: #003CAB; }
        .t-btn-default { background: #fff; border: 1px solid #dcdcdc; color: #333; }
        .t-btn-default:hover { border-color: #0052D9; color: #0052D9; }
        .t-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #e7e7e7; border-color: #e7e7e7; color: #999; }

        /* 表格样式 */
        .plan-table th { background-color: #f3f5f8; font-weight: 600; color: #444; padding: 10px 12px; border-bottom: 1px solid #e7e7e7; text-align: left; white-space: nowrap; }
        .plan-table td { padding: 8px 12px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
        .plan-table tr:hover { background-color: #f8faff; }
        
        /* 开关样式 */
        .toggle-checkbox:checked { right: 0; border-color: #0052D9; }
        .toggle-checkbox:checked + .toggle-label { background-color: #0052D9; }
        
        /* 选中态边框 */
        .radio-card { border: 1px solid #dcdcdc; cursor: pointer; transition: all 0.2s; }
        .radio-card.active { border-color: #0052D9; background-color: #f0f6ff; }
        .radio-card:hover:not(.active) { border-color: #bbb; }

        /* 底部栏强化样式 */
        .footer-highlight { background: #fff; border-top: 1px solid #e7e7e7; box-shadow: 0 -8px 30px rgba(0,0,0,0.08); }
        .progress-track { background: #f0f0f0; border-radius: 4px; height: 12px; overflow: hidden; }
        .progress-bar { height: 100%; transition: width 0.3s ease; border-radius: 4px; }
    </style>
</head>

<body class="pb-32" x-data="planApp()">

    <header class="bg-white border-b border-gray-200 px-6 py-4 sticky top-0 z-30 shadow-sm flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 text-white rounded flex items-center justify-center font-bold text-lg"><i class="fa-solid fa-flag"></i></div>
            <div>
                <h1 class="text-base font-bold text-gray-900">新建销售计划 (初始)</h1>
                <div class="text-xs text-gray-500">编制部门：集团营销中心</div>
            </div>
        </div>
        <button class="text-gray-500 hover:text-gray-800 text-sm" @click="confirmCancel()">
            <i class="fa-solid fa-xmark mr-1"></i>取消
        </button>
    </header>

    <main class="max-w-[1400px] mx-auto p-6 space-y-6">

        <div class="t-card p-6">
            <h3 class="text-sm font-bold text-gray-800 mb-4 border-l-4 border-blue-600 pl-3">基础信息设定</h3>
            
            <div class="grid grid-cols-3 gap-8 mb-6">
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1.5"><span class="text-red-500 mr-1">*</span>计划年度</label>
                    <div class="relative">
                        <select x-model="form.year" @change="updatePlanName" class="t-input appearance-none cursor-pointer">
                            <template x-for="y in yearOptions" :key="y">
                                <option :value="y" x-text="y + '年'"></option>
                            </template>
                        </select>
                        <i class="fa-solid fa-calendar-days absolute right-3 top-2.5 text-gray-400 pointer-events-none"></i>
                    </div>
                </div>

                <div class="col-span-2">
                    <label class="block text-xs font-medium text-gray-500 mb-1.5"><span class="text-red-500 mr-1">*</span>计划名称</label>
                    <input type="text" x-model="form.name" @input="isNameEdited = true" class="t-input" placeholder="请输入计划名称">
                </div>
            </div>

            <div>
                <label class="block text-xs font-medium text-gray-500 mb-1.5">计划备注</label>
                <textarea x-model="form.remark" class="t-input h-20 py-2 resize-none" placeholder="请输入关于本计划的说明、制定依据或特殊情况备注..."></textarea>
            </div>
        </div>

        <div class="t-card p-6 relative overflow-hidden">
            <h3 class="text-sm font-bold text-gray-800 mb-6 border-l-4 border-blue-600 pl-3">年度总目标设定</h3>

            <div class="bg-blue-50/50 border border-blue-100 rounded-lg p-6">
                
                <div class="flex items-center gap-4 mb-6">
                    <span class="text-xs font-bold text-gray-600">参考基准：</span>
                    
                    <div @click="changeRefType('actual')" 
                         class="radio-card px-4 py-2 rounded bg-white flex items-center gap-3 w-64"
                         :class="refType === 'actual' ? 'active' : ''">
                        <div class="w-4 h-4 rounded-full border flex items-center justify-center"
                             :class="refType === 'actual' ? 'border-blue-600' : 'border-gray-300'">
                            <div class="w-2 h-2 rounded-full bg-blue-600" x-show="refType === 'actual'"></div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500">去年实际完成</div>
                            <div class="font-bold font-mono text-gray-800" x-text="formatMoney(totalLastActual)"></div>
                        </div>
                    </div>

                    <div @click="changeRefType('target')" 
                         class="radio-card px-4 py-2 rounded bg-white flex items-center gap-3 w-64"
                         :class="refType === 'target' ? 'active' : ''">
                        <div class="w-4 h-4 rounded-full border flex items-center justify-center"
                             :class="refType === 'target' ? 'border-blue-600' : 'border-gray-300'">
                            <div class="w-2 h-2 rounded-full bg-blue-600" x-show="refType === 'target'"></div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500">去年计划目标</div>
                            <div class="font-bold font-mono text-gray-800" x-text="formatMoney(totalLastTarget)"></div>
                        </div>
                    </div>
                </div>

                <div class="flex items-start gap-4">
                    
                    <div class="flex-1 max-w-xs">
                        <label class="block text-xs font-medium text-gray-500 mb-1.5">预期增长率</label>
                        <div class="relative group">
                            <input type="number" x-model.number="growthRate" @input="calcTargetByRate()" step="0.5"
                                   class="t-input text-xl font-bold text-blue-600 border-blue-200 focus:border-blue-600 h-12 pr-8 transition">
                            <span class="absolute right-3 top-4 text-xs text-blue-400 font-bold">%</span>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button @click="quickSetRate(5)" class="text-[10px] bg-white border border-gray-200 px-2 py-0.5 rounded hover:border-blue-500 text-gray-600">+5%</button>
                            <button @click="quickSetRate(10)" class="text-[10px] bg-white border border-gray-200 px-2 py-0.5 rounded hover:border-blue-500 text-gray-600">+10%</button>
                            <button @click="quickSetRate(20)" class="text-[10px] bg-white border border-gray-200 px-2 py-0.5 rounded hover:border-blue-500 text-gray-600">+20%</button>
                        </div>
                    </div>

                    <div class="pt-9 text-gray-300"><i class="fa-solid fa-arrow-right-long"></i></div>

                    <div class="flex-1">
                        <label class="block text-xs font-medium text-gray-500 mb-1.5 flex justify-between">
                            <span>本年度设定总目标</span>
                            <span class="text-[10px] text-gray-400 font-normal">直接输入数值可反算增长率</span>
                        </label>
                        <div class="relative">
                            <span class="absolute left-4 top-4 text-gray-400 text-sm">¥</span>
                            <input type="number" x-model.number="actualTarget" @input="calcRateByTarget()"
                                   class="t-input text-3xl font-bold pl-8 h-12 border-blue-500 bg-white shadow-sm text-gray-900 focus:ring-4 ring-blue-50/50">
                            <span class="absolute right-4 top-4 text-xs text-gray-400 font-bold">万元</span>
                        </div>
                        <div class="mt-2 text-xs text-gray-500 flex items-center gap-1" x-show="actualTarget > 0">
                            <i class="fa-solid fa-circle-info text-blue-500"></i>
                            <span>相当于去年实际完成的 <span class="font-bold text-gray-800" x-text="((actualTarget/totalLastActual)*100).toFixed(1) + '%'"></span></span>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="t-card p-0 flex flex-col min-h-[500px]">
            
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                <div class="flex items-center gap-4">
                    <h3 class="text-sm font-bold text-gray-800 border-l-4 border-blue-600 pl-3">下级机构目标分解</h3>
                    
                    <div class="flex items-center gap-2 ml-4 border-l border-gray-300 pl-4">
                        <span class="text-xs text-gray-600">显示历史数据</span>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="history-toggle" x-model="showHistory" 
                                   class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 top-0 left-0"/>
                            <label for="history-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer transition-colors duration-300"></label>
                        </div>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button class="t-btn t-btn-default text-xs h-8" @click="distribute('avg')">
                        <i class="fa-solid fa-scale-balanced mr-1.5 text-gray-400"></i>平均分配
                    </button>
                    <button class="t-btn t-btn-default text-xs h-8" @click="distribute('ref')">
                        <i class="fa-solid fa-chart-pie mr-1.5 text-gray-400"></i>按去年占比分配
                    </button>
                </div>
            </div>

            <div x-show="showHistory" x-transition class="px-6 py-3 bg-indigo-50 border-b border-indigo-100 flex items-center gap-8 text-sm text-indigo-900">
                <div class="font-bold"><i class="fa-solid fa-clock-rotate-left mr-2"></i>去年整体经营概况</div>
                <div class="flex gap-6 text-xs">
                    <div>目标：<span class="font-mono font-bold" x-text="formatMoney(totalLastTarget)"></span> 万</div>
                    <div>实际：<span class="font-mono font-bold" x-text="formatMoney(totalLastActual)"></span> 万</div>
                    <div>达成率：<span class="font-mono font-bold" :class="totalLastActual >= totalLastTarget ? 'text-green-600' : 'text-orange-600'" x-text="((totalLastActual/totalLastTarget)*100).toFixed(1) + '%'"></span></div>
                </div>
            </div>

            <div class="flex-1 overflow-auto">
                <table class="w-full plan-table text-sm">
                    <thead>
                        <tr>
                            <th class="w-16 text-center">序号</th>
                            <th class="w-48">下级机构</th>
                            
                            <template x-if="showHistory">
                                <th class="w-32 text-right text-gray-500 font-normal bg-indigo-50/30">去年目标</th>
                            </template>
                            <template x-if="showHistory">
                                <th class="w-32 text-right text-gray-500 font-normal bg-indigo-50/30">去年完成</th>
                            </template>
                            <template x-if="showHistory">
                                <th class="w-24 text-right text-gray-500 font-normal bg-indigo-50/30">达成率</th>
                            </template>

                            <th class="w-48 text-right bg-blue-50 text-blue-700">今年目标 (万元)</th>
                            <th class="w-24 text-right">同比增长</th>
                            <th class="w-24 text-right">占比</th>
                            <th>备注</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700">
                        <template x-for="(comp, index) in companies" :key="comp.id">
                            <tr>
                                <td class="text-center text-gray-400" x-text="index + 1"></td>
                                <td class="font-bold" x-text="comp.name"></td>
                                
                                <template x-if="showHistory">
                                    <td class="text-right font-mono text-gray-400 text-xs bg-indigo-50/10" x-text="formatMoney(comp.lastYearTarget)"></td>
                                </template>
                                <template x-if="showHistory">
                                    <td class="text-right font-mono text-gray-600 text-xs bg-indigo-50/10" x-text="formatMoney(comp.lastYearActual)"></td>
                                </template>
                                <template x-if="showHistory">
                                    <td class="text-right font-mono text-xs bg-indigo-50/10">
                                        <span :class="comp.lastYearActual >= comp.lastYearTarget ? 'text-green-600' : 'text-orange-500'" 
                                              x-text="((comp.lastYearActual/comp.lastYearTarget)*100).toFixed(1) + '%'"></span>
                                    </td>
                                </template>

                                <td class="text-right p-0 relative border-l border-blue-100">
                                    <input type="number" x-model.number="comp.target" 
                                           class="w-full h-full text-right outline-none bg-transparent px-4 py-3 font-bold font-mono focus:bg-white focus:shadow-inner text-blue-700 hover:bg-blue-50/30 transition" 
                                           placeholder="0">
                                </td>
                                
                                <td class="text-right">
                                    <span class="text-xs px-1.5 rounded" 
                                          :class="getGrowthRate(comp) >= 0 ? 'text-green-600 bg-green-50' : 'text-red-500 bg-red-50'"
                                          x-text="getGrowthRate(comp) + '%'">
                                    </span>
                                </td>
                                <td class="text-right text-xs text-gray-500" x-text="getShare(comp) + '%'"></td>
                                <td>
                                    <input type="text" x-model="comp.remark" class="w-full text-xs border-b border-transparent focus:border-gray-300 outline-none bg-transparent" placeholder="添加备注...">
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <div class="fixed bottom-0 left-0 right-0 footer-highlight z-40 h-20 flex items-center justify-center">
        <div class="max-w-[1400px] w-full px-6 flex justify-between items-center">
            
            <div class="flex items-center gap-8 flex-1 mr-12">
                <div class="flex-1 max-w-lg">
                    <div class="flex justify-between items-end mb-2">
                        <div class="text-sm font-medium text-gray-600">
                            已分配: <span class="font-bold text-gray-900 font-mono text-lg" x-text="formatMoney(allocatedTotal)"></span>
                        </div>
                        <div class="text-sm font-bold flex items-center gap-2" :class="balanceStatus.color">
                            <i class="fa-solid text-lg" :class="balanceStatus.icon"></i>
                            <span x-text="balanceStatus.text"></span>
                        </div>
                    </div>
                    <div class="progress-track w-full">
                        <div class="progress-bar" 
                             :class="balanceStatus.barColor"
                             :style="`width: ${Math.min((allocatedTotal / (actualTarget || 1)) * 100, 100)}%`"></div>
                    </div>
                </div>

                <div class="h-10 border-l border-gray-300 pl-6 flex flex-col justify-center">
                    <div x-show="diffAmount > 0" class="text-blue-600 text-xs">还需分配</div>
                    <div x-show="diffAmount < 0" class="text-red-500 text-xs">超出目标</div>
                    <div x-show="diffAmount !== 0" class="font-bold font-mono text-xl" 
                         :class="diffAmount > 0 ? 'text-blue-700' : 'text-red-600'"
                         x-text="formatMoney(Math.abs(diffAmount))">
                    </div>
                    <div x-show="diffAmount === 0" class="text-green-600 font-bold text-lg">完美匹配</div>
                </div>
            </div>

            <div class="flex items-center gap-6">
                <div class="text-right">
                    <div class="text-[10px] text-gray-400 font-sans uppercase tracking-wider">Plan Total Target</div>
                    <div class="text-2xl font-bold text-gray-900 font-mono" x-text="formatMoney(actualTarget)"></div>
                </div>

                <div class="flex gap-3 pl-6 border-l border-gray-200">
                    <button class="t-btn t-btn-default w-32 h-10 text-base" @click="saveDraft()">保存草稿</button>
                    <button class="t-btn t-btn-primary w-32 h-10 text-base shadow-lg shadow-blue-200/50" 
                            @click="submitPlan()" 
                            :disabled="!isValid" 
                            :class="{'opacity-50 cursor-not-allowed': !isValid}">
                        <i class="fa-regular fa-paper-plane mr-2"></i> 提交
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function planApp() {
            const currentYear = new Date().getFullYear();
            
            return {
                // 表单数据
                form: {
                    year: currentYear,
                    name: `${currentYear}年度销售计划`,
                    remark: ''
                },
                isNameEdited: false, 
                yearOptions: [], 

                // 目标设定逻辑
                refType: 'actual', // 'actual' | 'target'
                growthRate: 10.0,  
                actualTarget: 0, 
                
                showHistory: false,

                // 模拟数据 (自动汇总计算总量)
                companies: [
                    { id: 1, name: '华东区域分公司', lastYearTarget: 1100, lastYearActual: 1200, target: 0, remark: '' },
                    { id: 2, name: '华北区域分公司', lastYearTarget: 1000, lastYearActual: 980, target: 0, remark: '' },
                    { id: 3, name: '华南区域分公司', lastYearTarget: 1400, lastYearActual: 1500, target: 0, remark: '' },
                    { id: 4, name: '西南区域分公司', lastYearTarget: 500, lastYearActual: 600, target: 0, remark: '' },
                    { id: 5, name: '海外业务部', lastYearTarget: 400, lastYearActual: 300, target: 0, remark: '' },
                    { id: 6, name: '大客户事业部', lastYearTarget: 700, lastYearActual: 800, target: 0, remark: '' },
                ],

                // 动态计算去年的总数
                get totalLastTarget() {
                    return this.companies.reduce((sum, c) => sum + c.lastYearTarget, 0);
                },
                get totalLastActual() {
                    return this.companies.reduce((sum, c) => sum + c.lastYearActual, 0);
                },
                
                // 获取当前选中的基准值
                get currentBaseVal() {
                    return this.refType === 'actual' ? this.totalLastActual : this.totalLastTarget;
                },

                init() {
                    // 初始化年份选项
                    for(let i=0; i<6; i++) {
                        this.yearOptions.push(currentYear + i);
                    }
                    
                    // 初始化计算
                    this.calcTargetByRate();
                    this.distribute('ref'); 
                },

                updatePlanName() {
                    if (!this.isNameEdited) {
                        this.form.name = `${this.form.year}年度销售计划`;
                    }
                },

                // 切换基准类型
                changeRefType(type) {
                    this.refType = type;
                    this.calcTargetByRate(); // 切换基准后，保持增长率不变，重算目标
                },

                // 快捷设置比例
                quickSetRate(rate) {
                    this.growthRate = rate;
                    this.calcTargetByRate();
                },

                // 逻辑 1: 比例 -> 目标
                calcTargetByRate() {
                    const base = this.currentBaseVal;
                    const raw = base * (1 + Number(this.growthRate) / 100);
                    this.actualTarget = Math.ceil(raw);
                },

                // 逻辑 2: 目标 -> 比例
                calcRateByTarget() {
                    const base = this.currentBaseVal;
                    if (this.actualTarget < 0) this.actualTarget = 0;
                    if (base === 0) return;
                    
                    const rawRatio = ((this.actualTarget - base) / base) * 100;
                    this.growthRate = rawRatio.toFixed(1);
                },

                // 统计已分配
                get allocatedTotal() {
                    return this.companies.reduce((sum, c) => sum + (Number(c.target) || 0), 0);
                },

                get diffAmount() {
                    return this.actualTarget - this.allocatedTotal;
                },

                get balanceStatus() {
                    const diff = this.diffAmount;
                    if (diff === 0) return { text: '已平衡', color: 'text-green-600', icon: 'fa-circle-check', barColor: 'bg-green-500' };
                    if (diff > 0) return { text: '未分配完', color: 'text-blue-600', icon: 'fa-circle-half-stroke', barColor: 'bg-blue-600' };
                    return { text: '分配超额', color: 'text-red-500', icon: 'fa-circle-xmark', barColor: 'bg-red-500' };
                },

                get isValid() {
                    return this.actualTarget > 0 && this.diffAmount === 0 && this.form.name;
                },

                distribute(mode) {
                    if (this.actualTarget <= 0) return; 

                    const total = this.actualTarget;
                    const count = this.companies.length;
                    let runningSum = 0;

                    if (mode === 'avg') {
                        const avg = Math.floor(total / count);
                        this.companies.forEach((c, i) => {
                            c.target = (i === count - 1) ? (total - runningSum) : avg;
                            runningSum += c.target;
                        });
                    } else if (mode === 'ref') {
                        // 按去年完成占比分配
                        const totalRef = this.totalLastActual;
                        if (totalRef === 0) return; 

                        this.companies.forEach((c, i) => {
                            if (i === count - 1) {
                                c.target = total - runningSum;
                            } else {
                                const ratio = c.lastYearActual / totalRef;
                                c.target = Math.floor(total * ratio);
                                runningSum += c.target;
                            }
                        });
                    }
                },

                getGrowthRate(comp) {
                    if (!comp.lastYearActual) return 100;
                    return Math.round(((comp.target - comp.lastYearActual) / comp.lastYearActual) * 100);
                },

                getShare(comp) {
                    if (this.actualTarget === 0) return 0;
                    return ((comp.target / this.actualTarget) * 100).toFixed(1);
                },

                formatMoney(num) {
                    return Number(num).toLocaleString('en-US');
                },

                saveDraft() {
                    alert('已保存草稿！');
                },

                confirmCancel() {
                    if(confirm('确定要取消编辑吗？未保存的内容将丢失。')) {
                        history.back();
                    }
                },

                submitPlan() {
                    if (!this.isValid) return;
                    alert(`【${this.form.name}】提交成功！\n年度总目标：${this.actualTarget}万元`);
                }
            }
        }
    </script>
</body>
</html>
