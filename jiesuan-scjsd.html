<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>结算单生成 - 多维筛选版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Inter', -apple-system, "Segoe UI", Roboto, sans-serif; background-color: #f8fafc; color: #334155; font-size: 13px; }
        
        /* === 字体规范严格执行 === */
        .text-13 { font-size: 13px !important; line-height: 1.5; }
        .text-12 { font-size: 12px !important; } /* 仅用于极其次要的标签 */
        
        /* 数字字体优化：最小14px，加粗，等宽 */
        .font-num { font-family: 'Menlo', 'Monaco', 'Consolas', monospace; font-weight: 600; font-size: 14px; letter-spacing: -0.02em; }
        .font-num-lg { font-size: 15px; }
        .font-num-xl { font-size: 18px; }
        .font-num-2xl { font-size: 26px; }

        /* === 滚动条美化 === */
        .custom-scroll::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }

        /* === 表格数字对齐 === */
        .num-cell { text-align: right; font-family: 'Menlo', monospace; font-size: 14px; }
        
        /* === 底部阴影 === */
        .footer-shadow { box-shadow: 0 -4px 10px -2px rgba(0, 0, 0, 0.05); }

        /* === 输入框聚焦效果 === */
        .input-focus:focus { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden" x-data="settlementApp()">

    <header class="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-6 shrink-0 z-20 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-indigo-600 rounded flex items-center justify-center text-white shadow-sm">
                <i class="fa-solid fa-file-invoice-dollar text-sm"></i>
            </div>
            <div>
                <h1 class="font-bold text-base text-slate-800">费用结算单生成</h1>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-13 text-slate-500 bg-slate-50 px-3 py-1 rounded-full border border-slate-200 flex items-center gap-2 transition-all"
                 :class="{'bg-indigo-50 border-indigo-100': currentContract}">
                <span class="w-1.5 h-1.5 rounded-full" :class="currentContract ? 'bg-indigo-500 animate-pulse' : 'bg-slate-300'"></span>
                <span>当前锁定：</span>
                <span class="font-bold text-indigo-700 font-num" x-text="currentContract ? currentContract.code : '无'"></span>
            </div>
            
            <button @click="resetSelection" x-show="selectedIds.length > 0" class="text-13 text-slate-500 hover:text-rose-600 transition flex items-center gap-1">
                <i class="fa-solid fa-trash-can"></i> 清空已选
            </button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        
        <aside class="w-[400px] bg-white border-r border-slate-200 flex flex-col shrink-0 overflow-hidden z-10">
            
            <div class="p-4 border-b border-slate-200 bg-slate-50/50 shrink-0 space-y-3">
                <div class="flex justify-between items-center">
                    <span class="font-bold text-slate-700 text-13"><i class="fa-solid fa-filter text-indigo-500 mr-1.5"></i>筛选条件</span>
                    <button @click="resetFilters" class="text-xs text-slate-400 hover:text-indigo-600 transition">重置条件</button>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <div class="col-span-2 relative">
                        <i class="fa-regular fa-building absolute left-2.5 top-2.5 text-slate-400 text-xs"></i>
                        <input type="text" x-model="filters.customer" placeholder="输入客户名称..." 
                               class="w-full bg-white border border-slate-300 rounded pl-8 pr-2 py-2 text-13 input-focus outline-none transition">
                    </div>
                    
                    <div class="relative">
                        <input type="text" x-model="filters.contractCode" placeholder="合同号" 
                               class="w-full bg-white border border-slate-300 rounded px-2 py-2 text-13 input-focus outline-none transition font-num text-xs">
                    </div>
                    <div class="relative">
                        <input type="text" x-model="filters.quoteCode" placeholder="报价单号" 
                               class="w-full bg-white border border-slate-300 rounded px-2 py-2 text-13 input-focus outline-none transition font-num text-xs">
                    </div>
                    <div class="relative">
                        <input type="text" x-model="filters.orderCode" placeholder="委托单号" 
                               class="w-full bg-white border border-slate-300 rounded px-2 py-2 text-13 input-focus outline-none transition font-num text-xs">
                    </div>
                    <div class="relative">
                        <input type="text" x-model="filters.regCode" placeholder="登记号(样品)" 
                               class="w-full bg-white border border-slate-300 rounded px-2 py-2 text-13 input-focus outline-none transition font-num text-xs">
                    </div>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scroll p-3 space-y-3 bg-slate-50/30">
                <template x-for="contract in filteredData" :key="contract.id">
                    <div class="bg-white border border-slate-200 rounded-lg shadow-sm transition-all duration-200 group"
                         :class="{'opacity-50 grayscale pointer-events-none bg-slate-100': isContractDisabled(contract.id), 'ring-1 ring-indigo-500': currentContract?.id === contract.id}">
                        
                        <div class="px-3 py-3 border-b border-slate-100 flex items-start gap-2 cursor-pointer hover:bg-slate-50"
                             @click="toggleExpand(contract.id)">
                            <div class="mt-0.5 text-slate-400">
                                <i class="fa-solid text-xs transition-transform duration-200" 
                                   :class="expandedIds.includes(contract.id) ? 'fa-caret-down' : 'fa-caret-right'"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-slate-700 text-13 truncate" x-text="contract.name"></span>
                                    <span class="text-[10px] px-1.5 rounded border border-indigo-100 bg-indigo-50 text-indigo-600">合同</span>
                                </div>
                                <div class="text-13 text-slate-500 mt-1 truncate flex items-center gap-1">
                                    <i class="fa-regular fa-building text-xs scale-90"></i>
                                    <span x-text="contract.customer"></span>
                                </div>
                                <div class="text-13 text-slate-400 mt-0.5 font-num" x-text="contract.code"></div>
                            </div>
                        </div>

                        <div x-show="expandedIds.includes(contract.id)" x-collapse>
                            <template x-for="quote in contract.quotes" :key="quote.id">
                                <div class="border-l-2 border-indigo-100 ml-3 pl-2 py-2">
                                    <div class="flex items-center gap-2 mb-2 cursor-pointer hover:text-indigo-600 transition" @click="toggleExpand(quote.id)">
                                        <i class="fa-solid fa-file-invoice text-slate-400 text-xs"></i>
                                        <div class="flex-1 min-w-0">
                                            <div class="text-13 font-bold text-slate-600 truncate" x-text="quote.subject"></div>
                                            <div class="text-[11px] text-slate-400 font-num" x-text="quote.code"></div>
                                        </div>
                                        <i class="fa-solid text-[10px] text-slate-300 mr-2" :class="expandedIds.includes(quote.id) ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
                                    </div>

                                    <div x-show="expandedIds.includes(quote.id)" x-collapse class="ml-2 space-y-2">
                                        <template x-for="order in quote.orders" :key="order.id">
                                            <div class="bg-slate-50 rounded p-2 border border-slate-100">
                                                <div class="flex items-center gap-2 mb-2 text-slate-500 pb-1 border-b border-slate-200/50">
                                                    <i class="fa-solid fa-list-ol text-xs"></i>
                                                    <span class="text-13 font-num font-bold" x-text="order.code"></span>
                                                </div>

                                                <div class="space-y-1">
                                                    <template x-for="sample in order.samples" :key="sample.id">
                                                        <div @click="toggleSample(sample, contract)"
                                                             class="flex items-center gap-3 px-2 py-1.5 rounded cursor-pointer transition select-none border border-transparent"
                                                             :class="isSelected(sample.id) ? 'bg-indigo-50 border-indigo-200' : 'hover:bg-white hover:shadow-sm hover:border-slate-200'">
                                                            
                                                            <div class="w-3.5 h-3.5 rounded border flex items-center justify-center transition-colors shrink-0"
                                                                 :class="isSelected(sample.id) ? 'bg-indigo-600 border-indigo-600' : 'border-slate-300 bg-white'">
                                                                <i class="fa-solid fa-check text-white text-[10px]" x-show="isSelected(sample.id)"></i>
                                                            </div>
                                                            
                                                            <div class="flex-1 min-w-0">
                                                                <div class="text-13 font-medium truncate" 
                                                                     :class="isSelected(sample.id) ? 'text-indigo-700' : 'text-slate-700'" 
                                                                     x-text="sample.name"></div>
                                                                <div class="text-13 text-slate-400 font-num mt-0.5" x-text="sample.regCode"></div>
                                                            </div>
                                                            
                                                            <div class="font-num text-slate-400 text-13">¥<span x-text="sample.testFee"></span></div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
                
                <div x-show="filteredData.length === 0" class="flex flex-col items-center justify-center py-12 text-slate-400">
                    <i class="fa-solid fa-magnifying-glass-minus text-2xl mb-2 text-slate-300"></i>
                    <p class="text-13">未匹配到任何数据</p>
                </div>
            </div>
        </aside>

        <section class="flex-1 flex flex-col min-w-0 bg-slate-50 relative">
            
            <div class="px-6 py-3 bg-white border-b border-slate-200 shrink-0 flex justify-between items-center h-14">
                <h2 class="text-sm font-bold text-slate-800 flex items-center gap-2">
                    费用明细列表
                    <span class="text-13 font-normal text-white bg-slate-400 px-2 py-0.5 rounded-full font-num" x-show="selectedIds.length > 0" x-text="selectedIds.length"></span>
                </h2>
                <div class="text-13 text-slate-400 flex items-center gap-1">
                    <i class="fa-regular fa-lightbulb text-yellow-500"></i> 折扣仅对检测费生效
                </div>
            </div>

            <div class="flex-1 overflow-auto p-5 custom-scroll pb-44"> 
                <div class="bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden min-h-[300px]">
                    <table class="w-full text-left text-13">
                        <thead class="bg-slate-50 text-slate-500 font-semibold border-b border-slate-200 whitespace-nowrap">
                            <tr>
                                <th class="px-4 py-3 w-12 text-center font-num">#</th>
                                <th class="px-4 py-3 min-w-[200px]">样品信息 (登记号/名称)</th>
                                <th class="px-3 py-3 num-cell bg-indigo-50/30 text-indigo-600 border-l border-indigo-50">检测费</th>
                                <th class="px-3 py-3 num-cell text-slate-400">加急</th>
                                <th class="px-3 py-3 num-cell text-slate-400">交通</th>
                                <th class="px-3 py-3 num-cell text-slate-400">修理</th>
                                <th class="px-3 py-3 num-cell text-slate-400">材料</th>
                                <th class="px-3 py-3 num-cell text-slate-400">其它</th>
                                <th class="px-4 py-3 num-cell font-bold text-slate-700 bg-slate-50 border-l border-slate-100">应收合计</th>
                                <th class="px-4 py-3 num-cell font-bold text-emerald-600 bg-emerald-50/30 border-l border-emerald-100 w-32">实收合计</th>
                                <th class="px-3 py-3 w-12 text-center"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <template x-for="(item, index) in selectedRows" :key="item.id">
                                <tr class="hover:bg-slate-50 group transition">
                                    <td class="px-4 py-3 text-center text-slate-300 font-num" x-text="index + 1"></td>
                                    <td class="px-4 py-3">
                                        <div class="flex flex-col">
                                            <span class="font-bold text-slate-700 truncate w-56 text-13" :title="item.name" x-text="item.name"></span>
                                            <span class="text-13 text-slate-400 font-num" x-text="item.regCode"></span>
                                        </div>
                                    </td>
                                    
                                    <td class="px-3 py-3 num-cell font-medium text-indigo-600 bg-indigo-50/10 border-l border-indigo-50 font-num" x-text="formatMoney(item.testFee)"></td>
                                    <td class="px-3 py-3 num-cell text-slate-500 font-num" x-text="item.expediteFee || '-'"></td>
                                    <td class="px-3 py-3 num-cell text-slate-500 font-num" x-text="item.transportFee || '-'"></td>
                                    <td class="px-3 py-3 num-cell text-slate-500 font-num" x-text="item.repairFee || '-'"></td>
                                    <td class="px-3 py-3 num-cell text-slate-500 font-num" x-text="item.materialFee || '-'"></td>
                                    <td class="px-3 py-3 num-cell text-slate-500 font-num" x-text="item.otherFee || '-'"></td>
                                    
                                    <td class="px-4 py-3 num-cell font-bold text-slate-600 bg-slate-50 border-l border-slate-100 font-num" x-text="formatMoney(calculateRowReceivable(item))"></td>
                                    <td class="px-4 py-3 num-cell font-bold text-emerald-600 bg-emerald-50/30 border-l border-emerald-100 font-num" x-text="formatMoney(calculateRowActual(item))"></td>
                                    
                                    <td class="px-3 py-3 text-center">
                                        <button @click="toggleSample(item, currentContract)" class="text-slate-300 hover:text-rose-500 transition w-6 h-6 rounded hover:bg-rose-50 flex items-center justify-center">
                                            <i class="fa-solid fa-xmark"></i>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                            
                            <tr x-show="selectedRows.length === 0">
                                <td colspan="11" class="py-24 text-center text-slate-400 bg-slate-50/30">
                                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 mb-4">
                                        <i class="fa-solid fa-calculator text-2xl text-slate-300"></i>
                                    </div>
                                    <p class="text-13 font-medium">请从左侧选择需要结算的样品</p>
                                </td>
                            </tr>
                        </tbody>
                        
                        <tfoot class="bg-slate-50 font-bold border-t border-slate-200 shadow-inner" x-show="selectedRows.length > 0">
                            <tr>
                                <td colspan="2" class="px-4 py-3 text-right text-13 text-slate-500">本页合计：</td>
                                <td class="px-3 py-3 num-cell font-num text-slate-600 border-l border-slate-200" x-text="formatMoney(totalTestFee)"></td>
                                <td class="px-3 py-3 num-cell font-num text-slate-500" x-text="formatMoney(totalExpediteFee)"></td>
                                <td class="px-3 py-3 num-cell font-num text-slate-500" x-text="formatMoney(totalTransportFee)"></td>
                                <td class="px-3 py-3 num-cell font-num text-slate-500" x-text="formatMoney(totalRepairFee)"></td>
                                <td class="px-3 py-3 num-cell font-num text-slate-500" x-text="formatMoney(totalMaterialFee)"></td>
                                <td class="px-3 py-3 num-cell font-num text-slate-500" x-text="formatMoney(totalOtherFee)"></td>
                                <td class="px-4 py-3 num-cell text-slate-800 font-num-lg border-l border-slate-200" x-text="formatMoney(totalReceivable)"></td>
                                <td class="px-4 py-3 num-cell text-emerald-600 font-num-lg bg-emerald-50/50 border-l border-emerald-100" x-text="formatMoney(finalTotalAmount)"></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <div class="absolute bottom-0 left-0 right-0 bg-white border-t border-slate-200 footer-shadow z-30 transition-transform duration-300"
                 :class="selectedIds.length === 0 ? 'translate-y-full' : 'translate-y-0'">
                
                <div class="px-6 py-2.5 bg-slate-50 border-b border-slate-100 flex gap-8 text-13 text-slate-500 overflow-x-auto whitespace-nowrap">
                    <span class="flex items-center gap-2">检测费：<b class="font-num text-indigo-600" x-text="formatMoney(totalTestFee)"></b></span>
                    <span class="w-px h-3 bg-slate-300"></span>
                    <span>加急：<b class="font-num" x-text="formatMoney(totalExpediteFee)"></b></span>
                    <span>交通：<b class="font-num" x-text="formatMoney(totalTransportFee)"></b></span>
                    <span>修理：<b class="font-num" x-text="formatMoney(totalRepairFee)"></b></span>
                    <span>材料：<b class="font-num" x-text="formatMoney(totalMaterialFee)"></b></span>
                    <span>其它：<b class="font-num" x-text="formatMoney(totalOtherFee)"></b></span>
                    <span class="ml-auto text-slate-400">应收总计：<b class="font-num text-slate-600 text-sm" x-text="formatMoney(totalReceivable)"></b></span>
                </div>

                <div class="px-8 py-5 flex items-center justify-between">
                    
                    <div class="flex items-center gap-8">
                        
                        <div class="flex flex-col">
                            <label class="text-13 text-slate-400 font-bold uppercase mb-1">折扣率</label>
                            <div class="relative flex items-center group">
                                <input type="number" x-model="globalDiscount" @input="updateFromDiscount" 
                                       class="font-num-xl font-bold text-indigo-600 border-b-2 border-indigo-200 focus:border-indigo-600 outline-none w-24 text-center bg-transparent transition py-1 group-hover:border-indigo-300"
                                       min="0" max="100" step="1">
                                <span class="text-sm font-bold text-indigo-400 ml-1 mb-1">%</span>
                            </div>
                            <div class="text-13 text-slate-400 mt-1">* 仅检测费</div>
                        </div>

                        <div class="text-slate-300 text-xl pb-4"><i class="fa-solid fa-arrow-right-arrow-left"></i></div>

                        <div class="flex flex-col">
                            <label class="text-13 text-slate-400 font-bold uppercase mb-1">实收总金额</label>
                            <div class="relative flex items-center group">
                                <span class="text-xl font-bold text-emerald-600 mr-2 mb-1">¥</span>
                                <input type="number" x-model="finalTotalAmount" @input="updateFromTotal"
                                       class="font-num-2xl font-bold text-emerald-600 border-b-2 border-emerald-200 focus:border-emerald-600 outline-none w-48 text-left bg-transparent transition py-1 group-hover:border-emerald-300"
                                       step="0.01">
                            </div>
                            <div class="text-13 text-slate-400 mt-1">含杂费</div>
                        </div>
                    </div>

                    <div class="flex items-center gap-4">
                        <button class="px-6 py-2.5 rounded-lg border border-slate-300 text-slate-600 font-medium hover:bg-slate-50 transition text-13">取消</button>
                        <button class="px-8 py-2.5 rounded-lg bg-indigo-600 text-white font-bold shadow-lg hover:bg-indigo-700 hover:shadow-xl transition transform active:scale-95 flex items-center gap-2 text-sm">
                            <i class="fa-solid fa-file-invoice"></i> 生成结算单
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        function settlementApp() {
            return {
                filters: {
                    customer: '',
                    contractCode: '',
                    quoteCode: '',
                    orderCode: '',
                    regCode: ''
                },
                
                contracts: [],
                expandedIds: [],
                selectedIds: [],
                currentContract: null,
                
                globalDiscount: 100,
                finalTotalAmount: 0,

                init() {
                    this.generateMockData();
                },

                // 生成4级数据：合同 -> 报价 -> 委托 -> 样品
                generateMockData() {
                    const customers = ['华为技术有限公司', '比亚迪汽车工业', '大疆创新科技', '迈瑞生物医疗', '中兴通讯'];
                    const quoteSubjects = ['', '', ''];
                    
                    this.contracts = Array.from({ length: 5 }, (_, i) => {
                        const contractId = `C${2023000 + i}`;
                        const cust = customers[i % customers.length];
                        
                        return {
                            id: contractId,
                            code: `HT-${contractId}`,
                            name: `${cust} - 2024年度服务合同`,
                            customer: cust,
                            quotes: Array.from({ length: Math.floor(Math.random() * 2) + 1 }, (_, q) => {
                                const quoteId = `Q${contractId}-${q+1}`;
                                return {
                                    id: quoteId,
                                    code: `QUO-${quoteId}`,
                                    subject: quoteSubjects[q % quoteSubjects.length],
                                    orders: Array.from({ length: Math.floor(Math.random() * 2) + 1 }, (_, o) => {
                                        const orderId = `WT-${quoteId}-${o+1}`;
                                        return {
                                            id: orderId,
                                            code: orderId,
                                            samples: Array.from({ length: Math.floor(Math.random() * 4) + 1 }, (_, k) => ({
                                                id: `${orderId}-S${k+1}`,
                                                regCode: `DJ${20230000 + (i*1000) + (q*100) + (o*10) + k}`,
                                                name: ['数字示波器', '频谱分析仪', '高低温试验箱', '信号发生器', '万用表'][Math.floor(Math.random()*5)],
                                                testFee: [1000, 2500, 800, 1500, 500][Math.floor(Math.random()*5)],
                                                expediteFee: Math.random() > 0.8 ? 500 : 0,
                                                transportFee: Math.random() > 0.7 ? 100 : 0,
                                                repairFee: 0, 
                                                materialFee: Math.random() > 0.9 ? 50 : 0,
                                                otherFee: 0
                                            }))
                                        }
                                    })
                                }
                            })
                        };
                    });
                    
                    // 默认展开
                    if(this.contracts.length > 0) {
                        this.expandedIds.push(this.contracts[0].id);
                        if(this.contracts[0].quotes.length > 0) {
                            this.expandedIds.push(this.contracts[0].quotes[0].id);
                        }
                    }
                },

                // 多维组合筛选逻辑
                get filteredData() {
                    let result = this.contracts;
                    const f = this.filters;

                    // 1. 客户筛选
                    if (f.customer) {
                        result = result.filter(c => c.customer.includes(f.customer));
                    }
                    // 2. 合同号筛选
                    if (f.contractCode) {
                        result = result.filter(c => c.code.toLowerCase().includes(f.contractCode.toLowerCase()));
                    }

                    // 3. 深层递归筛选 (报价单/委托单/登记号)
                    // 只要子级有匹配，父级就保留。
                    return result.map(contract => {
                        const c = { ...contract };
                        
                        // 筛选报价单
                        c.quotes = c.quotes.map(quote => {
                            const q = { ...quote };
                            
                            // 筛选委托单
                            q.orders = q.orders.map(order => {
                                const o = { ...order };
                                
                                // 筛选样品 (登记号)
                                if (f.regCode) {
                                    o.samples = o.samples.filter(s => s.regCode.toLowerCase().includes(f.regCode.toLowerCase()));
                                }
                                
                                return o;
                            }).filter(o => {
                                // 委托单号匹配 && 还有样品
                                const matchOrder = !f.orderCode || o.code.toLowerCase().includes(f.orderCode.toLowerCase());
                                return o.samples.length > 0 && matchOrder;
                            });
                            
                            return q;
                        }).filter(q => {
                            // 报价单号匹配 && 还有委托单
                            const matchQuote = !f.quoteCode || q.code.toLowerCase().includes(f.quoteCode.toLowerCase());
                            return q.orders.length > 0 && matchQuote;
                        });
                        
                        return c;
                    }).filter(c => c.quotes.length > 0);
                },

                resetFilters() {
                    this.filters = { customer: '', contractCode: '', quoteCode: '', orderCode: '', regCode: '' };
                },

                isContractDisabled(contractId) {
                    return this.currentContract && this.currentContract.id !== contractId;
                },

                toggleExpand(id) {
                    if (this.expandedIds.includes(id)) {
                        this.expandedIds = this.expandedIds.filter(x => x !== id);
                    } else {
                        this.expandedIds.push(id);
                    }
                },

                toggleSample(sample, contract) {
                    if (this.currentContract && this.currentContract.id !== contract.id) {
                        alert("锁定状态下无法跨合同选择！请先清空已选。");
                        return;
                    }

                    const index = this.selectedIds.indexOf(sample.id);
                    if (index > -1) {
                        this.selectedIds.splice(index, 1);
                        if (this.selectedIds.length === 0) {
                            this.currentContract = null;
                            this.globalDiscount = 100;
                            this.finalTotalAmount = 0;
                        } else {
                            this.recalcTotalByDiscount();
                        }
                    } else {
                        if (this.selectedIds.length === 0) this.currentContract = contract;
                        this.selectedIds.push(sample.id);
                        this.recalcTotalByDiscount();
                    }
                },

                isSelected(id) { return this.selectedIds.includes(id); },

                // 扁平化获取选中行 (遍历4层)
                get selectedRows() {
                    const rows = [];
                    if (!this.currentContract) return rows;
                    this.currentContract.quotes.forEach(q => {
                        q.orders.forEach(o => {
                            o.samples.forEach(s => {
                                if (this.selectedIds.includes(s.id)) rows.push(s);
                            });
                        });
                    });
                    return rows;
                },

                // ====== 费用计算 ======
                get totalTestFee() { return this.selectedRows.reduce((sum, i) => sum + i.testFee, 0); },
                get totalExpediteFee() { return this.selectedRows.reduce((sum, i) => sum + i.expediteFee, 0); },
                get totalTransportFee() { return this.selectedRows.reduce((sum, i) => sum + i.transportFee, 0); },
                get totalRepairFee() { return this.selectedRows.reduce((sum, i) => sum + i.repairFee, 0); },
                get totalMaterialFee() { return this.selectedRows.reduce((sum, i) => sum + i.materialFee, 0); },
                get totalOtherFee() { return this.selectedRows.reduce((sum, i) => sum + i.otherFee, 0); },
                
                get totalMiscFee() { 
                    return this.totalExpediteFee + this.totalTransportFee + this.totalRepairFee + this.totalMaterialFee + this.totalOtherFee; 
                },
                get totalReceivable() { return this.totalTestFee + this.totalMiscFee; },

                formatMoney(val) {
                    return Number(val).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                },

                calculateRowReceivable(item) {
                    return item.testFee + item.expediteFee + item.transportFee + item.repairFee + item.materialFee + item.otherFee;
                },
                calculateRowActual(item) {
                    return (item.testFee * (this.globalDiscount / 100)) + 
                           (item.expediteFee + item.transportFee + item.repairFee + item.materialFee + item.otherFee);
                },

                // ====== 双向反算 ======
                updateFromDiscount() {
                    if (this.globalDiscount > 100) this.globalDiscount = 100;
                    this.recalcTotalByDiscount();
                },
                recalcTotalByDiscount() {
                    const discountRate = Number(this.globalDiscount) / 100;
                    const val = (this.totalTestFee * discountRate) + this.totalMiscFee;
                    this.finalTotalAmount = val.toFixed(2);
                },
                updateFromTotal() {
                    const total = Number(this.finalTotalAmount);
                    if (this.totalTestFee === 0) {
                        this.globalDiscount = 100;
                        return;
                    }
                    let calcDiscount = ((total - this.totalMiscFee) / this.totalTestFee) * 100;
                    if (calcDiscount < 0) calcDiscount = 0;
                    this.globalDiscount = calcDiscount.toFixed(2);
                },

                resetSelection() {
                    this.selectedIds = [];
                    this.currentContract = null;
                    this.globalDiscount = 100;
                    this.finalTotalAmount = 0;
                }
            }
        }
    </script>
</body>
</html>
