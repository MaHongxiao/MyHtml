<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>历史单据引用 - 双源版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        [x-cloak] { display: none !important; }
        body { font-family: "PingFang SC", "Microsoft YaHei", sans-serif; background-color: #f3f4f7; color: #1d1d1f; font-size: 14px; }

        /* TDesign 风格滚动条 */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #dcdcdc; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #999; }

        /* 类型标签 */
        .tag-quote { background-color: #e6f4ff; color: #0052d9; border: 1px solid #d4e3fc; }
        .tag-entrust { background-color: #e3f9e9; color: #008858; border: 1px solid #c6f3d7; }

        /* 选中态 */
        .item-row.selected { background-color: #ecf2fe; }
        .checkbox-custom { appearance: none; width: 16px; height: 16px; border: 1px solid #dcdcdc; border-radius: 3px; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; background: #fff; cursor: pointer; }
        .checkbox-custom:checked { background-color: #0052d9; border-color: #0052d9; }
        .checkbox-custom:checked::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: white; font-size: 10px; }
        
        /* 动画 */
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen bg-black/50 backdrop-blur-sm" x-data="historyReferenceModal()">

    <div class="bg-white rounded-lg shadow-2xl w-[1200px] h-[750px] flex flex-col overflow-hidden slide-in">
        
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-white shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded flex items-center justify-center text-xl">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-gray-800">引用历史单据</h3>
                    <p class="text-xs text-gray-500 mt-0.5">支持引用历史报价单及委托单，同名器具自动互斥</p>
                </div>
            </div>
            <button @click="close()" class="text-gray-400 hover:text-red-500 transition w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100">
                <i class="fa-solid fa-times text-lg"></i>
            </button>
        </div>

        <div class="flex flex-1 overflow-hidden">
            
            <div class="flex-1 flex flex-col border-r border-gray-200 bg-white">
                
                <div class="p-4 border-b border-gray-100 flex items-center justify-between gap-4 bg-gray-50/50">
                    <div class="flex bg-gray-200 rounded p-1 gap-1">
                        <button @click="filterType = 'all'" 
                                class="px-4 py-1.5 text-xs rounded transition font-medium"
                                :class="filterType === 'all' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600 hover:text-gray-900'">
                            全部
                        </button>
                        <button @click="filterType = 'quote'" 
                                class="px-4 py-1.5 text-xs rounded transition font-medium flex items-center gap-1"
                                :class="filterType === 'quote' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600 hover:text-gray-900'">
                            <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span> 报价单
                        </button>
                        <button @click="filterType = 'entrust'" 
                                class="px-4 py-1.5 text-xs rounded transition font-medium flex items-center gap-1"
                                :class="filterType === 'entrust' ? 'bg-white text-green-600 shadow-sm' : 'text-gray-600 hover:text-gray-900'">
                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> 委托单
                        </button>
                    </div>

                    <div class="relative flex-1 max-w-md">
                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-gray-400 text-xs"></i>
                        <input type="text" x-model="searchKeyword" class="w-full pl-9 pr-4 py-2 border border-gray-300 rounded text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition" placeholder="搜索单号、客户名称、器具名称...">
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto custom-scroll p-4 space-y-4 bg-gray-50/30">
                    <template x-for="record in filteredRecords" :key="record.id">
                        <div class="bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-shadow overflow-hidden group">
                            <div class="px-4 py-3 bg-white flex justify-between items-center cursor-pointer border-b border-gray-100 hover:bg-gray-50 transition" @click="record.expanded = !record.expanded">
                                <div class="flex items-center gap-3">
                                    <div class="transition-transform duration-200 text-gray-400 text-xs" :class="{'rotate-90': record.expanded}">
                                        <i class="fa-solid fa-chevron-right"></i>
                                    </div>
                                    
                                    <span class="px-2 py-0.5 rounded text-xs font-medium flex items-center gap-1"
                                          :class="record.type === 'quote' ? 'tag-quote' : 'tag-entrust'">
                                        <i :class="record.type === 'quote' ? 'fa-solid fa-file-invoice-dollar' : 'fa-solid fa-clipboard-check'"></i>
                                        <span x-text="record.type === 'quote' ? '报价单' : '委托单'"></span>
                                    </span>

                                    <div>
                                        <div class="flex items-center gap-2">
                                            <span class="font-bold text-gray-800 text-sm" x-text="record.no"></span>
                                            <span class="text-xs text-gray-400">|</span>
                                            <span class="text-xs text-gray-500" x-text="record.date"></span>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-0.5">
                                            客户：<span class="text-gray-700 font-medium" x-text="record.customer"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-400">
                                    共 <span x-text="record.items.length"></span> 项
                                </div>
                            </div>

                            <div x-show="record.expanded" x-collapse class="bg-gray-50/50">
                                <table class="w-full text-left text-xs border-collapse">
                                    <thead class="text-gray-500 bg-gray-50 border-b border-gray-100">
                                        <tr>
                                            <th class="pl-12 py-2 w-10">选</th>
                                            <th class="py-2">器具名称</th>
                                            <th class="py-2">规格型号</th>
                                            <th class="py-2 text-right pr-6" x-text="record.type === 'quote' ? '报价(元)' : '成交价(元)'"></th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-100">
                                        <template x-for="item in record.items" :key="item.uniqueKey">
                                            <tr class="item-row hover:bg-blue-50 transition cursor-pointer" 
                                                :class="isSelected(item) ? 'bg-blue-50' : ''"
                                                @click="toggleSelection(item, record)">
                                                <td class="pl-12 py-3">
                                                    <input type="checkbox" class="checkbox-custom" :checked="isSelected(item)">
                                                </td>
                                                <td class="py-3 font-medium text-gray-700" x-text="item.name"></td>
                                                <td class="py-3 text-gray-500" x-text="item.model"></td>
                                                <td class="py-3 text-right pr-6 font-mono" 
                                                    :class="record.type==='quote'?'text-orange-600':'text-green-600'" 
                                                    x-text="item.price"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </template>

                    <div x-show="filteredRecords.length === 0" class="flex flex-col items-center justify-center py-20 text-gray-400">
                        <i class="fa-regular fa-folder-open text-4xl mb-3 opacity-30"></i>
                        <p class="text-sm">未找到符合条件的单据</p>
                    </div>
                </div>
            </div>

            <div class="w-[350px] bg-gray-50 border-l border-gray-200 flex flex-col">
                <div class="p-4 border-b border-gray-200 bg-white flex justify-between items-center">
                    <span class="font-bold text-gray-800 text-sm">已选清单 <span class="bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded-full text-xs ml-1" x-text="selectedItems.length"></span></span>
                    <button @click="selectedItems = []" class="text-xs text-red-500 hover:underline" x-show="selectedItems.length > 0">清空</button>
                </div>
                
                <div class="flex-1 overflow-y-auto custom-scroll p-3 space-y-2">
                    <template x-for="(item, idx) in selectedItems" :key="item.uniqueKey">
                        <div class="bg-white p-3 rounded border border-gray-200 shadow-sm relative group hover:border-blue-300 transition">
                            <button @click="toggleSelection(item, null)" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 hidden group-hover:block transition">
                                <i class="fa-solid fa-times-circle"></i>
                            </button>
                            <div class="flex items-start gap-2 mb-1">
                                <span class="text-[10px] px-1.5 rounded border mt-0.5"
                                      :class="item.sourceType === 'quote' ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-green-50 text-green-600 border-green-100'">
                                    <span x-text="item.sourceType === 'quote' ? '报价' : '委托'"></span>
                                </span>
                                <span class="font-bold text-sm text-gray-800 leading-tight" x-text="item.name"></span>
                            </div>
                            <div class="text-xs text-gray-500 pl-1 mb-1">型号：<span x-text="item.model"></span></div>
                            <div class="flex justify-between items-center text-xs pl-1">
                                <span class="text-gray-400 font-mono" x-text="item.sourceNo"></span>
                                <span class="font-bold font-mono" :class="item.sourceType === 'quote' ? 'text-orange-600' : 'text-green-600'" x-text="'¥' + item.price"></span>
                            </div>
                        </div>
                    </template>
                    
                    <div x-show="selectedItems.length === 0" class="text-center py-10 text-gray-400 text-xs">
                        <p>请从左侧列表选择器具</p>
                        <p class="mt-1 opacity-60">同名/同型号器具会自动互斥</p>
                    </div>
                </div>

                <div class="p-4 bg-white border-t border-gray-200">
                    <button @click="confirm()" class="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white rounded shadow-md text-sm font-medium transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-check"></i> 确认引用
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function historyReferenceModal() {
            return {
                filterType: 'all', // all, quote, entrust
                searchKeyword: '',
                selectedItems: [], // 存储选中的器具对象

                // 模拟数据源 (包含报价单和委托单)
                records: [
                    {
                        id: 1, no: 'Q-20231025-001', type: 'quote', date: '2023-10-25', customer: '华为技术有限公司', expanded: true,
                        items: [
                            { id: 'q1-1', name: '数字万用表', model: 'Fluke 17B+', price: 300 },
                            { id: 'q1-2', name: '绝缘电阻测试仪', model: 'UT501A', price: 450 },
                            { id: 'q1-3', name: '示波器', model: 'TBS1102B', price: 1200 }
                        ]
                    },
                    {
                        id: 2, no: 'WT-20230910-088', type: 'entrust', date: '2023-09-10', customer: '比亚迪汽车工业', expanded: false,
                        items: [
                            { id: 'w2-1', name: '数字万用表', model: 'Fluke 17B+', price: 280 }, // 同名同型号，测试互斥
                            { id: 'w2-2', name: '扭矩扳手', model: 'N200', price: 150 }
                        ]
                    },
                    {
                        id: 3, no: 'Q-20230815-099', type: 'quote', date: '2023-08-15', customer: '小米通讯', expanded: false,
                        items: [
                            { id: 'q3-1', name: '温湿度计', model: 'Testo 608-H1', price: 200 }
                        ]
                    },
                    {
                        id: 4, no: 'WT-20230801-002', type: 'entrust', date: '2023-08-01', customer: '华为技术有限公司', expanded: false,
                        items: [
                            { id: 'w4-1', name: '示波器', model: 'TBS1102B', price: 1100 } // 同名同型号，测试互斥
                        ]
                    }
                ],

                // 初始化处理：给每个item增加唯一标识和来源信息，方便处理
                init() {
                    this.records.forEach(record => {
                        record.items.forEach(item => {
                            // 构造唯一key，防止不同单据ID冲突（虽然模拟数据已区分）
                            item.uniqueKey = `${record.type}_${record.id}_${item.id}`;
                            // 注入来源信息，方便后续判断
                            item.sourceType = record.type;
                            item.sourceNo = record.no;
                            item.sourceId = record.id;
                        });
                    });
                },

                // 筛选逻辑
                get filteredRecords() {
                    return this.records.filter(r => {
                        // 类型筛选
                        if (this.filterType !== 'all' && r.type !== this.filterType) return false;
                        // 关键词筛选
                        if (this.searchKeyword) {
                            const key = this.searchKeyword.toLowerCase();
                            const matchNo = r.no.toLowerCase().includes(key);
                            const matchCust = r.customer.toLowerCase().includes(key);
                            const matchItem = r.items.some(i => i.name.toLowerCase().includes(key));
                            return matchNo || matchCust || matchItem;
                        }
                        return true;
                    });
                },

                // 核心交互：选中/取消 (含同名互斥逻辑)
                toggleSelection(item, parentRecord) {
                    const existingIndex = this.selectedItems.findIndex(i => i.uniqueKey === item.uniqueKey);
                    
                    if (existingIndex > -1) {
                        // 已选中 -> 取消选中
                        this.selectedItems.splice(existingIndex, 1);
                    } else {
                        // 未选中 -> 选中 (需先检查同名互斥)
                        this.handleMutualExclusion(item);
                        this.selectedItems.push(item);
                    }
                },

                // 互斥逻辑：检查已选列表中是否有 同名+同型号 的器具
                handleMutualExclusion(newItem) {
                    // 找到冲突项的索引
                    const conflictIndex = this.selectedItems.findIndex(i => 
                        i.name === newItem.name && i.model === newItem.model
                    );

                    if (conflictIndex > -1) {
                        // 如果存在冲突，移除旧的 (实现“反选前者，选中后者”)
                        // 可选：加个Toast提示用户发生了替换
                        // alert(`已自动替换同型号器具：${newItem.name}`); 
                        this.selectedItems.splice(conflictIndex, 1);
                    }
                },

                // 判断是否选中 (用于样式)
                isSelected(item) {
                    return this.selectedItems.some(i => i.uniqueKey === item.uniqueKey);
                },

                confirm() {
                    if (this.selectedItems.length === 0) {
                        alert("请至少选择一项器具");
                        return;
                    }
                    console.log("Selected:", this.selectedItems);
                    alert(`已引用 ${this.selectedItems.length} 项数据，请查看控制台输出。`);
                    this.close();
                },

                close() {
                    document.body.innerHTML = '<div class="flex h-screen items-center justify-center text-slate-500">弹窗已关闭</div>';
                }
            }
        }
    </script>
</body>
</html>
