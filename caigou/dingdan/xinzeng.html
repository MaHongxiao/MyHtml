<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ›å»ºé‡‡è´­è®¢å•</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f1f5f9; color: #334155; }
        
        .text-num { font-family: 'Menlo', 'Monaco', monospace; font-weight: 600; }
        .text-min { font-size: 13px; line-height: 1.5; }
        
        .smart-input {
            width: 100%; 
            border: 1px solid #e2e8f0; 
            background: #fff; 
            padding: 8px 12px;
            border-radius: 6px; 
            outline: none; 
            transition: all 0.2s; 
            font-size: 14px;
            color: #334155;
        }
        .smart-input:hover { border-color: #94a3b8; }
        .smart-input:focus { 
            border-color: #3b82f6; 
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1); 
        }
        .smart-input::placeholder { color: #94a3b8; }
        .smart-input:disabled { background-color: #f1f5f9; cursor: not-allowed; color: #64748b; }
        .smart-input.error { border-color: #ef4444; }
        .smart-input.error:focus { box-shadow: 0 0 0 3px rgba(239,68,68,0.1); }
        
        .smart-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: #334155;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .field-label {
            font-size: 13px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 6px;
            display: block;
        }
        .field-label .required { color: #ef4444; margin-left: 2px; }
        
        .error-msg {
            font-size: 12px;
            color: #ef4444;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .data-table th {
            background: #f8fafc;
            font-size: 13px;
            font-weight: 600;
            color: #475569;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
        }
        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
            vertical-align: middle;
        }
        .data-table tr:hover td { background: #f8fafc; }
        
        .bottom-bar {
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.3s;
        }
        
        .step-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }
        .step-active {
            background: #dbeafe;
            color: #1d4ed8;
            border: 1px solid #93c5fd;
        }
        .step-completed {
            background: #dcfce7;
            color: #15803d;
            border: 1px solid #86efac;
        }
        .step-pending {
            background: #f1f5f9;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(-10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .validation-highlight {
            border-left: 3px solid #ef4444;
            background-color: #fef2f2;
        }
        
        .supplier-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: #eff6ff;
            color: #1d4ed8;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid #dbeafe;
        }
        
        .urgency-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .urgency-normal { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
        .urgency-urgent { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
        .urgency-critical { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        
        .address-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .address-card:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .address-card.selected {
            border-color: #3b82f6;
            background: #eff6ff;
            box-shadow: 0 0 0 2px rgba(59,130,246,0.1);
        }
        
        .min-qty-warning {
            font-size: 11px;
            color: #d97706;
            background: #fef3c7;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 4px;
            display: inline-block;
        }
        
        @media (max-width: 1024px) {
            .form-grid { grid-template-columns: 1fr !important; }
            .hide-mobile { display: none; }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden" x-data="purchaseOrderApp()">

    <!-- é¡¶éƒ¨Header -->
    <header class="bg-white border-b border-slate-200 h-16 px-6 flex justify-between items-center shadow-sm z-30 flex-shrink-0">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-200">
                <i class="fa-solid fa-file-invoice-dollar text-white text-lg"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-slate-800">åˆ›å»ºé‡‡è´­è®¢å•</h1>
                <div class="text-min text-slate-500 mt-0.5" x-text="form.institution ? form.institution + ' Â· ' + (form.department || 'æœªé€‰æ‹©éƒ¨é—¨') : 'è‰ç¨¿çŠ¶æ€ Â· å¾…å®Œå–„ä¿¡æ¯'"></div>
            </div>
        </div>
    </header>

    <!-- è¿›åº¦æ­¥éª¤æ¡ -->
    <div class="bg-white border-b border-slate-200 px-6 py-3 flex-shrink-0">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="step-item" :class="step1Valid ? 'step-completed' : (currentStep === 1 ? 'step-active' : 'step-pending')">
                    <i class="fa-solid" :class="step1Valid ? 'fa-check-circle' : 'fa-file-pen'"></i>
                    <span>1. è®¢å•ä¿¡æ¯</span>
                </div>
                <i class="fa-solid fa-chevron-right text-slate-300 text-sm"></i>
                <div class="step-item" :class="step2Valid ? 'step-completed' : (currentStep === 2 ? 'step-active' : 'step-pending')">
                    <i class="fa-solid" :class="step2Valid ? 'fa-check-circle' : 'fa-truck'"></i>
                    <span>2. é…é€ä¿¡æ¯</span>
                </div>
                <i class="fa-solid fa-chevron-right text-slate-300 text-sm"></i>
                <div class="step-item" :class="currentStep === 3 ? 'step-active' : 'step-pending'">
                    <i class="fa-solid fa-clipboard-check"></i>
                    <span>3. æäº¤ç¡®è®¤</span>
                </div>
            </div>
            <div class="text-min text-slate-500">
                å½“å‰æ­¥éª¤ï¼š<span class="font-medium text-blue-600" x-text="currentStep === 1 ? 'è®¢å•ä¿¡æ¯' : (currentStep === 2 ? 'é…é€ä¿¡æ¯' : 'æäº¤ç¡®è®¤')"></span>
            </div>
        </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡åŒºåŸŸ -->
    <div class="bg-white border-b border-slate-200 px-6 py-4 grid grid-cols-1 md:grid-cols-4 gap-4 flex-shrink-0">
        <div class="stat-card flex items-center justify-between">
            <div>
                <div class="text-min text-slate-500 mb-1">è®¢å•æ€»é‡‘é¢</div>
                <div class="text-2xl font-bold text-blue-600 text-num" x-text="'Â¥' + formatMoney(totalAmount)">Â¥0.00</div>
            </div>
            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                <i class="fa-solid fa-yen-sign"></i>
            </div>
        </div>
        
        <div class="stat-card flex items-center justify-between">
            <div>
                <div class="text-min text-slate-500 mb-1">å•†å“ç§ç±»</div>
                <div class="text-2xl font-bold text-slate-800" x-text="products.length">0</div>
            </div>
            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600">
                <i class="fa-solid fa-list-ol"></i>
            </div>
        </div>
        
        <div class="stat-card flex items-center justify-between">
            <div>
                <div class="text-min text-slate-500 mb-1">å•†å“æ€»æ•°é‡</div>
                <div class="text-2xl font-bold text-slate-800" x-text="totalQuantity">0</div>
            </div>
            <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600">
                <i class="fa-solid fa-boxes-stacked"></i>
            </div>
        </div>

        <div class="stat-card flex items-center justify-between">
            <div>
                <div class="text-min text-slate-500 mb-1">æ¶‰åŠä¾›åº”å•†</div>
                <div class="text-2xl font-bold text-slate-800" x-text="uniqueSuppliers.length">0</div>
            </div>
            <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-600">
                <i class="fa-solid fa-building-user"></i>
            </div>
        </div>
    </div>

    <!-- ä¸»ä½“å†…å®¹åŒº -->
    <main class="flex-1 overflow-y-auto bg-slate-50 custom-scroll pb-32">
        <div class="max-w-7xl mx-auto p-6 space-y-6">
            
            <!-- ç¬¬ä¸€éƒ¨åˆ†ï¼šè®¢å•åŸºæœ¬ä¿¡æ¯ -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 fade-in" :class="errors.step1 ? 'validation-highlight' : ''" id="step1">
                <div class="section-title">
                    <i class="fa-solid fa-file-pen text-blue-600"></i>
                    è®¢å•åŸºæœ¬ä¿¡æ¯
                    <span class="ml-auto text-min font-normal text-slate-400" x-show="step1Valid">
                        <i class="fa-solid fa-check-circle text-emerald-500 mr-1"></i>å·²å®Œæˆ
                    </span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 form-grid">
                    <!-- è®¢å•ç¼–å· -->
                    <div>
                        <label class="field-label">è®¢å•ç¼–å· <span class="text-slate-400 font-normal">(è‡ªåŠ¨ç”Ÿæˆ)</span></label>
                        <input type="text" x-model="form.orderNo" disabled 
                               class="smart-input bg-slate-50 text-num text-slate-600">
                        <p class="text-min text-slate-400 mt-1">æ ¼å¼ï¼šæœºæ„ç®€ç§°+æ—¥æœŸ+æµæ°´å·</p>
                    </div>

                    <!-- ç”³è¯·æœºæ„ï¼ˆè‡ªåŠ¨å¸¦å‡ºï¼‰ -->
                    <div>
                        <label class="field-label">ç”³è¯·æœºæ„</label>
                        <input type="text" x-model="form.institution" disabled 
                               class="smart-input bg-slate-50 text-slate-600" placeholder="è‡ªåŠ¨å¸¦å‡ºå½“å‰ç™»å½•æœºæ„">
                    </div>

                    <!-- ç”³è¯·éƒ¨é—¨ -->
                    <div>
                        <label class="field-label">ç”³è¯·éƒ¨é—¨ <span class="required">*</span></label>
                        <select x-model="form.department" class="smart-input smart-select" :class="errors.department ? 'error' : ''">
                            <option value="">è¯·é€‰æ‹©</option>
                            <template x-for="dept in departments" :key="dept.code">
                                <option :value="dept.name" x-text="dept.name"></option>
                            </template>
                        </select>
                        <p x-show="errors.department" class="error-msg" x-text="errors.department"></p>
                    </div>

                    <!-- ç´§æ€¥ç¨‹åº¦ -->
                    <div>
                        <label class="field-label">ç´§æ€¥ç¨‹åº¦ <span class="required">*</span></label>
                        <div class="flex gap-2 mt-1">
                            <button type="button" @click="form.urgency = 'normal'" 
                                    class="flex-1 py-2 px-3 rounded-lg text-sm font-medium border transition"
                                    :class="form.urgency === 'normal' ? 'urgency-normal border-slate-400 bg-slate-50' : 'border-slate-200 text-slate-600 hover:border-slate-300'">
                                æ™®é€š
                            </button>
                            <button type="button" @click="form.urgency = 'urgent'" 
                                    class="flex-1 py-2 px-3 rounded-lg text-sm font-medium border transition"
                                    :class="form.urgency === 'urgent' ? 'urgency-urgent border-amber-400 bg-amber-50' : 'border-slate-200 text-slate-600 hover:border-slate-300'">
                                ç´§æ€¥
                            </button>
                            <button type="button" @click="form.urgency = 'critical'" 
                                    class="flex-1 py-2 px-3 rounded-lg text-sm font-medium border transition"
                                    :class="form.urgency === 'critical' ? 'urgency-critical border-red-400 bg-red-50' : 'border-slate-200 text-slate-600 hover:border-slate-300'">
                                ç‰¹æ€¥
                            </button>
                        </div>
                        <p x-show="errors.urgency" class="error-msg" x-text="errors.urgency"></p>
                    </div>

                    <!-- æœŸæœ›é€è¾¾æ—¥æœŸ -->
                    <div>
                        <label class="field-label">æœŸæœ›é€è¾¾æ—¥æœŸ <span class="required">*</span></label>
                        <input type="date" x-model="form.deliveryDate" @blur="validateStep1()"
                               class="smart-input" :class="errors.deliveryDate ? 'error' : ''">
                        <p x-show="errors.deliveryDate" class="error-msg" x-text="errors.deliveryDate"></p>
                        <p class="text-min text-slate-400 mt-1" x-show="maxDeliveryDays > 0">
                            <i class="fa-solid fa-circle-info mr-1"></i>æ‰€é€‰å•†å“æœ€é•¿è´§æœŸï¼š<span x-text="maxDeliveryDays"></span>å¤©
                        </p>
                    </div>

                    <!-- æ”¶è´§æ—¶é—´èŒƒå›´ -->
                    <div>
                        <label class="field-label">æ”¶è´§æ—¶é—´èŒƒå›´ <span class="required">*</span></label>
                        <select x-model="form.deliveryTimeRange" class="smart-input smart-select" :class="errors.deliveryTimeRange ? 'error' : ''">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="anytime">éšæ—¶</option>
                            <option value="workday">å·¥ä½œæ—¥å‡å¯</option>
                            <option value="worktime">ä»…å·¥ä½œæ—¶é—´ï¼ˆ9:00-18:00ï¼‰</option>
                            <option value="morning">ä¸Šåˆï¼ˆ9:00-12:00ï¼‰</option>
                            <option value="afternoon">ä¸‹åˆï¼ˆ14:00-18:00ï¼‰</option>
                        </select>
                        <p x-show="errors.deliveryTimeRange" class="error-msg" x-text="errors.deliveryTimeRange"></p>
                    </div>

                    <!-- å‘¨æœ«æ˜¯å¦å¯é…é€ -->
                    <div>
                        <label class="field-label">å‘¨æœ«æ˜¯å¦å¯é…é€ <span class="required">*</span></label>
                        <div class="flex gap-4 mt-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" x-model="form.weekendDelivery" value="yes" class="w-4 h-4 text-blue-600 border-slate-300 focus:ring-blue-500">
                                <span class="text-sm text-slate-700">æ˜¯</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" x-model="form.weekendDelivery" value="no" class="w-4 h-4 text-blue-600 border-slate-300 focus:ring-blue-500">
                                <span class="text-sm text-slate-700">å¦</span>
                            </label>
                        </div>
                    </div>

                    <!-- è®¢å•å¤‡æ³¨ -->
                    <div class="lg:col-span-4">
                        <label class="field-label">å¤‡æ³¨è¯´æ˜</label>
                        <textarea x-model="form.remark" rows="2" class="smart-input resize-none" 
                                  placeholder="å¦‚æœ‰ç‰¹æ®Šè¦æ±‚è¯·åœ¨æ­¤è¯´æ˜ï¼Œå¦‚ï¼šé€è´§æ—¶éœ€æºå¸¦å•†å“åˆæ ¼è¯ä¸æ£€æµ‹æŠ¥å‘Šã€å¤–åŒ…è£…éœ€æ ‡æ³¨é˜²æ½®æ˜“ç¢ç­‰"></textarea>
                    </div>
                </div>

                <!-- å•†å“æ˜ç»†åŒºåŸŸ -->
                <div class="mt-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-sm font-bold text-slate-700">é‡‡è´­å•†å“æ˜ç»† <span class="required">*</span></h3>
                            <p class="text-min text-slate-500 mt-1">é€‰æ‹©å•†å“åè‡ªåŠ¨å…³è”ä¾›åº”å•†ä¿¡æ¯</p>
                        </div>
                        <div class="flex gap-2">
                            <button @click="openProductModal()" class="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition flex items-center gap-1">
                                <i class="fa-solid fa-plus"></i> æ·»åŠ å•†å“
                            </button>
                        </div>
                    </div>

                    <!-- å•†å“è¡¨æ ¼ï¼ˆå«CASå·ã€è´§å·ã€å“ç‰Œã€ä¾›åº”å•†ï¼‰ -->
                    <div class="overflow-x-auto border border-slate-200 rounded-lg" :class="errors.products ? 'border-red-300' : ''">
                        <table class="w-full data-table">
                            <thead>
                                <tr>
                                    <th class="w-10 text-center">#</th>
                                    <th class="min-w-[160px]">å•†å“ä¿¡æ¯</th>
                                    <th class="w-24">CASå·</th>
                                    <th class="w-24">è´§å·</th>
                                    <th class="min-w-[100px]">è§„æ ¼</th>
                                    <th class="w-24">å“ç‰Œ</th>
                                    <th class="min-w-[120px]">ä¾›åº”å•†</th>
                                    <th class="w-20 text-center">å•ä½</th>
                                    <th class="w-24 text-right">å•ä»·(Â¥)</th>
                                    <th class="w-20 text-center">æ•°é‡</th>
                                    <th class="w-24 text-right">å°è®¡(Â¥)</th>
                                    <th class="w-16 text-center">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(product, index) in products" :key="index">
                                    <tr class="group">
                                        <td class="text-center text-slate-400" x-text="index + 1"></td>
                                        <td>
                                            <div class="font-medium text-slate-800" x-text="product.name"></div>
                                            <div class="text-min text-slate-400" x-text="product.code"></div>
                                            <div x-show="product.minOrderQty > 1 && product.quantity < product.minOrderQty" class="min-qty-warning">
                                                <i class="fa-solid fa-triangle-exclamation mr-1"></i>æœ€å°èµ·è®¢é‡ï¼š<span x-text="product.minOrderQty"></span>
                                            </div>
                                        </td>
                                        <td class="text-min text-slate-600 font-mono" x-text="product.cas || '-'"></td>
                                        <td class="text-min text-slate-600" x-text="product.artNo || '-'"></td>
                                        <td class="text-min text-slate-600" x-text="product.spec"></td>
                                        <td class="text-min text-slate-600" x-text="product.brand || '-'"></td>
                                        <td>
                                            <span class="supplier-tag" x-text="product.supplierName || '-'"></span>
                                            <div class="text-min text-slate-400 mt-1" x-show="product.deliveryDays">
                                                è´§æœŸï¼š<span x-text="product.deliveryDays"></span>å¤©
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <input type="text" x-model="product.unit" class="smart-input text-center py-1 px-2 text-sm">
                                        </td>
                                        <td>
                                            <input type="number" x-model.number="product.price" @input="calculateRow(index)" 
                                                   class="smart-input text-right py-1 px-2 text-sm text-num" step="0.01" min="0">
                                        </td>
                                        <td>
                                            <input type="number" x-model.number="product.quantity" @input="calculateRow(index)" 
                                                   class="smart-input text-center py-1 px-2 text-sm text-num" min="1"
                                                   :class="product.quantity < product.minOrderQty ? 'border-amber-300 bg-amber-50' : ''">
                                        </td>
                                        <td class="text-right font-medium text-slate-800 text-num" x-text="'Â¥' + formatMoney(product.subtotal)"></td>
                                        <td class="text-center">
                                            <button @click="removeProduct(index)" class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition">
                                                <i class="fa-solid fa-trash-can"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                                
                                <!-- ç©ºçŠ¶æ€ -->
                                <tr x-show="products.length === 0">
                                    <td colspan="12" class="text-center py-12 text-slate-400">
                                        <div class="mb-3 text-4xl">ğŸ›’</div>
                                        <div class="text-min mb-2">æš‚æ— å•†å“ï¼Œè¯·æ·»åŠ é‡‡è´­å•†å“</div>
                                        <button @click="openProductModal()" class="text-blue-600 hover:underline text-sm">æ·»åŠ å•†å“</button>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot x-show="products.length > 0" class="bg-slate-50 border-t border-slate-200">
                                <tr>
                                    <td colspan="10" class="text-right font-medium text-slate-600">å•†å“å°è®¡ï¼š</td>
                                    <td class="text-right font-bold text-slate-800 text-num" x-text="'Â¥' + formatMoney(subtotal)"></td>
                                    <td></td>
                                </tr>
                                <tr class="border-t border-slate-200 bg-blue-50">
                                    <td colspan="10" class="text-right font-bold text-slate-800 text-base">è®¢å•æ€»è®¡ï¼š</td>
                                    <td class="text-right font-bold text-blue-600 text-lg text-num" x-text="'Â¥' + formatMoney(totalAmount)"></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <p x-show="errors.products" class="error-msg mt-2" x-text="errors.products"></p>
                    
                    <!-- å¤šä¾›åº”å•†æç¤º -->
                    <div x-show="uniqueSuppliers.length > 1" class="mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg flex items-start gap-2">
                        <i class="fa-solid fa-circle-info text-amber-600 mt-0.5"></i>
                        <div class="text-min text-amber-800">
                            <div class="font-medium mb-1">å¤šä¾›åº”å•†è®¢å•</div>
                            <div>å½“å‰è®¢å•åŒ…å« <span x-text="uniqueSuppliers.length" class="font-bold"></span> å®¶ä¾›åº”å•†çš„å•†å“ï¼Œå®¡æ‰¹é€šè¿‡åå°†æŒ‰ä¾›åº”å•†æ‹†åˆ†ä¸ºå¤šä¸ªé€è´§å•ã€‚</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç¬¬äºŒéƒ¨åˆ†ï¼šé…é€ä¸è”ç³»äººä¿¡æ¯å®Œå–„ -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 fade-in" :class="errors.step2 ? 'validation-highlight' : ''" id="step2">
                <div class="section-title">
                    <i class="fa-solid fa-truck-fast text-indigo-600"></i>
                    é…é€ä¸è”ç³»äººä¿¡æ¯å®Œå–„
                    <span class="ml-auto text-min font-normal" x-show="step2Valid">
                        <i class="fa-solid fa-check-circle text-emerald-500 mr-1"></i>å·²å®Œæˆ
                    </span>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- å·¦ä¾§ï¼šæ”¶è´§åœ°å€ -->
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <h3 class="text-sm font-bold text-slate-700">æ”¶è´§åœ°å€ä¿¡æ¯</h3>
                            <button @click="openAddressModal()" class="text-sm text-blue-600 hover:text-blue-700 font-medium flex items-center gap-1">
                                <i class="fa-solid fa-address-book"></i> é€‰æ‹©å¸¸ç”¨åœ°å€
                            </button>
                        </div>
                        
                        <div>
                            <label class="field-label">è¯¦ç»†æ”¶è´§åœ°å€ <span class="required">*</span></label>
                            <textarea x-model="form.address" rows="3" @blur="validateStep2()"
                                      class="smart-input resize-none" :class="errors.address ? 'error' : ''"
                                      placeholder="è¯·è¾“å…¥è¯¦ç»†æ”¶è´§åœ°å€ï¼ˆçœå¸‚åŒºè¡—é“é—¨ç‰Œå·ï¼‰"></textarea>
                            <p x-show="errors.address" class="error-msg" x-text="errors.address"></p>
                        </div>

                        <div>
                            <label class="field-label">äº¤è´§æ–¹å¼ <span class="required">*</span></label>
                            <select x-model="form.deliveryMethod" class="smart-input smart-select">
                                <option value="delivery">é€è´§ä¸Šé—¨</option>
                                <option value="pickup">ä¸Šé—¨è‡ªæ</option>
                                <option value="express">å¿«é€’ç‰©æµ</option>
                            </select>
                        </div>
                    </div>

                    <!-- å³ä¾§ï¼šè”ç³»äººä¿¡æ¯ -->
                    <div class="space-y-4">
                        <h3 class="text-sm font-bold text-slate-700 mb-3">è”ç³»äººä¿¡æ¯</h3>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="field-label">æ”¶è´§äººå§“å <span class="required">*</span></label>
                                <input type="text" x-model="form.contactName" @blur="validateStep2()"
                                       class="smart-input" :class="errors.contactName ? 'error' : ''" placeholder="æ”¶è´§äººå§“å">
                                <p x-show="errors.contactName" class="error-msg" x-text="errors.contactName"></p>
                            </div>
                            <div>
                                <label class="field-label">è”ç³»ç”µè¯ <span class="required">*</span></label>
                                <input type="tel" x-model="form.contactPhone" @blur="validateStep2()"
                                       class="smart-input text-num" :class="errors.contactPhone ? 'error' : ''" placeholder="11ä½æ‰‹æœºå·">
                                <p x-show="errors.contactPhone" class="error-msg" x-text="errors.contactPhone"></p>
                            </div>
                        </div>

                        <div>
                            <label class="field-label">å¤‡ç”¨è”ç³»ç”µè¯</label>
                            <input type="tel" x-model="form.contactPhone2" class="smart-input text-num" placeholder="å¤‡ç”¨ç”µè¯ï¼ˆé€‰å¡«ï¼‰">
                        </div>

                        <div>
                            <label class="field-label">ç”µå­é‚®ç®±</label>
                            <input type="email" x-model="form.contactEmail" class="smart-input" placeholder="ç”¨äºæ¥æ”¶è®¢å•é€šçŸ¥">
                        </div>

                        <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mt-4">
                            <div class="flex items-start gap-2">
                                <i class="fa-solid fa-circle-info text-amber-600 mt-0.5"></i>
                                <div class="text-min text-amber-800">
                                    <div class="font-medium mb-1">é…é€æç¤º</div>
                                    <div>åŒ–å­¦å“åŠå±é™©ç‰©å“éœ€æŒ‡å®šä¸“äººæ¥æ”¶ï¼Œå¹¶æå‰å‡†å¤‡ç›¸åº”çš„å‚¨å­˜æ¡ä»¶å’Œå®‰å…¨é˜²æŠ¤æªæ–½ã€‚</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç¬¬ä¸‰éƒ¨åˆ†ï¼šè®¢å•æäº¤ä¸æ ¡éªŒ -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 fade-in" id="step3">
                <div class="section-title">
                    <i class="fa-solid fa-clipboard-check text-emerald-600"></i>
                    è®¢å•æäº¤å‰ç¡®è®¤
                </div>
                
                <div class="space-y-4">
                    <!-- æ ¡éªŒçŠ¶æ€æ±‡æ€» -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="p-4 rounded-lg border" :class="step1Valid ? 'bg-emerald-50 border-emerald-200' : 'bg-slate-50 border-slate-200'">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fa-solid" :class="step1Valid ? 'fa-check-circle text-emerald-600' : 'fa-circle-xmark text-slate-400'"></i>
                                <span class="font-medium text-sm" :class="step1Valid ? 'text-emerald-800' : 'text-slate-600'">è®¢å•ä¿¡æ¯å®Œæ•´æ€§</span>
                            </div>
                            <div class="text-min" :class="step1Valid ? 'text-emerald-700' : 'text-slate-500'">
                                <span x-text="step1Valid ? 'åŸºæœ¬ä¿¡æ¯å®Œæ•´ï¼Œå•†å“å·²æ·»åŠ ' : 'å¾…å®Œå–„è®¢å•åŸºæœ¬ä¿¡æ¯å’Œå•†å“æ˜ç»†'"></span>
                            </div>
                        </div>

                        <div class="p-4 rounded-lg border" :class="step2Valid ? 'bg-emerald-50 border-emerald-200' : 'bg-slate-50 border-slate-200'">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fa-solid" :class="step2Valid ? 'fa-check-circle text-emerald-600' : 'fa-circle-xmark text-slate-400'"></i>
                                <span class="font-medium text-sm" :class="step2Valid ? 'text-emerald-800' : 'text-slate-600'">é…é€ä¿¡æ¯å®Œæ•´æ€§</span>
                            </div>
                            <div class="text-min" :class="step2Valid ? 'text-emerald-700' : 'text-slate-500'">
                                <span x-text="step2Valid ? 'æ”¶è´§åœ°å€å’Œè”ç³»äººå·²å¡«å†™' : 'å¾…å®Œå–„æ”¶è´§åœ°å€å’Œè”ç³»äººä¿¡æ¯'"></span>
                            </div>
                        </div>

                        <div class="p-4 rounded-lg border" :class="allValid ? 'bg-emerald-50 border-emerald-200' : 'bg-amber-50 border-amber-200'">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fa-solid" :class="allValid ? 'fa-check-circle text-emerald-600' : 'fa-triangle-exclamation text-amber-600'"></i>
                                <span class="font-medium text-sm" :class="allValid ? 'text-emerald-800' : 'text-amber-800'">è®¢å•å¯æäº¤çŠ¶æ€</span>
                            </div>
                            <div class="text-min" :class="allValid ? 'text-emerald-700' : 'text-amber-700'">
                                <span x-text="allValid ? 'æ‰€æœ‰æ ¡éªŒé€šè¿‡ï¼Œå¯æäº¤è®¢å•' : 'å­˜åœ¨æœªå®Œæˆçš„å¿…å¡«é¡¹'"></span>
                            </div>
                        </div>
                    </div>

                    <!-- è®¢å•æ‘˜è¦ -->
                    <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                        <h4 class="font-bold text-slate-800 mb-3 text-sm">è®¢å•ä¿¡æ¯æ±‡æ€»</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-4">
                            <div>
                                <div class="text-min text-slate-500 mb-1">ç”³è¯·æœºæ„</div>
                                <div class="font-medium text-slate-800" x-text="form.institution || '-'">-</div>
                            </div>
                            <div>
                                <div class="text-min text-slate-500 mb-1">ç”³è¯·éƒ¨é—¨</div>
                                <div class="font-medium text-slate-800" x-text="form.department || '-'">-</div>
                            </div>
                            <div>
                                <div class="text-min text-slate-500 mb-1">ç´§æ€¥ç¨‹åº¦</div>
                                <div class="font-medium">
                                    <span class="urgency-tag" :class="'urgency-' + form.urgency" x-text="getUrgencyText(form.urgency)"></span>
                                </div>
                            </div>
                            <div>
                                <div class="text-min text-slate-500 mb-1">æœŸæœ›é€è¾¾æ—¥æœŸ</div>
                                <div class="font-medium text-slate-800" x-text="form.deliveryDate || '-'">-</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-4 pt-4 border-t border-slate-200">
                            <div>
                                <div class="text-min text-slate-500 mb-1">æ”¶è´§äºº</div>
                                <div class="font-medium text-slate-800" x-text="form.contactName || '-'">-</div>
                            </div>
                            <div>
                                <div class="text-min text-slate-500 mb-1">è”ç³»ç”µè¯</div>
                                <div class="font-medium text-slate-800 text-num" x-text="form.contactPhone || '-'">-</div>
                            </div>
                            <div>
                                <div class="text-min text-slate-500 mb-1">æ”¶è´§æ—¶é—´</div>
                                <div class="font-medium text-slate-800" x-text="getTimeRangeText(form.deliveryTimeRange)">-</div>
                            </div>
                            <div>
                                <div class="text-min text-slate-500 mb-1">å‘¨æœ«é…é€</div>
                                <div class="font-medium text-slate-800" x-text="form.weekendDelivery === 'yes' ? 'æ˜¯' : 'å¦'">-</div>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-200 flex justify-between items-center">
                            <div class="text-min text-slate-600">
                                å…± <span class="font-bold text-slate-800" x-text="products.length">0</span> ç§å•†å“ï¼Œ 
                                æ¶‰åŠ <span class="font-bold text-slate-800" x-text="uniqueSuppliers.length">0</span> å®¶ä¾›åº”å•†ï¼Œ
                                åˆè®¡ <span class="font-bold text-slate-800" x-text="totalQuantity">0</span> ä»¶
                            </div>
                            <div class="text-lg font-bold text-blue-600 text-num">
                                è®¢å•æ€»é¢ï¼šÂ¥<span x-text="formatMoney(totalAmount)">0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- åº•éƒ¨å›ºå®šæ“ä½œæ  -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 px-6 py-4 bottom-bar z-40">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="text-min text-slate-500">
                    è®¢å•é‡‘é¢ï¼š<span class="font-bold text-blue-600 text-num text-lg" x-text="'Â¥' + formatMoney(totalAmount)"></span>
                </div>
                <div class="h-4 w-px bg-slate-300"></div>
                <div class="text-min text-slate-500">
                    å•†å“ï¼š<span class="font-medium text-slate-800" x-text="products.length">0</span> ç§ / 
                    <span class="font-medium text-slate-800" x-text="totalQuantity">0</span> ä»¶
                </div>
                <div class="h-4 w-px bg-slate-300"></div>
                <div class="text-min" :class="allValid ? 'text-emerald-600' : 'text-amber-600'">
                    <i class="fa-solid" :class="allValid ? 'fa-check-circle' : 'fa-circle-exclamation'"></i>
                    <span x-text="allValid ? 'å¯æäº¤å®¡æ‰¹' : 'ä¿¡æ¯å¾…å®Œå–„'"></span>
                </div>
            </div>
            <div class="flex gap-3">
                <button @click="goBack()" class="px-5 py-2.5 border border-slate-300 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-50 transition">
                    å–æ¶ˆ
                </button>
                <button @click="saveDraft()" class="px-5 py-2.5 border border-blue-300 text-blue-600 rounded-lg text-sm font-medium hover:bg-blue-50 transition flex items-center gap-2">
                    <i class="fa-regular fa-floppy-disk"></i> ä¿å­˜è‰ç¨¿
                </button>
                <button @click="validateAndSubmit()" :disabled="!allValid"
                        :class="allValid ? 'bg-blue-600 hover:bg-blue-700 text-white shadow-md shadow-blue-200' : 'bg-slate-300 text-slate-500 cursor-not-allowed'"
                        class="px-6 py-2.5 rounded-lg text-sm font-medium transition flex items-center gap-2">
                    <i class="fa-solid fa-paper-plane"></i> æäº¤å®¡æ‰¹
                </button>
            </div>
        </div>
    </div>

    <!-- å•†å“é€‰æ‹©å¼¹çª—ï¼ˆå¢åŠ CASå·ã€è´§å·ã€å“ç‰Œã€è´§æœŸæ˜¾ç¤ºï¼‰ -->
    <div x-show="productModal.open" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4" x-cloak @click.self="closeProductModal()">
        <div class="bg-white w-full max-w-5xl rounded-xl shadow-2xl max-h-[80vh] flex flex-col fade-in">
            <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <h3 class="text-lg font-bold text-slate-800">é€‰æ‹©å•†å“</h3>
                <button @click="closeProductModal()" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="p-4 border-b border-slate-100 flex gap-3">
                <div class="relative flex-1">
                    <i class="fa-solid fa-search absolute left-3 top-2.5 text-slate-400 text-sm"></i>
                    <input type="text" x-model="productModal.keyword" placeholder="æœç´¢å•†å“åç§°/CASå·/è´§å·/ç¼–ç ..." 
                           class="smart-input pl-9">
                </div>
                <select x-model="productModal.category" class="smart-input smart-select w-40">
                    <option value="">å…¨éƒ¨åˆ†ç±»</option>
                    <option value="reagent">åŒ–å­¦è¯•å‰‚</option>
                    <option value="consumable">è€—æ</option>
                    <option value="equipment">è®¾å¤‡</option>
                </select>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scroll">
                <table class="w-full data-table">
                    <thead class="sticky top-0 bg-white z-10">
                        <tr>
                            <th class="min-w-[160px]">å•†å“ä¿¡æ¯</th>
                            <th class="w-28">CASå·</th>
                            <th class="w-24">è´§å·</th>
                            <th class="w-32">è§„æ ¼</th>
                            <th class="w-24">å“ç‰Œ</th>
                            <th class="min-w-[120px]">ä¾›åº”å•†</th>
                            <th class="w-20">è´§æœŸ</th>
                            <th class="w-24 text-right">å•ä»·</th>
                            <th class="w-20 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="product in filteredProducts" :key="product.id">
                            <tr class="hover:bg-slate-50 cursor-pointer" @click="addProduct(product)">
                                <td>
                                    <div class="font-medium text-slate-800" x-text="product.name"></div>
                                    <div class="text-min text-slate-400" x-text="product.code"></div>
                                </td>
                                <td class="text-min text-slate-600 font-mono" x-text="product.cas || '-'"></td>
                                <td class="text-min text-slate-600" x-text="product.artNo || '-'"></td>
                                <td class="text-min text-slate-600" x-text="product.spec"></td>
                                <td class="text-min text-slate-600" x-text="product.brand || '-'"></td>
                                <td>
                                    <span class="supplier-tag" x-text="product.supplierName"></span>
                                </td>
                                <td class="text-min text-center">
                                    <span x-text="product.deliveryDays || '-'"></span>
                                    <span x-show="product.deliveryDays">å¤©</span>
                                </td>
                                <td class="text-right text-num font-medium" x-text="'Â¥' + product.price.toFixed(2)"></td>
                                <td class="text-center">
                                    <button class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition" @click.stop="addProduct(product)">
                                        æ·»åŠ 
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            
            <div class="px-6 py-4 border-t border-slate-200 bg-slate-50 flex justify-end">
                <button @click="closeProductModal()" class="px-5 py-2 border border-slate-300 text-slate-700 rounded-lg text-sm font-medium hover:bg-white transition">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- å¸¸ç”¨åœ°å€é€‰æ‹©å¼¹çª— -->
    <div x-show="addressModal.open" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4" x-cloak @click.self="closeAddressModal()">
        <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl max-h-[80vh] flex flex-col fade-in">
            <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <h3 class="text-lg font-bold text-slate-800">é€‰æ‹©å¸¸ç”¨åœ°å€</h3>
                <button @click="closeAddressModal()" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scroll p-4">
                <div class="grid gap-3">
                    <template x-for="addr in addressList" :key="addr.id">
                        <div class="address-card" :class="{'selected': addressModal.selectedId === addr.id}" @click="selectAddress(addr)">
                            <div class="flex items-start justify-between">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="font-medium text-slate-800" x-text="addr.contactName"></span>
                                        <span class="text-min text-slate-500" x-text="addr.contactPhone"></span>
                                        <span x-show="addr.isDefault" class="text-min px-2 py-0.5 bg-blue-100 text-blue-700 rounded">é»˜è®¤</span>
                                    </div>
                                    <div class="text-sm text-slate-600" x-text="addr.fullAddress"></div>
                                    <div class="text-min text-slate-400 mt-1" x-text="addr.institution + ' Â· ' + addr.department"></div>
                                </div>
                                <div x-show="addressModal.selectedId === addr.id" class="text-blue-600">
                                    <i class="fa-solid fa-check-circle text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            
            <div class="px-6 py-4 border-t border-slate-200 bg-slate-50 flex justify-between items-center">
                <button @click="closeAddressModal()" class="px-5 py-2 text-slate-600 hover:text-slate-800 text-sm font-medium">
                    æ‰‹åŠ¨è¾“å…¥åœ°å€
                </button>
                <div class="flex gap-3">
                    <button @click="closeAddressModal()" class="px-5 py-2 border border-slate-300 text-slate-700 rounded-lg text-sm font-medium hover:bg-white transition">å–æ¶ˆ</button>
                    <button @click="confirmAddressSelection()" 
                            class="px-5 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition"
                            :disabled="!addressModal.selectedId"
                            :class="{'opacity-50 cursor-not-allowed': !addressModal.selectedId}">
                        ç¡®è®¤é€‰æ‹©
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toastæç¤º -->
    <div x-show="toast.show" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-2"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition ease-in duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed top-20 right-6 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-2xl z-[100] flex items-center gap-3">
        <i class="fa-solid" :class="toast.type === 'success' ? 'fa-check-circle text-emerald-400' : 'fa-circle-exclamation text-rose-400'"></i>
        <span class="text-sm font-medium" x-text="toast.message"></span>
    </div>

    <script>
        function purchaseOrderApp() {
            return {
                currentStep: 1,
                
                form: {
                    orderNo: '',
                    institution: 'ä¸­å¿ƒå®éªŒå®¤', // è‡ªåŠ¨å¸¦å‡ºå½“å‰ç™»å½•äººæ‰€å±æœºæ„
                    department: '',
                    urgency: 'normal', // normal, urgent, critical
                    deliveryDate: '',
                    deliveryTimeRange: '',
                    weekendDelivery: 'no',
                    remark: '',
                    address: '',
                    deliveryMethod: 'delivery',
                    contactName: '',
                    contactPhone: '',
                    contactPhone2: '',
                    contactEmail: ''
                },
                products: [],
                errors: {},
                
                productModal: {
                    open: false,
                    keyword: '',
                    category: ''
                },
                
                addressModal: {
                    open: false,
                    selectedId: null
                },
                
                // å•†å“åº“ï¼ˆæŒ‰éœ€æ±‚æ–‡æ¡£å­—æ®µï¼šCASå·ã€è´§å·ã€å“ç‰Œã€è´§æœŸã€ä¾›åº”å•†ã€æœ€å°èµ·è®¢é‡ï¼‰
                productLibrary: [
                    { 
                        id: 1, 
                        code: '0402000001', 
                        name: '10mlä¸€æ¬¡æ€§ç¦»å¿ƒç®¡ï¼ˆæ— èŒæ— é…¶ï¼‰', 
                        cas: '',
                        artNo: 'GBT-001',
                        brand: 'æ´ç‰¹',
                        spec: 'PPæè´¨ï¼Œ100æ”¯/è¢‹', 
                        price: 45.00, 
                        stock: 120, 
                        category: 'consumable', 
                        supplierId: 'S001', 
                        supplierName: 'è¥¿å®‰åŒ–å­¦è¯•å‰‚æœ‰é™å…¬å¸',
                        deliveryDays: 3,
                        minOrderQty: 10
                    },
                    { 
                        id: 2, 
                        code: '0101000001', 
                        name: 'ç”²é†‡ï¼ˆè‰²è°±çº§ï¼‰', 
                        cas: '67-56-1',
                        artNo: 'M178-4L',
                        brand: 'Sigma',
                        spec: '4L/ç“¶ï¼ŒHPLCçº§', 
                        price: 128.00, 
                        stock: 50, 
                        category: 'reagent', 
                        supplierId: 'S002', 
                        supplierName: 'èµ›é»˜é£ä¸–å°”ç§‘æŠ€',
                        deliveryDays: 5,
                        minOrderQty: 1
                    },
                    { 
                        id: 3, 
                        code: '0201000001', 
                        name: 'å®¹é‡ç“¶ï¼ˆAçº§ï¼‰', 
                        cas: '',
                        artNo: 'GBW-100',
                        brand: 'å¤©ç»',
                        spec: '100mlï¼Œç¡¼ç¡…ç»ç’ƒ', 
                        price: 35.00, 
                        stock: 200, 
                        category: 'consumable', 
                        supplierId: 'S003', 
                        supplierName: 'å›½è¯é›†å›¢åŒ–å­¦è¯•å‰‚',
                        deliveryDays: 2,
                        minOrderQty: 5
                    }
                ],
                
                departments: [
                    { code: 'ORG001', name: 'æœ‰æœºåˆ†æå®éªŒå®¤' },
                    { code: 'ORG002', name: 'æ— æœºåˆ†æå®éªŒå®¤' },
                    { code: 'ORG003', name: 'å¾®ç”Ÿç‰©æ£€æµ‹éƒ¨' },
                    { code: 'ORG004', name: 'è´¨æ§éƒ¨' }
                ],
                
                // å¸¸ç”¨åœ°å€åˆ—è¡¨
                addressList: [
                    {
                        id: 1,
                        institution: 'ä¸­å¿ƒå®éªŒå®¤',
                        department: 'æœ‰æœºåˆ†æå®éªŒå®¤',
                        contactName: 'å¼ ä¸‰',
                        contactPhone: '13800138000',
                        fullAddress: 'é™•è¥¿çœè¥¿å®‰å¸‚é›å¡”åŒºç§‘æŠ€è·¯XXXå·ä¸­å¿ƒå®éªŒå®¤Aæ ‹2æ¥¼203åº“æˆ¿',
                        isDefault: true
                    },
                    {
                        id: 2,
                        institution: 'ä¸­å¿ƒå®éªŒå®¤',
                        department: 'å¾®ç”Ÿç‰©æ£€æµ‹éƒ¨',
                        contactName: 'æå››',
                        contactPhone: '13900139000',
                        fullAddress: 'é™•è¥¿çœè¥¿å®‰å¸‚é›å¡”åŒºç§‘æŠ€è·¯XXXå·ä¸­å¿ƒå®éªŒå®¤Bæ ‹1æ¥¼105åº“æˆ¿',
                        isDefault: false
                    }
                ],
                
                toast: { show: false, message: '', type: 'success' },

                get subtotal() {
                    return this.products.reduce((sum, p) => sum + (p.subtotal || 0), 0);
                },
                
                get totalAmount() {
                    return this.subtotal;
                },
                
                get totalQuantity() {
                    return this.products.reduce((sum, p) => sum + (parseInt(p.quantity) || 0), 0);
                },
                
                get uniqueSuppliers() {
                    const suppliers = new Map();
                    this.products.forEach(p => {
                        if (p.supplierId) {
                            suppliers.set(p.supplierId, p.supplierName);
                        }
                    });
                    return Array.from(suppliers.entries());
                },
                
                // è®¡ç®—æœ€é•¿è´§æœŸ
                get maxDeliveryDays() {
                    if (this.products.length === 0) return 0;
                    return Math.max(...this.products.map(p => p.deliveryDays || 0));
                },
                
                get step1Valid() {
                    return this.form.institution && this.form.department && 
                           this.form.urgency && this.form.deliveryDate && 
                           this.form.deliveryTimeRange && this.products.length > 0 &&
                           this.products.every(p => p.supplierId && p.quantity >= p.minOrderQty);
                },
                
                get step2Valid() {
                    return this.form.address && this.form.contactName && this.form.contactPhone;
                },
                
                get allValid() {
                    return this.step1Valid && this.step2Valid;
                },
                
                get filteredProducts() {
                    return this.productLibrary.filter(p => {
                        const matchKeyword = !this.productModal.keyword || 
                            p.name.includes(this.productModal.keyword) || 
                            p.code.includes(this.productModal.keyword) ||
                            (p.cas && p.cas.includes(this.productModal.keyword)) ||
                            (p.artNo && p.artNo.includes(this.productModal.keyword));
                        const matchCategory = !this.productModal.category || p.category === this.productModal.category;
                        return matchKeyword && matchCategory;
                    });
                },

                init() {
                    // ç”Ÿæˆè®¢å•ç¼–å·ï¼šæœºæ„ç®€ç§°+æ—¥æœŸ+æµæ°´å·
                    const date = new Date().toISOString().slice(0,10).replace(/-/g,'');
                    this.form.orderNo = 'ä¸­å¿ƒå®éªŒå®¤-' + date + '-001';
                    
                    // è®¾ç½®é»˜è®¤äº¤è´§æ—¥æœŸä¸º7å¤©å
                    const defaultDate = new Date();
                    defaultDate.setDate(defaultDate.getDate() + 7);
                    this.form.deliveryDate = defaultDate.toISOString().split('T')[0];
                },

                getUrgencyText(urgency) {
                    const map = {
                        'normal': 'æ™®é€š',
                        'urgent': 'ç´§æ€¥',
                        'critical': 'ç‰¹æ€¥'
                    };
                    return map[urgency] || 'æ™®é€š';
                },
                
                getTimeRangeText(range) {
                    const map = {
                        'anytime': 'éšæ—¶',
                        'workday': 'å·¥ä½œæ—¥å‡å¯',
                        'worktime': 'ä»…å·¥ä½œæ—¶é—´ï¼ˆ9:00-18:00ï¼‰',
                        'morning': 'ä¸Šåˆï¼ˆ9:00-12:00ï¼‰',
                        'afternoon': 'ä¸‹åˆï¼ˆ14:00-18:00ï¼‰'
                    };
                    return map[range] || '-';
                },

                validateStep1() {
                    this.errors.department = !this.form.department ? 'è¯·é€‰æ‹©ç”³è¯·éƒ¨é—¨' : '';
                    this.errors.deliveryDate = !this.form.deliveryDate ? 'è¯·é€‰æ‹©æœŸæœ›é€è¾¾æ—¥æœŸ' : '';
                    this.errors.deliveryTimeRange = !this.form.deliveryTimeRange ? 'è¯·é€‰æ‹©æ”¶è´§æ—¶é—´èŒƒå›´' : '';
                    this.errors.products = this.products.length === 0 ? 'è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªå•†å“' : '';
                    
                    // æ£€æŸ¥æœ€å°èµ·è®¢é‡
                    const invalidQty = this.products.find(p => p.quantity < p.minOrderQty);
                    if (invalidQty) {
                        this.errors.products = `ã€${invalidQty.name}ã€‘æ•°é‡å°äºæœ€å°èµ·è®¢é‡${invalidQty.minOrderQty}`;
                    }
                    
                    Object.keys(this.errors).forEach(key => {
                        if (!this.errors[key]) delete this.errors[key];
                    });
                    
                    if (this.step1Valid) {
                        this.currentStep = 2;
                    }
                    return this.step1Valid;
                },
                
                validateStep2() {
                    this.errors.address = !this.form.address ? 'è¯·è¾“å…¥è¯¦ç»†æ”¶è´§åœ°å€' : '';
                    this.errors.contactName = !this.form.contactName ? 'è¯·è¾“å…¥æ”¶è´§äººå§“å' : '';
                    this.errors.contactPhone = !this.form.contactPhone ? 'è¯·è¾“å…¥è”ç³»ç”µè¯' : '';
                    if (this.form.contactPhone && !/^1[3-9]\d{9}$/.test(this.form.contactPhone)) {
                        this.errors.contactPhone = 'è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·';
                    }
                    
                    Object.keys(this.errors).forEach(key => {
                        if (!this.errors[key]) delete this.errors[key];
                    });
                    
                    if (this.step2Valid && this.step1Valid) {
                        this.currentStep = 3;
                    }
                    return this.step2Valid;
                },

                openProductModal() {
                    this.productModal.open = true;
                },
                closeProductModal() {
                    this.productModal.open = false;
                },
                
                addProduct(product) {
                    const exists = this.products.find(p => p.id === product.id);
                    if (exists) {
                        exists.quantity += 1;
                        this.calculateRow(this.products.indexOf(exists));
                        this.showToast('å•†å“æ•°é‡å·²å¢åŠ ', 'success');
                    } else {
                        this.products.push({
                            id: product.id,
                            code: product.code,
                            name: product.name,
                            cas: product.cas,
                            artNo: product.artNo,
                            brand: product.brand,
                            spec: product.spec,
                            price: product.price,
                            supplierId: product.supplierId,
                            supplierName: product.supplierName,
                            deliveryDays: product.deliveryDays,
                            minOrderQty: product.minOrderQty,
                            quantity: product.minOrderQty > 1 ? product.minOrderQty : 1,
                            unit: 'ä¸ª',
                            subtotal: product.price * (product.minOrderQty > 1 ? product.minOrderQty : 1),
                            remark: ''
                        });
                        this.validateStep1();
                        this.showToast(`å·²æ·»åŠ ã€${product.name}ã€‘`, 'success');
                    }
                },
                
                removeProduct(index) {
                    if (confirm('ç¡®å®šåˆ é™¤è¯¥å•†å“å—ï¼Ÿ')) {
                        this.products.splice(index, 1);
                        this.validateStep1();
                        this.showToast('å•†å“å·²åˆ é™¤', 'success');
                    }
                },
                
                calculateRow(index) {
                    const product = this.products[index];
                    product.subtotal = (parseFloat(product.price) || 0) * (parseInt(product.quantity) || 0);
                    // å®æ—¶æ ¡éªŒæœ€å°èµ·è®¢é‡
                    if (product.quantity < product.minOrderQty) {
                        this.showToast(`ã€${product.name}ã€‘æ•°é‡å°äºæœ€å°èµ·è®¢é‡${product.minOrderQty}`, 'error');
                    }
                },

                // å¸¸ç”¨åœ°å€é€‰æ‹©
                openAddressModal() {
                    this.addressModal.open = true;
                    this.addressModal.selectedId = null;
                },
                closeAddressModal() {
                    this.addressModal.open = false;
                },
                selectAddress(addr) {
                    this.addressModal.selectedId = addr.id;
                },
                confirmAddressSelection() {
                    const addr = this.addressList.find(a => a.id === this.addressModal.selectedId);
                    if (addr) {
                        this.form.address = addr.fullAddress;
                        this.form.contactName = addr.contactName;
                        this.form.contactPhone = addr.contactPhone;
                        this.showToast('åœ°å€å·²å¡«å……', 'success');
                    }
                    this.closeAddressModal();
                },

                validateAndSubmit() {
                    const step1 = this.validateStep1();
                    const step2 = this.validateStep2();
                    
                    if (!step1) {
                        this.scrollToSection('step1');
                        this.showToast('è¯·å®Œå–„è®¢å•åŸºæœ¬ä¿¡æ¯', 'error');
                        return;
                    }
                    
                    if (!step2) {
                        this.scrollToSection('step2');
                        this.showToast('è¯·å®Œå–„é…é€ä¸è”ç³»äººä¿¡æ¯', 'error');
                        return;
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ•°é‡ä¸è¶³çš„å•†å“
                    const invalidProducts = this.products.filter(p => p.quantity < p.minOrderQty);
                    if (invalidProducts.length > 0) {
                        this.showToast(`ã€${invalidProducts[0].name}ã€‘æ•°é‡å°äºæœ€å°èµ·è®¢é‡`, 'error');
                        return;
                    }
                    
                    const supplierInfo = this.uniqueSuppliers.length > 1 
                        ? `æ¶‰åŠ ${this.uniqueSuppliers.length} å®¶ä¾›åº”å•†ï¼Œå®¡æ‰¹é€šè¿‡åå°†æ‹†åˆ†ä¸ºå¤šä¸ªé€è´§å•` 
                        : `ä¾›åº”å•†ï¼š${this.products[0]?.supplierName || ''}`;
                    
                    if (confirm(`ç¡®è®¤æäº¤é‡‡è´­è®¢å•ï¼Ÿ\n\n${supplierInfo}\nè®¢å•é‡‘é¢ï¼šÂ¥${this.formatMoney(this.totalAmount)}\nå•†å“æ•°é‡ï¼š${this.totalQuantity} ä»¶`)) {
                        console.log('æäº¤æ•°æ®ï¼š', {
                            form: this.form,
                            products: this.products,
                            totalAmount: this.totalAmount,
                            supplierCount: this.uniqueSuppliers.length
                        });
                        this.showToast('é‡‡è´­è®¢å•å·²æäº¤å®¡æ‰¹ï¼', 'success');
                        setTimeout(() => {
                            if (confirm('æäº¤æˆåŠŸï¼æ˜¯å¦è¿”å›åˆ—è¡¨é¡µï¼Ÿ')) {
                                window.history.back();
                            }
                        }, 1500);
                    }
                },
                
                scrollToSection(id) {
                    document.getElementById(id).scrollIntoView({ behavior: 'smooth', block: 'center' });
                },

                saveDraft() {
                    localStorage.setItem('purchaseOrderDraft', JSON.stringify({
                        form: this.form,
                        products: this.products,
                        saveTime: new Date().toLocaleString()
                    }));
                    this.showToast('è‰ç¨¿å·²ä¿å­˜', 'success');
                },
                
                goBack() {
                    if (confirm('ç¡®å®šè¦ç¦»å¼€å—ï¼Ÿæœªä¿å­˜çš„æ›´æ”¹å°†ä¸¢å¤±ã€‚')) {
                        window.history.back();
                    }
                },
                
                formatMoney(amount) {
                    return amount.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                },
                
                showToast(message, type = 'success') {
                    this.toast = { show: true, message, type };
                    setTimeout(() => this.toast.show = false, 3000);
                }
            }
        }
    </script>
</body>
</html>
