<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>收货入库管理</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Inter', system-ui, sans-serif; background-color: #f1f5f9; }
        
        .form-label { 
            display: block; 
            font-size: 13px; 
            font-weight: 600; 
            color: #475569; 
            margin-bottom: 6px; 
        }
        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
            background: white;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }
        .form-input:disabled {
            background-color: #f1f5f9;
            color: #64748b;
            cursor: not-allowed;
        }
        .form-input.error {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        
        /* 状态标签样式 */
        .status-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        .status-draft { background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }
        .status-confirmed { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
        .status-processing { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
        .status-pending { background: #c7d2fe; color: #3730a3; border: 1px solid #a5b4fc; }
        .status-rejected { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .status-completed { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
        
        .badge-rejected {
            background: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 6px;
        }
        
        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }
        .timeline-step::after {
            content: '';
            position: absolute;
            top: 16px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #e2e8f0;
            z-index: 0;
        }
        .timeline-step:last-child::after {
            display: none;
        }
        .timeline-step.completed::after {
            background: #10b981;
        }
        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            z-index: 1;
            background: white;
            border: 2px solid #cbd5e1;
            color: #64748b;
        }
        .timeline-step.active .step-circle {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
            box-shadow: 0 0 0 4px rgba(59,130,246,0.2);
        }
        .timeline-step.completed .step-circle {
            border-color: #10b981;
            background: #10b981;
            color: white;
        }
        .timeline-step.rejected .step-circle {
            border-color: #ef4444;
            background: #ef4444;
            color: white;
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            border: none;
        }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-secondary { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; }
        .btn-secondary:hover { background: #e2e8f0; }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .stockin-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
        }
        .stockin-card.rejected {
            border-left: 4px solid #ef4444;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        .reject-reason-box {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
        }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col" x-data="deliveryApp()">

    <!-- 顶部导航 -->
    <header class="bg-white border-b border-slate-200 h-14 px-6 flex justify-between items-center flex-shrink-0 z-20">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                <i class="fa-solid fa-file-invoice text-white text-sm"></i>
            </div>
            <h1 class="text-lg font-bold text-slate-800">收货入库管理</h1>
        </div>
        <div class="flex items-center gap-3">
            <button @click="currentView = 'list'" class="text-sm text-slate-600 hover:text-blue-600 font-medium px-3 py-1.5 rounded-lg hover:bg-slate-50 transition">
                <i class="fa-solid fa-list mr-1"></i>返回列表
            </button>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-1 overflow-hidden bg-slate-50 flex">
        
        <!-- 左侧：送货单列表 -->
        <div x-show="currentView === 'list'" class="flex-1 flex flex-col p-4 overflow-hidden" x-cloak>
            <!-- 筛选栏 -->
            <div class="bg-white p-4 rounded-lg border border-slate-200 mb-4 flex flex-wrap gap-4 items-end shadow-sm">
                <div class="flex-1 min-w-[200px]">
                    <label class="form-label">搜索</label>
                    <div class="relative">
                        <i class="fa-solid fa-search absolute left-3 top-2.5 text-slate-400 text-sm"></i>
                        <input type="text" x-model="filters.keyword" placeholder="送货单号/订单号/供应商" 
                               class="form-input pl-9" @input.debounce.300="applyFilters()">
                    </div>
                </div>
                <div class="w-44">
                    <label class="form-label">状态</label>
                    <select x-model="filters.status" class="form-input" @change="applyFilters()">
                        <option value="">全部状态</option>
                        <option value="draft">待确认</option>
                        <option value="confirmed">待送货</option>
                        <option value="processing">待完成</option>
                        <option value="pending">待审批</option>
                        <option value="rejected">已驳回</option>
                        <option value="completed">已完成</option>
                    </select>
                </div>
                <div class="w-40">
                    <label class="form-label">供应商</label>
                    <select x-model="filters.supplier" class="form-input" @change="applyFilters()">
                        <option value="">全部供应商</option>
                        <template x-for="sup in suppliers" :key="sup">
                            <option :value="sup" x-text="sup"></option>
                        </template>
                    </select>
                </div>
                <button @click="resetFilters()" class="btn btn-secondary mb-0.5">
                    <i class="fa-solid fa-rotate-left"></i> 重置
                </button>
            </div>

            <!-- 列表 -->
            <div class="flex-1 bg-white rounded-lg border border-slate-200 overflow-hidden flex flex-col shadow-sm">
                <div class="overflow-auto flex-1">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-50 sticky top-0 z-10">
                            <tr>
                                <th class="px-4 py-3 text-left font-semibold text-slate-600 border-b w-36">送货单编号</th>
                                <th class="px-4 py-3 text-left font-semibold text-slate-600 border-b">关联订单</th>
                                <th class="px-4 py-3 text-left font-semibold text-slate-600 border-b">供应商</th>
                                <th class="px-4 py-3 text-center font-semibold text-slate-600 border-b w-24">商品种数</th>
                                <th class="px-4 py-3 text-center font-semibold text-slate-600 border-b w-32">收货进度</th>
                                <th class="px-4 py-3 text-center font-semibold text-slate-600 border-b w-36">状态</th>
                                <th class="px-4 py-3 text-center font-semibold text-slate-600 border-b w-32">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="item in paginatedData" :key="item.id">
                                <tr class="border-b border-slate-100 hover:bg-slate-50 cursor-pointer" @click="viewDetail(item)">
                                    <td class="px-4 py-3 font-mono font-medium text-slate-700" x-text="item.code"></td>
                                    <td class="px-4 py-3 text-slate-600" x-text="item.orderCode"></td>
                                    <td class="px-4 py-3">
                                        <div class="font-medium text-slate-800" x-text="item.supplierName"></div>
                                        <div class="text-xs text-slate-400 mt-0.5" x-text="item.supplierContact"></div>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="font-medium" x-text="item.products.length"></span>
                                        <span class="text-xs text-slate-400">种</span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="flex items-center justify-center gap-2">
                                            <div class="w-20 h-2 bg-slate-200 rounded-full overflow-hidden">
                                                <div class="h-full rounded-full transition-all" 
                                                     :style="`width: ${getProgress(item)}%`"
                                                     :class="getProgress(item) === 100 ? 'bg-emerald-500' : 'bg-blue-500'"></div>
                                            </div>
                                            <span class="text-xs font-medium text-slate-600" x-text="getProgress(item) + '%'"></span>
                                        </div>
                                        <div class="text-xs text-center mt-1 text-slate-400">
                                            <span x-text="item.totalReceived"></span>/<span x-text="item.totalQty"></span>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <div class="flex items-center justify-center">
                                            <span class="status-tag" :class="'status-' + item.status" x-text="getStatusText(item.status)"></span>
                                            <span x-show="item.status === 'rejected'" class="badge-rejected">已驳回</span>
                                        </div>
                                        <div x-show="item.status === 'rejected' && item.rejectInfo" class="text-xs text-red-600 mt-1 truncate max-w-[150px]" x-text="'原因: ' + item.rejectInfo.reason"></div>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <div class="flex items-center justify-center gap-1" @click.stop>
                                            <!-- 待确认：确认按钮 -->
                                            <button x-show="item.status === 'draft'" @click="confirmDelivery(item)" 
                                                    class="btn btn-warning text-xs py-1.5 px-3">
                                                <i class="fa-solid fa-check"></i> 确认
                                            </button>
                                            
                                            <!-- 待送货/待完成/已驳回：收货入库 -->
                                            <button x-show="['confirmed', 'processing', 'rejected'].includes(item.status)" @click="openStockIn(item)" 
                                                    class="btn btn-primary text-xs py-1.5 px-3">
                                                <i class="fa-solid fa-box-open"></i> 
                                                <span x-text="item.status === 'rejected' ? '确认入库' : '收货入库'"></span>
                                            </button>
                                            
                                            <!-- 待审批：查看并审批（如果是审批人角色） -->
                                            <button x-show="item.status === 'pending'" @click="viewDetail(item)" 
                                                    class="btn btn-secondary text-xs py-1.5 px-3">
                                                <i class="fa-solid fa-eye"></i> 立即审批
                                            </button>
                                            
                                            <!-- 已完成：查看 -->
                                            <button x-show="item.status === 'completed'" @click="viewDetail(item)" 
                                                    class="btn btn-secondary text-xs py-1.5 px-3">
                                                <i class="fa-solid fa-eye"></i> 查看
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="filteredData.length === 0">
                                <td colspan="7" class="px-4 py-16 text-center text-slate-400">
                                    <i class="fa-regular fa-folder-open text-4xl mb-2 block"></i>
                                    暂无符合条件的送货单
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页 -->
                <div class="border-t border-slate-200 px-4 py-3 flex items-center justify-between bg-slate-50">
                    <div class="text-xs text-slate-500">
                        显示 <span x-text="(currentPage-1)*pageSize+1"></span>-<span x-text="Math.min(currentPage*pageSize, filteredData.length)"></span> 条，共 <span x-text="filteredData.length"></span> 条
                    </div>
                    <div class="flex gap-1">
                        <button @click="currentPage--" :disabled="currentPage===1" class="px-2 py-1 border rounded hover:bg-white disabled:opacity-50 text-sm">
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>
                        <template x-for="p in totalPages" :key="p">
                            <button @click="currentPage=p" 
                                    :class="currentPage===p ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-600 border-slate-300 hover:border-blue-400'"
                                    class="px-3 py-1 border rounded text-sm font-medium min-w-[32px]">
                                <span x-text="p"></span>
                            </button>
                        </template>
                        <button @click="currentPage++" :disabled="currentPage===totalPages" class="px-2 py-1 border rounded hover:bg-white disabled:opacity-50 text-sm">
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧：送货单详情 -->
        <div x-show="currentView === 'detail'" class="flex-1 overflow-y-auto p-4" x-cloak>
            <div class="max-w-6xl mx-auto space-y-4 animate-slide-in">
                
                <!-- 基本信息卡片 -->
                <div class="card p-6">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <div class="flex items-center gap-3 mb-2 flex-wrap">
                                <h2 class="text-xl font-bold text-slate-800">送货单详情</h2>
                                <span class="status-tag" :class="'status-' + currentDelivery.status" x-text="getStatusText(currentDelivery.status)"></span>
                                <span x-show="currentDelivery.status === 'rejected'" class="badge-rejected">已驳回</span>
                                <span x-show="currentDelivery.isPartial && currentDelivery.status !== 'completed'" class="px-2 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-bold">部分入库</span>
                            </div>
                            <p class="text-sm text-slate-500">
                                <span x-show="currentDelivery.status === 'draft'">订单审批通过后自动生成，请与供应商确认无误后操作</span>
                                <span x-show="currentDelivery.status === 'confirmed'">已确认，等待收货入库</span>
                                <span x-show="currentDelivery.status === 'processing'">部分商品已入库，请继续完成剩余入库</span>
                                <span x-show="currentDelivery.status === 'pending'">已全部入库，等待业务负责人审批</span>
                                <span x-show="currentDelivery.status === 'rejected'">审批被驳回，请查看原因并重新处理</span>
                                <span x-show="currentDelivery.status === 'completed'">已完成，审批通过</span>
                            </p>
                        </div>
                        <div class="flex gap-2 flex-wrap justify-end">
                            <!-- 待确认：确认按钮 -->
                            <button x-show="currentDelivery.status === 'draft'" @click="confirmDelivery(currentDelivery)" class="btn btn-warning">
                                <i class="fa-solid fa-check"></i> 确认送货单
                            </button>
                            
                            <!-- 待送货/待完成/已驳回：收货入库（驳回后显示确认入库） -->
                            <button x-show="['confirmed', 'processing', 'rejected'].includes(currentDelivery.status)" @click="openStockInModal()" class="btn btn-primary">
                                <i class="fa-solid fa-box-open"></i> 
                                <span x-text="currentDelivery.status === 'rejected' ? '确认入库' : '登记入库'"></span>
                            </button>
                            
                            <!-- 待审批：审批操作（模拟审批人视角） -->
                            <template x-if="currentDelivery.status === 'pending'">
                                <div class="flex gap-2">
                                    <button @click="openApproveModal()" class="btn btn-success">
                                        <i class="fa-solid fa-check"></i> 审批通过
                                    </button>
                                    <button @click="openRejectModal()" class="btn btn-danger">
                                        <i class="fa-solid fa-xmark"></i> 驳回
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="bg-slate-50 p-3 rounded border border-slate-200">
                            <div class="text-xs text-slate-500 mb-1">送货单编号</div>
                            <div class="font-mono font-bold text-slate-800" x-text="currentDelivery.code"></div>
                        </div>
                        <div class="bg-slate-50 p-3 rounded border border-slate-200">
                            <div class="text-xs text-slate-500 mb-1">关联订单号</div>
                            <div class="font-mono font-bold text-slate-800" x-text="currentDelivery.orderCode"></div>
                        </div>
                        <div class="bg-slate-50 p-3 rounded border border-slate-200">
                            <div class="text-xs text-slate-500 mb-1">供应商</div>
                            <div class="font-bold text-slate-800" x-text="currentDelivery.supplierName"></div>
                        </div>
                        <div class="bg-slate-50 p-3 rounded border border-slate-200">
                            <div class="text-xs text-slate-500 mb-1">创建时间</div>
                            <div class="font-bold text-slate-800" x-text="currentDelivery.createTime"></div>
                        </div>
                    </div>

                    <!-- 流程时间线 -->
                    <div class="bg-slate-50 rounded-lg p-6 border border-slate-200">
                        <h3 class="text-sm font-bold text-slate-700 mb-4">处理进度</h3>
                        <div class="flex items-start">
                            <template x-for="(step, idx) in timelineSteps" :key="idx">
                                <div class="timeline-step" 
                                     :class="{
                                         'completed': isStepCompleted(step.value), 
                                         'active': currentDelivery.status === step.value,
                                         'rejected': step.value === 'rejected' && currentDelivery.status === 'rejected'
                                     }">
                                    <div class="step-circle">
                                        <i class="fa-solid" :class="getStepIcon(step.value)"></i>
                                    </div>
                                    <div class="mt-2 text-xs font-medium text-slate-700 text-center" x-text="step.label"></div>
                                    <div class="text-xs text-slate-400 mt-1 text-center" x-text="getStepTime(step.value)"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- 驳回原因显示（如果被驳回） -->
                    <div x-show="currentDelivery.status === 'rejected' && currentDelivery.rejectInfo" class="reject-reason-box mt-4">
                        <div class="flex items-start gap-3">
                            <i class="fa-solid fa-circle-exclamation text-red-500 mt-0.5"></i>
                            <div class="flex-1">
                                <div class="text-sm font-bold text-red-800 mb-1">审批驳回原因</div>
                                <div class="text-sm text-red-700" x-text="currentDelivery.rejectInfo?.reason"></div>
                                <div class="text-xs text-red-600 mt-2 flex gap-4">
                                    <span>审批人：<span x-text="currentDelivery.rejectInfo?.approver"></span></span>
                                    <span>时间：<span x-text="currentDelivery.rejectInfo?.time"></span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 商品明细 -->
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-800">商品送货明细</h3>
                        <div class="text-sm">
                            <span class="text-slate-500 mr-4">送货总数：<span class="font-bold text-slate-800" x-text="currentDelivery.totalQty"></span></span>
                            <span class="text-slate-500 mr-4">累计入库：<span class="font-bold text-emerald-600" x-text="currentDelivery.totalReceived"></span></span>
                            <span class="text-slate-500" x-show="currentDelivery.totalLoss > 0">损耗：<span class="font-bold text-red-600" x-text="currentDelivery.totalLoss"></span></span>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-sm border-collapse">
                            <thead>
                                <tr class="bg-slate-50 border-b border-slate-200">
                                    <th class="px-3 py-3 text-left font-semibold text-slate-600 w-12">序号</th>
                                    <th class="px-3 py-3 text-left font-semibold text-slate-600">商品名称</th>
                                    <th class="px-3 py-3 text-left font-semibold text-slate-600">CAS号</th>
                                    <th class="px-3 py-3 text-left font-semibold text-slate-600">规格</th>
                                    <th class="px-3 py-3 text-left font-semibold text-slate-600">货号</th>
                                    <th class="px-3 py-3 text-left font-semibold text-slate-600">品牌</th>
                                    <th class="px-3 py-3 text-center font-semibold text-slate-600">单位</th>
                                    <th class="px-3 py-3 text-right font-semibold text-slate-600">送货数量</th>
                                    <th class="px-3 py-3 text-right font-semibold text-slate-600">已入库</th>
                                    <th class="px-3 py-3 text-right font-semibold text-slate-600">待入库</th>
                                    <th class="px-3 py-3 text-center font-semibold text-slate-600">状态</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(prod, idx) in currentDelivery.products" :key="idx">
                                    <tr class="border-b border-slate-100 hover:bg-slate-50">
                                        <td class="px-3 py-3 text-slate-500" x-text="idx + 1"></td>
                                        <td class="px-3 py-3 font-medium text-slate-800" x-text="prod.name"></td>
                                        <td class="px-3 py-3 font-mono text-slate-600 text-xs" x-text="prod.cas || '-'"></td>
                                        <td class="px-3 py-3 text-slate-600 text-xs" x-text="prod.spec"></td>
                                        <td class="px-3 py-3 font-mono text-slate-600 text-xs" x-text="prod.itemNo"></td>
                                        <td class="px-3 py-3 text-slate-600 text-xs" x-text="prod.brand"></td>
                                        <td class="px-3 py-3 text-center text-slate-600 text-xs" x-text="prod.unit"></td>
                                        <td class="px-3 py-3 text-right font-bold text-slate-800" x-text="prod.qty"></td>
                                        <td class="px-3 py-3 text-right font-bold text-emerald-600" x-text="prod.receivedQty || 0"></td>
                                        <td class="px-3 py-3 text-right font-bold" 
                                            :class="(prod.remainingQty || 0) > 0 ? 'text-amber-600' : 'text-slate-400'"
                                            x-text="prod.remainingQty || 0"></td>
                                        <td class="px-3 py-3 text-center">
                                            <span x-show="(prod.remainingQty || 0) === 0" class="px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 text-xs font-bold">已完成</span>
                                            <span x-show="(prod.remainingQty || 0) > 0 && (prod.receivedQty || 0) > 0" class="px-2 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-bold">进行中</span>
                                            <span x-show="(prod.receivedQty || 0) === 0" class="px-2 py-1 rounded-full bg-slate-100 text-slate-600 text-xs font-bold">待入库</span>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 入库记录 -->
                <div class="card p-6" x-show="currentDelivery.stockInRecords && currentDelivery.stockInRecords.length > 0">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-800">入库明细记录</h3>
                        <span class="text-xs text-slate-500">共 <span x-text="currentDelivery.stockInRecords.length"></span> 批次</span>
                    </div>

                    <div class="space-y-3">
                        <template x-for="(record, rIdx) in currentDelivery.stockInRecords" :key="rIdx">
                            <div class="stockin-card" :class="{'rejected': record.isRejected}">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex items-center gap-3">
                                        <span class="px-2 py-1 rounded bg-blue-100 text-blue-700 text-xs font-bold">入库 #<span x-text="rIdx + 1"></span></span>
                                        <span class="text-sm text-slate-500"><i class="fa-regular fa-clock mr-1"></i><span x-text="record.time"></span></span>
                                        <span class="text-sm text-slate-500"><i class="fa-regular fa-user mr-1"></i><span x-text="record.operator"></span></span>
                                    </div>
                                    <div class="flex gap-2">
                                        <span x-show="record.lossQty > 0" class="px-2 py-1 rounded bg-red-100 text-red-700 text-xs font-bold">
                                            损耗 <span x-text="record.lossQty"></span> 件
                                        </span>
                                    </div>
                                </div>
                                
                                <table class="w-full text-sm">
                                    <thead class="text-xs text-slate-500 border-b border-slate-200">
                                        <tr>
                                            <th class="text-left py-2 font-medium">商品名称</th>
                                            <th class="text-center py-2 font-medium w-24">入库数量</th>
                                            <th class="text-center py-2 font-medium w-24">损耗数量</th>
                                            <th class="text-left py-2 font-medium">损耗原因</th>
                                            <th class="text-left py-2 font-medium">备注</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-sm">
                                        <template x-for="(item, iIdx) in record.items" :key="iIdx">
                                            <tr class="border-t border-slate-100 last:border-0">
                                                <td class="py-2 font-medium text-slate-800" x-text="item.productName"></td>
                                                <td class="py-2 text-center font-bold text-emerald-600" x-text="item.qty"></td>
                                                <td class="py-2 text-center" :class="item.lossQty > 0 ? 'text-red-600 font-bold' : 'text-slate-400'" x-text="item.lossQty || 0"></td>
                                                <td class="py-2 text-sm text-slate-600" x-text="item.lossReason || '-'"></td>
                                                <td class="py-2 text-sm text-slate-500" x-text="item.remark || '-'"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                                
                                <!-- 如果这条记录被驳回，显示原因 -->
                                <div x-show="record.rejectReason" class="mt-3 p-3 bg-red-50 border border-red-200 rounded text-sm text-red-700">
                                    <div class="font-bold mb-1">驳回原因：</div>
                                    <div x-text="record.rejectReason"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- 审批记录 -->
                <div x-show="currentDelivery.approveInfo" class="card p-6 bg-emerald-50 border-emerald-200">
                    <h3 class="text-lg font-bold text-emerald-800 mb-3">审批记录</h3>
                    <div class="flex items-center gap-6 text-sm">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-check-circle text-emerald-600 text-lg"></i>
                            <span class="font-bold text-emerald-900" x-text="currentDelivery.approveInfo?.approver"></span>
                        </div>
                        <div class="text-emerald-700" x-text="currentDelivery.approveInfo?.time"></div>
                        <div class="text-emerald-700" x-text="currentDelivery.approveInfo?.comment || '审批通过'"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 登记入库弹窗（已去掉结算单价，时间操作人自动获取） -->
    <div x-show="showStockInModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4" x-cloak @click.self="closeStockInModal()">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col animate-slide-in">
            <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <div>
                    <h3 class="text-lg font-bold text-slate-800">收货入库登记</h3>
                    <p class="text-sm text-slate-500 mt-1">
                        <span x-show="currentDelivery.status === 'rejected'">重新入库，请确保数量准确</span>
                        <span x-show="currentDelivery.status !== 'rejected'">支持部分入库，全部入库完成后自动提交审批</span>
                    </p>
                </div>
                <button @click="closeStockInModal()" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 custom-scroll">
                <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg flex justify-between items-center">
                    <div class="text-sm">
                        <span class="text-slate-600">送货单号：</span>
                        <span class="font-mono font-bold text-blue-800" x-text="currentDelivery.code"></span>
                    </div>
                    <div class="text-sm">
                        <span class="text-slate-600">供应商：</span>
                        <span class="font-bold text-blue-800" x-text="currentDelivery.supplierName"></span>
                    </div>
                </div>

                <!-- 自动获取信息显示 -->
                <div class="mb-4 p-3 bg-slate-50 rounded-lg border border-slate-200 flex gap-6 text-sm">
                    <div>
                        <span class="text-slate-500">入库时间：</span>
                        <span class="font-bold text-slate-800" x-text="currentTime"></span>
                    </div>
                    <div>
                        <span class="text-slate-500">操作人：</span>
                        <span class="font-bold text-slate-800" x-text="currentUser"></span>
                    </div>
                </div>

                <div class="space-y-4">
                    <template x-for="(item, idx) in stockInForm.items" :key="idx">
                        <div class="border border-slate-200 rounded-lg p-4" :class="item.isCompleted ? 'bg-slate-50 opacity-75' : 'bg-white'">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <div class="font-bold text-slate-800 mb-1" x-text="item.productName"></div>
                                    <div class="text-xs text-slate-500 space-x-3">
                                        <span>CAS: <span class="font-mono" x-text="item.cas || '-'"></span></span>
                                        <span>货号: <span class="font-mono" x-text="item.itemNo"></span></span>
                                        <span>规格: <span x-text="item.spec"></span></span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-slate-800" x-text="item.remainingQty + ' ' + item.unit"></div>
                                    <div class="text-xs text-slate-500">剩余待入库</div>
                                    <div class="text-xs text-slate-400 mt-1">送货: <span x-text="item.totalQty"></span> | 已收: <span x-text="item.receivedQty"></span></div>
                                </div>
                            </div>

                            <div x-show="!item.isCompleted" class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="form-label">本次入库 <span class="text-red-500">*</span></label>
                                    <input type="number" x-model.number="item.qty" min="0" :max="item.remainingQty"
                                           class="form-input text-center font-bold text-lg" 
                                           :class="item.qty > item.remainingQty ? 'error' : ''">
                                    <div x-show="item.qty > item.remainingQty" class="text-xs text-red-500 mt-1">超出待收数量</div>
                                </div>
                                <div>
                                    <label class="form-label">损耗数量</label>
                                    <input type="number" x-model.number="item.lossQty" min="0" :max="item.qty"
                                           class="form-input text-center">
                                </div>
                                <div>
                                    <label class="form-label">损耗原因</label>
                                    <select x-model="item.lossReason" class="form-input text-sm" 
                                            :class="item.lossQty > 0 && !item.lossReason ? 'error' : ''">
                                        <option value="">请选择</option>
                                        <option value="运输破损">运输破损</option>
                                        <option value="质量不合格">质量不合格</option>
                                        <option value="规格不符">规格/型号不符</option>
                                        <option value="数量短缺">数量短缺</option>
                                        <option value="过期临期">过期/临期</option>
                                        <option value="其他原因">其他原因</option>
                                    </select>
                                </div>
                                <div class="col-span-3">
                                    <label class="form-label">备注</label>
                                    <input type="text" x-model="item.remark" class="form-input text-sm" placeholder="可选填，如包装情况、批次号等">
                                </div>
                            </div>

                            <div x-show="item.isCompleted" class="flex items-center gap-2 text-emerald-600 font-medium py-4">
                                <i class="fa-solid fa-check-circle text-xl"></i>
                                <span>该商品已入库完成</span>
                            </div>
                        </div>
                    </template>
                </div>

                <div class="mt-6 text-xs text-slate-500 bg-yellow-50 p-3 rounded border border-yellow-200 flex items-start gap-2">
                    <i class="fa-solid fa-circle-info text-yellow-600 mt-0.5"></i>
                    <div>
                        <p>提示：若本次入库后仍有剩余数量，送货单将保持"待完成"状态，等待后续补货入库。</p>
                        <p class="mt-1 font-medium text-red-600">当所有商品入库数量与送货数量完全匹配时，确认入库后将自动提交审批。</p>
                    </div>
                </div>
            </div>

            <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex justify-between items-center">
                <div class="text-sm">
                    <span class="text-slate-600">本次入库合计：</span>
                    <span class="font-bold text-blue-600 text-lg" x-text="calculateCurrentStockInTotal()"></span>
                    <span class="text-slate-400 mx-2">|</span>
                    <span class="text-slate-600">入库后进度：</span>
                    <span class="font-bold" :class="isAllCompletedAfterThis() ? 'text-emerald-600' : 'text-amber-600'" x-text="getProgressAfterThis() + '%'"></span>
                    <span x-show="isAllCompletedAfterThis()" class="ml-2 text-xs text-emerald-600 font-bold">(将自动提交审批)</span>
                </div>
                <div class="flex gap-3">
                    <button @click="closeStockInModal()" class="btn btn-secondary">取消</button>
                    <button @click="saveStockIn()" :disabled="!isStockInValid()" 
                            class="btn btn-primary" :class="!isStockInValid() ? 'opacity-50 cursor-not-allowed' : ''">
                        <i class="fa-solid fa-check"></i> 
                        <span x-text="isAllCompletedAfterThis() ? '确认入库并提交审批' : '确认入库'"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 审批弹窗（通过 - 无需填写原因和审批人） -->
    <div x-show="showApproveModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4" x-cloak>
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 animate-slide-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fa-solid fa-clipboard-check"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-2">确认审批通过？</h3>
                <p class="text-sm text-slate-500">入库数量与送货单数量已完全匹配，审批通过后状态将变更为"已完成"</p>
            </div>

            <div class="bg-slate-50 rounded-lg p-4 mb-6 space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-slate-500">送货单号：</span>
                    <span class="font-mono font-bold" x-text="currentDelivery.code"></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-slate-500">入库总数：</span>
                    <span class="font-bold text-emerald-600" x-text="currentDelivery.totalReceived"></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-slate-500">送货总数：</span>
                    <span class="font-bold" x-text="currentDelivery.totalQty"></span>
                </div>
                <div class="flex justify-between" x-show="currentDelivery.totalLoss > 0">
                    <span class="text-slate-500">损耗总数：</span>
                    <span class="font-bold text-red-600" x-text="currentDelivery.totalLoss"></span>
                </div>
            </div>

            <div class="flex gap-3">
                <button @click="showApproveModal = false" class="flex-1 btn btn-secondary">取消</button>
                <button @click="confirmApprove()" class="flex-1 btn btn-success">
                    确认通过
                </button>
            </div>
        </div>
    </div>

    <!-- 驳回弹窗（必须填写原因） -->
    <div x-show="showRejectModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4" x-cloak>
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 animate-slide-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fa-solid fa-circle-xmark"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-2">审批驳回</h3>
                <p class="text-sm text-slate-500">请填写驳回原因，业务人员将重新处理</p>
            </div>

            <div class="space-y-4 mb-6">
                <div>
                    <label class="form-label">驳回原因 <span class="text-red-500">*</span></label>
                    <textarea x-model="rejectForm.reason" rows="3" class="form-input" placeholder="请详细说明驳回原因，如数量不符、质量问题等..." required></textarea>
                </div>
            </div>

            <div class="flex gap-3">
                <button @click="showRejectModal = false" class="flex-1 btn btn-secondary">取消</button>
                <button @click="confirmReject()" :disabled="!rejectForm.reason" 
                        class="flex-1 btn btn-danger" :class="!rejectForm.reason ? 'opacity-50' : ''">
                    确认驳回
                </button>
            </div>
        </div>
    </div>

    <!-- Toast提示 -->
    <div x-show="toast.show" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-2"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition ease-in duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed top-6 right-6 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-2xl z-[100] flex items-center gap-3">
        <i class="fa-solid" :class="toast.type === 'success' ? 'fa-check-circle text-emerald-400' : 'fa-circle-exclamation text-rose-400'"></i>
        <span class="text-sm font-medium" x-text="toast.message"></span>
    </div>

    <script>
        function deliveryApp() {
            return {
                currentView: 'list',
                currentPage: 1,
                pageSize: 10,
                showStockInModal: false,
                showApproveModal: false,
                showRejectModal: false,
                
                // 模拟自动获取的系统信息
                currentUser: '当前操作员', // 实际应从系统登录信息获取
                currentTime: new Date().toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }),
                
                filters: {
                    keyword: '',
                    status: '',
                    supplier: ''
                },

                timelineSteps: [
                    { value: 'draft', label: '待确认' },
                    { value: 'confirmed', label: '待送货' },
                    { value: 'processing', label: '待完成' },
                    { value: 'pending', label: '待审批' },
                    { value: 'completed', label: '已完成' }
                ],

                stockInForm: {
                    items: []
                },

                rejectForm: {
                    reason: ''
                },

                suppliers: ['西安化学试剂有限公司', '赛默飞世尔科技', 'Sigma-Aldrich', '国药集团化学试剂'],

                // 示例数据
                deliveryOrders: [
                    {
                        id: 1,
                        code: 'SHD-20240115-001',
                        orderCode: 'ORD-20240115-001',
                        supplierName: '西安化学试剂有限公司',
                        supplierContact: '张经理 029-88886666',
                        createTime: '2024-01-15 10:00',
                        status: 'draft', // draft:待确认, confirmed:待送货, processing:待完成, pending:待审批, rejected:已驳回, completed:已完成
                        isPartial: false,
                        totalQty: 100,
                        totalReceived: 0,
                        totalLoss: 0,
                        products: [
                            { name: '甲醇（色谱级）', cas: '67-56-1', spec: '4L/瓶，HPLC级', itemNo: 'M1775', brand: 'Sigma', unit: '瓶', qty: 50, receivedQty: 0, remainingQty: 50 },
                            { name: 'C18色谱柱', cas: '-', spec: '4.6×250mm，5μm', itemNo: '28905', brand: 'Agilent', unit: '支', qty: 20, receivedQty: 0, remainingQty: 20 },
                            { name: '一次性离心管', cas: '-', spec: '10ml，无菌无酶', itemNo: 'CT-10', brand: 'Corning', unit: '袋', qty: 30, receivedQty: 0, remainingQty: 30 }
                        ],
                        stockInRecords: [],
                        approveInfo: null,
                        rejectInfo: null
                    },
                    {
                        id: 2,
                        code: 'SHD-20240114-002',
                        orderCode: 'ORD-20240114-089',
                        supplierName: '赛默飞世尔科技',
                        supplierContact: '李经理 400-820-3360',
                        createTime: '2024-01-14 14:30',
                        status: 'confirmed',
                        isPartial: false,
                        totalQty: 25,
                        totalReceived: 0,
                        totalLoss: 0,
                        products: [
                            { name: '乙腈（色谱级）', cas: '75-05-8', spec: '4L/瓶', itemNo: 'A998', brand: 'Thermo', unit: '瓶', qty: 20, receivedQty: 0, remainingQty: 20 },
                            { name: '滤膜', cas: '-', spec: '0.22μm，水系', itemNo: 'FG-022', brand: 'Thermo', unit: '盒', qty: 5, receivedQty: 0, remainingQty: 5 }
                        ],
                        stockInRecords: [],
                        approveInfo: null,
                        rejectInfo: null
                    },
                    {
                        id: 3,
                        code: 'SHD-20240113-003',
                        orderCode: 'ORD-20240113-056',
                        supplierName: '国药集团化学试剂',
                        supplierContact: '王经理 021-12345678',
                        createTime: '2024-01-13 09:00',
                        status: 'processing',
                        isPartial: true,
                        totalQty: 100,
                        totalReceived: 60,
                        totalLoss: 2,
                        products: [
                            { name: '乙醇（分析纯）', cas: '64-17-5', spec: '500ml/瓶', itemNo: 'E1110', brand: 'SCRC', unit: '瓶', qty: 100, receivedQty: 60, remainingQty: 40 }
                        ],
                        stockInRecords: [
                            {
                                time: '2024-01-13 10:30',
                                operator: '张三',
                                lossQty: 2,
                                items: [
                                    { productName: '乙醇（分析纯）', qty: 50, lossQty: 2, lossReason: '运输破损', remark: '外箱破损2瓶' },
                                    { productName: '乙醇（分析纯）', qty: 10, lossQty: 0, lossReason: '', remark: '' }
                                ],
                                isRejected: false
                            }
                        ],
                        approveInfo: null,
                        rejectInfo: null
                    },
                    {
                        id: 4,
                        code: 'SHD-20240112-004',
                        orderCode: 'ORD-20240112-042',
                        supplierName: 'Sigma-Aldrich',
                        supplierContact: '张代理 021-61415566',
                        createTime: '2024-01-12 11:20',
                        status: 'pending',
                        isPartial: false,
                        totalQty: 50,
                        totalReceived: 50,
                        totalLoss: 0,
                        products: [
                            { name: '标准品套装', cas: 'Mix', spec: '1ml×10支', itemNo: 'ST-001', brand: 'Sigma', unit: '套', qty: 50, receivedQty: 50, remainingQty: 0 }
                        ],
                        stockInRecords: [
                            {
                                time: '2024-01-12 14:00',
                                operator: '李四',
                                lossQty: 0,
                                items: [
                                    { productName: '标准品套装', qty: 50, lossQty: 0, lossReason: '', remark: '' }
                                ],
                                isRejected: false
                            }
                        ],
                        approveInfo: null,
                        rejectInfo: null
                    },
                    {
                        id: 5,
                        code: 'SHD-20240111-005',
                        orderCode: 'ORD-20240111-038',
                        supplierName: '西安化学试剂有限公司',
                        supplierContact: '张经理 029-88886666',
                        createTime: '2024-01-11 10:00',
                        status: 'rejected',
                        isPartial: false,
                        totalQty: 80,
                        totalReceived: 80,
                        totalLoss: 5,
                        products: [
                            { name: '盐酸（分析纯）', cas: '7647-01-0', spec: '500ml/瓶', itemNo: 'H1750', brand: '本地品牌', unit: '瓶', qty: 80, receivedQty: 80, remainingQty: 0 }
                        ],
                        stockInRecords: [
                            {
                                time: '2024-01-11 15:00',
                                operator: '王五',
                                lossQty: 5,
                                items: [
                                    { productName: '盐酸（分析纯）', qty: 80, lossQty: 5, lossReason: '质量不合格', remark: '瓶盖密封不严' }
                                ],
                                isRejected: true,
                                rejectReason: ''
                            }
                        ],
                        approveInfo: null,
                        rejectInfo: {
                            approver: '系统管理员',
                            time: '2024-01-11 16:30',
                            reason: '损耗率过高，超过5%，请与供应商协商补货后重新提交'
                        }
                    },
                    {
                        id: 6,
                        code: 'SHD-20240110-006',
                        orderCode: 'ORD-20240110-025',
                        supplierName: '赛默飞世尔科技',
                        supplierContact: '李经理 400-820-3360',
                        createTime: '2024-01-10 09:30',
                        status: 'completed',
                        isPartial: false,
                        totalQty: 30,
                        totalReceived: 30,
                        totalLoss: 0,
                        products: [
                            { name: '气相色谱柱', cas: '-', spec: 'DB-5，30m×0.32mm', itemNo: '123-4567', brand: 'Agilent', unit: '支', qty: 30, receivedQty: 30, remainingQty: 0 }
                        ],
                        stockInRecords: [
                            {
                                time: '2024-01-10 14:00',
                                operator: '赵六',
                                lossQty: 0,
                                items: [
                                    { productName: '气相色谱柱', qty: 30, lossQty: 0, lossReason: '', remark: '' }
                                ],
                                isRejected: false
                            }
                        ],
                        approveInfo: {
                            approver: '系统管理员',
                            time: '2024-01-10 16:00',
                            comment: '数量准确，质量合格'
                        },
                        rejectInfo: null
                    }
                ],

                get filteredData() {
                    return this.deliveryOrders.filter(item => {
                        if (this.filters.keyword) {
                            const k = this.filters.keyword.toLowerCase();
                            if (!item.code.toLowerCase().includes(k) && 
                                !item.orderCode.toLowerCase().includes(k) &&
                                !item.supplierName.toLowerCase().includes(k)) return false;
                        }
                        if (this.filters.status) {
                            if (this.filters.status === 'processing') {
                                // 待完成包括processing和rejected（业务上的待完成）
                                if (!['processing', 'rejected'].includes(item.status)) return false;
                            } else {
                                if (item.status !== this.filters.status) return false;
                            }
                        }
                        if (this.filters.supplier && item.supplierName !== this.filters.supplier) return false;
                        return true;
                    });
                },

                get paginatedData() {
                    const start = (this.currentPage - 1) * this.pageSize;
                    return this.filteredData.slice(start, start + this.pageSize);
                },

                get totalPages() {
                    return Math.ceil(this.filteredData.length / this.pageSize);
                },

                get currentDelivery() {
                    return this.deliveryOrders.find(d => d.id === this.currentDeliveryId) || this.deliveryOrders[0];
                },

                currentDeliveryId: null,
                toast: { show: false, message: '', type: 'success' },

                init() {
                    this.deliveryOrders.forEach(order => this.calculateOrderStats(order));
                },

                calculateOrderStats(order) {
                    order.totalQty = order.products.reduce((sum, p) => sum + p.qty, 0);
                    order.totalReceived = order.products.reduce((sum, p) => sum + (p.receivedQty || 0), 0);
                    order.totalLoss = order.stockInRecords ? order.stockInRecords.reduce((sum, r) => sum + (r.lossQty || 0), 0) : 0;
                    order.isPartial = order.products.some(p => (p.remainingQty || 0) > 0 && (p.receivedQty || 0) > 0);
                },

                getProgress(item) {
                    if (item.totalQty === 0) return 0;
                    return Math.round((item.totalReceived / item.totalQty) * 100);
                },

                getStatusText(status) {
                    const map = {
                        'draft': '待确认',
                        'confirmed': '待送货',
                        'processing': '待完成',
                        'pending': '待审批',
                        'rejected': '待完成',  // 业务上显示为待完成，但标记已驳回
                        'completed': '已完成'
                    };
                    return map[status] || status;
                },

                applyFilters() {
                    this.currentPage = 1;
                },

                resetFilters() {
                    this.filters = { keyword: '', status: '', supplier: '' };
                    this.applyFilters();
                },

                viewDetail(item) {
                    this.currentDeliveryId = item.id;
                    this.currentView = 'detail';
                },

                confirmDelivery(item) {
                    if (confirm('确认已与供应商线下核对送货单信息无误？确认后状态将变更为"待送货"')) {
                        item.status = 'confirmed';
                        this.calculateOrderStats(item);
                        this.showToast('送货单已确认，状态更新为"待送货"', 'success');
                    }
                },

                openStockIn(item) {
                    if (item) {
                        this.currentDeliveryId = item.id;
                        this.currentView = 'detail';
                    }
                    this.initStockInForm();
                    // 更新时间
                    this.currentTime = new Date().toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                    this.showStockInModal = true;
                },
                
                openStockInModal() {
                    this.initStockInForm();
                    this.currentTime = new Date().toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                    this.showStockInModal = true;
                },

                initStockInForm() {
                    const delivery = this.currentDelivery;
                    this.stockInForm = {
                        items: delivery.products.map(p => ({
                            productId: p.id || Math.random().toString(36).substr(2, 9),
                            productName: p.name,
                            cas: p.cas,
                            spec: p.spec,
                            itemNo: p.itemNo,
                            brand: p.brand,
                            unit: p.unit,
                            totalQty: p.qty,
                            receivedQty: p.receivedQty || 0,
                            remainingQty: p.qty - (p.receivedQty || 0),
                            isCompleted: (p.qty - (p.receivedQty || 0)) <= 0,
                            qty: 0,
                            lossQty: 0,
                            lossReason: '',
                            remark: ''
                        }))
                    };
                },

                calculateCurrentStockInTotal() {
                    if (!this.stockInForm.items) return 0;
                    return this.stockInForm.items.reduce((sum, item) => sum + (parseInt(item.qty) || 0), 0);
                },

                getProgressAfterThis() {
                    const delivery = this.currentDelivery;
                    const currentTotal = this.calculateCurrentStockInTotal();
                    const projectedTotal = delivery.totalReceived + currentTotal;
                    if (delivery.totalQty === 0) return 0;
                    return Math.round((projectedTotal / delivery.totalQty) * 100);
                },

                isAllCompletedAfterThis() {
                    return this.getProgressAfterThis() === 100;
                },

                isStockInValid() {
                    const validItems = this.stockInForm.items.filter(item => !item.isCompleted && (parseInt(item.qty) || 0) > 0);
                    if (validItems.length === 0) return false;
                    
                    for (let item of validItems) {
                        if ((parseInt(item.qty) || 0) > item.remainingQty) return false;
                        if (item.lossQty > 0 && !item.lossReason) return false;
                    }
                    
                    return true;
                },

                saveStockIn() {
                    const delivery = this.currentDelivery;
                    const recordItems = [];
                    let totalLoss = 0;
                    let hasActualStock = false;

                    this.stockInForm.items.forEach(item => {
                        const qty = parseInt(item.qty) || 0;
                        if (qty > 0) {
                            hasActualStock = true;
                            const lossQty = parseInt(item.lossQty) || 0;
                            recordItems.push({
                                productName: item.productName,
                                qty: qty,
                                lossQty: lossQty,
                                lossReason: item.lossReason,
                                remark: item.remark
                            });
                            totalLoss += lossQty;

                            // 更新商品收货数量
                            const product = delivery.products.find(p => p.name === item.productName);
                            if (product) {
                                product.receivedQty = (product.receivedQty || 0) + qty;
                                product.remainingQty = product.qty - product.receivedQty;
                            }
                        }
                    });

                    if (!hasActualStock) {
                        this.showToast('请至少填写一个商品的入库数量', 'error');
                        return;
                    }

                    // 添加入库记录（使用自动获取的时间和操作人）
                    if (!delivery.stockInRecords) delivery.stockInRecords = [];
                    delivery.stockInRecords.push({
                        time: this.currentTime,
                        operator: this.currentUser,
                        lossQty: totalLoss,
                        items: recordItems,
                        isRejected: false,
                        rejectReason: ''
                    });

                    // 更新统计
                    this.calculateOrderStats(delivery);

                    // 判断状态：如果全部完成，直接提交审批（状态变为待审批）
                    const allCompleted = delivery.products.every(p => (p.remainingQty || 0) === 0);
                    
                    if (allCompleted) {
                        // 全部完成，自动提交审批，状态变为待审批
                        delivery.status = 'pending';
                        this.showToast('已全部入库并自动提交审批', 'success');
                    } else {
                        // 部分完成，变为待完成（可以继续入库）
                        delivery.status = 'processing';
                        this.showToast('部分入库成功，请继续完成剩余入库', 'success');
                    }

                    this.showStockInModal = false;
                },

                closeStockInModal() {
                    this.showStockInModal = false;
                },

                openApproveModal() {
                    this.showApproveModal = true;
                },

                // 审批通过（无需填写审批人，使用当前用户）
                confirmApprove() {
                    const delivery = this.currentDelivery;
                    delivery.status = 'completed';
                    delivery.approveInfo = {
                        approver: this.currentUser, // 自动使用当前操作人
                        time: new Date().toLocaleString('zh-CN'),
                        comment: '审批通过'
                    };
                    this.showApproveModal = false;
                    this.showToast('审批通过，送货单已完成', 'success');
                },

                openRejectModal() {
                    this.rejectForm = { reason: '' }; // 只需要原因
                    this.showRejectModal = true;
                },

                // 驳回（只需要原因，审批人自动使用当前用户）
                confirmReject() {
                    if (!this.rejectForm.reason) {
                        this.showToast('请填写驳回原因', 'error');
                        return;
                    }
                    const delivery = this.currentDelivery;
                    delivery.status = 'rejected';
                    delivery.rejectInfo = {
                        approver: this.currentUser, // 自动使用当前操作人
                        time: new Date().toLocaleString('zh-CN'),
                        reason: this.rejectForm.reason
                    };
                    
                    // 标记最后一条入库记录为被驳回
                    if (delivery.stockInRecords && delivery.stockInRecords.length > 0) {
                        const lastRecord = delivery.stockInRecords[delivery.stockInRecords.length - 1];
                        lastRecord.isRejected = true;
                        lastRecord.rejectReason = this.rejectForm.reason;
                    }
                    
                    this.showRejectModal = false;
                    this.showToast('已驳回，请查看原因并重新入库', 'success');
                },

                isStepCompleted(stepValue) {
                    const statusOrder = ['draft', 'confirmed', 'processing', 'pending', 'completed'];
                    const currentIdx = statusOrder.indexOf(this.currentDelivery.status);
                    const stepIdx = statusOrder.indexOf(stepValue);
                    
                    // 特殊处理：如果被驳回，processing步骤高亮为红色（表示有问题）
                    if (stepValue === 'processing' && this.currentDelivery.status === 'rejected') {
                        return false; // 未完成，是有问题的状态
                    }
                    
                    return stepIdx < currentIdx || (stepIdx === currentIdx && this.currentDelivery.status !== 'rejected');
                },

                getStepIcon(stepValue) {
                    if (this.currentDelivery.status === 'rejected' && stepValue === 'processing') {
                        return 'fa-circle-xmark';
                    }
                    if (this.currentDelivery.status === stepValue) {
                        if (stepValue === 'rejected') return 'fa-circle-xmark';
                        return 'fa-spinner fa-spin';
                    }
                    if (this.isStepCompleted(stepValue)) {
                        return 'fa-check';
                    }
                    return 'fa-circle';
                },

                getStepTime(stepValue) {
                    const delivery = this.currentDelivery;
                    if (!delivery) return '';
                    
                    switch(stepValue) {
                        case 'draft': return delivery.createTime;
                        case 'confirmed': return delivery.status !== 'draft' ? '已确认' : '';
                        case 'processing': 
                            if (delivery.status === 'rejected') return '被驳回';
                            return delivery.stockInRecords?.length > 0 ? '入库中' : '';
                        case 'pending': 
                            return delivery.status === 'pending' || delivery.status === 'completed' || delivery.status === 'rejected' ? 
                                (delivery.stockInRecords?.length > 0 ? '已提交' : '') : '';
                        case 'completed': return delivery.approveInfo?.time || '';
                        default: return '';
                    }
                },

                showToast(message, type = 'success') {
                    this.toast = { show: true, message, type };
                    setTimeout(() => this.toast.show = false, 3000);
                }
            }
        }
    </script>
</body>
</html>
