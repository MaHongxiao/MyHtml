<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¹è´¦å•ç®¡ç†</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f8fafc; color: #334155; }
        
        .text-num { font-family: 'Menlo', 'Monaco', 'Consolas', monospace; font-weight: 600; }
        .text-min { font-size: 12px; line-height: 1.5; }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        
        .smart-input {
            width: 100%; 
            border: 1px solid #e2e8f0; 
            background: #fff; 
            padding: 8px 12px;
            border-radius: 6px; 
            outline: none; 
            transition: all 0.2s; 
            font-size: 14px;
        }
        .smart-input:hover { border-color: #94a3b8; }
        .smart-input:focus { 
            border-color: #3b82f6; 
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1); 
        }
        
        .data-table th {
            background: #f1f5f9;
            font-size: 13px;
            font-weight: 600;
            color: #475569;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
        }
        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
            vertical-align: middle;
        }
        .data-table tr:hover td { background: #f8fafc; }
        
        .status-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }
        .status-draft { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
        .status-confirmed { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        
        .tab-btn {
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .tab-btn:hover { background: #f1f5f9; }
        .tab-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 16px 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.3s;
            cursor: pointer;
        }
        .stat-card:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .stat-card.active { border-color: #3b82f6; background: #eff6ff; }
        
        .delivery-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            transition: all 0.2s;
        }
        .delivery-card:hover { border-color: #3b82f6; box-shadow: 0 2px 8px rgba(59,130,246,0.08); }
        .delivery-card.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .modal-backdrop {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
        .modal-content {
            animation: modalSlideIn 0.3s ease-out;
        }
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .supplier-tag {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            background: #e0e7ff;
            color: #3730a3;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 4px;
            margin-bottom: 2px;
        }
        
        .step-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
        }
        .step-item {
            flex: 1;
            padding: 12px;
            background: #f1f5f9;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            color: #64748b;
            position: relative;
        }
        .step-item.active {
            background: #3b82f6;
            color: white;
        }
        .step-item.completed {
            background: #dcfce7;
            color: #166534;
        }
        
        /* æ“ä½œæŒ‰é’®æ ·å¼ - ç¡®ä¿ä¸€è¡Œå±•ç¤º */
        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        .action-btn-primary {
            background: #dbeafe;
            color: #1e40af;
        }
        .action-btn-primary:hover { background: #bfdbfe; }
        .action-btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
        }
        .action-btn-secondary:hover { background: #e2e8f0; }
        .action-btn-danger {
            background: transparent;
            color: #dc2626;
        }
        .action-btn-danger:hover { background: #fee2e2; }
        
        @media (max-width: 1280px) {
            .hide-mobile { display: none; }
        }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden" x-data="reconciliationApp()" x-init="init()">

    <!-- é¡¶éƒ¨Header -->
    <header class="bg-white border-b border-slate-200 h-16 px-6 flex justify-between items-center shadow-sm z-30 flex-shrink-0">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-200">
                <i class="fa-solid fa-file-invoice-dollar text-white text-lg"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-slate-800">å¯¹è´¦å•ç®¡ç†</h1>
                <div class="text-min text-slate-500 mt-0.5">å‘¨æœŸç»“ç®— Â· ä¾›åº”å•†å¯¹è´¦ Â· è´¢åŠ¡å½’æ¡£</div>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <button @click="refreshData()" class="w-10 h-10 flex items-center justify-center text-slate-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition" title="åˆ·æ–°">
                <i class="fa-solid fa-rotate-right" :class="loading ? 'animate-spin' : ''"></i>
            </button>
            <button @click="batchExport()" :disabled="selectedItems.length === 0" 
                    class="px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-50 transition flex items-center gap-2 no-print disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fa-solid fa-download"></i> æ‰¹é‡å¯¼å‡º<span x-show="selectedItems.length > 0" x-text="'(' + selectedItems.length + ')'"></span>
            </button>
            <button @click="openGenerateModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 shadow-md shadow-blue-200 transition flex items-center gap-2 no-print">
                <i class="fa-solid fa-plus"></i> ç”Ÿæˆå¯¹è´¦å•
            </button>
        </div>
    </header>

    <!-- ç»Ÿè®¡å¡ç‰‡åŒºåŸŸ -->
    <div class="bg-white border-b border-slate-200 px-6 py-4 grid grid-cols-2 md:grid-cols-4 gap-4 flex-shrink-0">
        <div class="stat-card flex items-center justify-between" 
             :class="{'active': currentTab === 'all'}" 
             @click="currentTab = 'all'">
            <div>
                <div class="text-min text-slate-500 mb-1">å…¨éƒ¨å¯¹è´¦å•</div>
                <div class="text-2xl font-bold text-slate-800" x-text="stats.total">0</div>
            </div>
            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600">
                <i class="fa-solid fa-layer-group"></i>
            </div>
        </div>
        
        <div class="stat-card flex items-center justify-between" 
             :class="{'active': currentTab === 'draft'}" 
             @click="currentTab = 'draft'">
            <div>
                <div class="text-min text-slate-500 mb-1">è‰ç¨¿</div>
                <div class="text-2xl font-bold text-amber-600" x-text="stats.draft">0</div>
            </div>
            <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center text-amber-600">
                <i class="fa-solid fa-file-pen"></i>
            </div>
        </div>
        
        <div class="stat-card flex items-center justify-between" 
             :class="{'active': currentTab === 'confirmed'}" 
             @click="currentTab = 'confirmed'">
            <div>
                <div class="text-min text-slate-500 mb-1">å·²å¯¹è´¦</div>
                <div class="text-2xl font-bold text-emerald-600" x-text="stats.confirmed">0</div>
            </div>
            <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600">
                <i class="fa-solid fa-check-circle"></i>
            </div>
        </div>
        
        <div class="stat-card flex items-center justify-between">
            <div>
                <div class="text-min text-slate-500 mb-1">æœ¬æœˆå¯¹è´¦é‡‘é¢</div>
                <div class="text-2xl font-bold text-blue-600 text-num" x-text="'Â¥' + stats.monthAmount.toLocaleString()">0</div>
            </div>
            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                <i class="fa-solid fa-yen-sign"></i>
            </div>
        </div>
    </div>

    <!-- Tabåˆ‡æ¢ -->
    <div class="bg-white border-b border-slate-200 px-6 pt-4 flex-shrink-0">
        <div class="flex gap-2 mb-4">
            <button class="tab-btn" :class="{'active': currentTab === 'all'}" @click="currentTab = 'all'">å…¨éƒ¨</button>
            <button class="tab-btn" :class="{'active': currentTab === 'draft'}" @click="currentTab = 'draft'">
                <i class="fa-solid fa-file-pen mr-1"></i>è‰ç¨¿
            </button>
            <button class="tab-btn" :class="{'active': currentTab === 'confirmed'}" @click="currentTab = 'confirmed'">
                <i class="fa-solid fa-check-circle mr-1"></i>å·²å¯¹è´¦
            </button>
        </div>
    </div>

    <!-- ä¸»ä½“å†…å®¹åŒº -->
    <main class="flex-1 overflow-hidden flex flex-col bg-slate-50 p-6">
        
        <!-- ç­›é€‰æ  -->
        <div class="bg-white rounded-xl border border-slate-200 p-4 mb-4 flex flex-wrap gap-4 items-end shadow-sm">
            <div class="flex-1 min-w-[200px]">
                <label class="block text-min text-slate-500 mb-1.5">å…³é”®è¯æœç´¢</label>
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-3 top-2.5 text-slate-400 text-sm"></i>
                    <input type="text" x-model="filters.keyword" placeholder="å¯¹è´¦å•å·/ä¾›åº”å•†åç§°" 
                           class="smart-input pl-9" @input.debounce.500="applyFilters()">
                </div>
            </div>
            
            <div class="w-48">
                <label class="block text-min text-slate-500 mb-1.5">å¯¹è´¦æ—¥æœŸ</label>
                <input type="date" x-model="filters.date" class="smart-input" @change="applyFilters()">
            </div>
            
            <div class="w-48">
                <label class="block text-min text-slate-500 mb-1.5">å¯¹è´¦å‘¨æœŸ</label>
                <select x-model="filters.period" class="smart-input" @change="applyFilters()">
                    <option value="">å…¨éƒ¨å‘¨æœŸ</option>
                    <template x-for="period in availablePeriods" :key="period">
                        <option :value="period" x-text="period"></option>
                    </template>
                </select>
            </div>
            
            <div class="w-48">
                <label class="block text-min text-slate-500 mb-1.5">ä¾›åº”å•†</label>
                <select x-model="filters.supplier" class="smart-input" @change="applyFilters()">
                    <option value="">å…¨éƒ¨ä¾›åº”å•†</option>
                    <template x-for="sup in suppliers" :key="sup.id">
                        <option :value="sup.id" x-text="sup.name"></option>
                    </template>
                </select>
            </div>
            
            <button @click="resetFilters()" class="px-4 py-2 text-slate-500 hover:text-slate-700 text-sm font-medium transition mb-0.5">
                <i class="fa-solid fa-rotate-left mr-1"></i> é‡ç½®
            </button>
        </div>

        <!-- æ•°æ®è¡¨æ ¼ -->
        <div class="flex-1 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col">
            <div class="overflow-auto custom-scroll flex-1">
                <table class="w-full data-table">
                    <thead class="sticky top-0 z-10">
                        <tr>
                            <th class="w-10 text-center">
                                <input type="checkbox" @change="toggleSelectAll()" :checked="isAllSelected" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                            </th>
                            <th class="w-36">å¯¹è´¦å•å·</th>
                            <th class="w-32">å¯¹è´¦æ—¥æœŸ</th>
                            <th class="min-w-[240px]">ä¾›åº”å•†ä¿¡æ¯</th>
                            <th class="w-28">å¯¹è´¦å‘¨æœŸ</th>
                            <th class="w-24 text-center">é€è´§å•æ•°</th>
                            <th class="w-32 text-right">å¯¹è´¦é‡‘é¢</th>
                            <th class="w-24 text-center">çŠ¶æ€</th>
                            <th class="w-52 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(item, index) in paginatedData" :key="item.id">
                            <tr>
                                <td class="text-center">
                                    <input type="checkbox" :value="item.id" x-model="selectedItems" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                                </td>
                                <td>
                                    <span class="text-num text-blue-600 font-medium" x-text="item.code"></span>
                                </td>
                                <td>
                                    <div class="text-slate-700" x-text="item.createTime.split(' ')[0]"></div>
                                </td>
                                <td>
                                    <template x-if="item.suppliers.length === 1">
                                        <div>
                                            <div class="font-medium text-slate-800" x-text="item.suppliers[0].name"></div>
                                            <div class="text-min text-slate-400 mt-0.5" x-text="item.suppliers[0].contact"></div>
                                        </div>
                                    </template>
                                    <template x-if="item.suppliers.length > 1">
                                        <div>
                                            <div class="flex flex-wrap gap-1 mb-1">
                                                <template x-for="(sup, idx) in item.suppliers.slice(0, 2)" :key="sup.id">
                                                    <span class="supplier-tag" x-text="sup.name"></span>
                                                </template>
                                                <span x-show="item.suppliers.length > 2" class="supplier-tag bg-slate-200 text-slate-600" x-text="'+' + (item.suppliers.length - 2) + 'å®¶'"></span>
                                            </div>
                                            <div class="text-min text-slate-400">
                                                å…± <span x-text="item.suppliers.length"></span> ä¸ªä¾›åº”å•† | 
                                                <a href="#" @click.prevent="viewSuppliersDetail(item)" class="text-blue-600 hover:underline">æŸ¥çœ‹è¯¦æƒ…</a>
                                            </div>
                                        </div>
                                    </template>
                                </td>
                                <td>
                                    <span class="text-num text-slate-700 bg-slate-100 px-2 py-1 rounded text-xs" x-text="item.period"></span>
                                </td>
                                <td class="text-center">
                                    <span class="font-medium text-slate-700" x-text="item.deliveryCount"></span>
                                    <span class="text-min text-slate-400">å•</span>
                                </td>
                                <td class="text-right">
                                    <span class="text-num font-bold text-slate-800" x-text="'Â¥' + item.amount.toLocaleString('zh-CN', {minimumFractionDigits: 2})"></span>
                                </td>
                                <td class="text-center">
                                    <span class="status-tag" :class="'status-' + item.status">
                                        <i class="fa-solid fa-circle text-[8px]"></i>
                                        <span x-text="getStatusText(item.status)"></span>
                                    </span>
                                </td>
                                <td class="text-center">
                                    <div class="flex items-center justify-center gap-1.5 whitespace-nowrap">
                                        <template x-if="item.status === 'draft'">
                                            <button @click="openConfirmModal(item)" class="action-btn action-btn-primary">
                                                <i class="fa-solid fa-check text-xs mr-1"></i>ç¡®è®¤
                                            </button>
                                        </template>
                                        <button @click="viewDetail(item)" class="action-btn action-btn-secondary">
                                            æŸ¥çœ‹
                                        </button>
                                        <button @click="exportItem(item)" class="action-btn action-btn-secondary">
                                            å¯¼å‡º
                                        </button>
                                        <button @click="deleteItem(item)" class="action-btn action-btn-danger">
                                            åˆ é™¤
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                        
                        <!-- ç©ºçŠ¶æ€ -->
                        <tr x-show="paginatedData.length === 0">
                            <td colspan="9" class="text-center py-16 text-slate-400">
                                <div class="mb-3 text-5xl">ğŸ“­</div>
                                <div class="text-min mb-4">æš‚æ— å¯¹è´¦å•è®°å½•</div>
                                <button @click="openGenerateModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition">
                                    ç«‹å³ç”Ÿæˆå¯¹è´¦å•
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- åˆ†é¡µ -->
            <div class="border-t border-slate-200 px-6 py-4 flex items-center justify-between bg-slate-50">
                <div class="text-min text-slate-500">
                    æ˜¾ç¤º <span x-text="filteredData.length > 0 ? (currentPage - 1) * pageSize + 1 : 0" class="font-medium"></span> - 
                    <span x-text="Math.min(currentPage * pageSize, filteredData.length)" class="font-medium"></span> æ¡ï¼Œ
                    å…± <span x-text="filteredData.length" class="font-medium"></span> æ¡
                </div>
                <div class="flex gap-2">
                    <button @click="currentPage = 1" :disabled="currentPage === 1" class="pagination-btn">
                        <i class="fa-solid fa-angles-left"></i>
                    </button>
                    <button @click="currentPage--" :disabled="currentPage === 1" class="pagination-btn">
                        <i class="fa-solid fa-angle-left"></i>
                    </button>
                    
                    <template x-for="page in displayedPages" :key="page">
                        <button @click="currentPage = page" 
                                class="pagination-btn" 
                                :class="page === currentPage ? 'active' : ''"
                                x-text="page"></button>
                    </template>
                    
                    <button @click="currentPage++" :disabled="currentPage === totalPages" class="pagination-btn">
                        <i class="fa-solid fa-angle-right"></i>
                    </button>
                    <button @click="currentPage = totalPages" :disabled="currentPage === totalPages" class="pagination-btn">
                        <i class="fa-solid fa-angles-right"></i>
                    </button>
                </div>
                <div class="flex items-center gap-2 text-min text-slate-500">
                    <span>æ¯é¡µ</span>
                    <select x-model.number="pageSize" @change="currentPage = 1" class="smart-input py-1 px-2 w-16 text-center">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                    <span>æ¡</span>
                </div>
            </div>
        </div>
    </main>

    <!-- ç”Ÿæˆå¯¹è´¦å•å¼¹çª—ï¼ˆåˆ†æ­¥å‘å¯¼ï¼‰ -->
    <div x-show="generateModal.open" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4" x-cloak>
        <div class="bg-white w-full max-w-5xl rounded-xl shadow-2xl modal-content flex flex-col max-h-[90vh]">
            <!-- å¼¹çª—å¤´éƒ¨ -->
            <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <h3 class="text-lg font-bold text-slate-800">ç”Ÿæˆå¯¹è´¦å•</h3>
                <button @click="closeGenerateModal()" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <!-- æ­¥éª¤æ¡ -->
            <div class="px-6 py-4 border-b border-slate-200 bg-white">
                <div class="step-bar">
                    <div class="step-item" :class="{'active': generateModal.step === 1, 'completed': generateModal.step > 1}">
                        <i class="fa-solid" :class="generateModal.step > 1 ? 'fa-check' : 'fa-calendar'"></i>
                        <div class="mt-1 font-medium">é€‰æ‹©å‘¨æœŸ</div>
                    </div>
                    <div class="step-item" :class="{'active': generateModal.step === 2, 'completed': generateModal.step > 2}">
                        <i class="fa-solid" :class="generateModal.step > 2 ? 'fa-check' : 'fa-list-check'"></i>
                        <div class="mt-1 font-medium">æ ¸å¯¹é€è´§å•</div>
                    </div>
                    <div class="step-item" :class="{'active': generateModal.step === 3}">
                        <i class="fa-solid fa-file-invoice"></i>
                        <div class="mt-1 font-medium">ç¡®è®¤ç”Ÿæˆ</div>
                    </div>
                </div>
            </div>
            
            <!-- æ­¥éª¤1ï¼šé€‰æ‹©å¯¹è´¦å‘¨æœŸ -->
            <div x-show="generateModal.step === 1" class="p-6 overflow-y-auto custom-scroll flex-1">
                <div class="max-w-md mx-auto">
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-slate-700 mb-3">é€‰æ‹©å¯¹è´¦å‘¨æœŸ <span class="text-red-500">*</span></label>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-min text-slate-500 mb-1">å‘¨æœŸç±»å‹</label>
                                <select x-model="generateModal.periodType" class="smart-input" @change="updatePeriodOptions()">
                                    <option value="month">æœˆåº¦</option>
                                    <option value="quarter">å­£åº¦</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-min text-slate-500 mb-1">å…·ä½“å‘¨æœŸ</label>
                                <select x-model="generateModal.period" class="smart-input">
                                    <template x-for="p in generateModal.periodOptions" :key="p">
                                        <option :value="p" x-text="p"></option>
                                    </template>
                                </select>
                            </div>
                        </div>
                        <p class="text-min text-slate-500 bg-blue-50 p-3 rounded-lg border border-blue-100">
                            <i class="fa-solid fa-circle-info mr-1 text-blue-500"></i>
                            é€‰æ‹©å‘¨æœŸåï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ç­›é€‰è¯¥å‘¨æœŸå†…å·²å®Œæˆä¸”æœªå¯¹è´¦çš„é€è´§å•
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- æ­¥éª¤2ï¼šæ ¸å¯¹é€è´§å•ï¼ˆå¸¦ä¾›åº”å•†ç­›é€‰ï¼‰ -->
            <div x-show="generateModal.step === 2" class="flex-1 overflow-hidden flex flex-col">
                <!-- ç­›é€‰æ  -->
                <div class="p-4 bg-slate-50 border-b border-slate-200 flex flex-wrap gap-3 items-center justify-between">
                    <div class="flex items-center gap-3 flex-1">
                        <div class="text-sm font-bold text-slate-700 whitespace-nowrap">ä¾›åº”å•†ç­›é€‰ï¼š</div>
                        <div class="flex gap-2 flex-wrap">
                            <button @click="filterDeliveriesBySupplier('')" 
                                    class="px-3 py-1.5 rounded-full text-xs font-medium transition border"
                                    :class="generateModal.supplierFilter === '' ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-600 border-slate-200 hover:border-blue-400'">
                                å…¨éƒ¨
                            </button>
                            <template x-for="sup in generateModal.availableSuppliers" :key="sup.id">
                                <button @click="filterDeliveriesBySupplier(sup.id)" 
                                        class="px-3 py-1.5 rounded-full text-xs font-medium transition border"
                                        :class="generateModal.supplierFilter === sup.id ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-600 border-slate-200 hover:border-blue-400'">
                                    <span x-text="sup.name"></span>
                                    <span class="ml-1 opacity-75" x-text="'(' + getDeliveryCountBySupplier(sup.id) + ')'"></span>
                                </button>
                            </template>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 border-l border-slate-300 pl-3">
                        <label class="flex items-center gap-2 text-sm text-slate-600 cursor-pointer bg-white px-3 py-1.5 rounded-lg border border-slate-200 hover:border-blue-400 transition">
                            <input type="checkbox" :checked="generateModal.selectedDeliveries.length === filteredAvailableDeliveries.length && filteredAvailableDeliveries.length > 0" @change="toggleSelectAllFilteredDeliveries()" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                            <span>å…¨é€‰</span>
                        </label>
                        <span class="text-sm text-slate-600 whitespace-nowrap">å·²é€‰ <b x-text="generateModal.selectedDeliveries.length" class="text-blue-600"></b> å•</span>
                    </div>
                </div>
                
                <!-- é€è´§å•åˆ—è¡¨ -->
                <div class="flex-1 overflow-y-auto custom-scroll p-4 bg-slate-50">
                    <div x-show="filteredAvailableDeliveries.length === 0" class="text-center py-12 text-slate-400">
                        <i class="fa-solid fa-inbox text-4xl mb-3"></i>
                        <p class="text-min">è¯¥å‘¨æœŸå†…æš‚æ— ç¬¦åˆæ¡ä»¶çš„é€è´§å•</p>
                        <button @click="generateModal.step = 1" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition">ä¿®æ”¹å‘¨æœŸ</button>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-3">
                        <template x-for="delivery in filteredAvailableDeliveries" :key="delivery.id">
                            <div class="delivery-card" :class="{'selected': generateModal.selectedDeliveries.includes(delivery.id)}">
                                <div class="flex items-start gap-3">
                                    <input type="checkbox" :value="delivery.id" x-model="generateModal.selectedDeliveries" class="mt-1 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                                    <div class="flex-1 grid grid-cols-12 gap-4">
                                        <div class="col-span-3">
                                            <div class="text-min text-slate-500 mb-1">é€è´§å•å·</div>
                                            <div class="text-num text-blue-600 font-medium" x-text="delivery.code"></div>
                                            <div class="text-min text-slate-400 mt-1">å…³è”è®¢å•ï¼š<span x-text="delivery.orderCode"></span></div>
                                        </div>
                                        <div class="col-span-2">
                                            <div class="text-min text-slate-500 mb-1">æ—¥æœŸ</div>
                                            <div class="text-sm text-slate-700" x-text="delivery.date"></div>
                                        </div>
                                        <div class="col-span-3">
                                            <div class="text-min text-slate-500 mb-1">ä¾›åº”å•†</div>
                                            <div class="text-sm font-medium text-slate-800" x-text="delivery.supplierName"></div>
                                            <div class="text-min text-slate-400 mt-1" x-text="delivery.supplierContact"></div>
                                        </div>
                                        <div class="col-span-2">
                                            <div class="text-min text-slate-500 mb-1">å•†å“æ•°é‡</div>
                                            <div class="text-sm text-slate-700"><span x-text="delivery.quantity"></span> ä»¶</div>
                                        </div>
                                        <div class="col-span-2 text-right">
                                            <div class="text-min text-slate-500 mb-1">é‡‘é¢</div>
                                            <div class="text-num font-bold text-slate-800 text-lg" x-text="'Â¥' + delivery.amount.toFixed(2)"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- åº•éƒ¨ç»Ÿè®¡ -->
                <div class="p-4 border-t border-slate-200 bg-white flex justify-between items-center">
                    <div class="text-sm text-slate-600">
                        å·²é€‰æ‹© <b x-text="generateModal.selectedDeliveries.length" class="text-blue-600 text-lg"></b> ä¸ªé€è´§å•
                        <span class="mx-2 text-slate-300">|</span>
                        æ¶‰åŠ <b x-text="getSelectedSuppliers().length" class="text-slate-800"></b> ä¸ªä¾›åº”å•†
                    </div>
                    <div class="text-lg font-bold text-slate-800">
                        åˆè®¡ï¼š<span class="text-num text-blue-600 text-2xl" x-text="'Â¥' + calculateSelectedAmount().toFixed(2)"></span>
                    </div>
                </div>
            </div>
            
            <!-- æ­¥éª¤3ï¼šç¡®è®¤ç”Ÿæˆ -->
            <div x-show="generateModal.step === 3" class="p-6 overflow-y-auto custom-scroll flex-1 bg-slate-50">
                <div class="max-w-2xl mx-auto">
                    <div class="bg-white rounded-xl border border-slate-200 p-6 mb-6">
                        <div class="flex items-center gap-3 mb-6 pb-4 border-b border-slate-100">
                            <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xl">
                                <i class="fa-solid fa-file-invoice-dollar"></i>
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-slate-800">å¯¹è´¦å•é¢„è§ˆ</h4>
                                <p class="text-min text-slate-500">è¯·æ ¸å¯¹ä»¥ä¸‹ä¿¡æ¯ï¼Œç¡®è®¤åå°†ç”Ÿæˆå¯¹è´¦å•</p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="flex justify-between py-2 border-b border-slate-100">
                                <span class="text-slate-500">å¯¹è´¦å‘¨æœŸ</span>
                                <span class="font-medium text-slate-800" x-text="generateModal.period"></span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-slate-100">
                                <span class="text-slate-500">æ¶‰åŠä¾›åº”å•†</span>
                                <div class="text-right">
                                    <span class="font-medium text-slate-800" x-text="getSelectedSuppliers().length + ' å®¶'"></span>
                                    <div class="text-min text-slate-400 mt-1 max-w-xs truncate" x-text="getSelectedSuppliers().map(s=>s.name).join('ã€')"></div>
                                </div>
                            </div>
                            <div class="flex justify-between py-2 border-b border-slate-100">
                                <span class="text-slate-500">é€è´§å•æ•°é‡</span>
                                <span class="font-medium text-slate-800" x-text="generateModal.selectedDeliveries.length + ' å•'"></span>
                            </div>
                            <div class="flex justify-between py-3 bg-blue-50 px-4 rounded-lg mt-4">
                                <span class="font-bold text-slate-700">å¯¹è´¦é‡‘é¢åˆè®¡</span>
                                <span class="font-bold text-num text-blue-600 text-xl" x-text="'Â¥' + calculateSelectedAmount().toFixed(2)"></span>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <label class="block text-sm font-bold text-slate-700 mb-2">å¤‡æ³¨è¯´æ˜</label>
                            <textarea x-model="generateModal.remark" rows="3" class="smart-input resize-none" placeholder="æ·»åŠ å¯¹è´¦å¤‡æ³¨ä¿¡æ¯ï¼ˆé€‰å¡«ï¼‰..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å¼¹çª—åº•éƒ¨ -->
            <div class="px-6 py-4 border-t border-slate-200 bg-white flex justify-between items-center">
                <button x-show="generateModal.step > 1" @click="generateModal.step--" class="px-5 py-2 border border-slate-300 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-50 transition">
                    <i class="fa-solid fa-arrow-left mr-1"></i> ä¸Šä¸€æ­¥
                </button>
                <div x-show="generateModal.step === 1"></div>
                
                <div class="flex gap-3">
                    <button @click="closeGenerateModal()" class="px-5 py-2 border border-slate-300 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-50 transition">å–æ¶ˆ</button>
                    <button x-show="generateModal.step < 3" 
                            @click="nextStep()" 
                            class="px-5 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 shadow-md shadow-blue-200 transition"
                            :disabled="!canProceed()"
                            :class="{'opacity-50 cursor-not-allowed': !canProceed()}">
                        ä¸‹ä¸€æ­¥ <i class="fa-solid fa-arrow-right ml-1"></i>
                    </button>
                    <button x-show="generateModal.step === 3" 
                            @click="generateReconciliation()" 
                            class="px-5 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 shadow-md shadow-blue-200 transition">
                        <i class="fa-solid fa-check mr-1"></i> ç¡®è®¤ç”Ÿæˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¡®è®¤å¯¹è´¦å¼¹çª—ï¼ˆæ˜¾ç¤ºè¯¦æƒ…åç¡®è®¤ï¼‰ -->
    <div x-show="confirmModal.open" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4" x-cloak>
        <div class="bg-white w-full max-w-4xl rounded-xl shadow-2xl max-h-[90vh] flex flex-col modal-content">
            <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-emerald-50">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-emerald-500 text-white rounded-full flex items-center justify-center">
                        <i class="fa-solid fa-clipboard-check"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-slate-800">ç¡®è®¤å¯¹è´¦</h3>
                        <p class="text-min text-slate-500">è¯·æ ¸å¯¹ä»¥ä¸‹å¯¹è´¦å•è¯¦æƒ…ï¼Œç¡®è®¤æ— è¯¯åæäº¤</p>
                    </div>
                </div>
                <button @click="confirmModal.open = false" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/50 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scroll p-6 bg-slate-50">
                <div class="bg-white rounded-xl border border-slate-200 p-6 mb-6">
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="p-4 bg-slate-50 rounded-lg border border-slate-200">
                            <div class="text-min text-slate-500 mb-1">å¯¹è´¦å•å·</div>
                            <div class="text-num font-bold text-slate-800" x-text="confirmModal.item?.code"></div>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-lg border border-slate-200">
                            <div class="text-min text-slate-500 mb-1">å¯¹è´¦å‘¨æœŸ</div>
                            <div class="font-bold text-slate-800" x-text="confirmModal.item?.period"></div>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-lg border border-slate-200">
                            <div class="text-min text-slate-500 mb-1">é€è´§å•æ•°</div>
                            <div class="font-bold text-slate-800" x-text="confirmModal.item?.deliveryCount + ' å•'"></div>
                        </div>
                        <div class="p-4 bg-emerald-50 rounded-lg border border-emerald-200">
                            <div class="text-min text-emerald-600 mb-1">å¯¹è´¦é‡‘é¢</div>
                            <div class="font-bold text-num text-emerald-600 text-xl" x-text="'Â¥' + (confirmModal.item?.amount || 0).toLocaleString('zh-CN', {minimumFractionDigits: 2})"></div>
                        </div>
                    </div>

                    <!-- ä¾›åº”å•†æ¸…å• -->
                    <div class="mb-6">
                        <h4 class="text-sm font-bold text-slate-700 mb-3">æ¶‰åŠä¾›åº”å•†</h4>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="sup in confirmModal.item?.suppliers" :key="sup.id">
                                <div class="flex items-center gap-2 px-3 py-2 bg-slate-100 rounded-lg border border-slate-200">
                                    <div class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold" x-text="sup.name.charAt(0)"></div>
                                    <div>
                                        <div class="text-sm font-medium text-slate-800" x-text="sup.name"></div>
                                        <div class="text-min text-slate-500" x-text="sup.contact"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- é€è´§å•æ˜ç»† -->
                    <div class="border border-slate-200 rounded-lg overflow-hidden">
                        <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 font-bold text-slate-800 text-sm">
                            é€è´§å•æ˜ç»†ï¼ˆå…± <span x-text="confirmModal.deliveries?.length"></span> å•ï¼‰
                        </div>
                        <div class="max-h-64 overflow-y-auto custom-scroll">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50 text-slate-500 text-min sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-left font-medium border-b">é€è´§å•å·</th>
                                        <th class="px-4 py-2 text-left font-medium border-b">ä¾›åº”å•†</th>
                                        <th class="px-4 py-2 text-left font-medium border-b">æ—¥æœŸ</th>
                                        <th class="px-4 py-2 text-right font-medium border-b">é‡‘é¢</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    <template x-for="d in confirmModal.deliveries" :key="d.id">
                                        <tr class="hover:bg-slate-50">
                                            <td class="px-4 py-3 text-num text-blue-600" x-text="d.code"></td>
                                            <td class="px-4 py-3 text-slate-700" x-text="d.supplierName"></td>
                                            <td class="px-4 py-3 text-slate-600" x-text="d.date"></td>
                                            <td class="px-4 py-3 text-right font-medium text-num" x-text="'Â¥' + d.amount.toFixed(2)"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                        <div class="bg-slate-50 px-4 py-3 border-t border-slate-200 flex justify-between items-center">
                            <span class="text-sm text-slate-500">åˆè®¡ <span x-text="confirmModal.deliveries?.length"></span> å•</span>
                            <span class="font-bold text-num text-blue-600" x-text="'Â¥' + (confirmModal.item?.amount || 0).toLocaleString('zh-CN', {minimumFractionDigits: 2})"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="px-6 py-4 border-t border-slate-200 bg-white flex justify-end gap-3">
                <button @click="confirmModal.open = false" class="px-5 py-2 border border-slate-300 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-50 transition">å–æ¶ˆ</button>
                <button @click="executeConfirm()" class="px-5 py-2 bg-emerald-600 text-white rounded-lg text-sm font-medium hover:bg-emerald-700 shadow-md shadow-emerald-200 transition flex items-center gap-2">
                    <i class="fa-solid fa-check"></i> ç¡®è®¤æ— è¯¯ï¼Œå®Œæˆå¯¹è´¦
                </button>
            </div>
        </div>
    </div>

    <!-- æŸ¥çœ‹è¯¦æƒ…å¼¹çª— -->
    <div x-show="detailModal.open" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4" x-cloak @click.self="detailModal.open = false">
        <div class="bg-white w-full max-w-4xl rounded-xl shadow-2xl max-h-[90vh] flex flex-col modal-content">
            <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <div>
                    <h3 class="text-lg font-bold text-slate-800">å¯¹è´¦å•è¯¦æƒ…</h3>
                    <p class="text-min text-slate-500 mt-0.5" x-text="'å•å·ï¼š' + detailModal.item?.code"></p>
                </div>
                <div class="flex items-center gap-3">
                    <button @click="printDetail()" class="px-3 py-1.5 border border-slate-300 text-slate-600 rounded-lg text-sm hover:bg-slate-50 transition">
                        <i class="fa-solid fa-print mr-1"></i> æ‰“å°
                    </button>
                    <button @click="detailModal.open = false" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scroll p-6">
                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <div class="text-min text-slate-500 mb-1">å¯¹è´¦çŠ¶æ€</div>
                        <span class="status-tag" :class="'status-' + detailModal.item?.status" x-show="detailModal.item">
                            <i class="fa-solid fa-circle text-[8px]"></i>
                            <span x-text="getStatusText(detailModal.item?.status)"></span>
                        </span>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <div class="text-min text-slate-500 mb-1">å¯¹è´¦å‘¨æœŸ</div>
                        <div class="font-bold text-slate-800" x-text="detailModal.item?.period"></div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <div class="text-min text-slate-500 mb-1">é€è´§å•æ•°é‡</div>
                        <div class="font-bold text-slate-800" x-text="detailModal.item?.deliveryCount + ' å•'"></div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <div class="text-min text-slate-500 mb-1">å¯¹è´¦é‡‘é¢</div>
                        <div class="font-bold text-blue-600 text-num text-lg" x-text="'Â¥' + (detailModal.item?.amount || 0).toLocaleString('zh-CN', {minimumFractionDigits: 2})"></div>
                    </div>
                </div>

                <!-- ä¾›åº”å•†ä¿¡æ¯ -->
                <div class="mb-6">
                    <h4 class="text-sm font-bold text-slate-700 mb-3">ä¾›åº”å•†ä¿¡æ¯</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <template x-for="sup in detailModal.item?.suppliers" :key="sup.id">
                            <div class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg bg-white">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-full flex items-center justify-center font-bold" x-text="sup.name.charAt(0)"></div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-slate-800 truncate" x-text="sup.name"></div>
                                    <div class="text-min text-slate-500" x-text="sup.contact"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- é€è´§å•åˆ—è¡¨ -->
                <div class="border border-slate-200 rounded-lg overflow-hidden">
                    <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 font-bold text-slate-800 text-sm flex justify-between items-center">
                        <span><i class="fa-solid fa-list-ul mr-2 text-slate-400"></i>é€è´§å•æ˜ç»†</span>
                        <span class="text-min font-normal text-slate-500">å…± <span x-text="detailModal.deliveries?.length"></span> å•</span>
                    </div>
                    <div class="max-h-96 overflow-y-auto custom-scroll">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-50 text-slate-500 text-min sticky top-0">
                                <tr>
                                    <th class="px-4 py-2 text-left font-medium border-b">é€è´§å•å·</th>
                                    <th class="px-4 py-2 text-left font-medium border-b">ä¾›åº”å•†</th>
                                    <th class="px-4 py-2 text-left font-medium border-b">é€è´§æ—¥æœŸ</th>
                                    <th class="px-4 py-2 text-left font-medium border-b">å…³è”è®¢å•å·</th>
                                    <th class="px-4 py-2 text-right font-medium border-b">é‡‘é¢</th>
                                    <th class="px-4 py-2 text-center font-medium border-b">çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                <template x-for="d in detailModal.deliveries" :key="d.id">
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-4 py-3 text-num text-blue-600" x-text="d.code"></td>
                                        <td class="px-4 py-3 text-slate-700" x-text="d.supplierName"></td>
                                        <td class="px-4 py-3 text-slate-600" x-text="d.date"></td>
                                        <td class="px-4 py-3 text-num text-slate-500" x-text="d.orderCode"></td>
                                        <td class="px-4 py-3 text-right font-medium text-num" x-text="'Â¥' + d.amount.toFixed(2)"></td>
                                        <td class="px-4 py-3 text-center">
                                            <span class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">å·²å¯¹è´¦</span>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    <div class="bg-slate-50 px-4 py-3 border-t border-slate-200 flex justify-between items-center">
                        <span class="text-sm text-slate-500">åˆè®¡ <span x-text="detailModal.deliveries?.length"></span> å•</span>
                        <span class="font-bold text-num text-blue-600" x-text="'Â¥' + (detailModal.item?.amount || 0).toLocaleString('zh-CN', {minimumFractionDigits: 2})"></span>
                    </div>
                </div>

                <!-- å¤‡æ³¨ -->
                <div x-show="detailModal.item?.remark" class="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-800">
                    <i class="fa-solid fa-note-sticky mr-1"></i> å¤‡æ³¨ï¼š<span x-text="detailModal.item?.remark"></span>
                </div>
            </div>
            
            <div class="px-6 py-4 border-t border-slate-200 bg-slate-50 flex justify-end gap-3">
                <button @click="exportItem(detailModal.item)" class="px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-50 transition">
                    <i class="fa-solid fa-download mr-1"></i> å¯¼å‡ºExcel
                </button>
                <button @click="detailModal.open = false" class="px-5 py-2 bg-slate-200 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-300 transition">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
    <div x-show="deleteModal.open" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4" x-cloak>
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 text-center modal-content">
            <div class="w-14 h-14 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                <i class="fa-solid fa-exclamation"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 mb-2">ç¡®è®¤åˆ é™¤?</h3>
            <p class="text-min text-slate-500 mb-6">
                å¯¹è´¦å• <b x-text="deleteModal.item?.code" class="text-slate-700"></b> å°†è¢«åˆ é™¤<br>
                <span class="text-amber-600 text-xs block mt-1">å…³è”é€è´§å•å°†æ¢å¤ä¸º"æœªå¯¹è´¦"çŠ¶æ€</span>
            </p>
            <div class="flex justify-center gap-3">
                <button @click="deleteModal.open = false" class="px-5 py-2 border border-slate-300 rounded-lg text-slate-700 text-sm font-medium hover:bg-slate-50 transition">å–æ¶ˆ</button>
                <button @click="executeDelete()" class="px-5 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 shadow-md shadow-red-200 transition">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- ä¾›åº”å•†è¯¦æƒ…å¼¹çª—ï¼ˆç”¨äºå¤šä¾›åº”å•†å±•ç¤ºï¼‰ -->
    <div x-show="supplierModal.open" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4" x-cloak>
        <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl p-6 modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-800">ä¾›åº”å•†è¯¦æƒ…</h3>
                <button @click="supplierModal.open = false" class="text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <div class="space-y-3 max-h-96 overflow-y-auto custom-scroll">
                <template x-for="sup in supplierModal.suppliers" :key="sup.id">
                    <div class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg">
                        <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold" x-text="sup.name.charAt(0)"></div>
                        <div>
                            <div class="font-medium text-slate-800" x-text="sup.name"></div>
                            <div class="text-min text-slate-500" x-text="sup.contact"></div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Toastæç¤º -->
    <div x-show="toast.show" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-2"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition ease-in duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed top-6 right-6 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-2xl z-[100] flex items-center gap-3">
        <i class="fa-solid" :class="toast.type === 'success' ? 'fa-check-circle text-emerald-400' : 'fa-circle-exclamation text-rose-400'"></i>
        <span class="text-sm font-medium" x-text="toast.message"></span>
    </div>

    <script>
        function reconciliationApp() {
            return {
                loading: false,
                currentPage: 1,
                pageSize: 10,
                currentTab: 'all',
                selectedItems: [],
                
                filters: {
                    keyword: '',
                    date: '',
                    period: '',
                    supplier: ''
                },
                
                suppliers: [
                    { id: 'S001', name: 'è¥¿å®‰åŒ–å­¦è¯•å‰‚æœ‰é™å…¬å¸', contact: 'å¼ ç»ç† 13800138000' },
                    { id: 'S002', name: 'èµ›é»˜é£ä¸–å°”ç§‘æŠ€', contact: 'æç»ç† 13900139000' },
                    { id: 'S003', name: 'å›½è¯é›†å›¢åŒ–å­¦è¯•å‰‚', contact: 'ç‹ç»ç† 13700137000' },
                    { id: 'S004', name: 'é˜¿æ‹‰ä¸ç”ŸåŒ–ç§‘æŠ€', contact: 'åˆ˜ç»ç† 13600136000' },
                    { id: 'S005', name: 'è¥¿æ ¼ç›å¥¥å¾·é‡Œå¥‡', contact: 'é™ˆç»ç† 13500135000' },
                    { id: 'S006', name: 'éº¦å…‹æ—è¯•å‰‚', contact: 'èµµç»ç† 13400134000' }
                ],
                
                availablePeriods: ['2024-01', '2024-02', '2024-03', '2024-04', '2024-05', '2024-06', '2024-Q1', '2024-Q2'],
                
                reconciliations: [],
                allDeliveries: [],
                
                generateModal: {
                    open: false,
                    step: 1,
                    periodType: 'month',
                    period: '2024-06',
                    periodOptions: [],
                    availableDeliveries: [],
                    filteredDeliveries: [],
                    selectedDeliveries: [],
                    availableSuppliers: [],
                    supplierFilter: '',
                    remark: ''
                },
                
                detailModal: {
                    open: false,
                    item: null,
                    deliveries: []
                },
                
                confirmModal: {
                    open: false,
                    item: null,
                    deliveries: []
                },
                
                deleteModal: {
                    open: false,
                    item: null
                },
                
                supplierModal: {
                    open: false,
                    suppliers: []
                },
                
                toast: { show: false, message: '', type: 'success' },
                
                init() {
                    this.generateMockData();
                    this.updatePeriodOptions();
                    this.applyFilters();
                },
                
                generateMockData() {
                    const periods = ['2024-01', '2024-02', '2024-03', '2024-04', '2024-05', '2024-06'];
                    
                    // ç”Ÿæˆé€è´§å•æ•°æ®ï¼ˆ200æ¡ï¼‰
                    for (let i = 1; i <= 200; i++) {
                        const supplier = this.suppliers[Math.floor(Math.random() * this.suppliers.length)];
                        const period = periods[Math.floor(Math.random() * periods.length)];
                        const date = period + '-' + String(Math.floor(Math.random() * 28) + 1).padStart(2, '0');
                        
                        this.allDeliveries.push({
                            id: 'D' + String(i).padStart(5, '0'),
                            code: 'SH' + date.replace(/-/g, '') + String(Math.floor(Math.random() * 1000)).padStart(3, '0'),
                            date: date,
                            supplierId: supplier.id,
                            supplierName: supplier.name,
                            supplierContact: supplier.contact,
                            orderCode: 'CG' + date.replace(/-/g, '') + String(Math.floor(Math.random() * 1000)).padStart(3, '0'),
                            amount: Math.floor(Math.random() * 5000) + 500 + Math.random() * 100,
                            quantity: Math.floor(Math.random() * 100) + 1,
                            status: Math.random() > 0.3 ? 'completed' : 'pending'
                        });
                    }
                    
                    // ç”Ÿæˆå¯¹è´¦å•æ•°æ®ï¼ˆ50æ¡ï¼‰
                    for (let i = 1; i <= 50; i++) {
                        const isMultiSupplier = Math.random() > 0.7;
                        const numSuppliers = isMultiSupplier ? Math.floor(Math.random() * 3) + 2 : 1;
                        const selectedSups = [];
                        const supplierIds = [];
                        
                        while (selectedSups.length < numSuppliers) {
                            const sup = this.suppliers[Math.floor(Math.random() * this.suppliers.length)];
                            if (!supplierIds.includes(sup.id)) {
                                selectedSups.push({...sup});
                                supplierIds.push(sup.id);
                            }
                        }
                        
                        const period = periods[Math.floor(Math.random() * periods.length)];
                        const status = Math.random() > 0.6 ? 'confirmed' : 'draft';
                        const createDate = period + '-' + String(Math.floor(Math.random() * 28) + 1).padStart(2, '0');
                        
                        const deliveryCount = Math.floor(Math.random() * 10) + 1;
                        const relatedDeliveries = this.allDeliveries
                            .filter(d => supplierIds.includes(d.supplierId) && d.date.startsWith(period.substring(0, 7)))
                            .slice(0, deliveryCount);
                        
                        const totalAmount = relatedDeliveries.reduce((sum, d) => sum + d.amount, 0);
                        
                        this.reconciliations.push({
                            id: i,
                            code: 'DZ' + createDate.replace(/-/g, '') + String(i).padStart(3, '0'),
                            suppliers: selectedSups,
                            period: period,
                            deliveryCount: relatedDeliveries.length,
                            amount: totalAmount,
                            status: status,
                            createTime: createDate + ' ' + String(Math.floor(Math.random() * 24)).padStart(2, '0') + ':' + String(Math.floor(Math.random() * 60)).padStart(2, '0') + ':00',
                            remark: Math.random() > 0.7 ? 'æœˆåº¦å¸¸è§„å¯¹è´¦ï¼Œè¯·æ ¸å¯¹åç¡®è®¤' : '',
                            deliveryIds: relatedDeliveries.map(d => d.id)
                        });
                    }
                    
                    this.reconciliations.sort((a, b) => new Date(b.createTime) - new Date(a.createTime));
                },
                
                updatePeriodOptions() {
                    if (this.generateModal.periodType === 'month') {
                        this.generateModal.periodOptions = ['2024-01', '2024-02', '2024-03', '2024-04', '2024-05', '2024-06'];
                    } else {
                        this.generateModal.periodOptions = ['2024-Q1', '2024-Q2'];
                    }
                    if (!this.generateModal.periodOptions.includes(this.generateModal.period)) {
                        this.generateModal.period = this.generateModal.periodOptions[0];
                    }
                },
                
                get stats() {
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    const monthAmount = this.reconciliations
                        .filter(r => r.createTime.startsWith(currentMonth) && r.status === 'confirmed')
                        .reduce((sum, r) => sum + r.amount, 0);
                    
                    return {
                        total: this.reconciliations.length,
                        draft: this.reconciliations.filter(r => r.status === 'draft').length,
                        confirmed: this.reconciliations.filter(r => r.status === 'confirmed').length,
                        monthAmount: monthAmount
                    };
                },
                
                get filteredData() {
                    let data = this.reconciliations;
                    
                    if (this.currentTab !== 'all') {
                        data = data.filter(item => item.status === this.currentTab);
                    }
                    
                    if (this.filters.keyword) {
                        const keyword = this.filters.keyword.toLowerCase();
                        data = data.filter(item => {
                            if (item.code.toLowerCase().includes(keyword)) return true;
                            return item.suppliers.some(s => s.name.toLowerCase().includes(keyword));
                        });
                    }
                    
                    if (this.filters.date) {
                        data = data.filter(item => item.createTime.startsWith(this.filters.date));
                    }
                    
                    if (this.filters.period) {
                        data = data.filter(item => item.period === this.filters.period);
                    }
                    
                    if (this.filters.supplier) {
                        data = data.filter(item => item.suppliers.some(s => s.id === this.filters.supplier));
                    }
                    
                    return data;
                },
                
                get paginatedData() {
                    const start = (this.currentPage - 1) * this.pageSize;
                    const end = start + this.pageSize;
                    return this.filteredData.slice(start, end);
                },
                
                get totalPages() {
                    return Math.ceil(this.filteredData.length / this.pageSize);
                },
                
                get displayedPages() {
                    const pages = [];
                    const maxDisplay = 5;
                    let start = Math.max(1, this.currentPage - 2);
                    let end = Math.min(this.totalPages, start + maxDisplay - 1);
                    
                    if (end - start < maxDisplay - 1) {
                        start = Math.max(1, end - maxDisplay + 1);
                    }
                    
                    for (let i = start; i <= end; i++) {
                        pages.push(i);
                    }
                    return pages;
                },
                
                get isAllSelected() {
                    return this.paginatedData.length > 0 && this.paginatedData.every(item => this.selectedItems.includes(item.id));
                },
                
                get filteredAvailableDeliveries() {
                    if (!this.generateModal.supplierFilter) {
                        return this.generateModal.availableDeliveries;
                    }
                    return this.generateModal.availableDeliveries.filter(d => d.supplierId === this.generateModal.supplierFilter);
                },
                
                applyFilters() {
                    this.currentPage = 1;
                    this.selectedItems = [];
                },
                
                resetFilters() {
                    this.filters = {
                        keyword: '',
                        date: '',
                        period: '',
                        supplier: ''
                    };
                    this.currentTab = 'all';
                    this.applyFilters();
                },
                
                getStatusText(status) {
                    const map = {
                        'draft': 'è‰ç¨¿',
                        'confirmed': 'å·²å¯¹è´¦'
                    };
                    return map[status] || status;
                },
                
                toggleSelectAll() {
                    if (this.isAllSelected) {
                        this.selectedItems = this.selectedItems.filter(id => !this.paginatedData.some(item => item.id === id));
                    } else {
                        const newIds = this.paginatedData.map(item => item.id).filter(id => !this.selectedItems.includes(id));
                        this.selectedItems = [...this.selectedItems, ...newIds];
                    }
                },
                
                // ç”Ÿæˆå¯¹è´¦å•ç›¸å…³
                openGenerateModal() {
                    this.generateModal = {
                        open: true,
                        step: 1,
                        periodType: 'month',
                        period: '2024-06',
                        periodOptions: [],
                        availableDeliveries: [],
                        filteredDeliveries: [],
                        selectedDeliveries: [],
                        availableSuppliers: [],
                        supplierFilter: '',
                        remark: ''
                    };
                    this.updatePeriodOptions();
                },
                
                closeGenerateModal() {
                    this.generateModal.open = false;
                },
                
                canProceed() {
                    if (this.generateModal.step === 1) {
                        return this.generateModal.period;
                    }
                    if (this.generateModal.step === 2) {
                        return this.generateModal.selectedDeliveries.length > 0;
                    }
                    return true;
                },
                
                nextStep() {
                    if (this.generateModal.step === 1) {
                        // æ ¹æ®å‘¨æœŸç­›é€‰é€è´§å•
                        const selectedPeriod = this.generateModal.period;
                        const periodPrefix = selectedPeriod.substring(0, 7); // 2024-01 æˆ– 2024-Q1
                        
                        this.generateModal.availableDeliveries = this.allDeliveries.filter(d => {
                            const periodMatch = selectedPeriod.includes('Q') 
                                ? this.getQuarter(d.date) === selectedPeriod
                                : d.date.startsWith(periodPrefix);
                            const notReconciled = !this.reconciliations.some(r => r.deliveryIds && r.deliveryIds.includes(d.id));
                            return periodMatch && d.status === 'completed' && notReconciled;
                        });
                        
                        // æå–æ¶‰åŠçš„ä¾›åº”å•†
                        const supplierIds = [...new Set(this.generateModal.availableDeliveries.map(d => d.supplierId))];
                        this.generateModal.availableSuppliers = this.suppliers.filter(s => supplierIds.includes(s.id));
                        
                        // é»˜è®¤å…¨é€‰
                        this.generateModal.selectedDeliveries = this.generateModal.availableDeliveries.map(d => d.id);
                    }
                    this.generateModal.step++;
                },
                
                getQuarter(dateStr) {
                    const month = parseInt(dateStr.split('-')[1]);
                    const year = dateStr.split('-')[0];
                    const quarter = Math.ceil(month / 3);
                    return year + '-Q' + quarter;
                },
                
                filterDeliveriesBySupplier(supplierId) {
                    this.generateModal.supplierFilter = supplierId;
                },
                
                getDeliveryCountBySupplier(supplierId) {
                    return this.generateModal.availableDeliveries.filter(d => d.supplierId === supplierId).length;
                },
                
                toggleSelectAllFilteredDeliveries() {
                    const filteredIds = this.filteredAvailableDeliveries.map(d => d.id);
                    const allSelected = filteredIds.every(id => this.generateModal.selectedDeliveries.includes(id));
                    
                    if (allSelected) {
                        this.generateModal.selectedDeliveries = this.generateModal.selectedDeliveries.filter(id => !filteredIds.includes(id));
                    } else {
                        const newIds = filteredIds.filter(id => !this.generateModal.selectedDeliveries.includes(id));
                        this.generateModal.selectedDeliveries = [...this.generateModal.selectedDeliveries, ...newIds];
                    }
                },
                
                calculateSelectedAmount() {
                    return this.generateModal.availableDeliveries
                        .filter(d => this.generateModal.selectedDeliveries.includes(d.id))
                        .reduce((sum, d) => sum + d.amount, 0);
                },
                
                getSelectedSuppliers() {
                    const selectedIds = [...new Set(this.generateModal.availableDeliveries
                        .filter(d => this.generateModal.selectedDeliveries.includes(d.id))
                        .map(d => d.supplierId))];
                    return this.suppliers.filter(s => selectedIds.includes(s.id));
                },
                
                generateReconciliation() {
                    const selectedDeliveries = this.generateModal.availableDeliveries.filter(d => 
                        this.generateModal.selectedDeliveries.includes(d.id)
                    );
                    
                    const supplierMap = new Map();
                    selectedDeliveries.forEach(d => {
                        if (!supplierMap.has(d.supplierId)) {
                            const sup = this.suppliers.find(s => s.id === d.supplierId);
                            supplierMap.set(d.supplierId, {...sup});
                        }
                    });
                    
                    const totalAmount = selectedDeliveries.reduce((sum, d) => sum + d.amount, 0);
                    const now = new Date();
                    
                    const newReconciliation = {
                        id: Date.now(),
                        code: 'DZ' + now.toISOString().slice(0,10).replace(/-/g,'') + Math.floor(Math.random()*1000),
                        suppliers: Array.from(supplierMap.values()),
                        period: this.generateModal.period,
                        deliveryCount: selectedDeliveries.length,
                        amount: totalAmount,
                        status: 'draft',
                        createTime: now.toLocaleString('zh-CN'),
                        remark: this.generateModal.remark,
                        deliveryIds: selectedDeliveries.map(d => d.id)
                    };
                    
                    this.reconciliations.unshift(newReconciliation);
                    this.showToast('å¯¹è´¦å•ç”ŸæˆæˆåŠŸ', 'success');
                    this.closeGenerateModal();
                    this.currentTab = 'draft';
                    this.applyFilters();
                },
                
                // ç¡®è®¤å¯¹è´¦æµç¨‹
                openConfirmModal(item) {
                    this.confirmModal.item = item;
                    this.confirmModal.deliveries = this.allDeliveries.filter(d => item.deliveryIds.includes(d.id));
                    this.confirmModal.open = true;
                },
                
                executeConfirm() {
                    if (this.confirmModal.item) {
                        const item = this.reconciliations.find(r => r.id === this.confirmModal.item.id);
                        if (item) {
                            item.status = 'confirmed';
                            this.showToast('å¯¹è´¦ç¡®è®¤æˆåŠŸï¼ŒçŠ¶æ€å·²æ›´æ–°ä¸º"å·²å¯¹è´¦"', 'success');
                        }
                        this.confirmModal.open = false;
                        this.confirmModal.item = null;
                        this.applyFilters();
                    }
                },
                
                // è¯¦æƒ…æŸ¥çœ‹
                viewDetail(item) {
                    this.detailModal.item = item;
                    this.detailModal.deliveries = this.allDeliveries.filter(d => item.deliveryIds.includes(d.id));
                    this.detailModal.open = true;
                },
                
                viewSuppliersDetail(item) {
                    this.supplierModal.suppliers = item.suppliers;
                    this.supplierModal.open = true;
                },
                
                printDetail() {
                    window.print();
                },
                
                // åˆ é™¤
                deleteItem(item) {
                    this.deleteModal.item = item;
                    this.deleteModal.open = true;
                },
                
                executeDelete() {
                    if (this.deleteModal.item) {
                        const index = this.reconciliations.findIndex(r => r.id === this.deleteModal.item.id);
                        if (index > -1) {
                            this.reconciliations.splice(index, 1);
                            this.showToast('åˆ é™¤æˆåŠŸ', 'success');
                        }
                        this.deleteModal.open = false;
                        this.deleteModal.item = null;
                        this.applyFilters();
                    }
                },
                
                // å¯¼å‡ºåŠŸèƒ½
                exportItem(item) {
                    this.showToast(`æ­£åœ¨å¯¼å‡ºå¯¹è´¦å• ${item.code}...`, 'success');
                    setTimeout(() => {
                        this.showToast('å¯¼å‡ºæˆåŠŸ', 'success');
                    }, 1000);
                },
                
                batchExport() {
                    if (this.selectedItems.length === 0) {
                        this.showToast('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„å¯¹è´¦å•', 'error');
                        return;
                    }
                    this.showToast(`æ­£åœ¨æ‰¹é‡å¯¼å‡º ${this.selectedItems.length} ä¸ªå¯¹è´¦å•...`, 'success');
                    setTimeout(() => {
                        this.showToast('æ‰¹é‡å¯¼å‡ºæˆåŠŸ', 'success');
                    }, 1500);
                },
                
                refreshData() {
                    this.loading = true;
                    setTimeout(() => {
                        this.loading = false;
                        this.showToast('æ•°æ®å·²åˆ·æ–°', 'success');
                    }, 500);
                },
                
                showToast(message, type = 'success') {
                    this.toast = { show: true, message, type };
                    setTimeout(() => this.toast.show = false, 3000);
                }
            }
        }
    </script>
</body>
</html>
