<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“ä¸ç±»ç›®ç®¡ç†</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f1f5f9; color: #334155; }
        
        /* å­—ä½“è§„èŒƒ */
        .text-num { font-family: 'Menlo', 'Monaco', monospace; font-weight: 600; }
        .text-min { font-size: 13px; line-height: 1.5; }
        
        /* æ»šåŠ¨æ¡ */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        
        /* æ ‘å½¢ç»“æ„ */
        .tree-line { position: absolute; left: 15px; top: 32px; bottom: 0; width: 1px; background-color: #e2e8f0; }
        .tree-item:last-child > .tree-line { display: none; }
        
        /* è¾“å…¥æ¡† */
        .smart-input {
            width: 100%; border: 1px solid #e2e8f0; background: #fff; padding: 8px 12px;
            border-radius: 6px; outline: none; transition: all 0.2s; font-size: 14px;
        }
        .smart-input:hover { border-color: #94a3b8; }
        .smart-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        
        /* è¡¨æ ¼æ ·å¼ - å…³é”®ä¿®æ”¹ï¼šä¸æŠ˜è¡Œ */
        .data-table {
            table-layout: fixed;
            width: max-content;
            min-width: 100%;
        }
        .data-table th {
            background: #f8fafc;
            font-size: 13px;
            font-weight: 600;
            color: #475569;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
            position: relative;
        }
        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
            vertical-align: middle;
            background: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .data-table tr:hover td { background: #f8fafc; }
        
        /* å†»ç»“åˆ— - å¼ºåŒ–æ ·å¼ */
        .sticky-col-left-1 { 
            position: sticky; 
            left: 0; 
            z-index: 30; 
            background: white; 
            box-shadow: 2px 0 5px -2px rgba(0,0,0,0.15);
            width: 48px;
            min-width: 48px;
        }
        .sticky-col-left-2 { 
            position: sticky; 
            left: 48px; 
            z-index: 30; 
            background: white; 
            box-shadow: 2px 0 5px -2px rgba(0,0,0,0.15);
            width: 120px;
            min-width: 120px;
        }
        .sticky-col-left-3 { 
            position: sticky; 
            left: 168px; 
            z-index: 30; 
            background: white; 
            box-shadow: 2px 0 5px -2px rgba(0,0,0,0.15);
            width: 280px;
            min-width: 280px;
        }
        .sticky-col-right { 
            position: sticky; 
            right: 0; 
            z-index: 30; 
            background: white; 
            box-shadow: -2px 0 5px -2px rgba(0,0,0,0.15);
            width: 140px;
            min-width: 140px;
        }
        
        /* è¡¨å¤´å†»ç»“åˆ—èƒŒæ™¯è‰² */
        .data-table thead th.sticky-col-left-1,
        .data-table thead th.sticky-col-left-2,
        .data-table thead th.sticky-col-left-3,
        .data-table thead th.sticky-col-right { 
            background: #f8fafc; 
            z-index: 40; 
        }
        
        /* çŠ¶æ€æ ‡ç­¾ */
        .status-tag { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; white-space: nowrap; }
        .status-active { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .status-inactive { background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }
        
        /* æ“ä½œé“¾æ¥ */
        .action-link { color: #3b82f6; font-size: 13px; cursor: pointer; transition: all 0.2s; padding: 4px 6px; border-radius: 4px; white-space: nowrap; display: inline-block; }
        .action-link:hover { color: #2563eb; background: #eff6ff; text-decoration: underline; }
        .action-link.danger { color: #dc2626; }
        .action-link.danger:hover { color: #b91c1c; background: #fee2e2; }
        .action-divider { color: #e2e8f0; margin: 0 2px; display: inline-block; }
        
        /* åŠ¨ç”» */
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* æ‹–æ‹½ */
        .dragging { opacity: 0.5; background: #f0f9ff; border: 2px dashed #3b82f6; }
        .drag-over { background: #eff6ff; border-top: 2px solid #3b82f6; }
        
        /* æ¨ªå‘æ»šåŠ¨å®¹å™¨ */
        .table-scroll-container {
            overflow-x: auto;
            overflow-y: hidden;
            position: relative;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 1024px) {
            .split-layout { flex-direction: column; }
            .tree-panel { width: 100%; height: auto; max-height: 40vh; border-right: none; border-bottom: 1px solid #e2e8f0; }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden" x-data="unifiedManageApp()">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-white border-b border-slate-200 h-16 px-6 flex justify-between items-center shadow-sm z-30 flex-shrink-0">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-200">
                <i class="fa-solid fa-boxes-stacked text-white text-lg"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-slate-800">å•†å“ä¸ç±»ç›®ç®¡ç†</h1>
                <div class="text-min text-slate-500 mt-0.5" x-text="selectedCategory ? selectedCategory.path : 'å…¨éƒ¨ç±»ç›®'"></div>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <button @click="refreshData()" class="w-10 h-10 flex items-center justify-center text-slate-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition" title="åˆ·æ–°">
                <i class="fa-solid fa-rotate-right" :class="loading ? 'animate-spin' : ''"></i>
            </button>
            <button @click="openCategoryModal()" class="px-4 py-2 border border-slate-300 rounded-lg text-slate-700 text-sm font-medium hover:bg-slate-50 transition flex items-center gap-2">
                <i class="fa-solid fa-folder-tree"></i> <span class="hidden sm:inline">ç®¡ç†ç±»ç›®</span>
            </button>
            <button @click="openCategoryModal()" class="px-4 py-2 border border-slate-300 rounded-lg text-slate-700 text-sm font-medium hover:bg-slate-50 transition flex items-center gap-2">
                <i class="fa-solid fa-folder-tree"></i> <span class="hidden sm:inline">æ‰¹é‡å¯¼å…¥</span>
            </button>
            <button @click="openAddProductModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 shadow-md shadow-blue-200 transition flex items-center gap-2">
                <i class="fa-solid fa-plus"></i> æ–°å¢å•†å“
            </button>
        </div>
    </header>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="bg-white border-b border-slate-200 px-6 py-4 grid grid-cols-2 md:grid-cols-4 gap-4 flex-shrink-0">
        <div class="bg-slate-50 rounded-lg border border-slate-200 p-4 flex items-center justify-between hover:shadow-md transition cursor-pointer" @click="selectCategory(null)">
            <div>
                <div class="text-min text-slate-500 mb-1">å…¨éƒ¨å•†å“</div>
                <div class="text-2xl font-bold text-slate-800" x-text="stats.total">0</div>
            </div>
            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600">
                <i class="fa-solid fa-layer-group"></i>
            </div>
        </div>
        
        <div class="bg-slate-50 rounded-lg border border-slate-200 p-4 flex items-center justify-between hover:shadow-md transition cursor-pointer" @click="setFilter('status', 'active')">
            <div>
                <div class="text-min text-slate-500 mb-1">å·²ä¸Šæ¶</div>
                <div class="text-2xl font-bold text-emerald-600" x-text="stats.active">0</div>
            </div>
            <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600">
                <i class="fa-solid fa-check-circle"></i>
            </div>
        </div>
        
        <div class="bg-slate-50 rounded-lg border border-slate-200 p-4 flex items-center justify-between hover:shadow-md transition cursor-pointer" @click="setFilter('status', 'inactive')">
            <div>
                <div class="text-min text-slate-500 mb-1">å·²ä¸‹æ¶</div>
                <div class="text-2xl font-bold text-slate-600" x-text="stats.inactive">0</div>
            </div>
            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600">
                <i class="fa-solid fa-circle-pause"></i>
            </div>
        </div>

        <div class="bg-slate-50 rounded-lg border border-slate-200 p-4 flex items-center justify-between hover:shadow-md transition cursor-pointer">
            <div>
                <div class="text-min text-slate-500 mb-1">ç±»ç›®æ€»æ•°</div>
                <div class="text-2xl font-bold text-blue-600" x-text="stats.categories">0</div>
            </div>
            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                <i class="fa-solid fa-folder-tree"></i>
            </div>
        </div>
    </div>

    <!-- ä¸»ä½“å†…å®¹åŒº -->
    <main class="flex-1 flex overflow-hidden split-layout">
        
        <!-- å·¦ä¾§ï¼šç±»ç›®æ ‘ -->
        <aside class="w-full lg:w-[360px] bg-white border-r border-slate-200 flex flex-col z-20 flex-shrink-0 tree-panel">
            <div class="p-4 border-b border-slate-100 bg-slate-50/50">
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-3 top-3 text-slate-400 text-sm"></i>
                    <input type="text" x-model="categorySearch" placeholder="æœç´¢ç±»ç›®åç§°..." 
                           class="w-full pl-9 pr-3 py-2 bg-white border border-slate-200 rounded-lg text-sm focus:border-blue-500 outline-none transition shadow-sm">
                </div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scroll p-2 space-y-1">
                <!-- å…¨éƒ¨å•†å“é€‰é¡¹ -->
                <div class="px-2 py-2 rounded-lg cursor-pointer transition-all flex items-center gap-3 mb-2"
                     :class="!selectedCategory ? 'bg-blue-50 border border-blue-200' : 'hover:bg-slate-50 border border-transparent'"
                     @click="selectCategory(null)">
                    <div class="w-8 h-8 rounded bg-slate-100 flex items-center justify-center text-slate-600">
                        <i class="fa-solid fa-boxes-stacked"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-semibold text-slate-800 text-sm">å…¨éƒ¨å•†å“</div>
                        <div class="text-min text-slate-400" x-text="stats.total + ' ä¸ªå•†å“'"></div>
                    </div>
                </div>

                <!-- ç±»ç›®æ ‘ -->
                <template x-for="(node, index) in filteredCategories" :key="node.id">
                    <div class="tree-item select-none" draggable="true"
                         @dragstart="dragStart($event, node, index)"
                         @dragover.prevent="dragOver($event, index)"
                         @drop="drop($event, index)"
                         :class="{'drag-over': dragOverIndex === index}">
                        
                        <div class="flex items-start gap-2 py-1.5 px-2 rounded-lg transition-all cursor-pointer group relative"
                             :class="selectedCategory?.id === node.id ? 'bg-blue-50 border border-blue-200' : 'hover:bg-slate-50 border border-transparent'"
                             @click="selectCategory(node)">
                            
                            <button @click.stop="toggleExpand(node)" 
                                    class="mt-1 w-5 h-5 flex items-center justify-center text-slate-400 hover:text-blue-600 transition-transform flex-shrink-0"
                                    :class="node.expanded ? 'rotate-90' : ''"
                                    x-show="node.children && node.children.length > 0">
                                <i class="fa-solid fa-caret-right"></i>
                            </button>
                            <span x-show="!node.children || node.children.length === 0" class="w-5 mt-1"></span>

                            <div class="mt-0.5 flex-shrink-0" :class="node.level === 1 ? 'text-blue-600' : (node.level === 2 ? 'text-indigo-500' : 'text-slate-400')">
                                <i class="fa-solid" :class="node.children?.length > 0 ? (node.expanded ? 'fa-folder-open' : 'fa-folder') : 'fa-file'"></i>
                            </div>

                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    <span class="font-medium text-slate-700 text-sm truncate" x-text="node.name"></span>
                                </div>
                                <div class="text-min text-slate-400 mt-0.5 flex items-center gap-2">
                                    <span x-text="(node.productCount || 0) + ' ä¸ªå•†å“'"></span>
                                    <span x-show="node.children?.length > 0" x-text="'Â· ' + node.children.length + ' ä¸ªå­ç±»'" class="text-slate-300"></span>
                                </div>
                            </div>
                        </div>

                        <!-- å­ç±»ç›® -->
                        <div x-show="node.expanded && node.children && node.children.length > 0" 
                             x-transition class="ml-6 border-l border-slate-200 pl-2 mt-1 space-y-1">
                            <template x-for="(child, cIndex) in node.children" :key="child.id">
                                <div>
                                    <div class="flex items-start gap-2 py-1.5 px-2 rounded-lg transition-all cursor-pointer group"
                                         :class="selectedCategory?.id === child.id ? 'bg-blue-50 border border-blue-200' : 'hover:bg-slate-50 border border-transparent'"
                                         @click="selectCategory(child)">
                                        
                                        <button @click.stop="toggleExpand(child)" 
                                                class="mt-1 w-5 h-5 flex items-center justify-center text-slate-400 hover:text-blue-600 transition-transform flex-shrink-0"
                                                :class="child.expanded ? 'rotate-90' : ''"
                                                x-show="child.children && child.children.length > 0">
                                            <i class="fa-solid fa-caret-right"></i>
                                        </button>
                                        <span x-show="!child.children || child.children.length === 0" class="w-5 mt-1"></span>

                                        <div class="mt-0.5 flex-shrink-0 text-indigo-500">
                                            <i class="fa-solid" :class="child.children?.length > 0 ? (child.expanded ? 'fa-folder-open' : 'fa-folder') : 'fa-file'"></i>
                                        </div>

                                        <div class="flex-1 min-w-0">
                                            <div class="font-medium text-slate-700 text-sm truncate" x-text="child.name"></div>
                                            <div class="text-min text-slate-400" x-text="(child.productCount || 0) + ' ä¸ªå•†å“'"></div>
                                        </div>
                                    </div>

                                    <!-- ä¸‰çº§ç±»ç›® -->
                                    <div x-show="child.expanded && child.children && child.children.length > 0" 
                                         x-transition class="ml-6 border-l border-slate-200 pl-2 mt-1 space-y-1">
                                        <template x-for="grandChild in child.children" :key="grandChild.id">
                                            <div class="flex items-center gap-2 py-1.5 px-2 rounded-lg transition-all cursor-pointer"
                                                 :class="selectedCategory?.id === grandChild.id ? 'bg-blue-50 border border-blue-200' : 'hover:bg-slate-50 border border-transparent'"
                                                 @click="selectCategory(grandChild)">
                                                <span class="w-5"></span>
                                                <div class="mt-0.5 text-slate-400"><i class="fa-solid fa-file"></i></div>
                                                <div class="flex-1 min-w-0">
                                                    <div class="text-sm text-slate-700 truncate" x-text="grandChild.name"></div>
                                                    <div class="text-min text-slate-400" x-text="(grandChild.productCount || 0) + ' ä¸ªå•†å“'"></div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>

            <div class="p-4 border-t border-slate-200 bg-slate-50 text-min text-slate-500 flex justify-between items-center">
                <span>å…± <b x-text="categoryCount"></b> ä¸ªç±»ç›®</span>
                <button @click="expandAll()" class="text-blue-600 hover:text-blue-700">å±•å¼€å…¨éƒ¨</button>
            </div>
        </aside>

        <!-- å³ä¾§ï¼šå•†å“åˆ—è¡¨ -->
        <section class="flex-1 bg-slate-50 overflow-hidden flex flex-col p-6">
            
            <!-- ç­›é€‰æ  -->
            <div class="bg-white rounded-xl border border-slate-200 p-4 mb-4 flex flex-wrap gap-4 items-end shadow-sm">
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-min text-slate-500 mb-1">å…³é”®è¯æœç´¢</label>
                    <div class="relative">
                        <i class="fa-solid fa-search absolute left-3 top-2.5 text-slate-400 text-sm"></i>
                        <input type="text" x-model="filters.keyword" placeholder="å•†å“ç¼–ç /åç§°/CASå·..." 
                               class="smart-input pl-9" @input.debounce.500="currentPage = 1">
                    </div>
                </div>
                
                <div class="w-32">
                    <label class="block text-min text-slate-500 mb-1">çŠ¶æ€</label>
                    <select x-model="filters.status" class="smart-input" @change="currentPage = 1">
                        <option value="">å…¨éƒ¨</option>
                        <option value="active">å·²ä¸Šæ¶</option>
                        <option value="inactive">å·²ä¸‹æ¶</option>
                    </select>
                </div>
                
                <div class="w-40">
                    <label class="block text-min text-slate-500 mb-1">ä¾›åº”å•†</label>
                    <select x-model="filters.supplier" class="smart-input" @change="currentPage = 1">
                        <option value="">å…¨éƒ¨ä¾›åº”å•†</option>
                        <template x-for="sup in suppliers" :key="sup.id">
                            <option :value="sup.id" x-text="sup.name"></option>
                        </template>
                    </select>
                </div>
                
                <button @click="resetFilters()" class="px-4 py-2 text-slate-500 hover:text-slate-700 text-sm font-medium transition mb-0.5">
                    <i class="fa-solid fa-rotate-left mr-1"></i> é‡ç½®
                </button>
            </div>

            <!-- æ‰¹é‡æ“ä½œæ  -->
            <div x-show="selectedIds.length > 0" class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 flex items-center justify-between fade-in" x-cloak>
                <div class="flex items-center gap-3">
                    <span class="text-min font-medium text-blue-900">
                        å·²é€‰æ‹© <span x-text="selectedIds.length" class="font-bold"></span> é¡¹
                    </span>
                    <span class="text-blue-300">|</span>
                    <button @click="batchAction('up')" class="text-sm text-emerald-700 hover:text-emerald-800 font-medium px-2 py-1 rounded hover:bg-emerald-100 transition">
                        æ‰¹é‡ä¸Šæ¶
                    </button>
                    <button @click="batchAction('down')" class="text-sm text-amber-700 hover:text-amber-800 font-medium px-2 py-1 rounded hover:bg-amber-100 transition">
                        æ‰¹é‡ä¸‹æ¶
                    </button>
                    <button @click="batchAction('delete')" class="text-sm text-red-700 hover:text-red-800 font-medium px-2 py-1 rounded hover:bg-red-100 transition">
                        æ‰¹é‡åˆ é™¤
                    </button>
                </div>
                <button @click="selectedIds = []" class="text-min text-slate-500 hover:text-slate-700">
                    å–æ¶ˆé€‰æ‹©
                </button>
            </div>

            <!-- æ•°æ®è¡¨æ ¼ - æ¨ªå‘æ»šåŠ¨å®¹å™¨ -->
            <div class="flex-1 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                <div class="table-scroll-container custom-scroll flex-1">
                    <table class="data-table border-collapse">
                        <thead class="sticky top-0 z-20">
                            <tr>
                                <th class="sticky-col-left-1 text-center">
                                    <input type="checkbox" :checked="isAllSelected" @change="toggleSelectAll()" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                                </th>
                                <th class="sticky-col-left-2">å•†å“ç¼–ç </th>
                                <th class="sticky-col-left-3">å•†å“åç§°</th>
                                <th style="width: 120px; min-width: 120px;">ç±»ç›®</th>
                                <th style="width: 100px; min-width: 100px;">CASå·</th>
                                <th style="width: 250px; min-width: 250px;">è§„æ ¼</th>
                                <th style="width: 60px; min-width: 60px;">å•ä½</th>
                                <th style="width: 150px; min-width: 150px;">ä¾›åº”å•†</th>
                                <th style="width: 80px; min-width: 80px;">å“ç‰Œ</th>
                                <th style="width: 100px; min-width: 100px; text-align: center;">å•ä»·</th>
                                <th style="width: 90px; min-width: 90px; text-align: center;">çŠ¶æ€</th>
                                <th class="sticky-col-right text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="item in paginatedData" :key="item.id">
                                <tr class="group">
                                    <td class="text-center sticky-col-left-1">
                                        <input type="checkbox" :value="item.id" x-model="selectedIds" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                                    </td>
                                    <td class="font-mono text-slate-600 text-num sticky-col-left-2" x-text="item.code"></td>
                                    <td class="sticky-col-left-3" :title="item.name">
                                        <div class="font-medium text-slate-800 truncate" x-text="item.name"></div>
                                        <div class="text-min text-slate-400 mt-0.5 truncate" x-show="item.brand" x-text="'å“ç‰Œ: ' + item.brand"></div>
                                    </td>
                                    <td>
                                        <span class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600" x-text="getCategoryName(item.category)"></span>
                                    </td>
                                    <td class="text-num text-slate-600" x-text="item.casNo || '-'"></td>
                                    <td :title="item.spec" x-text="item.spec"></td>
                                    <td class="text-slate-700" x-text="item.unit"></td>
                                    <td>
                                        <div class="text-sm text-slate-700 truncate" x-text="item.supplierName"></div>
                                    </td>
                                    <td class="text-slate-600" x-text="item.brand || '-'"></td>
                                    <td class="text-center font-bold text-slate-700 text-num" x-text="'Â¥' + item.price.toFixed(2)"></td>
                                    <td class="text-center">
                                        <span class="status-tag" :class="'status-' + item.status">
                                            <i class="fa-solid fa-circle text-[8px]"></i>
                                            <span x-text="item.status === 'active' ? 'å·²ä¸Šæ¶' : 'å·²ä¸‹æ¶'"></span>
                                        </span>
                                    </td>
                                    <td class="text-center sticky-col-right">
                                        <div class="flex items-center justify-center gap-1">
                                            <span class="action-link" @click="editProduct(item)">ç¼–è¾‘</span>
                                            <span class="action-divider">|</span>
                                            <template x-if="item.status === 'inactive'">
                                                <span class="action-link" @click="changeStatus(item, 'active')">ä¸Šæ¶</span>
                                            </template>
                                            <template x-if="item.status === 'active'">
                                                <span class="action-link" @click="changeStatus(item, 'inactive')">ä¸‹æ¶</span>
                                            </template>
                                            <span class="action-divider">|</span>
                                            <span class="action-link danger" @click="deleteProduct(item)">åˆ é™¤</span>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                            
                            <tr x-show="paginatedData.length === 0">
                                <td colspan="12" class="text-center py-16 text-slate-400">
                                    <div class="mb-3 text-4xl">ğŸ“­</div>
                                    <div class="text-min">æš‚æ— ç¬¦åˆæ¡ä»¶çš„å•†å“</div>
                                    <button @click="resetFilters()" class="mt-2 text-blue-600 hover:underline text-sm">æ¸…é™¤ç­›é€‰æ¡ä»¶</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- åˆ†é¡µ -->
                <div class="border-t border-slate-200 px-6 py-4 flex items-center justify-between bg-slate-50 flex-shrink-0">
                    <div class="text-min text-slate-500">
                        æ˜¾ç¤º <span x-text="(currentPage - 1) * pageSize + 1" class="font-medium"></span> - 
                        <span x-text="Math.min(currentPage * pageSize, filteredData.length)" class="font-medium"></span> æ¡ï¼Œ
                        å…± <span x-text="filteredData.length" class="font-medium"></span> æ¡
                    </div>
                    <div class="flex gap-2">
                        <button @click="currentPage = 1" :disabled="currentPage === 1" class="px-3 py-1.5 border border-slate-200 rounded bg-white text-slate-600 text-sm hover:border-blue-400 disabled:opacity-50">
                            <i class="fa-solid fa-angles-left"></i>
                        </button>
                        <button @click="currentPage--" :disabled="currentPage === 1" class="px-3 py-1.5 border border-slate-200 rounded bg-white text-slate-600 text-sm hover:border-blue-400 disabled:opacity-50">
                            <i class="fa-solid fa-angle-left"></i>
                        </button>
                        
                        <template x-for="page in displayedPages" :key="page">
                            <button @click="currentPage = page" 
                                    class="px-3 py-1.5 border rounded text-sm font-medium transition"
                                    :class="page === currentPage ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-600 border-slate-200 hover:border-blue-400'"
                                    x-text="page"></button>
                        </template>
                        
                        <button @click="currentPage++" :disabled="currentPage === totalPages" class="px-3 py-1.5 border border-slate-200 rounded bg-white text-slate-600 text-sm hover:border-blue-400 disabled:opacity-50">
                            <i class="fa-solid fa-angle-right"></i>
                        </button>
                        <button @click="currentPage = totalPages" :disabled="currentPage === totalPages" class="px-3 py-1.5 border border-slate-200 rounded bg-white text-slate-600 text-sm hover:border-blue-400 disabled:opacity-50">
                            <i class="fa-solid fa-angles-right"></i>
                        </button>
                    </div>
                    <div class="flex items-center gap-2 text-min text-slate-500">
                        <select x-model.number="pageSize" @change="currentPage = 1" class="smart-input py-1 px-2 w-16 text-center">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                        <span>æ¡/é¡µ</span>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- ç±»ç›®ç®¡ç†å¼¹çª— - æ”¯æŒä¸‰çº§ -->
    <div x-show="categoryModalOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm" x-cloak @click.self="closeCategoryModal()">
        <div class="bg-white w-full max-w-3xl rounded-xl shadow-2xl overflow-hidden fade-in mx-4 max-h-[90vh] flex flex-col">
            <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50 flex-shrink-0">
                <h3 class="text-lg font-bold text-slate-800">ç®¡ç†ç±»ç›®ï¼ˆæ”¯æŒä¸‰çº§ï¼‰</h3>
                <button @click="closeCategoryModal()" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scroll p-6">
                <div class="space-y-4">
                    <template x-for="(node, index) in categories" :key="node.id">
                        <div class="border border-slate-200 rounded-lg p-4 bg-slate-50/30">
                            <!-- ä¸€çº§ç±»ç›® -->
                            <div class="flex items-center justify-between mb-3 pb-3 border-b border-slate-100">
                                <div class="flex items-center gap-3">
                                    <i class="fa-solid fa-folder text-blue-600 text-lg"></i>
                                    <div>
                                        <span class="font-bold text-slate-800" x-text="node.name"></span>
                                        <span class="text-xs text-slate-400 ml-2" x-text="node.code"></span>
                                        <span class="text-xs text-blue-600 bg-blue-50 px-2 py-0.5 rounded ml-2">ä¸€çº§</span>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button @click="openEditCategory(node)" class="text-xs px-3 py-1.5 text-blue-600 hover:bg-blue-50 rounded border border-blue-200 transition">ç¼–è¾‘</button>
                                    <button @click="openAddSubCategory(node)" class="text-xs px-3 py-1.5 text-emerald-600 hover:bg-emerald-50 rounded border border-emerald-200 transition">æ·»åŠ äºŒçº§</button>
                                    <button @click="confirmDeleteCategory(node)" class="text-xs px-3 py-1.5 text-rose-600 hover:bg-rose-50 rounded border border-rose-200 transition">åˆ é™¤</button>
                                </div>
                            </div>
                            
                            <!-- äºŒçº§ç±»ç›® -->
                            <div x-show="node.children && node.children.length > 0" class="ml-6 space-y-3">
                                <template x-for="child in node.children" :key="child.id">
                                    <div class="border border-slate-200 rounded-lg p-3 bg-white">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center gap-3">
                                                <i class="fa-solid fa-folder text-indigo-500"></i>
                                                <div>
                                                    <span class="font-semibold text-slate-700" x-text="child.name"></span>
                                                    <span class="text-xs text-slate-400 ml-2" x-text="child.code"></span>
                                                    <span class="text-xs text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded ml-2">äºŒçº§</span>
                                                </div>
                                            </div>
                                            <div class="flex gap-2">
                                                <button @click="openEditCategory(child)" class="text-xs px-2 py-1 text-blue-600 hover:bg-blue-50 rounded border border-blue-200">ç¼–è¾‘</button>
                                                <button @click="openAddSubCategory(child)" class="text-xs px-2 py-1 text-emerald-600 hover:bg-emerald-50 rounded border border-emerald-200">æ·»åŠ ä¸‰çº§</button>
                                                <button @click="confirmDeleteCategory(child)" class="text-xs px-2 py-1 text-rose-600 hover:bg-rose-50 rounded border border-rose-200">åˆ é™¤</button>
                                            </div>
                                        </div>
                                        
                                        <!-- ä¸‰çº§ç±»ç›® -->
                                        <div x-show="child.children && child.children.length > 0" class="ml-6 mt-2 space-y-2 border-l-2 border-slate-100 pl-4">
                                            <template x-for="grandChild in child.children" :key="grandChild.id">
                                                <div class="flex items-center justify-between py-2 border-b border-slate-50 last:border-0">
                                                    <div class="flex items-center gap-3">
                                                        <i class="fa-solid fa-file text-slate-400 text-sm"></i>
                                                        <div>
                                                            <span class="text-sm text-slate-700" x-text="grandChild.name"></span>
                                                            <span class="text-xs text-slate-400 ml-2" x-text="grandChild.code"></span>
                                                            <span class="text-xs text-slate-600 bg-slate-100 px-2 py-0.5 rounded ml-2">ä¸‰çº§</span>
                                                        </div>
                                                    </div>
                                                    <div class="flex gap-2">
                                                        <button @click="openEditCategory(grandChild)" class="text-xs px-2 py-1 text-blue-600 hover:underline">ç¼–è¾‘</button>
                                                        <button @click="confirmDeleteCategory(grandChild)" class="text-xs px-2 py-1 text-rose-600 hover:underline">åˆ é™¤</button>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                        
                                        <!-- æ·»åŠ ä¸‰çº§æç¤º -->
                                        <div x-show="!child.children || child.children.length === 0" class="ml-6 mt-2 text-xs text-slate-400 italic">
                                            æš‚æ— ä¸‰çº§ç±»ç›®ï¼Œç‚¹å‡»"æ·»åŠ ä¸‰çº§"åˆ›å»º
                                        </div>
                                    </div>
                                </template>
                            </div>
                            
                            <!-- ç©ºçŠ¶æ€ -->
                            <div x-show="!node.children || node.children.length === 0" class="ml-6 text-sm text-slate-400 italic">
                                æš‚æ— äºŒçº§ç±»ç›®ï¼Œç‚¹å‡»"æ·»åŠ äºŒçº§"åˆ›å»º
                            </div>
                        </div>
                    </template>
                </div>
                
                <button @click="openAddCategory()" class="mt-6 w-full py-3 border-2 border-dashed border-slate-300 rounded-lg text-slate-500 hover:border-blue-400 hover:text-blue-600 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-plus"></i> æ–°å¢ä¸€çº§ç±»ç›®
                </button>
            </div>
        </div>
    </div>

    <!-- ç±»ç›®ç¼–è¾‘å¼¹çª— -->
    <div x-show="categoryEditModal.open" class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm" x-cloak>
        <div class="bg-white w-full max-w-md rounded-xl shadow-2xl p-6 fade-in mx-4">
            <h3 class="text-lg font-bold text-slate-800 mb-4" x-text="categoryEditModal.editing ? 'ç¼–è¾‘ç±»ç›®' : 'æ–°å¢ç±»ç›®'"></h3>
            
            <div class="space-y-4">
                <div x-show="!categoryEditModal.editing && categoryEditModal.parentId">
                    <label class="block text-min font-bold text-slate-700 mb-2">ä¸Šçº§ç±»ç›®</label>
                    <input type="text" class="smart-input bg-slate-50" :value="getCategoryPath(categoryEditModal.parentId)" readonly>
                </div>

                <div>
                    <label class="block text-min font-bold text-slate-700 mb-2">ç±»ç›®ç¼–ç  <span class="text-rose-500">*</span></label>
                    <input type="text" class="smart-input font-mono" x-model="categoryEditModal.data.code" 
                           :readonly="categoryEditModal.editing"
                           placeholder="å¦‚ï¼š01 æˆ– 0101 æˆ– 010101">
                </div>

                <div>
                    <label class="block text-min font-bold text-slate-700 mb-2">ç±»ç›®åç§° <span class="text-rose-500">*</span></label>
                    <input type="text" class="smart-input" x-model="categoryEditModal.data.name" placeholder="è¯·è¾“å…¥ç±»ç›®åç§°">
                </div>

                <div>
                    <label class="block text-min font-bold text-slate-700 mb-2">æ’åºå·</label>
                    <input type="number" class="smart-input" x-model.number="categoryEditModal.data.sort" min="1">
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-6">
                <button @click="categoryEditModal.open = false" class="px-5 py-2 border border-slate-300 rounded-lg text-slate-700 text-sm font-medium hover:bg-slate-50 transition">å–æ¶ˆ</button>
                <button @click="saveCategory()" class="px-5 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 shadow-md shadow-blue-200 transition">ç¡®è®¤ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å•†å“ç¼–è¾‘å¼¹çª— -->
    <div x-show="productModal.open" class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm overflow-y-auto py-10" x-cloak>
        <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl overflow-hidden fade-in mx-4 my-auto">
            <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <h3 class="text-lg font-bold text-slate-800" x-text="productModal.editing ? 'ç¼–è¾‘å•†å“' : 'æ–°å¢å•†å“'"></h3>
                <button @click="productModal.open = false" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-4 max-h-[60vh] overflow-y-auto custom-scroll">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-min font-bold text-slate-700 mb-2">å•†å“ç¼–ç  <span class="text-rose-500">*</span></label>
                        <input type="text" class="smart-input font-mono" x-model="productModal.data.code" :readonly="productModal.editing">
                    </div>
                    <div>
                        <label class="block text-min font-bold text-slate-700 mb-2">æ‰€å±ç±»ç›® <span class="text-rose-500">*</span></label>
                        <select class="smart-input" x-model="productModal.data.category">
                            <option value="">è¯·é€‰æ‹©ç±»ç›®</option>
                            <template x-for="cat in flatCategories" :key="cat.id">
                                <option :value="cat.code" x-text="cat.path || cat.name"></option>
                            </template>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-min font-bold text-slate-700 mb-2">å•†å“åç§° <span class="text-rose-500">*</span></label>
                    <input type="text" class="smart-input" x-model="productModal.data.name" placeholder="è¯·è¾“å…¥å•†å“åç§°">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-min font-bold text-slate-700 mb-2">CASå·</label>
                        <input type="text" class="smart-input" x-model="productModal.data.casNo" placeholder="å¦‚ï¼š67-56-1">
                    </div>
                    <div>
                        <label class="block text-min font-bold text-slate-700 mb-2">è´§å·</label>
                        <input type="text" class="smart-input" x-model="productModal.data.itemNo" placeholder="ä¾›åº”å•†è´§å·">
                    </div>
                </div>

                <div>
                    <label class="block text-min font-bold text-slate-700 mb-2">è§„æ ¼æè¿°</label>
                    <input type="text" class="smart-input" x-model="productModal.data.spec" placeholder="å¦‚ï¼š4L/ç“¶ï¼ŒHPLCçº§ï¼Œâ‰¥99.9%">
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-min font-bold text-slate-700 mb-2">å•ä½</label>
                        <input type="text" class="smart-input" x-model="productModal.data.unit" placeholder="ç“¶/ä¸ª/æ”¯">
                    </div>
                    <div>
                        <label class="block text-min font-bold text-slate-700 mb-2">å•ä»· (Â¥)</label>
                        <input type="number" step="0.01" class="smart-input" x-model.number="productModal.data.price">
                    </div>
                    <div>
                        <label class="block text-min font-bold text-slate-700 mb-2">æœ€å°èµ·è®¢é‡</label>
                        <input type="number" class="smart-input" x-model.number="productModal.data.minOrderQty" min="1">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-min font-bold text-slate-700 mb-2">ä¾›åº”å•†</label>
                        <select class="smart-input" x-model="productModal.data.supplier">
                            <option value="">è¯·é€‰æ‹©</option>
                            <template x-for="sup in suppliers" :key="sup.id">
                                <option :value="sup.id" x-text="sup.name"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label class="block text-min font-bold text-slate-700 mb-2">å“ç‰Œ</label>
                        <input type="text" class="smart-input" x-model="productModal.data.brand" placeholder="å“ç‰Œåç§°">
                    </div>
                </div>

                <div>
                    <label class="block text-min font-bold text-slate-700 mb-2">çŠ¶æ€</label>
                    <div class="flex gap-4 mt-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" x-model="productModal.data.status" value="active" class="text-blue-600 focus:ring-blue-500">
                            <span class="text-sm text-slate-700">ä¸Šæ¶</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" x-model="productModal.data.status" value="inactive" class="text-blue-600 focus:ring-blue-500">
                            <span class="text-sm text-slate-700">ä¸‹æ¶</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex justify-end gap-3">
                <button @click="productModal.open = false" class="px-5 py-2 border border-slate-300 rounded-lg text-slate-700 text-sm font-medium hover:bg-slate-50 transition">å–æ¶ˆ</button>
                <button @click="saveProduct()" class="px-5 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 shadow-md shadow-blue-200 transition">ç¡®è®¤ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
    <div x-show="deleteModal.open" class="fixed inset-0 z-[70] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm" x-cloak>
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 text-center fade-in mx-4">
            <div class="w-14 h-14 bg-rose-100 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-exclamation text-2xl"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 mb-2">ç¡®è®¤åˆ é™¤?</h3>
            <p class="text-min text-slate-500 mb-6">
                <span x-show="deleteModal.type === 'product'">
                    å•†å“ <b x-text="deleteModal.item?.name" class="text-slate-700"></b> å°†è¢«æ°¸ä¹…åˆ é™¤<br>
                    <span class="text-rose-500 text-xs">æ­¤æ“ä½œä¸å¯æ¢å¤</span>
                </span>
                <span x-show="deleteModal.type === 'category'">
                    ç±»ç›® <b x-text="deleteModal.item?.name" class="text-slate-700"></b> å°†è¢«åˆ é™¤<br>
                    <span x-show="deleteModal.item?.children?.length > 0" class="text-rose-500 text-xs block mt-1">
                        (åŒ…å« <span x-text="deleteModal.item?.children?.length"></span> ä¸ªå­ç±»ç›®)
                    </span>
                    <span class="text-rose-500 text-xs">å…³è”å•†å“å°†å˜ä¸ºæœªåˆ†ç±»</span>
                </span>
            </p>
            <div class="flex justify-center gap-3">
                <button @click="deleteModal.open = false" class="px-5 py-2 border border-slate-300 rounded-lg text-slate-700 text-sm font-medium hover:bg-slate-50 transition">å–æ¶ˆ</button>
                <button @click="executeDelete()" class="px-5 py-2 bg-rose-600 text-white rounded-lg text-sm font-medium hover:bg-rose-700 shadow-md shadow-rose-200 transition">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- Toast æç¤º -->
    <div x-show="toast.show" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-2"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition ease-in duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed top-20 right-6 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-2xl z-[100] flex items-center gap-3">
        <i class="fa-solid" :class="toast.type === 'success' ? 'fa-check-circle text-emerald-400' : 'fa-circle-exclamation text-rose-400'"></i>
        <span class="text-sm font-medium" x-text="toast.message"></span>
    </div>

    <script>
        function unifiedManageApp() {
            return {
                loading: false,
                selectedIds: [],
                currentPage: 1,
                pageSize: 10,
                
                // ç±»ç›®ç›¸å…³ - åŒ…å«ä¸‰çº§ç»“æ„ç¤ºä¾‹
                categories: [
                    {
                        id: '1', code: '01', name: 'åŒ–å­¦è¯•å‰‚', level: 1, sort: 1, expanded: true,
                        children: [
                            { 
                                id: '1-1', code: '0101', name: 'æœ‰æœºè¯•å‰‚', level: 2, sort: 1, expanded: false,
                                children: [
                                    { id: '1-1-1', code: '010101', name: 'é†‡ç±»', level: 3, sort: 1 },
                                    { id: '1-1-2', code: '010102', name: 'çƒ·çƒƒç±»', level: 3, sort: 2 }
                                ]
                            },
                            { id: '1-2', code: '0102', name: 'æ— æœºè¯•å‰‚', level: 2, sort: 2, expanded: false, children: [] }
                        ]
                    },
                    {
                        id: '2', code: '02', name: 'ç»ç’ƒå™¨çš¿', level: 1, sort: 2, expanded: false,
                        children: [
                            { id: '2-1', code: '0201', name: 'çƒ§æ¯', level: 2, sort: 1, children: [] },
                            { id: '2-2', code: '0202', name: 'å®¹é‡ç“¶', level: 2, sort: 2, children: [] }
                        ]
                    },
                    {
                        id: '3', code: '03', name: 'ä»ªå™¨é…ä»¶', level: 1, sort: 3, expanded: false, children: [] },
                    {
                        id: '4', code: '04', name: 'æ ·å“å‰å¤„ç†è€—æ', level: 1, sort: 4, expanded: false, children: [] }
                ],
                
                selectedCategory: null,
                categorySearch: '',
                dragOverIndex: null,
                draggedNode: null,
                
                // å•†å“ç›¸å…³
                products: [
                    { id: 1, code: '0101010001', name: 'ç”²é†‡ï¼ˆè‰²è°±çº§ï¼‰', spec: '4L/ç“¶ï¼ŒHPLCçº§ï¼Œâ‰¥99.9%', casNo: '67-56-1', itemNo: 'M049-4L', unit: 'ç“¶', category: '0101', supplier: 'S001', supplierName: 'è¥¿å®‰åŒ–å­¦è¯•å‰‚æœ‰é™å…¬å¸', brand: 'å›½äº§', minOrderQty: 1, price: 128.00, status: 'active' },
                    { id: 2, code: '0101010002', name: 'ä¹™é†‡ï¼ˆæ— æ°´ï¼‰', spec: '500ml/ç“¶ï¼Œâ‰¥99.7%', casNo: '64-17-5', itemNo: 'E001', unit: 'ç“¶', category: '0101', supplier: 'S001', supplierName: 'è¥¿å®‰åŒ–å­¦è¯•å‰‚æœ‰é™å…¬å¸', brand: 'å›½äº§', minOrderQty: 1, price: 35.00, status: 'active' },
                    { id: 3, code: '0102010001', name: 'ç›é…¸', spec: '500ml/ç“¶ï¼Œ36-38%', casNo: '7647-01-0', itemNo: 'H001', unit: 'ç“¶', category: '0102', supplier: 'S002', supplierName: 'å›½è¯é›†å›¢åŒ–å­¦è¯•å‰‚', brand: 'SCRC', minOrderQty: 1, price: 28.00, status: 'active' },
                    { id: 4, code: '0201000001', name: 'çƒ§æ¯ï¼ˆä½å‹ï¼‰', spec: '100mlï¼Œç¡¼ç¡…ç»ç’ƒï¼ŒåŠ åšå‹ï¼Œè€é«˜æ¸©', casNo: '', itemNo: 'BE100', unit: 'ä¸ª', category: '0201', supplier: 'S001', supplierName: 'è¥¿å®‰åŒ–å­¦è¯•å‰‚æœ‰é™å…¬å¸', brand: 'å¤©ç»', minOrderQty: 10, price: 12.00, status: 'active' },
                    { id: 5, code: '0202000001', name: 'å®¹é‡ç“¶ï¼ˆAçº§ï¼‰', spec: '100mlï¼Œè“æ ‡ï¼Œé«˜ç²¾åº¦', casNo: '', itemNo: 'VB100', unit: 'ä¸ª', category: '0202', supplier: 'S001', supplierName: 'è¥¿å®‰åŒ–å­¦è¯•å‰‚æœ‰é™å…¬å¸', brand: 'å¤©ç»', minOrderQty: 5, price: 35.00, status: 'inactive' },
                    { id: 6, code: '0300000001', name: 'C18è‰²è°±æŸ±', spec: '4.6Ã—250mmï¼Œ5Î¼mï¼Œé«˜åˆ†ç¦»åº¦', casNo: '', itemNo: 'C18-4625', unit: 'æ”¯', category: '03', supplier: 'S003', supplierName: 'èµ›é»˜é£ä¸–å°”ç§‘æŠ€', brand: 'Thermo', minOrderQty: 1, price: 2850.00, status: 'active' },
                    { id: 7, code: '0400000001', name: 'æœ‰æœºç³»å¾®å­”æ»¤è†œ', spec: '0.45Î¼mï¼Œ47mmï¼Œ100ç‰‡/ç›’', casNo: '', itemNo: 'MF-045', unit: 'ç›’', category: '04', supplier: 'S003', supplierName: 'èµ›é»˜é£ä¸–å°”ç§‘æŠ€', brand: 'Millipore', minOrderQty: 2, price: 89.00, status: 'active' },
                    { id: 8, code: '0400000002', name: 'ä¸€æ¬¡æ€§ç¦»å¿ƒç®¡', spec: '10mlï¼Œæ— èŒæ— é…¶ï¼Œ100æ”¯/è¢‹ï¼ŒPPæè´¨', casNo: '', itemNo: 'CT-010', unit: 'è¢‹', category: '04', supplier: 'S002', supplierName: 'å›½è¯é›†å›¢åŒ–å­¦è¯•å‰‚', brand: 'å›½äº§', minOrderQty: 5, price: 45.00, status: 'active' },
                    { id: 9, code: '0101020001', name: 'æ­£å·±çƒ·', spec: '4L/ç“¶ï¼ŒHPLCçº§ï¼Œå†œæ®‹çº§', casNo: '110-54-3', itemNo: 'HX001', unit: 'ç“¶', category: '010102', supplier: 'S003', supplierName: 'èµ›é»˜é£ä¸–å°”ç§‘æŠ€', brand: 'Fisher', minOrderQty: 1, price: 168.00, status: 'inactive' },
                    { id: 10, code: '0101020002', name: 'ç¯å·±çƒ·', spec: '500ml/ç“¶ï¼ŒARçº§ï¼Œåˆ†æçº¯', casNo: '110-82-7', itemNo: 'CH001', unit: 'ç“¶', category: '010102', supplier: 'S001', supplierName: 'è¥¿å®‰åŒ–å­¦è¯•å‰‚æœ‰é™å…¬å¸', brand: 'å›½äº§', minOrderQty: 1, price: 42.00, status: 'active' }
                ],
                
                suppliers: [
                    { id: 'S001', name: 'è¥¿å®‰åŒ–å­¦è¯•å‰‚æœ‰é™å…¬å¸' },
                    { id: 'S002', name: 'å›½è¯é›†å›¢åŒ–å­¦è¯•å‰‚' },
                    { id: 'S003', name: 'èµ›é»˜é£ä¸–å°”ç§‘æŠ€' }
                ],
                
                filters: {
                    keyword: '',
                    status: '',
                    supplier: ''
                },
                
                // å¼¹çª—çŠ¶æ€
                categoryModalOpen: false,
                categoryEditModal: {
                    open: false,
                    editing: false,
                    parentId: null,
                    data: { code: '', name: '', sort: 1 }
                },
                productModal: {
                    open: false,
                    editing: false,
                    data: { code: '', name: '', category: '', casNo: '', itemNo: '', spec: '', unit: '', price: 0, minOrderQty: 1, supplier: '', brand: '', status: 'active' }
                },
                deleteModal: {
                    open: false,
                    type: '', // 'product' æˆ– 'category'
                    item: null
                },
                
                toast: { show: false, message: '', type: 'success' },

                init() {
                    this.calculateProductCounts();
                },

                // è®¡ç®—å±æ€§
                get filteredCategories() {
                    if (!this.categorySearch) return this.categories;
                    return this.filterTree(this.categories, this.categorySearch.toLowerCase());
                },

                get flatCategories() {
                    const result = [];
                    const walk = (nodes, parentPath = '') => {
                        nodes.forEach(node => {
                            const path = parentPath ? `${parentPath} > ${node.name}` : node.name;
                            result.push({ ...node, path });
                            if (node.children) walk(node.children, path);
                        });
                    };
                    walk(this.categories);
                    return result;
                },

                get categoryCount() {
                    let count = 0;
                    const countNodes = (nodes) => {
                        nodes.forEach(n => {
                            count++;
                            if (n.children) countNodes(n.children);
                        });
                    };
                    countNodes(this.categories);
                    return count;
                },

                get stats() {
                    const total = this.products.length;
                    const active = this.products.filter(p => p.status === 'active').length;
                    const inactive = total - active;
                    return { total, active, inactive, categories: this.categoryCount };
                },

                get filteredData() {
                    let result = this.products.filter(item => {
                        // ç±»ç›®ç­›é€‰
                        if (this.selectedCategory) {
                            const catCode = this.selectedCategory.code;
                            if (!item.category.startsWith(catCode)) return false;
                        }
                        
                        // å…³é”®è¯æœç´¢
                        if (this.filters.keyword) {
                            const keyword = this.filters.keyword.toLowerCase();
                            if (!item.code.toLowerCase().includes(keyword) && 
                                !item.name.toLowerCase().includes(keyword) &&
                                !(item.casNo && item.casNo.toLowerCase().includes(keyword))) {
                                return false;
                            }
                        }
                        
                        // çŠ¶æ€ç­›é€‰
                        if (this.filters.status && item.status !== this.filters.status) return false;
                        
                        // ä¾›åº”å•†ç­›é€‰
                        if (this.filters.supplier && item.supplier !== this.filters.supplier) return false;
                        
                        return true;
                    });
                    
                    return result;
                },

                get paginatedData() {
                    const start = (this.currentPage - 1) * this.pageSize;
                    const end = start + this.pageSize;
                    return this.filteredData.slice(start, end);
                },

                get totalPages() {
                    return Math.ceil(this.filteredData.length / this.pageSize) || 1;
                },

                get displayedPages() {
                    const pages = [];
                    const maxDisplay = 5;
                    let start = Math.max(1, this.currentPage - 2);
                    let end = Math.min(this.totalPages, start + maxDisplay - 1);
                    
                    if (end - start < maxDisplay - 1) {
                        start = Math.max(1, end - maxDisplay + 1);
                    }
                    
                    for (let i = start; i <= end; i++) {
                        pages.push(i);
                    }
                    return pages;
                },

                get isAllSelected() {
                    return this.paginatedData.length > 0 && this.paginatedData.every(item => this.selectedIds.includes(item.id));
                },

                // æ–¹æ³•
                filterTree(nodes, query) {
                    return nodes.filter(node => {
                        const match = node.name.toLowerCase().includes(query);
                        if (node.children) {
                            const filteredChildren = this.filterTree(node.children, query);
                            if (filteredChildren.length > 0) {
                                node.children = filteredChildren;
                                return true;
                            }
                        }
                        return match;
                    });
                },

                calculateProductCounts() {
                    const countMap = {};
                    
                    // åˆå§‹åŒ–
                    const initCount = (nodes) => {
                        nodes.forEach(n => {
                            countMap[n.code] = 0;
                            if (n.children) initCount(n.children);
                        });
                    };
                    initCount(this.categories);
                    
                    // ç»Ÿè®¡å•†å“
                    this.products.forEach(p => {
                        // æ‰¾åˆ°å¯¹åº”ç±»ç›®åŠå…¶æ‰€æœ‰çˆ¶ç±»ç›®
                        const findAndIncrement = (nodes, targetCode) => {
                            for (let node of nodes) {
                                if (targetCode.startsWith(node.code)) {
                                    countMap[node.code] = (countMap[node.code] || 0) + 1;
                                    if (node.children) findAndIncrement(node.children, targetCode);
                                    return true;
                                }
                            }
                            return false;
                        };
                        findAndIncrement(this.categories, p.category);
                    });
                    
                    // å›å¡«åˆ°æ ‘
                    const fillCount = (nodes) => {
                        nodes.forEach(n => {
                            n.productCount = countMap[n.code] || 0;
                            if (n.children) fillCount(n.children);
                        });
                    };
                    fillCount(this.categories);
                },

                selectCategory(node) {
                    this.selectedCategory = node;
                    this.currentPage = 1;
                    this.selectedIds = [];
                },

                toggleExpand(node) {
                    node.expanded = !node.expanded;
                },

                expandAll() {
                    const expand = (nodes) => {
                        nodes.forEach(n => {
                            n.expanded = true;
                            if (n.children) expand(n.children);
                        });
                    };
                    expand(this.categories);
                },

                getCategoryName(code) {
                    const cat = this.flatCategories.find(c => c.code === code);
                    return cat ? cat.name : code;
                },

                getCategoryPath(id) {
                    if (!id) return 'æ ¹ç±»ç›®';
                    const cat = this.findCategoryById(this.categories, id);
                    return cat ? cat.name : '';
                },

                findCategoryById(nodes, id) {
                    for (let n of nodes) {
                        if (n.id === id) return n;
                        if (n.children) {
                            const found = this.findCategoryById(n.children, id);
                            if (found) return found;
                        }
                    }
                    return null;
                },

                findCategoryByCode(nodes, code) {
                    for (let n of nodes) {
                        if (n.code === code) return n;
                        if (n.children) {
                            const found = this.findCategoryByCode(n.children, code);
                            if (found) return found;
                        }
                    }
                    return null;
                },

                // æ‹–æ‹½æ’åº
                dragStart(e, node, index) {
                    this.draggedNode = node;
                    e.target.classList.add('dragging');
                },

                dragOver(e, index) {
                    e.preventDefault();
                    this.dragOverIndex = index;
                },

                drop(e, index) {
                    e.preventDefault();
                    this.dragOverIndex = null;
                    if (this.draggedNode) {
                        // ç®€åŒ–çš„åŒçº§æ’åº
                        this.showToast('æ’åºå·²æ›´æ–°', 'success');
                    }
                    this.draggedNode = null;
                    document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
                },

                // ç­›é€‰æ“ä½œ
                setFilter(key, value) {
                    this.filters[key] = value;
                    this.currentPage = 1;
                },

                resetFilters() {
                    this.filters = { keyword: '', status: '', supplier: '' };
                    this.currentPage = 1;
                },

                // è¡¨æ ¼æ“ä½œ
                toggleSelectAll() {
                    if (this.isAllSelected) {
                        this.selectedIds = [];
                    } else {
                        this.selectedIds = this.paginatedData.map(item => item.id);
                    }
                },

                changeStatus(item, newStatus) {
                    item.status = newStatus;
                    this.showToast(newStatus === 'active' ? 'å·²ä¸Šæ¶' : 'å·²ä¸‹æ¶', 'success');
                },

                batchAction(action) {
                    const count = this.selectedIds.length;
                    if (count === 0) return;
                    
                    let updated = 0;
                    this.products.forEach(p => {
                        if (this.selectedIds.includes(p.id)) {
                            if (action === 'up') { p.status = 'active'; updated++; }
                            else if (action === 'down') { p.status = 'inactive'; updated++; }
                        }
                    });
                    
                    if (action === 'delete') {
                        this.products = this.products.filter(p => !this.selectedIds.includes(p.id));
                        this.calculateProductCounts();
                        this.showToast(`å·²åˆ é™¤ ${count} ä¸ªå•†å“`, 'success');
                    } else {
                        this.showToast(`å·²æ›´æ–° ${updated} ä¸ªå•†å“`, 'success');
                    }
                    this.selectedIds = [];
                },

                // å¼¹çª—æ“ä½œ
                openCategoryModal() {
                    this.categoryModalOpen = true;
                },

                closeCategoryModal() {
                    this.categoryModalOpen = false;
                },

                openAddCategory() {
                    this.categoryEditModal = {
                        open: true,
                        editing: false,
                        parentId: null,
                        data: { 
                            code: String(this.categories.length + 1).padStart(2, '0'), 
                            name: '', 
                            sort: this.categories.length + 1 
                        }
                    };
                },

                openAddSubCategory(parent) {
                    const siblingCount = parent.children?.length || 0;
                    const level = parent.level + 1;
                    let code;
                    
                    if (level === 2) {
                        code = parent.code + String(siblingCount + 1).padStart(2, '0');
                    } else if (level === 3) {
                        code = parent.code + String(siblingCount + 1).padStart(2, '0');
                    } else {
                        code = parent.code + '01';
                    }
                    
                    this.categoryEditModal = {
                        open: true,
                        editing: false,
                        parentId: parent.id,
                        data: { 
                            code: code, 
                            name: '', 
                            sort: siblingCount + 1 
                        }
                    };
                },

                openEditCategory(node) {
                    this.categoryEditModal = {
                        open: true,
                        editing: true,
                        parentId: null,
                        data: { ...node }
                    };
                },

                saveCategory() {
                    const data = this.categoryEditModal.data;
                    if (!data.code || !data.name) {
                        this.showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
                        return;
                    }

                    if (this.categoryEditModal.editing) {
                        // æ›´æ–°ç°æœ‰ç±»ç›®
                        const updateNode = (nodes) => {
                            for (let n of nodes) {
                                if (n.id === data.id) {
                                    Object.assign(n, data);
                                    return true;
                                }
                                if (n.children && updateNode(n.children)) return true;
                            }
                            return false;
                        };
                        updateNode(this.categories);
                        this.showToast('ä¿®æ”¹æˆåŠŸ');
                    } else {
                        // æ–°å¢ç±»ç›®
                        const parent = this.categoryEditModal.parentId ? 
                            this.findCategoryById(this.categories, this.categoryEditModal.parentId) : null;
                        
                        const newNode = {
                            id: Date.now().toString(),
                            ...data,
                            level: parent ? parent.level + 1 : 1,
                            children: [],
                            productCount: 0,
                            expanded: false
                        };
                        
                        if (parent) {
                            if (!parent.children) parent.children = [];
                            parent.children.push(newNode);
                            parent.children.sort((a, b) => a.sort - b.sort);
                            parent.expanded = true;
                        } else {
                            this.categories.push(newNode);
                            this.categories.sort((a, b) => a.sort - b.sort);
                        }
                        this.showToast('åˆ›å»ºæˆåŠŸ');
                    }
                    this.categoryEditModal.open = false;
                },

                confirmDeleteCategory(node) {
                    this.deleteModal = {
                        open: true,
                        type: 'category',
                        item: node
                    };
                },

                openAddProductModal() {
                    this.productModal = {
                        open: true,
                        editing: false,
                        data: { 
                            code: '', 
                            name: '', 
                            category: this.selectedCategory?.code || '', 
                            casNo: '', 
                            itemNo: '', 
                            spec: '', 
                            unit: '', 
                            price: 0, 
                            minOrderQty: 1, 
                            supplier: '', 
                            brand: '', 
                            status: 'active' 
                        }
                    };
                },

                editProduct(item) {
                    this.productModal = {
                        open: true,
                        editing: true,
                        data: { ...item }
                    };
                },

                saveProduct() {
                    const data = this.productModal.data;
                    if (!data.code || !data.name || !data.category) {
                        this.showToast('è¯·å¡«å†™å¿…å¡«é¡¹', 'error');
                        return;
                    }

                    // è‡ªåŠ¨å¡«å……ä¾›åº”å•†åç§°
                    const supplier = this.suppliers.find(s => s.id === data.supplier);
                    if (supplier) data.supplierName = supplier.name;

                    if (this.productModal.editing) {
                        const index = this.products.findIndex(p => p.id === data.id);
                        if (index > -1) {
                            this.products[index] = { ...this.products[index], ...data };
                            this.showToast('ä¿®æ”¹æˆåŠŸ');
                        }
                    } else {
                        const newProduct = {
                            id: Date.now(),
                            ...data
                        };
                        this.products.push(newProduct);
                        this.showToast('åˆ›å»ºæˆåŠŸ');
                    }
                    
                    this.calculateProductCounts();
                    this.productModal.open = false;
                },

                deleteProduct(item) {
                    this.deleteModal = {
                        open: true,
                        type: 'product',
                        item: item
                    };
                },

                executeDelete() {
                    if (this.deleteModal.type === 'product') {
                        this.products = this.products.filter(p => p.id !== this.deleteModal.item.id);
                        this.calculateProductCounts();
                        this.showToast('åˆ é™¤æˆåŠŸ');
                    } else if (this.deleteModal.type === 'category') {
                        this.removeCategory(this.categories, this.deleteModal.item.id);
                        this.calculateProductCounts();
                        this.showToast('ç±»ç›®å·²åˆ é™¤');
                        if (this.selectedCategory?.id === this.deleteModal.item.id) {
                            this.selectedCategory = null;
                        }
                    }
                    this.deleteModal.open = false;
                },

                removeCategory(nodes, id) {
                    const idx = nodes.findIndex(n => n.id === id);
                    if (idx > -1) {
                        nodes.splice(idx, 1);
                        return true;
                    }
                    for (let n of nodes) {
                        if (n.children && this.removeCategory(n.children, id)) return true;
                    }
                    return false;
                },

                refreshData() {
                    this.loading = true;
                    setTimeout(() => {
                        this.loading = false;
                        this.showToast('æ•°æ®å·²åˆ·æ–°');
                    }, 500);
                },

                showToast(message, type = 'success') {
                    this.toast = { show: true, message, type };
                    setTimeout(() => this.toast.show = false, 3000);
                }
            }
        }
    </script>
</body>
</html>
