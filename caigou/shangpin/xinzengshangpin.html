<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品基本信息维护</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f8fafc; color: #334155; }
        
        /* 字体规范 - 参考缴费单 */
        .text-num { font-family: 'Menlo', 'Monaco', monospace; font-weight: 600; }
        .text-min { font-size: 13px; line-height: 1.5; }
        
        /* 输入框样式 - 参考绩效分配 */
        .smart-input {
            width: 100%; 
            border: 1px solid #e2e8f0; 
            background: #fff; 
            padding: 8px 12px;
            border-radius: 6px; 
            outline: none; 
            transition: all 0.2s; 
            font-size: 14px;
            color: #334155;
        }
        .smart-input:hover { border-color: #94a3b8; }
        .smart-input:focus { 
            border-color: #3b82f6; 
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1); 
        }
        .smart-input::placeholder { color: #94a3b8; }
        .smart-input:disabled { background-color: #f1f5f9; cursor: not-allowed; }
        
        /* 表单分组标题 */
        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: #334155;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* 标签样式 */
        .field-label {
            font-size: 13px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 6px;
            display: block;
        }
        .field-label .required { color: #ef4444; margin-left: 2px; }
        
        /* 错误提示 */
        .error-msg {
            font-size: 12px;
            color: #ef4444;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* 图片上传区域 */
        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8fafc;
        }
        .upload-area:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .upload-area.has-file {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        /* 底部操作栏阴影 */
        .bottom-bar {
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        
        /* 动画 */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr !important; }
            .container-padding { padding: 16px; }
        }

        /* 供应商选择弹窗 */
        .modal-backdrop {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
        .modal-content {
            animation: modalSlideIn 0.3s ease-out;
        }
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* 供应商列表项 */
        .supplier-item {
            transition: all 0.2s;
            cursor: pointer;
        }
        .supplier-item:hover {
            background: #f1f5f9;
        }
        .supplier-item.selected {
            background: #eff6ff;
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden" x-data="productEditApp()">

    <!-- 顶部Header - 仅保留标题信息，移除操作按钮 -->
    <header class="bg-white border-b border-slate-200 h-16 px-6 flex justify-between items-center shadow-sm z-30 flex-shrink-0">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-200">
                <i class="fa-solid fa-box-open text-white text-lg"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-slate-800" x-text="isEdit ? '编辑商品信息' : '新增商品'">商品基本信息维护</h1>
                <div class="text-min text-slate-500 mt-0.5" x-text="isEdit ? '修改商品基础资料与配置' : '录入新商品基础信息'"></div>
            </div>
        </div>
        
        <!-- 右侧仅保留返回按钮（可选）或留空 -->
        <div class="flex items-center gap-3">
            <!-- 原顶部按钮已移到底部 -->
        </div>
    </header>

    <!-- 主体内容区 -->
    <main class="flex-1 overflow-y-auto bg-slate-50 custom-scroll pb-28">
        <div class="max-w-7xl mx-auto p-6 container-padding">
            
            <!-- 商品编码提示条（编辑模式） -->
            <div x-show="isEdit" class="mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-center justify-between fade-in">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-barcode text-blue-600"></i>
                    <div>
                        <div class="text-min text-slate-600">当前编辑商品</div>
                        <div class="font-bold text-slate-800 text-num text-lg" x-text="form.productCode">0402000001</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-min text-slate-500">创建时间</div>
                    <div class="text-sm font-medium text-slate-700" x-text="form.createTime || '2024-01-15 10:30:00'">2024-01-15 10:30:00</div>
                </div>
            </div>

            <form @submit.prevent="submitForm()" class="space-y-6">
                
                <!-- 基本信息卡片 -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 fade-in">
                    <div class="section-title">
                        <i class="fa-solid fa-circle-info text-blue-600"></i>
                        基本信息
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 form-grid">
                        <!-- 商品编码 -->
                        <div>
                            <label class="field-label">商品编码 <span x-show="!isEdit" class="text-slate-400 font-normal">(自动生成)</span></label>
                            <input type="text" x-model="form.productCode" disabled 
                                   class="smart-input bg-slate-50 text-num text-slate-600" placeholder="系统自动生成">
                            <p class="text-min text-slate-400 mt-1">规则：类目编码 + 6位流水号</p>
                        </div>

                        <!-- 商品名称 -->
                        <div class="lg:col-span-2">
                            <label class="field-label">商品名称 <span class="required">*</span></label>
                            <input type="text" x-model="form.productName" 
                                   class="smart-input" :class="errors.productName ? 'border-red-300 focus:border-red-500 focus:shadow-red-100' : ''"
                                   placeholder="请输入商品全称，如：10ml一次性离心管（无菌无酶）">
                            <p x-show="errors.productName" class="error-msg" x-text="errors.productName"></p>
                        </div>

                        <!-- 所属类目 - 三级联动 -->
                        <div class="lg:col-span-3">
                            <label class="field-label">所属类目 <span class="required">*</span></label>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <select x-model="form.categoryLevel1" @change="onCategory1Change()" 
                                        class="smart-input" :class="errors.category ? 'border-red-300' : ''">
                                    <option value="">请选择一级类目</option>
                                    <template x-for="cat in categories" :key="cat.code">
                                        <option :value="cat.code" x-text="cat.name"></option>
                                    </template>
                                </select>
                                
                                <select x-model="form.categoryLevel2" @change="onCategory2Change()" 
                                        class="smart-input" :disabled="!form.categoryLevel1">
                                    <option value="">请选择二级类目</option>
                                    <template x-for="cat in level2Options" :key="cat.code">
                                        <option :value="cat.code" x-text="cat.name"></option>
                                    </template>
                                </select>
                                
                                <select x-model="form.categoryLevel3" @change="onCategory3Change()" 
                                        class="smart-input" :disabled="!form.categoryLevel2">
                                    <option value="">请选择三级类目</option>
                                    <template x-for="cat in level3Options" :key="cat.code">
                                        <option :value="cat.code" x-text="cat.name"></option>
                                    </template>
                                </select>
                            </div>
                            <p x-show="errors.category" class="error-msg" x-text="errors.category"></p>
                        </div>

                        <!-- 规格型号 -->
                        <div class="lg:col-span-2">
                            <label class="field-label">规格型号 <span class="required">*</span></label>
                            <input type="text" x-model="form.specification" 
                                   class="smart-input" placeholder="如：材质PP、容量10ml、γ射线灭菌、100支/袋">
                            <p class="text-min text-slate-400 mt-1">建议包含：材质、容量、灭菌方式、包装规格等关键参数</p>
                        </div>

                        <!-- 单位 -->
                        <div>
                            <label class="field-label">单位 <span class="required">*</span></label>
                            <select x-model="form.unit" class="smart-input">
                                <option value="">请选择</option>
                                <option value="支">支</option>
                                <option value="袋">袋</option>
                                <option value="箱">箱</option>
                                <option value="瓶">瓶</option>
                                <option value="个">个</option>
                                <option value="盒">盒</option>
                                <option value="包">包</option>
                                <option value="卷">卷</option>
                            </select>
                        </div>

                        <!-- 单价 -->
                        <div>
                            <label class="field-label">单价（元） <span class="required">*</span></label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-slate-400">¥</span>
                                <input type="number" x-model.number="form.price" step="0.01" min="0"
                                       class="smart-input pl-7" placeholder="0.00">
                            </div>
                        </div>

                        <!-- 供应商 - 改为弹窗选择 -->
                        <div class="lg:col-span-2">
                            <label class="field-label">供应商 <span class="required">*</span></label>
                            <div class="relative">
                                <input type="text" 
                                       x-model="selectedSupplierName" 
                                       @click="openSupplierModal()"
                                       readonly
                                       class="smart-input cursor-pointer bg-white hover:border-blue-400" 
                                       :class="{'text-slate-400': !form.supplierId, 'border-red-300': errors.supplier}"
                                       placeholder="点击选择供应商">
                                <div class="absolute right-3 top-2 text-slate-400">
                                    <i class="fa-solid fa-chevron-down"></i>
                                </div>
                            </div>
                            <p x-show="errors.supplier" class="error-msg" x-text="errors.supplier"></p>
                            <p class="text-min text-slate-400 mt-1">点击输入框选择已审核通过的供应商</p>
                        </div>

                        <!-- 状态 -->
                        <div>
                            <label class="field-label">上架状态</label>
                            <div class="flex items-center gap-4 mt-2">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" x-model="form.status" value="active" class="w-4 h-4 text-blue-600 border-slate-300 focus:ring-blue-500">
                                    <span class="text-sm text-slate-700">立即上架</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" x-model="form.status" value="inactive" class="w-4 h-4 text-slate-600 border-slate-300 focus:ring-slate-500">
                                    <span class="text-sm text-slate-500">暂不上架</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 库存与预警 - 已移除库存预警值 -->
                <!-- <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 fade-in">
                    <div class="section-title">
                        <i class="fa-solid fa-warehouse text-indigo-600"></i>
                        库存配置
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 form-grid">
                        <div>
                            <label class="field-label">最小起订量</label>
                            <input type="number" x-model.number="form.minOrderQty" min="1" class="smart-input" placeholder="1">
                        </div>
                        
                        <div>
                            <label class="field-label">有效期（月）</label>
                            <input type="number" x-model.number="form.shelfLife" min="0" class="smart-input" placeholder="36">
                            <p class="text-min text-slate-400 mt-1">0表示长期有效</p>
                        </div>
                    </div>
                </div> -->

                <!-- 技术参数 -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 fade-in">
                    <div class="section-title">
                        <i class="fa-solid fa-flask text-purple-600"></i>
                        技术参数与说明
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 form-grid">
                        <div>
                            <label class="field-label">材质说明</label>
                            <input type="text" x-model="form.material" class="smart-input" placeholder="如：PP、玻璃、PTFE、不锈钢">
                        </div>
                        
                        <div>
                            <label class="field-label">适用场景</label>
                            <input type="text" x-model="form.application" class="smart-input" placeholder="如：气相色谱分析、细胞培养、常规实验">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="field-label">技术参数详情</label>
                            <textarea x-model="form.technicalParams" rows="3" class="smart-input resize-none" 
                                      placeholder="耐温范围、离心耐受度、化学兼容性、精度等级等详细技术参数..."></textarea>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="field-label">备注说明</label>
                            <textarea x-model="form.remark" rows="2" class="smart-input resize-none" 
                                      placeholder="其他需要说明的信息，如特殊储存条件、使用注意事项等"></textarea>
                        </div>
                    </div>
                </div>

                <!-- 图片附件 -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 fade-in">
                    <div class="section-title">
                        <i class="fa-solid fa-images text-emerald-600"></i>
                        商品图片与附件
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- 主图上传 -->
                        <div>
                            <label class="field-label">商品主图</label>
                            <div class="upload-area" :class="form.mainImage ? 'has-file' : ''" @click="$refs.mainImageInput.click()">
                                <input type="file" x-ref="mainImageInput" @change="handleImageUpload($event, 'mainImage')" accept="image/*" class="hidden">
                                <template x-if="!form.mainImage">
                                    <div>
                                        <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-400 mb-2"></i>
                                        <p class="text-sm text-slate-600">点击上传商品主图</p>
                                        <p class="text-min text-slate-400 mt-1">支持 JPG、PNG 格式，建议尺寸 800x800</p>
                                    </div>
                                </template>
                                <template x-if="form.mainImage">
                                    <div class="relative">
                                        <img :src="form.mainImage" class="h-32 mx-auto rounded-lg shadow-sm">
                                        <button @click.stop="form.mainImage = null" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600">
                                            <i class="fa-solid fa-xmark"></i>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- 附件上传 -->
                        <div>
                            <label class="field-label">相关附件</label>
                            <div class="upload-area" @click="$refs.fileInput.click()">
                                <input type="file" x-ref="fileInput" @change="handleFileUpload($event)" multiple class="hidden">
                                <i class="fa-solid fa-paperclip text-3xl text-slate-400 mb-2"></i>
                                <p class="text-sm text-slate-600">点击上传附件</p>
                                <p class="text-min text-slate-400 mt-1">支持 PDF、DOC、XLS 等格式</p>
                            </div>
                            <!-- 文件列表 -->
                            <div class="mt-3 space-y-2" x-show="form.attachments.length > 0">
                                <template x-for="(file, index) in form.attachments" :key="index">
                                    <div class="flex items-center justify-between p-2 bg-slate-50 rounded border border-slate-200 text-min">
                                        <div class="flex items-center gap-2 truncate">
                                            <i class="fa-regular fa-file text-blue-600"></i>
                                            <span class="truncate" x-text="file.name"></span>
                                        </div>
                                        <button @click="removeAttachment(index)" class="text-slate-400 hover:text-red-500">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </main>

    <!-- 底部固定操作栏 - 移至底部，整合原顶部按钮 -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 px-6 py-4 bottom-bar z-40">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="text-min text-slate-500 flex items-center gap-2">
                <i class="fa-solid fa-circle-info"></i>
                <span>带 <span class="text-red-500">*</span> 的为必填项</span>
            </div>
            <div class="flex gap-3">
                <button @click="goBack()" class="px-5 py-2.5 border border-slate-300 rounded-lg text-slate-700 text-sm font-medium hover:bg-slate-50 transition flex items-center gap-2">
                    <i class="fa-solid fa-arrow-left"></i> 返回
                </button>
                <button @click="saveDraft()" class="px-5 py-2.5 border border-slate-300 rounded-lg text-slate-700 text-sm font-medium hover:bg-slate-50 transition flex items-center gap-2">
                    <i class="fa-regular fa-floppy-disk"></i> 暂存草稿
                </button>
                <button @click="submitForm()" class="px-6 py-2.5 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 shadow-md shadow-blue-200 transition flex items-center gap-2">
                    <i class="fa-solid fa-check"></i> 确认保存
                </button>
            </div>
        </div>
    </div>

    <!-- 供应商选择弹窗 -->
    <div x-show="supplierModal.open" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4" x-cloak @click.self="closeSupplierModal()">
        <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl modal-content flex flex-col max-h-[80vh]">
            <!-- 弹窗头部 -->
            <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <h3 class="text-lg font-bold text-slate-800">选择供应商</h3>
                <button @click="closeSupplierModal()" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <!-- 搜索框 -->
            <div class="p-4 border-b border-slate-200">
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-3 top-3 text-slate-400 text-sm"></i>
                    <input type="text" 
                           x-model="supplierModal.search" 
                           @input.debounce.300="filterSuppliers()"
                           placeholder="搜索供应商名称..." 
                           class="smart-input pl-9"
                           autofocus>
                </div>
            </div>
            
            <!-- 供应商列表 -->
            <div class="flex-1 overflow-y-auto custom-scroll p-2">
                <div x-show="supplierModal.filteredSuppliers.length === 0" class="text-center py-8 text-slate-400">
                    <i class="fa-solid fa-inbox text-3xl mb-2"></i>
                    <p class="text-min">未找到匹配的供应商</p>
                </div>
                
                <template x-for="sup in supplierModal.filteredSuppliers" :key="sup.id">
                    <div class="supplier-item p-3 border border-slate-200 rounded-lg mb-2 flex items-center justify-between"
                         :class="{'selected': form.supplierId === sup.id}"
                         @click="selectSupplier(sup)">
                        <div>
                            <div class="font-medium text-slate-800" x-text="sup.name"></div>
                            <div class="text-min text-slate-500 mt-1" x-text="sup.contact || '暂无联系方式'"></div>
                        </div>
                        <div x-show="form.supplierId === sup.id" class="text-blue-600">
                            <i class="fa-solid fa-check-circle text-xl"></i>
                        </div>
                    </div>
                </template>
            </div>
            
            <!-- 弹窗底部 -->
            <div class="px-6 py-4 border-t border-slate-200 bg-slate-50 flex justify-between items-center">
                <span class="text-min text-slate-500">
                    共 <span x-text="supplierModal.filteredSuppliers.length" class="font-medium"></span> 家供应商
                </span>
                <div class="flex gap-3">
                    <button @click="closeSupplierModal()" class="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg text-sm font-medium hover:bg-white transition">
                        取消
                    </button>
                    <button @click="confirmSupplierSelection()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition"
                            :disabled="!supplierModal.tempSelected"
                            :class="{'opacity-50 cursor-not-allowed': !supplierModal.tempSelected}">
                        确认选择
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 成功提示Toast -->
    <div x-show="toast.show" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-2"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition ease-in duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed top-20 right-6 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-2xl z-[100] flex items-center gap-3">
        <i class="fa-solid" :class="toast.type === 'success' ? 'fa-check-circle text-emerald-400' : 'fa-circle-exclamation text-rose-400'"></i>
        <span class="text-sm font-medium" x-text="toast.message"></span>
    </div>

    <script>
        function productEditApp() {
            return {
                isEdit: true,
                form: {
                    productCode: '0402000001',
                    productName: '10ml一次性离心管（无菌无酶）',
                    categoryLevel1: '04',
                    categoryLevel2: '0402',
                    categoryLevel3: '040201',
                    specification: '材质PP、容量10ml、γ射线灭菌、100支/袋',
                    unit: '袋',
                    price: 45.00,
                    supplierId: 'S001',
                    status: 'active',
                    minOrderQty: 1,
                    shelfLife: 36,
                    material: 'PP',
                    application: '细胞培养、分子生物学实验',
                    technicalParams: '耐温范围：-80℃~120℃\n离心耐受：12000rpm\n无菌级别：γ射线灭菌，SAL 10^-6',
                    remark: '',
                    mainImage: null,
                    attachments: [],
                    createTime: '2024-01-15 10:30:00'
                },
                errors: {},
                level2Options: [],
                level3Options: [],
                
                // 供应商相关
                selectedSupplierName: '西安化学试剂有限公司',
                supplierModal: {
                    open: false,
                    search: '',
                    filteredSuppliers: [],
                    tempSelected: null
                },
                
                categories: [
                    { code: '01', name: '化学试剂', children: [
                        { code: '0101', name: '无机试剂' },
                        { code: '0102', name: '有机试剂' }
                    ]},
                    { code: '02', name: '玻璃器皿', children: [] },
                    { code: '03', name: '仪器配件', children: [] },
                    { code: '04', name: '样品前处理耗材', children: [
                        { code: '0401', name: '滤膜' },
                        { code: '0402', name: '离心管', children: [
                            { code: '040201', name: '微量离心管' },
                            { code: '040202', name: '螺口离心管' }
                        ]},
                        { code: '0403', name: '样品瓶' }
                    ]},
                    { code: '05', name: '安全防护用品', children: [] }
                ],
                
                suppliers: [
                    { id: 'S001', name: '西安化学试剂有限公司', contact: '张经理 029-88886666' },
                    { id: 'S002', name: '赛默飞世尔科技', contact: '李经理 010-12345678' },
                    { id: 'S003', name: '国药集团化学试剂', contact: '王经理 021-87654321' },
                    { id: 'S004', name: '阿拉丁试剂（上海）有限公司', contact: '刘经理 021-50321688' },
                    { id: 'S005', name: 'Sigma-Aldrich西格玛奥德里奇', contact: '陈经理 400-889-1988' },
                    { id: 'S006', name: 'TCI梯希爱（上海）化成工业发展有限公司', contact: '赵经理 021-67121386' }
                ],
                
                toast: { show: false, message: '', type: 'success' },

                init() {
                    const urlParams = new URLSearchParams(window.location.search);
                    this.isEdit = urlParams.get('mode') !== 'add';
                    
                    if (this.isEdit) {
                        this.loadCategoryOptions();
                        // 加载供应商显示名称
                        const sup = this.suppliers.find(s => s.id === this.form.supplierId);
                        if (sup) this.selectedSupplierName = sup.name;
                    } else {
                        this.resetForm();
                    }
                    
                    // 初始化供应商列表
                    this.supplierModal.filteredSuppliers = [...this.suppliers];
                },

                loadCategoryOptions() {
                    if (this.form.categoryLevel1) {
                        const cat1 = this.categories.find(c => c.code === this.form.categoryLevel1);
                        this.level2Options = cat1?.children || [];
                    }
                    if (this.form.categoryLevel2) {
                        const cat2 = this.level2Options.find(c => c.code === this.form.categoryLevel2);
                        this.level3Options = cat2?.children || [];
                    }
                },

                resetForm() {
                    this.form = {
                        productCode: '',
                        productName: '',
                        categoryLevel1: '',
                        categoryLevel2: '',
                        categoryLevel3: '',
                        specification: '',
                        unit: '',
                        price: null,
                        supplierId: '',
                        status: 'active',
                        minOrderQty: 1,
                        shelfLife: 36,
                        material: '',
                        application: '',
                        technicalParams: '',
                        remark: '',
                        mainImage: null,
                        attachments: []
                    };
                    this.selectedSupplierName = '';
                    this.level2Options = [];
                    this.level3Options = [];
                },

                onCategory1Change() {
                    this.form.categoryLevel2 = '';
                    this.form.categoryLevel3 = '';
                    this.level3Options = [];
                    
                    const cat1 = this.categories.find(c => c.code === this.form.categoryLevel1);
                    this.level2Options = cat1?.children || [];
                    
                    this.generateProductCode();
                },

                onCategory2Change() {
                    this.form.categoryLevel3 = '';
                    
                    const cat2 = this.level2Options.find(c => c.code === this.form.categoryLevel2);
                    this.level3Options = cat2?.children || [];
                    
                    this.generateProductCode();
                },

                onCategory3Change() {
                    this.generateProductCode();
                },

                generateProductCode() {
                    if (this.isEdit) return;
                    
                    let prefix = this.form.categoryLevel3 || this.form.categoryLevel2 || this.form.categoryLevel1;
                    if (prefix) {
                        const serial = Math.floor(100000 + Math.random() * 900000);
                        this.form.productCode = prefix + serial;
                    }
                },

                // 供应商选择相关方法
                openSupplierModal() {
                    this.supplierModal.open = true;
                    this.supplierModal.search = '';
                    this.supplierModal.tempSelected = this.form.supplierId;
                    this.filterSuppliers();
                    // 聚焦到搜索框
                    this.$nextTick(() => {
                        const searchInput = document.querySelector('.modal-content input[type="text"]');
                        if (searchInput) searchInput.focus();
                    });
                },

                closeSupplierModal() {
                    this.supplierModal.open = false;
                    this.supplierModal.tempSelected = null;
                },

                filterSuppliers() {
                    if (!this.supplierModal.search) {
                        this.supplierModal.filteredSuppliers = [...this.suppliers];
                    } else {
                        const keyword = this.supplierModal.search.toLowerCase();
                        this.supplierModal.filteredSuppliers = this.suppliers.filter(s => 
                            s.name.toLowerCase().includes(keyword) || 
                            s.id.toLowerCase().includes(keyword)
                        );
                    }
                },

                selectSupplier(supplier) {
                    this.supplierModal.tempSelected = supplier.id;
                },

                confirmSupplierSelection() {
                    if (this.supplierModal.tempSelected) {
                        this.form.supplierId = this.supplierModal.tempSelected;
                        const sup = this.suppliers.find(s => s.id === this.supplierModal.tempSelected);
                        if (sup) this.selectedSupplierName = sup.name;
                    }
                    this.closeSupplierModal();
                },

                validate() {
                    this.errors = {};
                    let valid = true;

                    if (!this.form.productName.trim()) {
                        this.errors.productName = '请输入商品名称';
                        valid = false;
                    }

                    if (!this.form.categoryLevel1 || !this.form.categoryLevel2) {
                        this.errors.category = '请选择完整类目';
                        valid = false;
                    }

                    if (!this.form.specification.trim()) {
                        this.errors.specification = '请输入规格型号';
                        valid = false;
                    }

                    if (!this.form.price || this.form.price <= 0) {
                        this.errors.price = '请输入有效单价';
                        valid = false;
                    }

                    if (!this.form.supplierId) {
                        this.errors.supplier = '请选择供应商';
                        valid = false;
                    }

                    return valid;
                },

                submitForm() {
                    if (!this.validate()) {
                        this.showToast('请检查必填项', 'error');
                        const firstError = document.querySelector('.border-red-300');
                        if (firstError) {
                            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        return;
                    }

                    console.log('提交数据：', this.form);
                    this.showToast(this.isEdit ? '商品信息更新成功' : '商品创建成功', 'success');
                    
                    setTimeout(() => {
                        this.goBack();
                    }, 1500);
                },

                saveDraft() {
                    localStorage.setItem('productDraft', JSON.stringify(this.form));
                    this.showToast('草稿已保存', 'success');
                },

                goBack() {
                    if (confirm('确定要离开吗？未保存的更改将丢失。')) {
                        window.history.back();
                    }
                },

                handleImageUpload(event, field) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.form[field] = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                },

                handleFileUpload(event) {
                    const files = Array.from(event.target.files);
                    files.forEach(file => {
                        this.form.attachments.push({
                            name: file.name,
                            size: file.size,
                            type: file.type
                        });
                    });
                },

                removeAttachment(index) {
                    this.form.attachments.splice(index, 1);
                },

                showToast(message, type = 'success') {
                    this.toast = { show: true, message, type };
                    setTimeout(() => this.toast.show = false, 3000);
                }
            }
        }
    </script>
</body>
</html>
