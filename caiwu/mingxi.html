<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµ„é‡‘æ˜ç»†å½•å…¥ - èµ„é‡‘é¢„ç®—ç®¡ç†ç³»ç»Ÿ</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        [x-cloak] { display: none !important; }
        body { 
            font-family: 'Inter', 'PingFang SC', 'Microsoft YaHei', system-ui, sans-serif; 
            background-color: #f1f5f9; 
            color: #334155; 
        }
        
        .text-num { font-family: 'Menlo', 'Monaco', 'JetBrains Mono', monospace; font-weight: 600; }
        .text-min { font-size: 13px; line-height: 1.5; }
        
        /* æ»šåŠ¨æ¡ */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.3s;
            cursor: pointer;
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); }
        .stat-card.active { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        
        /* è¡¨æ ¼æ ·å¼ */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        .data-table th {
            background: #f8fafc;
            font-size: 13px;
            font-weight: 600;
            color: #475569;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
        }
        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
            vertical-align: middle;
        }
        .data-table tbody tr:hover td { background: #f8fafc; }
        
        /* è¾“å…¥æ¡† */
        .smart-input {
            width: 100%;
            border: 1px solid #e2e8f0;
            background: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            outline: none;
            transition: all 0.2s;
            font-size: 14px;
        }
        .smart-input:hover { border-color: #94a3b8; }
        .smart-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        .smart-input:disabled { background-color: #f1f5f9; cursor: not-allowed; color: #64748b; }
        .smart-input.error { border-color: #ef4444; }
        
        /* çŠ¶æ€æ ‡ç­¾ */
        .status-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }
        .status-draft { background: #e0e7ff; color: #3730a3; border: 1px solid #c7d2fe; }
        .status-pending { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
        .status-approved { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .status-rejected { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        
        /* æ“ä½œæŒ‰é’® */
        .action-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            flex-wrap: nowrap;
        }
        .action-link {
            color: #3b82f6;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            padding: 4px 6px;
            border-radius: 4px;
            white-space: nowrap;
        }
        .action-link:hover { color: #2563eb; background: #eff6ff; text-decoration: underline; }
        .action-link.danger { color: #dc2626; }
        .action-link.danger:hover { color: #b91c1c; background: #fee2e2; }
        .action-link.success { color: #059669; }
        .action-link.success:hover { color: #047857; background: #d1fae5; }
        .action-link.disabled { color: #cbd5e1; cursor: not-allowed; text-decoration: none; }
        .action-link.disabled:hover { background: transparent; }
        .action-divider { color: #e2e8f0; user-select: none; }
        
        /* å¼¹çª— */
        .modal-backdrop {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
        
        /* æ­¥éª¤æ¡ */
        .step-item { position: relative; flex: 1; text-align: center; }
        .step-item::before { content: ''; position: absolute; top: 14px; left: -50%; width: 100%; height: 2px; background: #e2e8f0; z-index: 0; }
        .step-item:first-child::before { display: none; }
        .step-item.completed::before { background: #10b981; }
        .step-item.active::before { background: #3b82f6; }
        .step-icon { width: 28px; height: 28px; background: #e2e8f0; color: #64748b; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; position: relative; z-index: 1; font-size: 12px; font-weight: 600; }
        .step-item.completed .step-icon { background: #10b981; color: white; }
        .step-item.active .step-icon { background: #3b82f6; color: white; }
        .step-item.rejected .step-icon { background: #ef4444; color: white; }
        
        /* æ‰¹é‡æ“ä½œæ  */
        .batch-bar {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        /* åˆ†é¡µ */
        .pagination-btn {
            padding: 6px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #475569;
            font-size: 13px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pagination-btn:hover:not(:disabled) { border-color: #3b82f6; color: #3b82f6; }
        .pagination-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* ç±»å‹Tabæ ·å¼ */
        .type-tab {
            position: relative;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
            background: transparent;
        }
        .type-tab:hover { color: #334155; background: rgba(59,130,246,0.05); }
        .type-tab.active { 
            color: #3b82f6; 
            border-bottom-color: #3b82f6;
            background: rgba(59,130,246,0.08);
        }
        .type-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #3b82f6;
        }
        
        /* ç±»å‹å¾½ç«  */
        .type-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .type-badge-actual {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .type-badge-plan {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        
        /* é¡¹ç›®åç§°åˆ†ç»„æ ·å¼ */
        .project-group-label {
            font-weight: 600;
            color: #ea580c;
            background-color: #fff7ed;
        }
        .project-item {
            color: #334155;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden" x-data="fundDetailApp()">

    <!-- é¡¶éƒ¨Header -->
    <header class="bg-white border-b border-slate-200 h-16 px-6 flex justify-between items-center shadow-sm z-30 flex-shrink-0">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-200">
                <i class="fa-solid fa-money-bill-transfer text-white text-lg"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-slate-800">èµ„é‡‘æ˜ç»†å½•å…¥</h1>
                <div class="text-min text-slate-500 mt-0.5">å®é™…å‘ç”Ÿä¸è®¡åˆ’æ˜ç»†ç®¡ç† Â· å›æ¬¾ä¸æ”¯å‡ºè®°å½•</div>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <button @click="refreshData()" class="w-10 h-10 flex items-center justify-center text-slate-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition" title="åˆ·æ–°">
                <i class="fa-solid fa-rotate-right" :class="loading ? 'animate-spin' : ''"></i>
            </button>
            <button @click="exportData()" class="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-50 transition flex items-center gap-2">
                <i class="fa-solid fa-download"></i> å¯¼å‡º
            </button>
            <button @click="openImportModal()" class="px-4 py-2 border border-blue-300 text-blue-600 rounded-lg text-sm font-medium hover:bg-blue-50 transition flex items-center gap-2">
                <i class="fa-solid fa-file-import"></i> æ‰¹é‡å¯¼å…¥
            </button>
            <button @click="openEditModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 shadow-md shadow-blue-200 transition flex items-center gap-2">
                <i class="fa-solid fa-plus"></i> æ–°å¢æ˜ç»†
            </button>
        </div>
    </header>

    <!-- ä¸»ç±»å‹Tabåˆ‡æ¢æ  -->
    <div class="bg-white border-b border-slate-200 flex-shrink-0 px-6">
        <div class="flex gap-1">
            <button @click="switchRecordType('actual')" class="type-tab flex items-center gap-2" :class="{'active': recordTypeTab === 'actual'}">
                <i class="fa-solid fa-receipt" :class="recordTypeTab === 'actual' ? 'text-blue-600' : 'text-slate-400'"></i>
                <span>å®é™…å‘ç”Ÿæ˜ç»†</span>
                <span class="ml-2 px-2 py-0.5 rounded-full text-xs font-bold" 
                      :class="recordTypeTab === 'actual' ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-600'"
                      x-text="stats.actualCount">0</span>
            </button>
            <button @click="switchRecordType('plan')" class="type-tab flex items-center gap-2" :class="{'active': recordTypeTab === 'plan'}">
                <i class="fa-solid fa-calendar-check" :class="recordTypeTab === 'plan' ? 'text-amber-600' : 'text-slate-400'"></i>
                <span>è®¡åˆ’æ˜ç»†</span>
                <span class="ml-2 px-2 py-0.5 rounded-full text-xs font-bold"
                      :class="recordTypeTab === 'plan' ? 'bg-amber-500 text-white' : 'bg-slate-200 text-slate-600'"
                      x-text="stats.planCount">0</span>
            </button>
        </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡åŒºåŸŸ -->
    <div class="bg-white border-b border-slate-200 px-6 py-4 grid grid-cols-2 md:grid-cols-5 gap-4 flex-shrink-0 overflow-x-auto">
        <div class="stat-card flex items-center justify-between" :class="{'active': currentTab === 'all'}" @click="currentTab = 'all'">
            <div>
                <div class="text-min text-slate-500 mb-1">å…¨éƒ¨è®°å½•</div>
                <div class="text-2xl font-bold text-slate-800" x-text="filteredStats.total">0</div>
            </div>
            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600">
                <i class="fa-solid fa-layer-group"></i>
            </div>
        </div>
        
        <div class="stat-card flex items-center justify-between" :class="{'active': currentTab === 'draft'}" @click="currentTab = 'draft'">
            <div>
                <div class="text-min text-slate-500 mb-1">è‰ç¨¿/å¾…æäº¤</div>
                <div class="text-2xl font-bold text-indigo-600" x-text="filteredStats.draft">0</div>
            </div>
            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600">
                <i class="fa-solid fa-pen-to-square"></i>
            </div>
        </div>
        
        <div class="stat-card flex items-center justify-between" :class="{'active': currentTab === 'pending'}" @click="currentTab = 'pending'">
            <div>
                <div class="text-min text-slate-500 mb-1">å®¡æ‰¹ä¸­</div>
                <div class="text-2xl font-bold text-amber-500" x-text="filteredStats.pending">0</div>
            </div>
            <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center text-amber-600">
                <i class="fa-solid fa-clock"></i>
            </div>
        </div>
        
        <div class="stat-card flex items-center justify-between" :class="{'active': currentTab === 'approved'}" @click="currentTab = 'approved'">
            <div>
                <div class="text-min text-slate-500 mb-1">å·²å®¡æ ¸</div>
                <div class="text-2xl font-bold text-emerald-600" x-text="filteredStats.approved">0</div>
            </div>
            <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600">
                <i class="fa-solid fa-check-circle"></i>
            </div>
        </div>
        
        <div class="stat-card flex items-center justify-between border-red-200 bg-red-50" :class="{'active': currentTab === 'rejected'}" @click="currentTab = 'rejected'">
            <div>
                <div class="text-min text-red-600 mb-1 font-medium">å·²é©³å›</div>
                <div class="text-2xl font-bold text-red-600" x-text="filteredStats.rejected">0</div>
            </div>
            <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-600">
                <i class="fa-solid fa-circle-xmark"></i>
            </div>
        </div>
    </div>

    <!-- ä¸»ä½“å†…å®¹åŒº -->
    <main class="flex-1 overflow-hidden flex flex-col bg-slate-50 p-6">
        
        <!-- ç­›é€‰æ  -->
        <div class="bg-white rounded-xl border border-slate-200 p-4 mb-4 shadow-sm flex flex-wrap gap-4 items-end">
            <div class="flex-1 min-w-[200px]">
                <label class="block text-min text-slate-500 mb-1">å…³é”®è¯æœç´¢</label>
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-3 top-2.5 text-slate-400 text-sm"></i>
                    <input type="text" x-model="filters.keyword" placeholder="æ‘˜è¦/åˆåŒåç§°/å¯¹æ–¹åç§°" 
                           class="smart-input pl-9" @input.debounce.500="applyFilters()">
                </div>
            </div>
            
            <div class="w-48">
                <label class="block text-min text-slate-500 mb-1">æœºæ„åç§°</label>
                <select x-model="filters.orgName" class="smart-input" @change="applyFilters()">
                    <option value="">å…¨éƒ¨æœºæ„</option>
                    <template x-for="org in orgList" :key="org">
                        <option :value="org" x-text="org"></option>
                    </template>
                </select>
            </div>
            
            <div class="w-40">
                <label class="block text-min text-slate-500 mb-1">éƒ¨é—¨åç§°</label>
                <select x-model="filters.deptName" class="smart-input" @change="applyFilters()">
                    <option value="">å…¨éƒ¨éƒ¨é—¨</option>
                    <template x-for="dept in deptList" :key="dept">
                        <option :value="dept" x-text="dept"></option>
                    </template>
                </select>
            </div>
            
            <div class="w-32">
                <label class="block text-min text-slate-500 mb-1">èµ„é‡‘ç±»å‹</label>
                <select x-model="filters.fundType" class="smart-input" @change="applyFilters()">
                    <option value="">å…¨éƒ¨</option>
                    <option value="income">å›æ¬¾</option>
                    <option value="expense">æ”¯å‡º</option>
                </select>
            </div>
            
            <div class="w-40">
                <label class="block text-min text-slate-500 mb-1">é¡¹ç›®åç§°</label>
                <select x-model="filters.projectName" class="smart-input" @change="applyFilters()">
                    <option value="">å…¨éƒ¨é¡¹ç›®</option>
                    <template x-for="project in projectTypes" :key="project.code">
                        <option :value="project.code" x-text="project.name" :class="project.auto ? 'project-group-label' : 'project-item'"></option>
                    </template>
                </select>
            </div>
            
            <div class="w-40">
                <label class="block text-min text-slate-500 mb-1">å‘ç”Ÿæ—¥æœŸ</label>
                <input type="date" x-model="filters.date" class="smart-input" @change="applyFilters()">
            </div>
            
            <button @click="resetFilters()" class="px-4 py-2 text-slate-500 hover:text-slate-700 text-sm font-medium transition mb-0.5">
                <i class="fa-solid fa-rotate-left mr-1"></i> é‡ç½®
            </button>
        </div>

        <!-- æ‰¹é‡æ“ä½œæ  -->
        <div x-show="selectedIds.length > 0" class="batch-bar" x-cloak>
            <div class="flex items-center gap-3">
                <span class="text-min font-medium text-blue-900">
                    å·²é€‰æ‹© <span x-text="selectedIds.length" class="font-bold"></span> é¡¹
                </span>
                <span class="text-slate-300">|</span>
                <button @click="batchSubmit()" class="text-sm text-blue-700 hover:text-blue-800 font-medium px-2 py-1 rounded hover:bg-blue-100 transition">
                    æ‰¹é‡æäº¤
                </button>
                <button @click="batchDelete()" class="text-sm text-red-700 hover:text-red-800 font-medium px-2 py-1 rounded hover:bg-red-100 transition">
                    æ‰¹é‡åˆ é™¤
                </button>
            </div>
            <button @click="selectedIds = []" class="text-min text-slate-500 hover:text-slate-700">
                å–æ¶ˆé€‰æ‹©
            </button>
        </div>

        <!-- æ•°æ®è¡¨æ ¼ -->
        <div class="flex-1 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col">
            <div class="overflow-auto custom-scroll flex-1">
                <table class="data-table">
                    <thead class="sticky top-0 z-10">
                        <tr>
                            <th class="w-10 text-center cursor-default">
                                <input type="checkbox" :checked="isAllSelected" @change="toggleSelectAll()" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                            </th>
                            <th class="w-32">ç±»å‹</th>
                            <th class="w-36">æœºæ„åç§°</th>
                            <th class="w-32">éƒ¨é—¨åç§°</th>
                            <th class="w-24 text-center">èµ„é‡‘ç±»å‹</th>
                            <th class="w-32">é¡¹ç›®åç§°</th>
                            <th class="w-28 text-right">å‘ç”Ÿé‡‘é¢</th>
                            <th class="w-28">å‘ç”Ÿæ—¥æœŸ</th>
                            <th class="min-w-[150px]">æ‘˜è¦</th>
                            <th class="w-32">ç›¸å¯¹æ–¹åç§°</th>
                            <th class="w-36">å…³è”åˆåŒ</th>
                            <th class="w-24 text-center">çŠ¶æ€</th>
                            <th class="w-24">å¡«æŠ¥äºº</th>
                            <th class="text-center w-48">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(item, index) in paginatedData" :key="item.id">
                            <tr class="fade-in">
                                <td class="text-center" @click.stop>
                                    <input type="checkbox" :value="item.id" x-model="selectedIds" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                                </td>
                                <td>
                                    <span class="type-badge" :class="item.recordType === 'actual' ? 'type-badge-actual' : 'type-badge-plan'">
                                        <i class="fa-solid mr-1" :class="item.recordType === 'actual' ? 'fa-receipt' : 'fa-calendar-check'"></i>
                                        <span x-text="item.recordType === 'actual' ? 'å®é™…å‘ç”Ÿ' : 'è®¡åˆ’'"></span>
                                    </span>
                                </td>
                                <td class="font-medium text-slate-800" x-text="item.orgName"></td>
                                <td class="text-slate-600" x-text="item.deptName"></td>
                                <td class="text-center">
                                    <span class="px-2 py-1 rounded text-xs font-medium" 
                                          :class="item.fundType === 'income' ? 'bg-emerald-50 text-emerald-700 border border-emerald-200' : 'bg-rose-50 text-rose-700 border border-rose-200'"
                                          x-text="item.fundType === 'income' ? 'å›æ¬¾' : 'æ”¯å‡º'">
                                    </span>
                                </td>
                                <td>
                                    <div class="text-sm text-slate-700" x-text="getProjectName(item.projectCode)"></div>
                                    <div class="text-min text-slate-400" x-text="item.projectCode"></div>
                                </td>
                                <td class="text-right font-medium text-num" 
                                    :class="item.fundType === 'income' ? 'text-emerald-600' : 'text-rose-600'"
                                    x-text="(item.fundType === 'income' ? '+' : '-') + 'Â¥' + formatMoney(item.amount)">
                                </td>
                                <td class="text-min text-slate-600" x-text="item.date"></td>
                                <td class="text-slate-700 max-w-[200px] truncate" :title="item.summary" x-text="item.summary || '-'"></td>
                                <td class="text-slate-600" x-text="item.counterparty || '-'"></td>
                                <td class="text-min text-slate-500" x-text="item.contract || '-'"></td>
                                <td class="text-center">
                                    <span class="status-tag" :class="'status-' + item.status">
                                        <i class="fa-solid fa-circle text-[8px]"></i>
                                        <span x-text="getStatusText(item.status)"></span>
                                    </span>
                                </td>
                                <td class="text-min text-slate-600" x-text="item.operator"></td>
                                <td class="text-center">
                                    <div class="action-bar">
                                        <span class="action-link" @click="viewDetail(item)">
                                            <i class="fa-solid fa-eye mr-1"></i>æŸ¥çœ‹
                                        </span>
                                        <span class="action-divider">|</span>
                                        
                                        <template x-if="item.status === 'draft' || item.status === 'rejected'">
                                            <span class="action-link" @click="openEditModal(item)">
                                                <i class="fa-solid fa-pen mr-1"></i>ç¼–è¾‘
                                            </span>
                                        </template>
                                        <template x-if="item.status !== 'draft' && item.status !== 'rejected'">
                                            <span class="action-link disabled">ç¼–è¾‘</span>
                                        </template>
                                        
                                        <span class="action-divider">|</span>
                                        
                                        <template x-if="item.status === 'draft' || item.status === 'rejected'">
                                            <span class="action-link success" @click="submitItem(item)">
                                                <i class="fa-solid fa-paper-plane mr-1"></i>æäº¤
                                            </span>
                                        </template>
                                        <template x-if="item.status !== 'draft' && item.status !== 'rejected'">
                                            <span class="action-link disabled">æäº¤</span>
                                        </template>
                                        
                                        <span class="action-divider">|</span>
                                        
                                        <template x-if="item.status === 'pending'">
                                            <span class="action-link" @click="recallItem(item)" style="color: #f59e0b;">
                                                <i class="fa-solid fa-rotate-left mr-1"></i>æ’¤å›
                                            </span>
                                        </template>
                                        <template x-if="item.status !== 'pending'">
                                            <span class="action-link disabled">æ’¤å›</span>
                                        </template>
                                        
                                        <span class="action-divider">|</span>
                                        
                                        <template x-if="item.status === 'pending'">
                                            <span class="action-link" @click="openApproveModal(item)">
                                                <i class="fa-solid fa-gavel mr-1"></i>å®¡æ‰¹
                                            </span>
                                        </template>
                                        <template x-if="item.status !== 'pending'">
                                            <span class="action-link disabled">å®¡æ‰¹</span>
                                        </template>
                                        
                                        <span class="action-divider">|</span>
                                        
                                        <template x-if="item.status !== 'pending'">
                                            <span class="action-link danger" @click="deleteItem(item)">
                                                <i class="fa-solid fa-trash mr-1"></i>åˆ é™¤
                                            </span>
                                        </template>
                                        <template x-if="item.status === 'pending'">
                                            <span class="action-link disabled">åˆ é™¤</span>
                                        </template>
                                    </div>
                                </td>
                            </tr>
                        </template>
                        
                        <!-- ç©ºçŠ¶æ€ -->
                        <tr x-show="paginatedData.length === 0">
                            <td colspan="14" class="text-center py-16 text-slate-400">
                                <div class="mb-3 text-4xl">ğŸ“­</div>
                                <div class="text-min">æš‚æ— ç¬¦åˆæ¡ä»¶çš„èµ„é‡‘æ˜ç»†è®°å½•</div>
                                <button @click="openEditModal()" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition">
                                    <i class="fa-solid fa-plus mr-1"></i> æ–°å¢æ˜ç»†
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- åˆ†é¡µ -->
            <div class="border-t border-slate-200 px-6 py-4 flex items-center justify-between bg-slate-50">
                <div class="text-min text-slate-500">
                    æ˜¾ç¤º <span x-text="(currentPage - 1) * pageSize + 1" class="font-medium"></span> - 
                    <span x-text="Math.min(currentPage * pageSize, filteredData.length)" class="font-medium"></span> æ¡ï¼Œ
                    å…± <span x-text="filteredData.length" class="font-medium"></span> æ¡
                </div>
                <div class="flex gap-2">
                    <button @click="currentPage = 1" :disabled="currentPage === 1" class="pagination-btn">
                        <i class="fa-solid fa-angles-left"></i>
                    </button>
                    <button @click="currentPage--" :disabled="currentPage === 1" class="pagination-btn">
                        <i class="fa-solid fa-angle-left"></i>
                    </button>
                    
                    <template x-for="page in displayedPages" :key="page">
                        <button @click="currentPage = page" 
                                class="pagination-btn" 
                                :class="page === currentPage ? 'active' : ''"
                                x-text="page"></button>
                    </template>
                    
                    <button @click="currentPage++" :disabled="currentPage === totalPages" class="pagination-btn">
                        <i class="fa-solid fa-angle-right"></i>
                    </button>
                    <button @click="currentPage = totalPages" :disabled="currentPage === totalPages" class="pagination-btn">
                        <i class="fa-solid fa-angles-right"></i>
                    </button>
                </div>
                <div class="flex items-center gap-2 text-min text-slate-500">
                    <span>æ¯é¡µ</span>
                    <select x-model.number="pageSize" @change="currentPage = 1" class="smart-input py-1 px-2 w-16 text-center">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                    <span>æ¡</span>
                </div>
            </div>
        </div>
    </main>

    <!-- æ–°å¢/ç¼–è¾‘å¼¹çª— -->
    <div x-show="editModal.open" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4" x-cloak @click.self="closeEditModal()">
        <div class="bg-white w-full max-w-3xl rounded-xl shadow-2xl max-h-[90vh] flex flex-col fade-in">
            <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <div class="flex items-center gap-3">
                    <h3 class="text-lg font-bold text-slate-800" x-text="editModal.isEdit ? 'ç¼–è¾‘èµ„é‡‘æ˜ç»†' : 'æ–°å¢èµ„é‡‘æ˜ç»†'"></h3>
                    <span class="type-badge" :class="editModal.form.recordType === 'actual' ? 'type-badge-actual' : 'type-badge-plan'">
                        <i class="fa-solid mr-1" :class="editModal.form.recordType === 'actual' ? 'fa-receipt' : 'fa-calendar-check'"></i>
                        <span x-text="editModal.form.recordType === 'actual' ? 'å®é™…å‘ç”Ÿ' : 'è®¡åˆ’'"></span>
                    </span>
                </div>
                <button @click="closeEditModal()" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scroll p-6">
                <div class="grid grid-cols-2 gap-4">
                    <!-- æ˜ç»†ç±»å‹ï¼ˆä»…ç¼–è¾‘æ—¶æ˜¾ç¤ºï¼Œæ–°å¢æ—¶æ ¹æ®å½“å‰Tabè‡ªåŠ¨è®¾ç½®ï¼‰ -->
                    <div x-show="editModal.isEdit" class="col-span-2 mb-2">
                        <label class="block text-min font-medium text-slate-700 mb-2">æ˜ç»†ç±»å‹ <span class="text-red-500">*</span></label>
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2 cursor-pointer p-3 rounded-lg border transition flex-1"
                                   :class="editModal.form.recordType === 'actual' ? 'border-blue-500 bg-blue-50' : 'border-slate-200 hover:border-blue-300'">
                                <input type="radio" x-model="editModal.form.recordType" value="actual" class="w-4 h-4 text-blue-600">
                                <div>
                                    <div class="font-medium text-slate-800">å®é™…å‘ç”Ÿæ˜ç»†</div>
                                    <div class="text-min text-slate-500">å·²å®é™…å‘ç”Ÿçš„èµ„é‡‘æ”¶ä»˜è®°å½•</div>
                                </div>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer p-3 rounded-lg border transition flex-1"
                                   :class="editModal.form.recordType === 'plan' ? 'border-amber-500 bg-amber-50' : 'border-slate-200 hover:border-amber-300'">
                                <input type="radio" x-model="editModal.form.recordType" value="plan" class="w-4 h-4 text-amber-600">
                                <div>
                                    <div class="font-medium text-slate-800">è®¡åˆ’æ˜ç»†</div>
                                    <div class="text-min text-slate-500">é¢„è®¡å‘ç”Ÿçš„èµ„é‡‘è®¡åˆ’å®‰æ’</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- æœºæ„åç§° -->
                    <div>
                        <label class="block text-min font-medium text-slate-700 mb-1">æœºæ„åç§° <span class="text-red-500">*</span></label>
                        <select x-model="editModal.form.orgName" class="smart-input" :class="errors.orgName ? 'error' : ''" @change="validateField('orgName'); calculateAutoAmount()">
                            <option value="">è¯·é€‰æ‹©</option>
                            <template x-for="org in orgList" :key="org">
                                <option :value="org" x-text="org"></option>
                            </template>
                        </select>
                        <p x-show="errors.orgName" class="text-min text-red-500 mt-1" x-text="errors.orgName"></p>
                    </div>
                    
                    <!-- éƒ¨é—¨åç§° -->
                    <div>
                        <label class="block text-min font-medium text-slate-700 mb-1">éƒ¨é—¨åç§° <span class="text-red-500">*</span></label>
                        <select x-model="editModal.form.deptName" class="smart-input" :class="errors.deptName ? 'error' : ''" @change="validateField('deptName'); calculateAutoAmount()">
                            <option value="">è¯·é€‰æ‹©</option>
                            <template x-for="dept in deptList" :key="dept">
                                <option :value="dept" x-text="dept"></option>
                            </template>
                        </select>
                        <p x-show="errors.deptName" class="text-min text-red-500 mt-1" x-text="errors.deptName"></p>
                    </div>
                    
                    <!-- èµ„é‡‘ç±»å‹ -->
                    <div>
                        <label class="block text-min font-medium text-slate-700 mb-1">èµ„é‡‘ç±»å‹ <span class="text-red-500">*</span></label>
                        <div class="flex gap-3 mt-1">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" x-model="editModal.form.fundType" value="income" @change="onFundTypeChange()" class="w-4 h-4 text-blue-600 border-slate-300 focus:ring-blue-500">
                                <span class="text-sm text-slate-700">å›æ¬¾</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" x-model="editModal.form.fundType" value="expense" @change="onFundTypeChange()" class="w-4 h-4 text-blue-600 border-slate-300 focus:ring-blue-500">
                                <span class="text-sm text-slate-700">æ”¯å‡º</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- é¡¹ç›®åç§° -->
                    <div>
                        <label class="block text-min font-medium text-slate-700 mb-1">é¡¹ç›®åç§° <span class="text-red-500">*</span></label>
                        <select x-model="editModal.form.projectCode" class="smart-input" :class="errors.projectCode ? 'error' : ''" @change="onProjectChange()">
                            <option value="">è¯·é€‰æ‹©</option>
                            <optgroup label="â€”â€” å›æ¬¾é¡¹ç›® â€”â€”">
                                <template x-for="project in projectTypes.filter(p => p.type === 'income')" :key="project.code">
                                    <option :value="project.code" x-text="project.name + (project.auto ? ' [è‡ªåŠ¨è®¡ç®—]' : '')" :style="project.auto ? 'color: #ea580c; background: #fff7ed;' : ''"></option>
                                </template>
                            </optgroup>
                            <optgroup label="â€”â€” æ”¯å‡ºé¡¹ç›® â€”â€”">
                                <template x-for="project in projectTypes.filter(p => p.type === 'expense')" :key="project.code">
                                    <option :value="project.code" x-text="project.name + (project.auto ? ' [è‡ªåŠ¨è®¡ç®—]' : '')" :style="project.auto ? 'color: #ea580c; background: #fff7ed;' : ''"></option>
                                </template>
                            </optgroup>
                        </select>
                        <p x-show="errors.projectCode" class="text-min text-red-500 mt-1" x-text="errors.projectCode"></p>
                        <p x-show="isAutoCalculatedProject" class="text-min text-amber-600 mt-1">
                            <i class="fa-solid fa-circle-info mr-1"></i>æ­¤é¡¹ç›®ä¸ºè‡ªåŠ¨è®¡ç®—é¡¹ï¼Œé‡‘é¢å°†æ ¹æ®å­é¡¹ç›®è‡ªåŠ¨æ±‡æ€»
                        </p>
                    </div>
                    
                    <!-- å‘ç”Ÿæ—¥æœŸ -->
                    <div>
                        <label class="block text-min font-medium text-slate-700 mb-1">å‘ç”Ÿæ—¥æœŸ <span class="text-red-500">*</span></label>
                        <input type="date" x-model="editModal.form.date" class="smart-input" :class="errors.date ? 'error' : ''" @blur="validateField('date'); calculateAutoAmount()">
                        <p x-show="errors.date" class="text-min text-red-500 mt-1" x-text="errors.date"></p>
                    </div>
                    
                    <!-- å‘ç”Ÿé‡‘é¢ -->
                    <div>
                        <label class="block text-min font-medium text-slate-700 mb-1">
                            å‘ç”Ÿé‡‘é¢ <span class="text-red-500">*</span>
                            <span x-show="isAutoCalculatedProject" class="text-min text-amber-600 font-normal ml-1">(è‡ªåŠ¨è®¡ç®—)</span>
                        </label>
                        <div class="relative">
                            <span class="absolute left-3 top-2 text-slate-400">Â¥</span>
                            <input type="number" x-model.number="editModal.form.amount" 
                                   class="smart-input pl-7 text-num" 
                                   :class="[errors.amount ? 'error' : '', isAutoCalculatedProject ? 'bg-amber-50 text-amber-700 cursor-not-allowed' : '']" 
                                   @blur="validateField('amount')" 
                                   placeholder="0.00" 
                                   step="0.01" 
                                   min="0"
                                   :disabled="isAutoCalculatedProject"
                                   :readonly="isAutoCalculatedProject">
                        </div>
                        <p x-show="errors.amount" class="text-min text-red-500 mt-1" x-text="errors.amount"></p>
                    </div>
                    
                    <!-- ç›¸å¯¹æ–¹åç§° - æ”¹ä¸ºç‚¹å‡»é€‰æ‹© -->
                    <div>
                        <label class="block text-min font-medium text-slate-700 mb-1">
                            ç›¸å¯¹æ–¹åç§° <span class="text-red-500">*</span>
                            <span class="text-min text-slate-400 font-normal" x-text="editModal.form.fundType === 'income' ? '(å®¢æˆ·)' : '(ä¾›åº”å•†)'"></span>
                        </label>
                        <div class="relative cursor-pointer" @click="openCounterpartyModal()">
                            <input type="text" x-model="editModal.form.counterparty" 
                                   class="smart-input cursor-pointer bg-slate-50 pr-10" :class="errors.counterparty ? 'error' : ''" 
                                   readonly
                                   placeholder="ç‚¹å‡»é€‰æ‹©...">
                            <i class="fa-solid fa-list absolute right-3 top-2.5 text-slate-400 text-sm"></i>
                        </div>
                        <p x-show="errors.counterparty" class="text-min text-red-500 mt-1" x-text="errors.counterparty"></p>
                    </div>
                    
                    <!-- å…³è”åˆåŒ -->
                    <div>
                        <label class="block text-min font-medium text-slate-700 mb-1">å…³è”åˆåŒ</label>
                        <input type="text" x-model="editModal.form.contract" class="smart-input" placeholder="é€‰å¡«ï¼Œè¾“å…¥åˆåŒåç§°æˆ–ç¼–å·">
                    </div>
                    
                    <!-- æ‘˜è¦ -->
                    <div class="col-span-2">
                        <label class="block text-min font-medium text-slate-700 mb-1">æ‘˜è¦ <span class="text-red-500">*</span></label>
                        <textarea x-model="editModal.form.summary" rows="2" class="smart-input resize-none" :class="errors.summary ? 'error' : ''" @blur="validateField('summary')" placeholder="è¯·ç®€è¦è¯´æ˜èµ„é‡‘ç”¨é€”æˆ–æ¥æº..."></textarea>
                        <p x-show="errors.summary" class="text-min text-red-500 mt-1" x-text="errors.summary"></p>
                    </div>
                </div>
                
                <!-- æç¤ºä¿¡æ¯ -->
                <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-min text-blue-700">
                    <i class="fa-solid fa-circle-info mr-1"></i>
                    ä¿å­˜åå¯åœ¨åˆ—è¡¨ä¸­æŸ¥çœ‹ï¼Œæäº¤åå°†è¿›å…¥å®¡æ‰¹æµç¨‹ï¼ˆéƒ¨é—¨é¢†å¯¼â†’è´¢åŠ¡â†’è´¢åŠ¡ä¸»ç®¡â†’è´¢åŠ¡æ€»ç›‘ï¼‰
                </div>
            </div>
            
            <div class="px-6 py-4 border-t border-slate-200 bg-slate-50 flex justify-end gap-3">
                <button @click="closeEditModal()" class="px-5 py-2 border border-slate-300 text-slate-700 rounded-lg text-sm font-medium hover:bg-white transition">å–æ¶ˆ</button>
                <button @click="saveDraft()" class="px-5 py-2 border border-blue-300 text-blue-600 rounded-lg text-sm font-medium hover:bg-blue-50 transition flex items-center gap-2">
                    <i class="fa-regular fa-floppy-disk"></i> ä¿å­˜è‰ç¨¿
                </button>
                <button @click="submitForm()" class="px-5 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 shadow-md shadow-blue-200 transition flex items-center gap-2">
                    <i class="fa-solid fa-paper-plane"></i> æäº¤å®¡æ ¸
                </button>
            </div>
        </div>
    </div>

    <!-- ç›¸å¯¹æ–¹é€‰æ‹©å¼¹çª— -->
    <div x-show="counterpartyModal.open" class="fixed inset-0 z-[60] flex items-center justify-center modal-backdrop p-4" x-cloak @click.self="closeCounterpartyModal()">
        <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl max-h-[80vh] flex flex-col fade-in">
            <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <div>
                    <h3 class="text-lg font-bold text-slate-800" x-text="editModal.form.fundType === 'income' ? 'é€‰æ‹©å®¢æˆ·' : 'é€‰æ‹©ä¾›åº”å•†'"></h3>
                    <p class="text-min text-slate-500 mt-1" x-text="'ä»åˆ—è¡¨ä¸­é€‰æ‹©' + (editModal.form.fundType === 'income' ? 'å®¢æˆ·' : 'ä¾›åº”å•†')"></p>
                </div>
                <button @click="closeCounterpartyModal()" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="p-4 border-b border-slate-200">
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-3 top-2.5 text-slate-400 text-sm"></i>
                    <input type="text" x-model="counterpartyModal.search" 
                           @input="searchCounterpartyModal()"
                           class="smart-input pl-9" 
                           placeholder="æœç´¢å…³é”®è¯...">
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scroll p-2">
                <div x-show="counterpartyModal.filteredList.length === 0" class="text-center py-8 text-slate-400 text-min">
                    æš‚æ— åŒ¹é…æ•°æ®
                </div>
                <template x-for="(item, index) in counterpartyModal.filteredList" :key="index">
                    <div @click="selectCounterpartyFromModal(item)" 
                         class="p-3 hover:bg-blue-50 cursor-pointer rounded-lg border border-transparent hover:border-blue-200 transition mb-1 flex items-center justify-between group"
                         :class="editModal.form.counterparty === item ? 'bg-blue-50 border-blue-200' : ''">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-sm group-hover:bg-blue-100 group-hover:text-blue-600 transition">
                                <i class="fa-solid" :class="editModal.form.fundType === 'income' ? 'fa-user' : 'fa-truck'"></i>
                            </div>
                            <span class="font-medium text-slate-700" x-text="item"></span>
                        </div>
                        <i x-show="editModal.form.counterparty === item" class="fa-solid fa-check text-blue-600"></i>
                    </div>
                </template>
            </div>
            
            <div class="px-6 py-4 border-t border-slate-200 bg-slate-50 flex justify-between items-center">
                <span class="text-min text-slate-500" x-text="'å…± ' + counterpartyModal.filteredList.length + ' æ¡'"></span>
                <div class="flex gap-3">
                    <button @click="editModal.form.counterparty = ''; closeCounterpartyModal()" class="px-4 py-2 text-slate-600 hover:text-slate-800 text-sm font-medium transition">
                        æ¸…ç©ºé€‰æ‹©
                    </button>
                    <button @click="closeCounterpartyModal()" class="px-5 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition">
                        ç¡®å®š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¯¦æƒ…å¼¹çª— -->
    <div x-show="detailModal.open" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4" x-cloak @click.self="closeDetailModal()">
        <div class="bg-white w-full max-w-4xl rounded-xl shadow-2xl max-h-[90vh] flex flex-col fade-in">
            <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <div class="flex items-center gap-3">
                    <h3 class="text-lg font-bold text-slate-800">èµ„é‡‘æ˜ç»†è¯¦æƒ…</h3>
                    <span class="type-badge" :class="detailModal.item?.recordType === 'actual' ? 'type-badge-actual' : 'type-badge-plan'">
                        <i class="fa-solid mr-1" :class="detailModal.item?.recordType === 'actual' ? 'fa-receipt' : 'fa-calendar-check'"></i>
                        <span x-text="detailModal.item?.recordType === 'actual' ? 'å®é™…å‘ç”Ÿ' : 'è®¡åˆ’'"></span>
                    </span>
                </div>
                <button @click="closeDetailModal()" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scroll p-6" x-show="detailModal.item">
                <!-- å®¡æ‰¹è¿›åº¦ -->
                <div x-show="detailModal.item?.status !== 'draft'" class="mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-sm font-bold text-slate-700">å®¡æ‰¹è¿›åº¦</span>
                        <span class="text-min text-slate-500" x-text="'å½“å‰çŠ¶æ€ï¼š' + getStatusText(detailModal.item?.status)"></span>
                    </div>
                    <div class="flex justify-between px-2">
                        <template x-for="(step, idx) in approvalSteps" :key="idx">
                            <div class="step-item" :class="getStepClass(idx, detailModal.item?.approvalStep, detailModal.item?.status)">
                                <div class="step-icon">
                                    <i class="fa-solid fa-check" x-show="idx < (detailModal.item?.approvalStep || 0) && detailModal.item?.status !== 'rejected'"></i>
                                    <i class="fa-solid fa-xmark" x-show="detailModal.item?.status === 'rejected' && idx === detailModal.item?.approvalStep"></i>
                                    <span x-show="(detailModal.item?.status !== 'rejected' && idx >= (detailModal.item?.approvalStep || 0)) || (detailModal.item?.status === 'rejected' && idx !== detailModal.item?.approvalStep)" x-text="idx + 1"></span>
                                </div>
                                <div class="text-xs mt-2 font-medium" x-text="step"></div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- é©³å›åŸå›  -->
                <div x-show="detailModal.item?.status === 'rejected' && detailModal.item?.rejectReason" class="mb-6 p-4 bg-red-50 rounded-lg border border-red-200">
                    <div class="flex items-start gap-3">
                        <i class="fa-solid fa-circle-exclamation text-red-500 mt-0.5"></i>
                        <div>
                            <div class="text-sm font-bold text-red-700 mb-1">é©³å›åŸå› </div>
                            <div class="text-sm text-red-600" x-text="detailModal.item?.rejectReason"></div>
                            <div class="text-min text-red-500 mt-2" x-text="'é©³å›äººï¼š' + detailModal.item?.rejectBy + ' Â· ' + detailModal.item?.rejectTime"></div>
                        </div>
                    </div>
                </div>

                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="p-4 bg-slate-50 rounded-lg border border-slate-200">
                        <div class="text-min text-slate-500 mb-1">èµ„é‡‘ç±»å‹</div>
                        <div class="font-bold text-lg" :class="detailModal.item?.fundType === 'income' ? 'text-emerald-600' : 'text-rose-600'" x-text="detailModal.item?.fundType === 'income' ? 'å›æ¬¾' : 'æ”¯å‡º'"></div>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-lg border border-slate-200">
                        <div class="text-min text-slate-500 mb-1">å‘ç”Ÿé‡‘é¢</div>
                        <div class="font-bold text-lg text-num text-slate-800" x-text="'Â¥' + formatMoney(detailModal.item?.amount || 0)"></div>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-lg border border-slate-200">
                        <div class="text-min text-slate-500 mb-1">å‘ç”Ÿæ—¥æœŸ</div>
                        <div class="font-bold text-lg text-slate-800" x-text="detailModal.item?.date"></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div>
                        <h4 class="text-sm font-bold text-slate-800 mb-3 border-b border-slate-200 pb-2">åŸºæœ¬ä¿¡æ¯</h4>
                        <div class="space-y-3 text-sm">
                            <div class="flex">
                                <span class="w-24 text-slate-500">æœºæ„åç§°ï¼š</span>
                                <span class="flex-1 font-medium text-slate-800" x-text="detailModal.item?.orgName"></span>
                            </div>
                            <div class="flex">
                                <span class="w-24 text-slate-500">éƒ¨é—¨åç§°ï¼š</span>
                                <span class="flex-1 font-medium text-slate-800" x-text="detailModal.item?.deptName"></span>
                            </div>
                            <div class="flex">
                                <span class="w-24 text-slate-500">é¡¹ç›®åç§°ï¼š</span>
                                <span class="flex-1 font-medium text-slate-800" x-text="getProjectName(detailModal.item?.projectCode)"></span>
                            </div>
                            <div class="flex">
                                <span class="w-24 text-slate-500">é¡¹ç›®ä»£ç ï¼š</span>
                                <span class="flex-1 font-mono text-slate-600" x-text="detailModal.item?.projectCode"></span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-sm font-bold text-slate-800 mb-3 border-b border-slate-200 pb-2">å…³è”ä¿¡æ¯</h4>
                        <div class="space-y-3 text-sm">
                            <div class="flex">
                                <span class="w-24 text-slate-500">ç›¸å¯¹æ–¹ï¼š</span>
                                <span class="flex-1 font-medium text-slate-800" x-text="detailModal.item?.counterparty || '-'"></span>
                            </div>
                            <div class="flex">
                                <span class="w-24 text-slate-500">å…³è”åˆåŒï¼š</span>
                                <span class="flex-1 font-medium text-slate-800" x-text="detailModal.item?.contract || '-'"></span>
                            </div>
                            <div class="flex">
                                <span class="w-24 text-slate-500">å¡«æŠ¥äººï¼š</span>
                                <span class="flex-1 text-slate-700" x-text="detailModal.item?.operator"></span>
                            </div>
                            <div class="flex">
                                <span class="w-24 text-slate-500">åˆ›å»ºæ—¶é—´ï¼š</span>
                                <span class="flex-1 text-slate-600 text-min" x-text="detailModal.item?.createTime"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <h4 class="text-sm font-bold text-slate-800 mb-3 border-b border-slate-200 pb-2">æ‘˜è¦è¯´æ˜</h4>
                    <p class="text-sm text-slate-700 bg-slate-50 p-4 rounded-lg border border-slate-200" x-text="detailModal.item?.summary || 'æ— '"></p>
                </div>

                <!-- æ“ä½œè®°å½• -->
                <div>
                    <h4 class="text-sm font-bold text-slate-800 mb-3 border-b border-slate-200 pb-2">æ“ä½œè®°å½•</h4>
                    <div class="space-y-3">
                        <div class="flex items-center gap-3 text-sm">
                            <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                            <div class="text-min text-slate-500 w-32" x-text="detailModal.item?.createTime"></div>
                            <div class="font-medium text-slate-800">åˆ›å»ºè®°å½•</div>
                            <div class="text-min text-slate-500 ml-auto" x-text="detailModal.item?.operator"></div>
                        </div>
                        <div class="flex items-center gap-3 text-sm" x-show="detailModal.item?.status !== 'draft'">
                            <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                            <div class="text-min text-slate-500 w-32" x-text="detailModal.item?.submitTime"></div>
                            <div class="font-medium text-slate-800">æäº¤å®¡æ ¸</div>
                            <div class="text-min text-slate-500 ml-auto" x-text="detailModal.item?.operator"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="px-6 py-4 border-t border-slate-200 bg-slate-50 flex justify-end gap-3">
                <button @click="closeDetailModal()" class="px-5 py-2 border border-slate-300 text-slate-700 rounded-lg text-sm font-medium hover:bg-white transition">å…³é—­</button>
                <button x-show="detailModal.item?.status === 'draft' || detailModal.item?.status === 'rejected'" 
                        @click="openEditModal(detailModal.item); closeDetailModal()" 
                        class="px-5 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition">ç¼–è¾‘</button>
                <button x-show="detailModal.item?.status === 'pending'" 
                        @click="openApproveModal(detailModal.item); closeDetailModal()" 
                        class="px-5 py-2 bg-emerald-600 text-white rounded-lg text-sm font-medium hover:bg-emerald-700 transition">å»å®¡æ‰¹</button>
            </div>
        </div>
    </div>

    <!-- å®¡æ‰¹å¼¹çª— - æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ç‰ˆ -->
    <div x-show="approveModal.open" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4" x-cloak @click.self="closeApproveModal()">
        <div class="bg-white w-full max-w-4xl rounded-xl shadow-2xl max-h-[90vh] flex flex-col fade-in">
            <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <div class="flex items-center gap-3">
                    <h3 class="text-lg font-bold text-slate-800">èµ„é‡‘æ˜ç»†å®¡æ‰¹</h3>
                    <span class="type-badge" :class="approveModal.item?.recordType === 'actual' ? 'type-badge-actual' : 'type-badge-plan'">
                        <i class="fa-solid mr-1" :class="approveModal.item?.recordType === 'actual' ? 'fa-receipt' : 'fa-calendar-check'"></i>
                        <span x-text="approveModal.item?.recordType === 'actual' ? 'å®é™…å‘ç”Ÿ' : 'è®¡åˆ’'"></span>
                    </span>
                </div>
                <button @click="closeApproveModal()" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scroll p-6">
                <!-- å®¡æ‰¹è¿›åº¦ -->
                <div class="mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-sm font-bold text-slate-700">å®¡æ‰¹è¿›åº¦</span>
                        <span class="status-tag" :class="'status-' + approveModal.item?.status">
                            <i class="fa-solid fa-circle text-[8px]"></i>
                            <span x-text="getStatusText(approveModal.item?.status)"></span>
                        </span>
                    </div>
                    <div class="flex justify-between px-2">
                        <template x-for="(step, idx) in approvalSteps" :key="idx">
                            <div class="step-item" :class="getStepClass(idx, approveModal.item?.approvalStep, approveModal.item?.status)">
                                <div class="step-icon">
                                    <i class="fa-solid fa-check" x-show="idx < (approveModal.item?.approvalStep || 0) && approveModal.item?.status !== 'rejected'"></i>
                                    <i class="fa-solid fa-xmark" x-show="approveModal.item?.status === 'rejected' && idx === approveModal.item?.approvalStep"></i>
                                    <span x-show="(approveModal.item?.status !== 'rejected' && idx >= (approveModal.item?.approvalStep || 0)) || (approveModal.item?.status === 'rejected' && idx !== approveModal.item?.approvalStep)" x-text="idx + 1"></span>
                                </div>
                                <div class="text-xs mt-2 font-medium" x-text="step"></div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- è¯¦ç»†ä¿¡æ¯å¡ç‰‡ -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="col-span-2 md:col-span-1 p-4 bg-white rounded-lg border border-slate-200 shadow-sm">
                        <h4 class="text-sm font-bold text-slate-800 mb-3 border-b border-slate-100 pb-2 flex items-center gap-2">
                            <i class="fa-solid fa-building text-blue-500"></i> åŸºæœ¬ä¿¡æ¯
                        </h4>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-500">æ˜ç»†ç±»å‹ï¼š</span>
                                <span class="font-medium" :class="approveModal.item?.recordType === 'actual' ? 'text-blue-600' : 'text-amber-600'" x-text="approveModal.item?.recordType === 'actual' ? 'å®é™…å‘ç”Ÿ' : 'è®¡åˆ’'"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500">æœºæ„åç§°ï¼š</span>
                                <span class="font-medium text-slate-800" x-text="approveModal.item?.orgName"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500">éƒ¨é—¨åç§°ï¼š</span>
                                <span class="font-medium text-slate-800" x-text="approveModal.item?.deptName"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500">èµ„é‡‘ç±»å‹ï¼š</span>
                                <span class="font-medium" :class="approveModal.item?.fundType === 'income' ? 'text-emerald-600' : 'text-rose-600'" x-text="approveModal.item?.fundType === 'income' ? 'å›æ¬¾' : 'æ”¯å‡º'"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500">é¡¹ç›®åç§°ï¼š</span>
                                <span class="font-medium text-slate-800" x-text="getProjectName(approveModal.item?.projectCode)"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-span-2 md:col-span-1 p-4 bg-white rounded-lg border border-slate-200 shadow-sm">
                        <h4 class="text-sm font-bold text-slate-800 mb-3 border-b border-slate-100 pb-2 flex items-center gap-2">
                            <i class="fa-solid fa-money-bill text-emerald-500"></i> é‡‘é¢ä¿¡æ¯
                        </h4>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-500">å‘ç”Ÿé‡‘é¢ï¼š</span>
                                <span class="text-xl font-bold text-num" :class="approveModal.item?.fundType === 'income' ? 'text-emerald-600' : 'text-rose-600'" x-text="'Â¥' + formatMoney(approveModal.item?.amount || 0)"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500">å‘ç”Ÿæ—¥æœŸï¼š</span>
                                <span class="font-medium text-slate-800" x-text="approveModal.item?.date"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500">å¡«æŠ¥äººï¼š</span>
                                <span class="font-medium text-slate-800" x-text="approveModal.item?.operator"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500">åˆ›å»ºæ—¶é—´ï¼š</span>
                                <span class="text-min text-slate-600" x-text="approveModal.item?.createTime"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å…³è”ä¿¡æ¯ -->
                <div class="p-4 bg-white rounded-lg border border-slate-200 shadow-sm mb-6">
                    <h4 class="text-sm font-bold text-slate-800 mb-3 border-b border-slate-100 pb-2 flex items-center gap-2">
                        <i class="fa-solid fa-link text-indigo-500"></i> å…³è”ä¿¡æ¯
                    </h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="flex">
                            <span class="w-24 text-slate-500">ç›¸å¯¹æ–¹ï¼š</span>
                            <span class="flex-1 font-medium text-slate-800" x-text="approveModal.item?.counterparty || '-'"></span>
                        </div>
                        <div class="flex">
                            <span class="w-24 text-slate-500">å…³è”åˆåŒï¼š</span>
                            <span class="flex-1 font-medium text-slate-800" x-text="approveModal.item?.contract || '-'"></span>
                        </div>
                    </div>
                </div>

                <!-- æ‘˜è¦ -->
                <div class="p-4 bg-slate-50 rounded-lg border border-slate-200 mb-6">
                    <h4 class="text-sm font-bold text-slate-800 mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-file-lines text-amber-500"></i> æ‘˜è¦è¯´æ˜
                    </h4>
                    <p class="text-sm text-slate-700 leading-relaxed" x-text="approveModal.item?.summary || 'æ— æ‘˜è¦è¯´æ˜'"></p>
                </div>

                <!-- é©³å›åŸå› ï¼ˆå¦‚æœæ˜¯é©³å›çŠ¶æ€ï¼‰ -->
                <div x-show="approveModal.item?.status === 'rejected' && approveModal.item?.rejectReason" class="p-4 bg-red-50 rounded-lg border border-red-200 mb-6">
                    <h4 class="text-sm font-bold text-red-700 mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-circle-exclamation"></i> ä¸Šæ¬¡é©³å›åŸå› 
                    </h4>
                    <p class="text-sm text-red-600" x-text="approveModal.item?.rejectReason"></p>
                    <div class="text-min text-red-500 mt-2" x-text="'é©³å›äººï¼š' + approveModal.item?.rejectBy + ' Â· ' + approveModal.item?.rejectTime"></div>
                </div>

                <!-- å®¡æ‰¹æ“ä½œåŒº -->
                <div class="border-t border-slate-200 pt-6">
                    <label class="block text-min font-bold text-slate-700 mb-3">å®¡æ‰¹å†³ç­– <span class="text-red-500">*</span></label>
                    <div class="flex gap-4 mb-4">
                        <button @click="approveModal.action = 'approve'" 
                                class="flex-1 py-3 border-2 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2"
                                :class="approveModal.action === 'approve' ? 'bg-emerald-50 border-emerald-500 text-emerald-700' : 'border-slate-200 text-slate-600 hover:border-emerald-300'">
                            <i class="fa-solid fa-check-circle text-lg"></i> 
                            <div class="text-left">
                                <div class="font-bold">æ‰¹å‡†é€šè¿‡</div>
                                <div class="text-xs opacity-75">è¿›å…¥ä¸‹ä¸€å®¡æ‰¹ç¯èŠ‚</div>
                            </div>
                        </button>
                        <button @click="approveModal.action = 'reject'" 
                                class="flex-1 py-3 border-2 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2"
                                :class="approveModal.action === 'reject' ? 'bg-red-50 border-red-500 text-red-700' : 'border-slate-200 text-slate-600 hover:border-red-300'">
                            <i class="fa-solid fa-times-circle text-lg"></i>
                            <div class="text-left">
                                <div class="font-bold">é©³å›ç”³è¯·</div>
                                <div class="text-xs opacity-75">è¿”å›ç”³è¯·äººä¿®æ”¹</div>
                            </div>
                        </button>
                    </div>
                    
                    <label class="block text-min font-medium text-slate-700 mb-2">
                        å®¡æ‰¹æ„è§ <span x-show="approveModal.action === 'reject'" class="text-red-500">*</span>
                        <span x-show="approveModal.action === 'approve'" class="text-slate-400 font-normal">ï¼ˆé€‰å¡«ï¼‰</span>
                    </label>
                    <textarea x-model="approveModal.comment" rows="3" class="smart-input resize-none" 
                              :placeholder="approveModal.action === 'approve' ? 'è¯·è¾“å…¥å®¡æ‰¹æ„è§ï¼ˆé€‰å¡«ï¼‰...' : 'è¯·è¾“å…¥é©³å›åŸå› ï¼ˆå¿…å¡«ï¼‰...'"></textarea>
                    <p x-show="approveModal.action === 'reject' && !approveModal.comment" class="text-min text-amber-600 mt-1">
                        <i class="fa-solid fa-triangle-exclamation mr-1"></i>é©³å›æ—¶å¿…é¡»å¡«å†™å®¡æ‰¹æ„è§
                    </p>
                </div>
            </div>
            
            <div class="px-6 py-4 border-t border-slate-200 bg-slate-50 flex justify-end gap-3">
                <button @click="closeApproveModal()" class="px-5 py-2 border border-slate-300 text-slate-700 rounded-lg text-sm font-medium hover:bg-white transition">å–æ¶ˆ</button>
                <button @click="confirmApprove()" 
                        class="px-5 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2"
                        :class="approveModal.action === 'approve' ? 'bg-emerald-600 hover:bg-emerald-700 text-white' : 'bg-red-600 hover:bg-red-700 text-white'"
                        :disabled="approveModal.action === 'reject' && !approveModal.comment">
                    <i class="fa-solid" :class="approveModal.action === 'approve' ? 'fa-check' : 'fa-xmark'"></i>
                    <span x-text="approveModal.action === 'approve' ? 'ç¡®è®¤æ‰¹å‡†' : 'ç¡®è®¤é©³å›'"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡å¯¼å…¥å¼¹çª— -->
    <div x-show="importModal.open" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4" x-cloak @click.self="closeImportModal()">
        <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl max-h-[90vh] flex flex-col fade-in">
            <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <h3 class="text-lg font-bold text-slate-800">æ‰¹é‡å¯¼å…¥èµ„é‡‘æ˜ç»†</h3>
                <button @click="closeImportModal()" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scroll p-6">
                <!-- æ­¥éª¤æŒ‡ç¤º -->
                <div class="flex items-center justify-center mb-6">
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm font-bold">1</div>
                        <div class="w-20 h-0.5 bg-blue-600"></div>
                        <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm font-bold">2</div>
                        <div class="w-20 h-0.5" :class="importModal.step >= 2 ? 'bg-blue-600' : 'bg-slate-300'"></div>
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold" :class="importModal.step >= 2 ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-600'">3</div>
                    </div>
                </div>

                <!-- æ­¥éª¤1ï¼šä¸‹è½½æ¨¡æ¿ -->
                <div x-show="importModal.step === 1" class="text-center py-8">
                    <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-file-excel text-2xl"></i>
                    </div>
                    <h4 class="text-lg font-bold text-slate-800 mb-2">ä¸‹è½½å¯¼å…¥æ¨¡æ¿</h4>
                    <p class="text-min text-slate-500 mb-6">è¯·ä½¿ç”¨æ ‡å‡†æ¨¡æ¿å¡«å†™æ•°æ®ï¼Œç¡®ä¿æ ¼å¼æ­£ç¡®</p>
                    <button @click="downloadTemplate()" class="px-6 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition flex items-center gap-2 mx-auto">
                        <i class="fa-solid fa-download"></i> ä¸‹è½½Excelæ¨¡æ¿
                    </button>
                    <div class="mt-6 text-left bg-slate-50 p-4 rounded-lg border border-slate-200 max-w-md mx-auto">
                        <div class="text-min font-medium text-slate-700 mb-2">æ¨¡æ¿å­—æ®µè¯´æ˜ï¼š</div>
                        <ul class="text-min text-slate-500 space-y-1 list-disc list-inside">
                            <li>æ˜ç»†ç±»å‹ï¼ˆå®é™…å‘ç”Ÿ/è®¡åˆ’ï¼‰</li>
                            <li>æœºæ„åç§°ã€éƒ¨é—¨åç§°ï¼ˆå¿…å¡«ï¼‰</li>
                            <li>èµ„é‡‘ç±»å‹ï¼ˆå›æ¬¾/æ”¯å‡ºï¼‰</li>
                            <li>é¡¹ç›®åç§°ï¼ˆè§DM01ä»£ç ï¼‰</li>
                            <li>å‘ç”Ÿæ—¥æœŸã€å‘ç”Ÿé‡‘é¢</li>
                            <li>ç›¸å¯¹æ–¹åç§°ã€å…³è”åˆåŒ</li>
                        </ul>
                    </div>
                </div>

                <!-- æ­¥éª¤2ï¼šä¸Šä¼ æ–‡ä»¶ -->
                <div x-show="importModal.step === 2">
                    <div class="border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:border-blue-400 hover:bg-blue-50 transition cursor-pointer" @click="$refs.fileInput.click()">
                        <input type="file" x-ref="fileInput" class="hidden" accept=".xlsx,.xls" @change="handleFileUpload($event)">
                        <i class="fa-solid fa-cloud-arrow-up text-4xl text-slate-400 mb-3"></i>
                        <h4 class="text-lg font-bold text-slate-800 mb-1">ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</h4>
                        <p class="text-min text-slate-500">æ”¯æŒ .xlsx, .xls æ ¼å¼ï¼Œæ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 5MB</p>
                    </div>
                    
                    <div x-show="importModal.fileName" class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-file-excel text-blue-600"></i>
                            <span class="text-sm font-medium text-slate-700" x-text="importModal.fileName"></span>
                        </div>
                        <button @click="importModal.fileName = ''; importModal.data = []" class="text-slate-400 hover:text-red-600">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- æ­¥éª¤3ï¼šæ•°æ®æ ¡éªŒ -->
                <div x-show="importModal.step === 3">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-sm font-bold text-slate-800">æ•°æ®é¢„è§ˆä¸æ ¡éªŒ</h4>
                        <span class="text-min" :class="importModal.errors.length > 0 ? 'text-amber-600' : 'text-emerald-600'" x-text="'å…± ' + importModal.data.length + ' æ¡ï¼Œ' + (importModal.errors.length > 0 ? 'å‘ç° ' + importModal.errors.length + ' å¤„é”™è¯¯' : 'æ ¡éªŒé€šè¿‡')"></span>
                    </div>
                    
                    <div class="overflow-x-auto border border-slate-200 rounded-lg max-h-60">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-50 sticky top-0">
                                <tr>
                                    <th class="px-3 py-2 text-left border-b">è¡Œå·</th>
                                    <th class="px-3 py-2 text-left border-b">ç±»å‹</th>
                                    <th class="px-3 py-2 text-left border-b">æœºæ„</th>
                                    <th class="px-3 py-2 text-left border-b">ç±»å‹</th>
                                    <th class="px-3 py-2 text-left border-b">é¡¹ç›®</th>
                                    <th class="px-3 py-2 text-right border-b">é‡‘é¢</th>
                                    <th class="px-3 py-2 text-center border-b">çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(row, idx) in importModal.data" :key="idx">
                                    <tr class="border-b" :class="row.error ? 'bg-red-50' : ''">
                                        <td class="px-3 py-2" x-text="row.lineNo"></td>
                                        <td class="px-3 py-2">
                                            <span class="text-min" :class="row.recordType === 'actual' ? 'text-blue-600' : 'text-amber-600'" x-text="row.recordType === 'actual' ? 'å®é™…' : 'è®¡åˆ’'"></span>
                                        </td>
                                        <td class="px-3 py-2" x-text="row.orgName"></td>
                                        <td class="px-3 py-2">
                                            <span :class="row.fundType === 'income' ? 'text-emerald-600' : 'text-rose-600'" x-text="row.fundType === 'income' ? 'å›æ¬¾' : 'æ”¯å‡º'"></span>
                                        </td>
                                        <td class="px-3 py-2 text-min" x-text="getProjectName(row.projectCode)"></td>
                                        <td class="px-3 py-2 text-right text-num" x-text="'Â¥' + formatMoney(row.amount)"></td>
                                        <td class="px-3 py-2 text-center">
                                            <i x-show="!row.error" class="fa-solid fa-check-circle text-emerald-500"></i>
                                            <i x-show="row.error" class="fa-solid fa-circle-exclamation text-red-500" :title="row.errorMsg"></i>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    
                    <div x-show="importModal.errors.length > 0" class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg text-min text-amber-700">
                        <div class="font-bold mb-1 flex items-center gap-2">
                            <i class="fa-solid fa-triangle-exclamation"></i>
                            <span>å‘ç°é”™è¯¯ï¼ˆå°†è·³è¿‡ä»¥ä¸‹é”™è¯¯æ•°æ®ï¼‰ï¼š</span>
                        </div>
                        <ul class="space-y-1 list-disc list-inside">
                            <template x-for="error in importModal.errors.slice(0, 5)" :key="error">
                                <li x-text="error"></li>
                            </template>
                            <li x-show="importModal.errors.length > 5" x-text="'è¿˜æœ‰ ' + (importModal.errors.length - 5) + ' å¤„é”™è¯¯...'"></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="px-6 py-4 border-t border-slate-200 bg-slate-50 flex justify-between items-center">
                <button x-show="importModal.step > 1" @click="importModal.step--" class="px-5 py-2 border border-slate-300 text-slate-700 rounded-lg text-sm font-medium hover:bg-white transition">ä¸Šä¸€æ­¥</button>
                
                <!-- æ­¥éª¤3çš„é”™è¯¯æç¤ºå’Œå¯¼å…¥æŒ‰é’® -->
                <div x-show="importModal.step === 3" class="flex items-center gap-3">
                    <span x-show="importModal.errors.length > 0" class="text-min text-amber-600 flex items-center gap-1">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                        <span x-text="'å°†å¯¼å…¥ ' + (importModal.data.length - importModal.errors.length) + ' æ¡æœ‰æ•ˆæ•°æ®'"></span>
                    </span>
                </div>
                
                <div class="flex gap-3 ml-auto">
                    <button @click="closeImportModal()" class="px-5 py-2 border border-slate-300 text-slate-700 rounded-lg text-sm font-medium hover:bg-white transition">å–æ¶ˆ</button>
                    <button x-show="importModal.step === 1" @click="importModal.step = 2" class="px-5 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition">ä¸‹ä¸€æ­¥</button>
                    <button x-show="importModal.step === 2 && importModal.fileName" @click="validateImportData()" class="px-5 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition">å¼€å§‹æ ¡éªŒ</button>
                    <!-- ä¿®æ”¹è¿™é‡Œï¼šæ— è®ºæ˜¯å¦æœ‰é”™è¯¯éƒ½æ˜¾ç¤ºç¡®è®¤å¯¼å…¥æŒ‰é’® -->
                    <button x-show="importModal.step === 3" @click="confirmImport()" 
                            class="px-5 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2"
                            :class="importModal.errors.length > 0 ? 'bg-amber-500 hover:bg-amber-600 text-white' : 'bg-emerald-600 hover:bg-emerald-700 text-white'">
                        <i class="fa-solid" :class="importModal.errors.length > 0 ? 'fa-exclamation-circle' : 'fa-check'"></i>
                        <span x-text="importModal.errors.length > 0 ? 'å¿½ç•¥é”™è¯¯å¹¶å¯¼å…¥' : 'ç¡®è®¤å¯¼å…¥'"></span>
                        <span x-show="importModal.data.length - importModal.errors.length > 0" x-text="'(' + (importModal.data.length - importModal.errors.length) + 'æ¡)'"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
    <div x-show="deleteModal.open" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" x-cloak>
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 text-center fade-in">
            <div class="w-14 h-14 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-exclamation text-2xl"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 mb-2">ç¡®è®¤åˆ é™¤?</h3>
            <p class="text-min text-slate-500 mb-6">
                è¯¥èµ„é‡‘æ˜ç»†è®°å½•å°†è¢«æ°¸ä¹…åˆ é™¤<br>
                <span class="text-red-500 text-xs">æ­¤æ“ä½œä¸å¯æ¢å¤</span>
            </p>
            <div class="flex justify-center gap-3">
                <button @click="deleteModal.open = false" class="px-5 py-2 border border-slate-300 rounded-lg text-slate-700 text-sm font-medium hover:bg-slate-50 transition">å–æ¶ˆ</button>
                <button @click="executeDelete()" class="px-5 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 shadow-md shadow-red-200 transition">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- Toastæç¤º -->
    <div x-show="toast.show" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-2"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition ease-in duration-300"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed top-20 right-6 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-2xl z-[100] flex items-center gap-3">
        <i class="fa-solid" :class="toast.type === 'success' ? 'fa-check-circle text-emerald-400' : 'fa-circle-exclamation text-rose-400'"></i>
        <span class="text-sm font-medium" x-text="toast.message"></span>
    </div>

    <script>
        function fundDetailApp() {
            return {
                loading: false,
                selectedIds: [],
                currentPage: 1,
                pageSize: 10,
                currentTab: 'all',
                recordTypeTab: 'actual', // 'actual' æˆ– 'plan'
                
                filters: {
                    keyword: '',
                    orgName: '',
                    deptName: '',
                    fundType: '',
                    projectName: '',
                    date: ''
                },
                
                // æœºæ„ä¸éƒ¨é—¨æ•°æ®
                orgList: ['ä¸­æ£€è®¡é‡æœ‰é™å…¬å¸', 'ä¸­æ£€é›†å›¢æº¯æºæŠ€æœ¯æœåŠ¡æœ‰é™å…¬å¸', 'ä¸­æ£€ï¼ˆæ±Ÿè‹ï¼‰è®¡é‡æµ‹è¯•æœ‰é™å…¬å¸', 'ä¸­æ£€ååŒ—è®¡é‡æœ‰é™å…¬å¸'],
                deptList: ['æœ‰æœºåˆ†æå®éªŒå®¤', 'æ— æœºåˆ†æå®éªŒå®¤', 'å¾®ç”Ÿç‰©æ£€æµ‹éƒ¨', 'è´¨æ§éƒ¨', 'ç ”å‘éƒ¨', 'è´¢åŠ¡éƒ¨'],
                
                // é¡¹ç›®ç±»å‹DM01 - æŒ‰æˆªå›¾æ›´æ–°ï¼Œæ©™è‰²æ ‡è®°ä¸ºautoï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰
                projectTypes: [
                    // å›æ¬¾ç±» A
                    { code: 'A00', name: 'é¢„è®¡å›æ¬¾å°è®¡', type: 'income', auto: true },
                    { code: 'A01', name: 'é”€å”®å›æ¬¾', type: 'income', auto: false },
                    { code: 'A02', name: 'ç­¹èµ„å›æ¬¾', type: 'income', auto: false },
                    { code: 'A03', name: 'æŠ•èµ„å›æ¬¾', type: 'income', auto: false },
                    { code: 'A04', name: 'å…¶ä»–å›æ¬¾', type: 'income', auto: false },
                    // æ”¯å‡ºç±» B
                    { code: 'B00', name: 'é¢„è®¡æ”¯å‡ºå°è®¡', type: 'expense', auto: true },
                    { code: 'B10', name: 'æˆæœ¬æ”¯å‡º', type: 'expense', auto: true },
                    { code: 'B11', name: 'äººå·¥æˆæœ¬æ”¯å‡º', type: 'expense', auto: false },
                    { code: 'B12', name: 'ä¸šåŠ¡åä½œè´¹æ”¯å‡º', type: 'expense', auto: false },
                    { code: 'B13', name: 'æ£€éªŒæ£€æµ‹è´¹æ”¯å‡º', type: 'expense', auto: false },
                    { code: 'B14', name: 'å…¶ä»–æˆæœ¬æ”¯å‡º', type: 'expense', auto: false },
                    { code: 'B20', name: 'è´¹ç”¨æ”¯å‡º', type: 'expense', auto: true },
                    { code: 'B21', name: 'é”€å”®è´¹ç”¨æ”¯å‡º', type: 'expense', auto: false },
                    { code: 'B22', name: 'ç®¡ç†è´¹ç”¨æ”¯å‡º', type: 'expense', auto: false },
                    { code: 'B23', name: 'ç ”å‘è´¹ç”¨æ”¯å‡º', type: 'expense', auto: false },
                    { code: 'B24', name: 'è´¢åŠ¡è´¹ç”¨æ”¯å‡º', type: 'expense', auto: false },
                    { code: 'B30', name: 'ç¨è´¹æ”¯å‡º', type: 'expense', auto: true },
                    { code: 'B31', name: 'ä¼ä¸šæ‰€å¾—ç¨æ”¯å‡º', type: 'expense', auto: false },
                    { code: 'B32', name: 'å¢å€¼ç¨æ”¯å‡º', type: 'expense', auto: false },
                    { code: 'B33', name: 'å…¶ä»–ç¨è´¹æ”¯å‡º', type: 'expense', auto: false },
                    { code: 'B40', name: 'é‡‡è´­æ”¯å‡º', type: 'expense', auto: true },
                    { code: 'B41', name: 'ç‰©æ–™é‡‡è´­æ”¯å‡º', type: 'expense', auto: false },
                    { code: 'B42', name: 'èµ„äº§é‡‡è´­æ”¯å‡º', type: 'expense', auto: false },
                    { code: 'B50', name: 'å·¥ç¨‹æ”¯å‡º', type: 'expense', auto: true },
                    { code: 'B51', name: 'å»ºç­‘å·¥ç¨‹', type: 'expense', auto: false },
                    { code: 'B52', name: 'è®¾å¤‡å®‰è£…å·¥ç¨‹', type: 'expense', auto: false },
                    { code: 'B53', name: 'å…¶ä»–å·¥ç¨‹æ”¯å‡º', type: 'expense', auto: false },
                    { code: 'B60', name: 'å¿è¿˜è´·æ¬¾æ”¯å‡º', type: 'expense', auto: true },
                    { code: 'B61', name: 'å¿è¿˜æœ¬é‡‘', type: 'expense', auto: false },
                    { code: 'B62', name: 'å¿è¿˜åˆ©æ¯', type: 'expense', auto: false },
                    { code: 'B70', name: 'è‚¡æƒæŠ•èµ„æ”¯å‡º', type: 'expense', auto: false },
                    { code: 'B80', name: 'èµ„æœ¬æ€§ç ”å‘æ”¯å‡º', type: 'expense', auto: false },
                    { code: 'B90', name: 'åˆ©æ¶¦åˆ†é…æ”¯å‡º', type: 'expense', auto: false },
                    { code: 'Ba0', name: 'å…¶ä»–æ”¯å‡º', type: 'expense', auto: false }
                ],
                
                // ç›¸å¯¹æ–¹æ•°æ®ï¼ˆå®¢æˆ·/ä¾›åº”å•†ï¼‰
                customers: ['è¥¿å®‰åŒ–å­¦è¯•å‰‚æœ‰é™å…¬å¸', 'èµ›é»˜é£ä¸–å°”ç§‘æŠ€', 'å›½è¯é›†å›¢åŒ–å­¦è¯•å‰‚', 'é˜¿æ‹‰ä¸è¯•å‰‚(ä¸Šæµ·)æœ‰é™å…¬å¸', 'æŸæ£€æµ‹ç§‘æŠ€å…¬å¸', 'æŸåˆ¶è¯ä¼ä¸š', 'æŸåŒ»ç–—å™¨æ¢°å…¬å¸', 'æŸç§‘ç ”é™¢æ‰€'],
                suppliers: ['è¥¿å®‰åŒ–å­¦è¯•å‰‚æœ‰é™å…¬å¸', 'èµ›é»˜é£ä¸–å°”ç§‘æŠ€', 'å›½è¯é›†å›¢åŒ–å­¦è¯•å‰‚', 'é˜¿æ‹‰ä¸è¯•å‰‚(ä¸Šæµ·)æœ‰é™å…¬å¸', 'æŸè®¾å¤‡ä¾›åº”å•†', 'æŸå·¥ç¨‹å…¬å¸', 'æŸä»ªå™¨å‚å•†', 'æŸè€—æä¾›åº”å•†'],
                
                // ä¸»æ•°æ®
                dataList: [],
                
                // å¼¹çª—çŠ¶æ€
                editModal: {
                    open: false,
                    isEdit: false,
                    form: {
                        id: null,
                        recordType: 'actual',
                        orgName: '',
                        deptName: '',
                        fundType: 'expense',
                        projectCode: '',
                        date: '',
                        amount: 0,
                        counterparty: '',
                        contract: '',
                        summary: '',
                        status: 'draft'
                    }
                },
                
                // ç›¸å¯¹æ–¹é€‰æ‹©å¼¹çª—
                counterpartyModal: { 
                    open: false, 
                    search: '', 
                    filteredList: [] 
                },
                
                detailModal: { open: false, item: null },
                approveModal: { open: false, item: null, action: 'approve', comment: '' },
                deleteModal: { open: false, item: null },
                importModal: { open: false, step: 1, fileName: '', data: [], errors: [] },
                
                errors: {},
                
                toast: { show: false, message: '', type: 'success' },
                
                approvalSteps: ['éƒ¨é—¨é¢†å¯¼', 'è´¢åŠ¡å®¡æ ¸', 'è´¢åŠ¡ä¸»ç®¡', 'è´¢åŠ¡æ€»ç›‘'],
                
                init() {
                    this.generateMockData();
                },
                
                // åˆ‡æ¢æ˜ç»†ç±»å‹Tab
                switchRecordType(type) {
                    this.recordTypeTab = type;
                    this.currentTab = 'all';
                    this.currentPage = 1;
                    this.selectedIds = [];
                },
                
                // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
                generateMockData() {
                    const summaries = [
                        'Q1å®éªŒè€—æé‡‡è´­æ¬¾é¡¹', 'è‰²è°±æŸ±é‡‡è´­é¢„ä»˜æ¬¾', 'è®¾å¤‡ç»´æŠ¤è´¹ç”¨', 
                        'å®¢æˆ·æ£€æµ‹æœåŠ¡è´¹å›æ¬¾', 'å®éªŒå®¤è£…ä¿®å°¾æ¬¾', 'åŸ¹è®­è´¹ç”¨æ”¯å‡º',
                        'è½¯ä»¶æˆæƒè´¹', 'è¯•å‰‚é‡‡è´­æ¬¾', 'è®¾å¤‡æ ¡å‡†è´¹ç”¨', 'æœˆåº¦èµ„é‡‘è®¡åˆ’', 'å­£åº¦é¢„ç®—å®‰æ’'
                    ];
                    
                    for (let i = 1; i <= 35; i++) {
                        const fundType = Math.random() > 0.3 ? 'expense' : 'income';
                        const projects = this.projectTypes.filter(p => p.type === fundType && !p.auto);
                        const project = projects[Math.floor(Math.random() * projects.length)];
                        const status = ['draft', 'pending', 'approved', 'rejected'][Math.floor(Math.random() * 4)];
                        const recordType = i <= 20 ? 'actual' : 'plan'; // å‰20æ¡å®é™…ï¼Œå15æ¡è®¡åˆ’
                        
                        this.dataList.push({
                            id: i,
                            recordType: recordType,
                            orgName: this.orgList[Math.floor(Math.random() * this.orgList.length)],
                            deptName: this.deptList[Math.floor(Math.random() * this.deptList.length)],
                            fundType: fundType,
                            projectCode: project?.code || 'A01',
                            date: '2024-01-' + String(Math.floor(Math.random() * 28) + 1).padStart(2, '0'),
                            amount: Math.floor(Math.random() * 50000) + 1000,
                            counterparty: Math.random() > 0.5 ? 'è¥¿å®‰åŒ–å­¦è¯•å‰‚æœ‰é™å…¬å¸' : 'èµ›é»˜é£ä¸–å°”ç§‘æŠ€',
                            contract: Math.random() > 0.5 ? 'HT202400' + i : '',
                            summary: summaries[Math.floor(Math.random() * summaries.length)],
                            operator: ['å¼ ä¸‰', 'æå››', 'ç‹äº”'][Math.floor(Math.random() * 3)],
                            createTime: '2024-01-' + String(Math.floor(Math.random() * 28) + 1).padStart(2, '0') + ' 10:30:00',
                            submitTime: status !== 'draft' ? '2024-01-' + String(Math.floor(Math.random() * 28) + 1).padStart(2, '0') + ' 14:20:00' : '',
                            status: status,
                            approvalStep: status === 'pending' ? Math.floor(Math.random() * 3) : (status === 'approved' ? 4 : 0),
                            rejectReason: status === 'rejected' ? 'é‡‘é¢è¶…å‡ºé¢„ç®—ï¼Œè¯·é‡æ–°æ ¸å¯¹ã€‚' : '',
                            rejectBy: status === 'rejected' ? 'éƒ¨é—¨é¢†å¯¼' : '',
                            rejectTime: status === 'rejected' ? '2024-01-15 16:30:00' : ''
                        });
                    }
                },
                
                // æ€»ç»Ÿè®¡ï¼ˆä¸å—Tabå½±å“ï¼‰
                get stats() {
                    return {
                        total: this.dataList.length,
                        actualCount: this.dataList.filter(d => d.recordType === 'actual').length,
                        planCount: this.dataList.filter(d => d.recordType === 'plan').length,
                        draft: this.dataList.filter(d => d.status === 'draft').length,
                        pending: this.dataList.filter(d => d.status === 'pending').length,
                        approved: this.dataList.filter(d => d.status === 'approved').length,
                        rejected: this.dataList.filter(d => d.status === 'rejected').length
                    };
                },
                
                // å½“å‰Tabè¿‡æ»¤åçš„ç»Ÿè®¡
                get filteredStats() {
                    const filtered = this.dataList.filter(item => item.recordType === this.recordTypeTab);
                    return {
                        total: filtered.length,
                        draft: filtered.filter(d => d.status === 'draft').length,
                        pending: filtered.filter(d => d.status === 'pending').length,
                        approved: filtered.filter(d => d.status === 'approved').length,
                        rejected: filtered.filter(d => d.status === 'rejected').length
                    };
                },
                
                get filteredData() {
                    let data = this.dataList.filter(item => {
                        // é¦–å…ˆæŒ‰æ˜ç»†ç±»å‹è¿‡æ»¤
                        if (item.recordType !== this.recordTypeTab) return false;
                        
                        // Tabç­›é€‰ï¼ˆçŠ¶æ€ï¼‰
                        if (this.currentTab === 'draft' && item.status !== 'draft') return false;
                        if (this.currentTab === 'pending' && item.status !== 'pending') return false;
                        if (this.currentTab === 'approved' && item.status !== 'approved') return false;
                        if (this.currentTab === 'rejected' && item.status !== 'rejected') return false;
                        
                        // å…³é”®è¯æœç´¢
                        if (this.filters.keyword) {
                            const keyword = this.filters.keyword.toLowerCase();
                            const match = item.summary?.toLowerCase().includes(keyword) ||
                                         item.contract?.toLowerCase().includes(keyword) ||
                                         item.counterparty?.toLowerCase().includes(keyword);
                            if (!match) return false;
                        }
                        
                        if (this.filters.orgName && item.orgName !== this.filters.orgName) return false;
                        if (this.filters.deptName && item.deptName !== this.filters.deptName) return false;
                        if (this.filters.fundType && item.fundType !== this.filters.fundType) return false;
                        if (this.filters.projectName && item.projectCode !== this.filters.projectName) return false;
                        if (this.filters.date && item.date !== this.filters.date) return false;
                        
                        return true;
                    });
                    
                    // æŒ‰æ—¥æœŸé™åº
                    data.sort((a, b) => new Date(b.date) - new Date(a.date));
                    return data;
                },
                
                get paginatedData() {
                    const start = (this.currentPage - 1) * this.pageSize;
                    return this.filteredData.slice(start, start + this.pageSize);
                },
                
                get totalPages() {
                    return Math.ceil(this.filteredData.length / this.pageSize) || 1;
                },
                
                get displayedPages() {
                    const pages = [];
                    const maxDisplay = 5;
                    let start = Math.max(1, this.currentPage - 2);
                    let end = Math.min(this.totalPages, start + maxDisplay - 1);
                    if (end - start < maxDisplay - 1) start = Math.max(1, end - maxDisplay + 1);
                    for (let i = start; i <= end; i++) pages.push(i);
                    return pages;
                },
                
                get isAllSelected() {
                    return this.paginatedData.length > 0 && this.paginatedData.every(item => this.selectedIds.includes(item.id));
                },
                
                get filteredProjects() {
                    return this.projectTypes.filter(p => p.type === this.editModal.form.fundType && !p.auto);
                },
                
                // åˆ¤æ–­å½“å‰é€‰æ‹©çš„é¡¹ç›®æ˜¯å¦ä¸ºè‡ªåŠ¨è®¡ç®—é¡¹
                get isAutoCalculatedProject() {
                    const project = this.projectTypes.find(p => p.code === this.editModal.form.projectCode);
                    return project ? project.auto : false;
                },
                
                toggleSelectAll() {
                    if (this.isAllSelected) {
                        this.selectedIds = [];
                    } else {
                        this.selectedIds = this.paginatedData.map(item => item.id);
                    }
                },
                
                getStatusText(status) {
                    const map = {
                        'draft': 'è‰ç¨¿',
                        'pending': 'å®¡æ‰¹ä¸­',
                        'approved': 'å·²å®¡æ ¸',
                        'rejected': 'å·²é©³å›'
                    };
                    return map[status] || status;
                },
                
                getProjectName(code) {
                    const project = this.projectTypes.find(p => p.code === code);
                    return project ? project.name : code;
                },
                
                getStepClass(idx, currentStep, status) {
                    if (status === 'rejected' && idx === currentStep) return 'rejected';
                    if (idx < currentStep) return 'completed';
                    if (idx === currentStep) return 'active';
                    return '';
                },
                
                formatMoney(amount) {
                    return amount?.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) || '0.00';
                },
                
                applyFilters() {
                    this.currentPage = 1;
                    this.selectedIds = [];
                },
                
                resetFilters() {
                    this.filters = {
                        keyword: '',
                        orgName: '',
                        deptName: '',
                        fundType: '',
                        projectName: '',
                        date: ''
                    };
                    this.applyFilters();
                },
                
                // è®¡ç®—è‡ªåŠ¨è®¡ç®—é¡¹ç›®çš„é‡‘é¢
                calculateAutoAmount() {
                    if (!this.isAutoCalculatedProject) return;
                    
                    const code = this.editModal.form.projectCode;
                    const orgName = this.editModal.form.orgName;
                    const deptName = this.editModal.form.deptName;
                    const date = this.editModal.form.date;
                    
                    let childrenCodes = [];
                    
                    // æ ¹æ®codeç¡®å®šå­é¡¹èŒƒå›´
                    if (code === 'A00') {
                        // A00 = A01+A02+A03+A04
                        childrenCodes = ['A01', 'A02', 'A03', 'A04'];
                    } else if (code === 'B00') {
                        // B00 = æ‰€æœ‰æ”¯å‡ºé¡¹ï¼ˆé™¤B00æœ¬èº«ï¼‰
                        childrenCodes = this.projectTypes.filter(p => p.type === 'expense' && p.code !== 'B00').map(p => p.code);
                    } else if (code === 'B10') {
                        childrenCodes = ['B11', 'B12', 'B13', 'B14'];
                    } else if (code === 'B20') {
                        childrenCodes = ['B21', 'B22', 'B23', 'B24'];
                    } else if (code === 'B30') {
                        childrenCodes = ['B31', 'B32', 'B33'];
                    } else if (code === 'B40') {
                        childrenCodes = ['B41', 'B42'];
                    } else if (code === 'B50') {
                        childrenCodes = ['B51', 'B52', 'B53'];
                    } else if (code === 'B60') {
                        childrenCodes = ['B61', 'B62'];
                    }
                    
                    // è®¡ç®—å­é¡¹ç›®é‡‘é¢æ€»å’Œï¼ˆåŒä¸€æœºæ„ã€éƒ¨é—¨ã€æ—¥æœŸï¼‰
                    let total = 0;
                    this.dataList.forEach(item => {
                        if (childrenCodes.includes(item.projectCode) && 
                            item.orgName === orgName && 
                            item.deptName === deptName && 
                            item.date === date &&
                            item.status !== 'rejected' &&
                            item.id !== this.editModal.form.id) { // æ’é™¤å½“å‰ç¼–è¾‘çš„é¡¹
                            total += Number(item.amount) || 0;
                        }
                    });
                    
                    this.editModal.form.amount = total;
                },
                
                // é¡¹ç›®åç§°æ”¹å˜æ—¶è§¦å‘
                onProjectChange() {
                    this.validateField('projectCode');
                    this.calculateAutoAmount();
                },
                
                // ç›¸å¯¹æ–¹é€‰æ‹©å¼¹çª—æ“ä½œ
                openCounterpartyModal() {
                    this.counterpartyModal.open = true;
                    this.counterpartyModal.search = '';
                    this.searchCounterpartyModal();
                },

                closeCounterpartyModal() {
                    this.counterpartyModal.open = false;
                    this.counterpartyModal.search = '';
                },

                searchCounterpartyModal() {
                    const list = this.editModal.form.fundType === 'income' ? this.customers : this.suppliers;
                    const keyword = this.counterpartyModal.search.toLowerCase();
                    this.counterpartyModal.filteredList = list.filter(item => 
                        item.toLowerCase().includes(keyword)
                    );
                },

                selectCounterpartyFromModal(name) {
                    this.editModal.form.counterparty = name;
                    this.validateField('counterparty');
                    this.closeCounterpartyModal();
                },
                
                // ç¼–è¾‘å¼¹çª—æ“ä½œ
                openEditModal(item = null) {
                    this.errors = {};
                    
                    if (item) {
                        this.editModal.isEdit = true;
                        this.editModal.form = { ...item };
                    } else {
                        this.editModal.isEdit = false;
                        this.editModal.form = {
                            id: null,
                            recordType: this.recordTypeTab, // æ ¹æ®å½“å‰Tabè‡ªåŠ¨è®¾ç½®ç±»å‹
                            orgName: '',
                            deptName: '',
                            fundType: 'expense',
                            projectCode: '',
                            date: new Date().toISOString().split('T')[0],
                            amount: 0,
                            counterparty: '',
                            contract: '',
                            summary: '',
                            status: 'draft'
                        };
                    }
                    this.editModal.open = true;
                    
                    // å¦‚æœæ˜¯è‡ªåŠ¨è®¡ç®—é¡¹ç›®ï¼Œç«‹å³è®¡ç®—é‡‘é¢
                    if (this.isAutoCalculatedProject) {
                        this.calculateAutoAmount();
                    }
                },
                
                closeEditModal() {
                    this.editModal.open = false;
                    setTimeout(() => {
                        this.editModal.isEdit = false;
                        this.errors = {};
                    }, 200);
                },
                
                onFundTypeChange() {
                    this.editModal.form.projectCode = '';
                    this.editModal.form.counterparty = '';
                    this.editModal.form.amount = 0;
                },
                
                validateField(field) {
                    const value = this.editModal.form[field];
                    switch(field) {
                        case 'orgName':
                            this.errors.orgName = !value ? 'è¯·é€‰æ‹©æœºæ„åç§°' : '';
                            break;
                        case 'deptName':
                            this.errors.deptName = !value ? 'è¯·é€‰æ‹©éƒ¨é—¨åç§°' : '';
                            break;
                        case 'projectCode':
                            this.errors.projectCode = !value ? 'è¯·é€‰æ‹©é¡¹ç›®åç§°' : '';
                            break;
                        case 'date':
                            this.errors.date = !value ? 'è¯·é€‰æ‹©å‘ç”Ÿæ—¥æœŸ' : '';
                            break;
                        case 'amount':
                            // è‡ªåŠ¨è®¡ç®—é¡¹ä¸éªŒè¯é‡‘é¢æ˜¯å¦>0ï¼ˆå¯èƒ½ä¸º0ï¼‰
                            if (this.isAutoCalculatedProject) {
                                this.errors.amount = '';
                            } else {
                                this.errors.amount = !value || value <= 0 ? 'è¯·è¾“å…¥æœ‰æ•ˆçš„å‘ç”Ÿé‡‘é¢' : '';
                            }
                            break;
                        case 'counterparty':
                            this.errors.counterparty = !value ? 'è¯·é€‰æ‹©ç›¸å¯¹æ–¹åç§°' : '';
                            break;
                        case 'summary':
                            this.errors.summary = !value ? 'è¯·è¾“å…¥æ‘˜è¦è¯´æ˜' : '';
                            break;
                    }
                    return !this.errors[field];
                },
                
                validateForm() {
                    const fields = ['orgName', 'deptName', 'projectCode', 'date', 'amount', 'counterparty', 'summary'];
                    let valid = true;
                    fields.forEach(field => {
                        if (!this.validateField(field)) valid = false;
                    });
                    return valid;
                },
                
                saveDraft() {
                    if (!this.validateForm()) {
                        this.showToast('è¯·å®Œå–„å¿…å¡«é¡¹', 'error');
                        return;
                    }
                    
                    const formData = { ...this.editModal.form };
                    
                    if (this.editModal.isEdit) {
                        const index = this.dataList.findIndex(d => d.id === formData.id);
                        if (index > -1) {
                            this.dataList[index] = { ...this.dataList[index], ...formData, status: 'draft' };
                        }
                    } else {
                        formData.id = Date.now();
                        formData.status = 'draft';
                        formData.operator = 'å½“å‰ç”¨æˆ·';
                        formData.createTime = new Date().toLocaleString();
                        this.dataList.unshift(formData);
                    }
                    
                    this.showToast('ä¿å­˜è‰ç¨¿æˆåŠŸ', 'success');
                    this.closeEditModal();
                },
                
                submitForm() {
                    if (!this.validateForm()) {
                        this.showToast('è¯·å®Œå–„å¿…å¡«é¡¹', 'error');
                        return;
                    }
                    
                    const formData = { ...this.editModal.form };
                    
                    if (this.editModal.isEdit) {
                        const index = this.dataList.findIndex(d => d.id === formData.id);
                        if (index > -1) {
                            this.dataList[index] = { 
                                ...this.dataList[index], 
                                ...formData, 
                                status: 'pending',
                                approvalStep: 0,
                                submitTime: new Date().toLocaleString()
                            };
                        }
                    } else {
                        formData.id = Date.now();
                        formData.status = 'pending';
                        formData.approvalStep = 0;
                        formData.operator = 'å½“å‰ç”¨æˆ·';
                        formData.createTime = new Date().toLocaleString();
                        formData.submitTime = new Date().toLocaleString();
                        this.dataList.unshift(formData);
                    }
                    
                    this.showToast('æäº¤å®¡æ ¸æˆåŠŸ', 'success');
                    this.closeEditModal();
                },
                
                // è¡Œæ“ä½œ
                submitItem(item) {
                    if (confirm(`ç¡®å®šæäº¤è¯¥${item.fundType === 'income' ? 'å›æ¬¾' : 'æ”¯å‡º'}è®°å½•è¿›è¡Œå®¡æ‰¹å—ï¼Ÿ`)) {
                        item.status = 'pending';
                        item.approvalStep = 0;
                        item.submitTime = new Date().toLocaleString();
                        this.showToast('å·²æäº¤å®¡æ‰¹', 'success');
                    }
                },
                
                recallItem(item) {
                    if (confirm('ç¡®å®šæ’¤å›è¯¥è®°å½•å—ï¼Ÿæ’¤å›åå°†è¿”å›è‰ç¨¿çŠ¶æ€ã€‚')) {
                        item.status = 'draft';
                        item.approvalStep = 0;
                        this.showToast('å·²æ’¤å›', 'success');
                    }
                },
                
                deleteItem(item) {
                    this.deleteModal.item = item;
                    this.deleteModal.open = true;
                },
                
                executeDelete() {
                    if (this.deleteModal.item) {
                        const index = this.dataList.findIndex(d => d.id === this.deleteModal.item.id);
                        if (index > -1) {
                            this.dataList.splice(index, 1);
                            this.showToast('åˆ é™¤æˆåŠŸ', 'success');
                        }
                    }
                    this.deleteModal.open = false;
                    this.deleteModal.item = null;
                },
                
                // è¯¦æƒ…å¼¹çª—
                viewDetail(item) {
                    this.detailModal.item = item;
                    this.detailModal.open = true;
                },
                
                closeDetailModal() {
                    this.detailModal.open = false;
                    setTimeout(() => this.detailModal.item = null, 200);
                },
                
                // å®¡æ‰¹å¼¹çª—
                openApproveModal(item) {
                    this.approveModal.item = item;
                    this.approveModal.action = 'approve';
                    this.approveModal.comment = '';
                    this.approveModal.open = true;
                },
                
                closeApproveModal() {
                    this.approveModal.open = false;
                    setTimeout(() => {
                        this.approveModal.item = null;
                        this.approveModal.comment = '';
                    }, 200);
                },
                
                confirmApprove() {
                    // é©³å›æ—¶å¿…é¡»å¡«å†™æ„è§ï¼Œæ‰¹å‡†æ—¶ä¸éœ€è¦
                    if (this.approveModal.action === 'reject' && !this.approveModal.comment) {
                        this.showToast('é©³å›æ—¶å¿…é¡»å¡«å†™å®¡æ‰¹æ„è§', 'error');
                        return;
                    }
                    
                    const item = this.approveModal.item;
                    if (this.approveModal.action === 'approve') {
                        item.approvalStep = (item.approvalStep || 0) + 1;
                        if (item.approvalStep >= 4) {
                            item.status = 'approved';
                        }
                        this.showToast('å®¡æ‰¹é€šè¿‡', 'success');
                    } else {
                        item.status = 'rejected';
                        item.rejectReason = this.approveModal.comment;
                        item.rejectBy = 'å½“å‰å®¡æ‰¹äºº';
                        item.rejectTime = new Date().toLocaleString();
                        this.showToast('å·²é©³å›', 'error');
                    }
                    
                    this.closeApproveModal();
                },
                
                // æ‰¹é‡å¯¼å…¥
                openImportModal() {
                    this.importModal = { open: true, step: 1, fileName: '', data: [], errors: [] };
                },
                
                closeImportModal() {
                    this.importModal.open = false;
                },
                
                downloadTemplate() {
                    this.showToast('æ¨¡æ¿ä¸‹è½½æˆåŠŸ', 'success');
                    setTimeout(() => this.importModal.step = 2, 500);
                },
                
                handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.importModal.fileName = file.name;
                        this.showToast('æ–‡ä»¶å·²é€‰æ‹©', 'success');
                    }
                },
                
                validateImportData() {
                    // æ¨¡æ‹Ÿæ ¡éªŒæ•°æ®
                    const mockData = [
                        { lineNo: 1, recordType: 'actual', orgName: 'ä¸­æ£€è®¡é‡æœ‰é™å…¬å¸', fundType: 'expense', projectCode: 'B12', amount: 15000, error: false },
                        { lineNo: 2, recordType: 'plan', orgName: 'ä¸­æ£€ååŒ—è®¡é‡æœ‰é™å…¬å¸', fundType: 'income', projectCode: 'A01', amount: 25000, error: false },
                        { lineNo: 3, recordType: 'actual', orgName: 'æŸé”™è¯¯æœºæ„', fundType: 'expense', projectCode: 'B99', amount: -1000, error: true, errorMsg: 'æœºæ„ä¸å­˜åœ¨ï¼Œé¡¹ç›®ä»£ç ä¸å­˜åœ¨' },
                        { lineNo: 4, recordType: 'plan', orgName: 'ä¸­æ£€ï¼ˆæ±Ÿè‹ï¼‰è®¡é‡æµ‹è¯•æœ‰é™å…¬å¸', fundType: 'expense', projectCode: 'B21', amount: 8000, error: false },
                        { lineNo: 5, recordType: 'actual', orgName: '', fundType: 'income', projectCode: 'A02', amount: 5000, error: true, errorMsg: 'æœºæ„åç§°ä¸èƒ½ä¸ºç©º' }
                    ];
                    
                    this.importModal.data = mockData;
                    this.importModal.errors = mockData.filter(d => d.error);
                    this.importModal.step = 3;
                },
                
                // ä¿®æ”¹ç¡®è®¤å¯¼å…¥æ–¹æ³•ï¼Œè¿‡æ»¤é”™è¯¯æ•°æ®
                confirmImport() {
                    const validData = this.importModal.data.filter(d => !d.error);
                    if (validData.length === 0) {
                        this.showToast('æ²¡æœ‰å¯å¯¼å…¥çš„æœ‰æ•ˆæ•°æ®', 'error');
                        return;
                    }
                    
                    // æ‰§è¡Œå¯¼å…¥ï¼ˆè¿™é‡Œåªæ¨¡æ‹Ÿæ·»åŠ åˆ°åˆ—è¡¨ï¼‰
                    validData.forEach(row => {
                        this.dataList.unshift({
                            id: Date.now() + Math.random(),
                            recordType: row.recordType || 'actual',
                            orgName: row.orgName || this.orgList[0],
                            deptName: this.deptList[0],
                            fundType: row.fundType,
                            projectCode: row.projectCode,
                            date: new Date().toISOString().split('T')[0],
                            amount: row.amount,
                            counterparty: 'æ‰¹é‡å¯¼å…¥',
                            contract: '',
                            summary: 'æ‰¹é‡å¯¼å…¥æ•°æ®',
                            operator: 'å½“å‰ç”¨æˆ·',
                            createTime: new Date().toLocaleString(),
                            status: 'draft'
                        });
                    });
                    
                    this.showToast(`æˆåŠŸå¯¼å…¥ ${validData.length} æ¡æœ‰æ•ˆæ•°æ®${this.importModal.errors.length > 0 ? 'ï¼Œå·²è·³è¿‡ ' + this.importModal.errors.length + ' æ¡é”™è¯¯æ•°æ®' : ''}`, 'success');
                    this.closeImportModal();
                },
                
                // æ‰¹é‡æ“ä½œ
                batchSubmit() {
                    const count = this.selectedIds.length;
                    if (!confirm(`ç¡®å®šæ‰¹é‡æäº¤é€‰ä¸­çš„ ${count} ä¸ªè®°å½•å—ï¼Ÿ`)) return;
                    
                    let successCount = 0;
                    this.selectedIds.forEach(id => {
                        const item = this.dataList.find(d => d.id === id);
                        if (item && item.status === 'draft') {
                            item.status = 'pending';
                            item.approvalStep = 0;
                            successCount++;
                        }
                    });
                    
                    this.selectedIds = [];
                    this.showToast(`æˆåŠŸæäº¤ ${successCount} ä¸ªè®°å½•`, 'success');
                },
                
                batchDelete() {
                    const count = this.selectedIds.length;
                    if (!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${count} ä¸ªè®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
                    
                    this.dataList = this.dataList.filter(d => !this.selectedIds.includes(d.id) || d.status === 'pending');
                    this.selectedIds = [];
                    this.showToast('æ‰¹é‡åˆ é™¤æˆåŠŸ', 'success');
                },
                
                // é€šç”¨
                refreshData() {
                    this.loading = true;
                    setTimeout(() => {
                        this.loading = false;
                        this.showToast('æ•°æ®å·²åˆ·æ–°', 'success');
                    }, 500);
                },
                
                exportData() {
                    this.showToast('æ­£åœ¨å¯¼å‡ºæ•°æ®...', 'success');
                },
                
                showToast(message, type = 'success') {
                    this.toast = { show: true, message, type };
                    setTimeout(() => this.toast.show = false, 3000);
                }
            }
        }
    </script>
</body>
</html>
