<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能报价栏 (最终版)</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Inter', system-ui, sans-serif; background-color: #f1f5f9; padding-bottom: 120px; }
        
        /* 拟态输入框风格 */
        .smart-input {
            background: transparent;
            border: none;
            border-bottom: 1px dashed #94a3b8;
            font-family: 'Monaco', 'Consolas', monospace;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s;
            outline: none;
        }
        .smart-input:focus {
            border-bottom: 2px solid #3b82f6;
            background-color: #eff6ff;
            color: #1d4ed8;
        }
        
        /* 运算符号 */
        .math-symbol { color: #cbd5e1; font-weight: 300; font-size: 24px; user-select: none; margin: 0 4px; }
        
        /* 锁定图标动画 */
        .lock-icon { transition: all 0.2s; cursor: pointer; }
        .lock-icon:hover { transform: scale(1.1); color: #64748b; }
        
        /* 综合折扣率标签 */
        .badge-rate {
            background: #f1f5f9; border: 1px solid #e2e8f0; color: #64748b;
            font-size: 11px; padding: 2px 8px; border-radius: 4px;
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen">

    <div x-data="smartPricing()" x-cloak 
         class="fixed bottom-0 left-0 right-0 z-50 bg-white border-t border-slate-200 shadow-[0_-4px_20px_-5px_rgba(0,0,0,0.1)] h-24 px-8 flex items-center justify-between">
        
        <div class="flex flex-col w-48">
            <span class="text-xs text-slate-400 font-medium uppercase tracking-wider mb-1">器具原价汇总</span>
            <div class="flex items-center gap-2">
                <span class="text-2xl font-bold text-slate-700 font-mono">¥<span x-text="basePrice"></span></span>
                <span class="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded">共 12 项</span>
            </div>
        </div>

        <div class="flex-1 mx-8 flex items-center justify-center h-full" style="padding-right: 300px;>
            <div class="bg-slate-50 border border-slate-200 rounded-xl px-12 py-3 flex items-center gap-8 relative shadow-inner">
                
                <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-white px-3 py-0.5 text-[10px] text-slate-400 border border-slate-200 rounded-full shadow-sm whitespace-nowrap">
                    计算公式：参与折扣器具总价 × 折扣率 不参与折扣器具总价 + 服务费 = 最终报价
                </div>

                <div class="flex flex-col items-center opacity-60">
                    <label class="text-[10px] text-slate-400 mb-1">器具原价</label>
                    <span class="text-lg font-bold text-slate-600 border-b border-transparent font-mono">¥<span x-text="basePrice"></span></span>
                </div>

                <span class="math-symbol">×</span>

                <div class="flex flex-col items-center relative group">
                    <label class="text-[10px] text-slate-500 mb-1 font-medium text-blue-600">折扣率</label>
                    <div class="relative">
                        <input type="number" x-model.number="discount" @input="calcForward()" 
                               class="smart-input w-20 text-lg text-blue-600 font-bold" placeholder="100">
                        <span class="absolute right-0 bottom-1 text-blue-400 font-bold">%</span>
                    </div>
                    <div class="absolute -top-4 -right-5" title="点击锁定：修改总价时，优先调整服务费，保持此折扣不变">
                        <i class="fa-solid lock-icon text-xs p-2" 
                           :class="lockMode === 'discount' ? 'fa-lock text-red-500' : 'fa-lock-open text-slate-300'"
                           @click="setLock('discount')"></i>
                    </div>
                </div>

                <span class="math-symbol">+</span>

                <div class="flex flex-col items-center relative group">
                    <label class="text-[10px] text-slate-500 mb-1 font-medium">服务费</label>
                    <div class="relative">
                        <span class="absolute left-0 bottom-1 text-slate-400">¥</span>
                        <input type="number" x-model.number="serviceFee" @input="calcForward()" 
                               class="smart-input w-28 text-lg text-slate-700 pl-4" placeholder="0">
                    </div>
                    <div class="absolute -top-4 -right-5" title="点击锁定：修改总价时，优先调整折扣，保持此费用不变">
                        <i class="fa-solid lock-icon text-xs p-2" 
                           :class="lockMode === 'fee' ? 'fa-lock text-red-500' : 'fa-lock-open text-slate-300'"
                           @click="setLock('fee')"></i>
                    </div>
                </div>

                <span class="math-symbol">=</span>

                <div class="flex flex-col items-center relative">
                    <label class="text-[10px] text-red-500 mb-1 font-bold flex items-center gap-1">
                        最终报价
                        <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span>
                    </label>
                    <div class="relative">
                        <span class="absolute left-0 bottom-1 text-red-400 font-bold text-lg">¥</span>
                        <input type="number" x-model.number="finalTotal" @input="calcReverse()" 
                               class="smart-input w-36 text-2xl text-red-600 font-bold pl-5 border-red-200 focus:border-red-500 bg-red-50/30 focus:bg-white" 
                               placeholder="0.00">
                    </div>
                    
                    <div class="absolute -bottom-8 w-48 text-center text-[10px] text-slate-400 transition-opacity duration-300" 
                         :class="isReverseCalculating ? 'opacity-100' : 'opacity-0'">
                        <i class="fa-solid fa-rotate mr-1 animate-spin"></i>
                        自动倒推: <span x-text="lockMode === 'discount' ? '服务费' : '折扣率'" class="font-bold text-blue-500"></span>
                    </div>
                </div>

            </div>
        </div>

        <div class="flex flex-col items-end w-48 pl-6 border-l border-slate-200 h-14 justify-center">
            <span class="text-[10px] text-slate-400 mb-1">综合实际折扣率</span>
            <div class="badge-rate font-mono">
                <span class="font-bold text-slate-700" x-text="realDiscountRate + '%'"></span>
                <span class="text-[9px] text-slate-400 ml-1">(含服务费)</span>
            </div>
        </div>

    </div>

    <script>
        function smartPricing() {
            return {
                basePrice: 2400,      // 器具总原价 (固定)
                serviceFee: 0,        // 服务费
                discount: 100,        // 折扣率 (Input)
                finalTotal: 2400,     // 最终总价
                
                lockMode: 'discount', // 默认锁定折扣
                isReverseCalculating: false,

                init() {
                    this.calcForward();
                },

                // 计算综合实际折扣率 (用于展示：最终价 / 原价)
                get realDiscountRate() {
                    if (this.basePrice === 0) return 0;
                    // 这里计算的是：最终需要支付的金额 / 器具原本的价值
                    // 它可以反映“加上服务费并打折后，相当于原价的多少比例”
                    return ((this.finalTotal / this.basePrice) * 100).toFixed(1);
                },

                setLock(mode) {
                    this.lockMode = mode;
                    this.isReverseCalculating = true;
                    setTimeout(() => this.isReverseCalculating = false, 600);
                },

                // 正向计算: (Base * Discount%) + Fee = Final
                calcForward() {
                    const fee = Number(this.serviceFee) || 0;
                    const dist = Number(this.discount) || 100;
                    
                    // 逻辑变更点：先乘折扣，再加服务费
                    this.finalTotal = ((this.basePrice * (dist / 100)) + fee).toFixed(2);
                    
                    this.isReverseCalculating = false;
                },

                // 反向计算: 修改 Final -> 推算 Fee 或 Discount
                calcReverse() {
                    this.isReverseCalculating = true;
                    const final = Number(this.finalTotal) || 0;
                    
                    if (this.lockMode === 'discount') {
                        // 场景1：锁折扣 -> 算服务费
                        // Fee = Final - (Base * Discount%)
                        const distRate = (Number(this.discount) || 100) / 100;
                        const baseDiscounted = this.basePrice * distRate;
                        
                        let calculatedFee = final - baseDiscounted;
                        this.serviceFee = calculatedFee.toFixed(2);
                        
                    } else {
                        // 场景2：锁服务费 -> 算折扣
                        // Discount% = (Final - Fee) / Base * 100
                        const fee = Number(this.serviceFee) || 0;
                        
                        if (this.basePrice === 0) {
                            this.discount = 0;
                        } else {
                            // 最终价减去服务费，剩下的钱全是给器具的
                            const moneyForInstruments = final - fee;
                            this.discount = ((moneyForInstruments / this.basePrice) * 100).toFixed(2);
                        }
                    }
                }
            }
        }
    </script>
</body>
</html>
